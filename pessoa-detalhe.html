<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Detalhe da Pessoa</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css">
    <style>
      .photo-area{position:relative;display:inline-block;}
      .tag-overlay{position:absolute;left:0;top:0;right:0;bottom:0;pointer-events:none}
      .tag-rect{position:absolute;border:2px solid rgba(59,130,246,0.9);background:rgba(59,130,246,0.12);pointer-events:auto;cursor:pointer;border-radius:6px;box-sizing:border-box}
      .tag-label{position:absolute;background:rgba(0,0,0,0.6);color:#fff;padding:2px 6px;border-radius:6px;font-size:12px;transform:translateY(-120%);white-space:nowrap}
      .tag-form{position:absolute;background:var(--bg-card);padding:8px;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,0.4);z-index:220}
      .tag-form select,.tag-form input{margin-bottom:6px;width:200px}
      #photoTaggedPeople{margin-top:8px;font-size:0.95rem;color:var(--text-main)}
      /* Tech info label and modal styling (subtle, footer placement) */
      #techInfoLabel{font-size:0.85rem;color:var(--text-secondary);text-decoration:none;display:inline-block;padding:4px 6px;border-radius:6px;border:none;background:transparent;opacity:0.85;transition:opacity .12s ease, transform .12s ease;}
      #techInfoLabel:hover{opacity:1;transform:none;color:var(--text-main)}
      #techInfoModal > div{box-shadow:0 14px 40px rgba(2,6,23,0.6);}
      #techInfoContent{font-family:SFMono-Regular,Menlo,Monaco,Roboto Mono,monospace;background:rgba(0,0,0,0.03);padding:12px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);max-height:60vh;overflow:auto;white-space:pre-wrap;word-break:break-word;color:var(--text-main);}
    </style>
    <script src="remote-storage.js"></script>
  </head>
  <body>
    <div class="app-shell">
      <aside class="sidebar">
        <a href="index.html" class="logo"><i class="mdi mdi-tree" aria-hidden="true"></i><span>myLineage</span></a>
        <nav>
          <a href="app.html"><i class="mdi mdi-account-multiple" aria-hidden="true"></i>Cadastro</a>
          <a href="indicadores.html"><i class="mdi mdi-chart-bar" aria-hidden="true"></i>Indicadores</a>
          <a href="arvore.html"><i class="mdi mdi-sitemap" aria-hidden="true"></i>Árvore</a>
          <a href="gedcom.html"><i class="mdi mdi-dna" aria-hidden="true"></i>GEDCOM</a>
          <a href="album.html"><i class="mdi mdi-image-multiple" aria-hidden="true"></i>Álbum</a>
        </nav>
        <div class="sidebar-footer">
          <a href="apis.html"><i class="mdi mdi-api" aria-hidden="true"></i>APIs</a>
          <a href="configuracao.html"><i class="mdi mdi-cog" aria-hidden="true"></i>Definições</a>
        </div>
      </aside>
      <main class="content">
        <div class="topbar">
          <div style="display:flex;align-items:center;gap:12px"><h1>Detalhe da Pessoa</h1></div>
          <div><a class="btn" href="app.html">Voltar</a></div>
        </div>
        <div class="main-grid">
          <div class="form-panel card" id="formPanel">
            <div class="accordion">
              <div class="accordion-card" id="cardDados">
                <button type="button" class="accordion-header" data-target="contentDados"><span>Dados Pessoais</span><span class="accordion-arrow"><i class="mdi mdi-chevron-down" aria-hidden="true"></i></span></button>
                <div class="accordion-content" id="contentDados">
                  <form id="personForm">
                    <input type="hidden" id="id" name="id" />
                    <input type="hidden" id="createdAt" name="createdAt" />
                    <input type="hidden" id="updatedAt" name="updatedAt" />
                    <input type="hidden" id="deletedAt" name="deletedAt" />
                    <div>
                      <label for="firstName">First Name</label>
                      <input type="text" id="firstName" name="firstName" required />
                    </div>
                    <div>
                      <label for="lastName">Last Name</label>
                      <input type="text" id="lastName" name="lastName" required />
                    </div>
                    <div>
                      <label for="gender">Gender</label>
                      <select id="gender" name="gender">
                        <option value="">-- selecione --</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                      </select>
                    </div>
                    <div class="full">
                      <label for="notes">Notes</label>
                      <textarea id="notes" name="notes"></textarea>
                    </div>
                    <div id="ageInfo"></div>
                    <div class="full">
                      <button type="submit" id="saveBtn">Salvar</button>
                      <button type="button" id="resetBtn">Limpar</button>
                    </div>
                  </form>
                </div>
              </div>

              <div class="accordion-card" id="cardEventos">
                <button type="button" class="accordion-header" data-target="contentEventos"><span>Eventos</span><span class="accordion-arrow"><i class="mdi mdi-chevron-down" aria-hidden="true"></i></span></button>
                <div class="accordion-content" id="contentEventos">
                  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
                    <div style="font-weight:600;color:var(--text-main);">Eventos</div>
                    <div><button type="button" id="openEventFormBtn" class="btn">Adicionar Evento</button></div>
                  </div>
                  <div id="eventFormWrapper" style="display:none;">
                    <form id="eventForm">
                      <div>
                        <label for="eventType">Tipo de evento</label>
                        <select id="eventType" name="eventType" required>
                          <option value="">-- selecione --</option>
                          <option value="BIRTH">Nascimento</option>
                          <option value="BAPTISM">Batismo</option>
                          <option value="DEATH">Óbito</option>
                          <option value="MARRIAGE">Casamento</option>
                          <option value="DIVORCE">Divórcio</option>
                          <option value="ADOPTION">Adoção</option>
                          <option value="CUSTOM">Outro</option>
                        </select>
                      </div>
                      <div>
                        <label for="eventDate">Data</label>
                        <input type="date" id="eventDate" name="eventDate" />
                      </div>
                      <div>
                        <label for="eventLocation">Local</label>
                        <input type="text" id="eventLocation" name="eventLocation" />
                      </div>
                      <div>
                        <label for="eventNotes">Notas</label>
                        <textarea id="eventNotes" name="eventNotes"></textarea>
                      </div>
                      <div class="full" style="display:flex;gap:8px;">
                        <button type="button" id="addEventBtn">Salvar Evento</button>
                        <button type="button" id="cancelEventBtn">Cancelar</button>
                      </div>
                    </form>
                  </div>
                  <div id="eventsList"></div>
                </div>
              </div>

              <div class="accordion-card" id="cardRelacoes">
                <button type="button" class="accordion-header" data-target="contentRelacoes"><span>Relações</span><span class="accordion-arrow"><i class="mdi mdi-chevron-down" aria-hidden="true"></i></span></button>
                <div class="accordion-content" id="contentRelacoes">
                  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
                    <div style="font-weight:600;color:var(--text-main);">Relações</div>
                    <div><button type="button" id="openRelationFormBtn" class="btn">Adicionar Relação</button></div>
                  </div>
                  <div id="relationFormWrapper" style="display:none;">
                    <form id="relationForm">
                      <div>
                        <label for="relationType">Tipo de relação</label>
                        <select id="relationType" name="relationType">
                          <option value="">-- selecione --</option>
                          <option value="siblin">Siblin</option>
                          <option value="ancestor">Ancestor</option>
                          <option value="child">Child</option>
                          <option value="mate">Mate</option>
                        </select>
                      </div>
                      <div>
                        <label for="relationPerson">Pessoa relacionada</label>
                        <select id="relationPerson" name="relationPerson">
                          <option value="">-- selecione --</option>
                        </select>
                      </div>
                      <div class="full" style="display:flex;gap:8px;">
                        <button type="button" id="addRelationBtn">Salvar Relação</button>
                        <button type="button" id="cancelRelationBtn">Cancelar</button>
                      </div>
                    </form>
                  </div>
                  <div id="relationsList"></div>
                </div>
              </div>
            </div>
            <div id="datesInfo" style="font-size:0.85em;color:#666;margin-top:16px;text-align:right;"></div>
          </div>
          <div class="card" id="photosPanel">
            <h2 style="margin:0 0 8px 0;">Fotos</h2>
            <p style="color:var(--text-secondary);margin-top:6px;">Fotos associadas à pessoa. Faça upload de novas imagens e vincule-as a esta pessoa. Remover vínculo não apaga o ficheiro.</p>

            <div style="display:flex;gap:8px;align-items:center;margin-top:12px;flex-direction:column;align-items:flex-start;">
              <div style="display:flex;gap:8px;align-items:center; width:100%">
                <input type="file" id="photoInput" accept="image/*" />
                <button class="btn" id="uploadPhotoBtn">Upload</button>
              </div>
              <div id="photoBaseInfo" style="color:var(--text-secondary);font-size:0.95rem;margin-top:6px;"></div>
              <div id="photosList" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:12px; width:100%"></div>
            </div>
          </div>
        </div>
        <div class="tech-footer" style="text-align:center;padding:8px 0 28px 0;">
          <a id="techInfoLabel" href="#">(i) informação técnica</a>
        </div>
      </main>
      
      <!-- Photo modal -->
      <div id="photoModal" style="display:none;position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.65);align-items:center;justify-content:center;z-index:200;">
        <div style="background:var(--bg-card);padding:22px;border-radius:12px;max-width:1100px;width:96%;max-height:96%;overflow:auto;box-sizing:border-box;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div style="font-weight:700">Visualizar Foto</div>
            <div><button id="closeModalBtn" class="btn">Fechar</button></div>
          </div>
          <div id="modalImageWrapper" style="display:flex;align-items:center;justify-content:center;text-align:center;margin-bottom:16px;padding:8px;">
            <div id="modalImageArea" style="max-width:100%;max-height:80vh;overflow:auto;">
              <!-- image + overlays inserted here -->
            </div>
          </div>
          <div style="margin-bottom:8px;">
            <label style="font-weight:600;color:var(--text-secondary);display:block;margin-bottom:6px;">Notas da Foto</label>
            <textarea id="photoNotes" style="width:100%;min-height:100px;padding:8px;border-radius:8px;border:1px solid rgba(163,163,255,0.08);background:rgba(35,40,58,0.7);color:var(--text-main);"></textarea>
            <div id="photoTaggedPeople"></div>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;">
            <button id="deletePhotoBtn" class="btn" style="background:linear-gradient(90deg,#fb7185,#f43f5e);">Remover Foto</button>
            <button id="savePhotoNotesBtn" class="btn">Salvar Notas</button>
          </div>
        </div>
      </div>
      <!-- Technical info modal -->
      <div id="techInfoModal" style="display:none;position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.65);align-items:center;justify-content:center;z-index:300;">
        <div style="background:var(--bg-card);padding:18px;border-radius:10px;max-width:900px;width:94%;max-height:86%;overflow:auto;box-sizing:border-box;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div style="font-weight:700">Informação técnica (JSON cru)</div>
            <div><button id="closeTechInfoBtn" class="btn">Fechar</button></div>
          </div>
          <div style="margin-bottom:8px;">
            <pre id="techInfoContent" style="white-space:pre-wrap;word-break:break-word;background:transparent;color:var(--text-main);font-size:0.9rem;">{
            }</pre>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Accordion helpers
      function openAccordion(id) { const el = document.getElementById(id); if (!el) return; el.style.display = 'block'; if (el.parentElement) el.parentElement.classList.add('open'); }
      function closeAccordion(id) { const el = document.getElementById(id); if (!el) return; el.style.display = 'none'; if (el.parentElement) el.parentElement.classList.remove('open'); }
      function toggleAccordion(id) { const el = document.getElementById(id); if (!el) return; if (el.style.display === 'block') closeAccordion(id); else openAccordion(id); }
      document.addEventListener('click', function(e){ const btn = e.target.closest && e.target.closest('.accordion-header'); if (btn && btn.dataset && btn.dataset.target) toggleAccordion(btn.dataset.target); });

      const STORAGE_KEY = 'people:myLineage';
      function nowISO() { return new Date().toISOString(); }
      function generateUUID() { if (crypto && crypto.randomUUID) return crypto.randomUUID(); const bytes = crypto.getRandomValues(new Uint8Array(16)); bytes[6] = (bytes[6] & 0x0f) | 0x40; bytes[8] = (bytes[8] & 0x3f) | 0x80; const b2h = b => Array.from(b).map(x => x.toString(16).padStart(2,'0')).join(''); const s = b2h(bytes); return s.slice(0,8)+'-'+s.slice(8,12)+'-'+s.slice(12,16)+'-'+s.slice(16,20)+'-'+s.slice(20); }
      function loadPeople() { try { const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : []; } catch(e) { return []; } }
      function savePeople(people) { localStorage.setItem(STORAGE_KEY, JSON.stringify(people)); }

      function getEvents() { try { const raw = localStorage.getItem('events:myLineage'); return raw ? JSON.parse(raw) : []; } catch (e) { return []; } }
      function saveEvents(events) { localStorage.setItem('events:myLineage', JSON.stringify(events)); }
      function getRelations() { try { const raw = localStorage.getItem('relations:myLineage'); return raw ? JSON.parse(raw) : []; } catch (e) { return []; } }
      function saveRelations(rel) { localStorage.setItem('relations:myLineage', JSON.stringify(rel)); }

      function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
      function formatDate(dateStr){ if(!dateStr) return ''; const d=new Date(dateStr); if(isNaN(d)) return escapeHtml(dateStr); const pad=n=>n.toString().padStart(2,'0'); return `${pad(d.getDate())}-${pad(d.getMonth()+1)}-${d.getFullYear()}`; }
      function computeAge(birthStr, refStr){ if(!birthStr) return null; const b=new Date(birthStr); const r= refStr ? new Date(refStr) : new Date(); if(isNaN(b)||isNaN(r)) return null; let years = r.getFullYear()-b.getFullYear(); const m = r.getMonth()-b.getMonth(); if (m<0 || (m===0 && r.getDate()<b.getDate())) years--; return years; }

      function showDatesInfo(person){ const el = document.getElementById('datesInfo'); if(!el) return; if(!person){ el.innerHTML=''; return; } let html=''; if(person.createdAt) html += `<div>Criado em: <span>${formatDate(person.createdAt)}</span></div>`; if(person.updatedAt) html += `<div>Atualizado em: <span>${formatDate(person.updatedAt)}</span></div>`; if(person.deletedAt) html += `<div>Excluído em: <span>${formatDate(person.deletedAt)}</span></div>`; el.innerHTML = html; }

      function renderEventsList(personId){
        try{
          const evsAll = getEvents();
          const list = document.getElementById('eventsList');
          const evs = evsAll.filter(ev => ev.personId === personId && !ev.deletedAt);
          if(evs.length===0){ list.innerHTML = '<div style="color:#888">Nenhum evento cadastrado.</div>'; return; }
          let html = '<div class="mini-list">';
          const typeLabels = { BIRTH: 'Nascimento', BAPTISM: 'Batismo', DEATH: 'Óbito', MARRIAGE: 'Casamento', DIVORCE: 'Divórcio', ADOPTION: 'Adoção', CUSTOM: 'Outro' };
          evs.forEach(ev=>{
            const label = typeLabels[ev.type] || ev.type;
            html += `
              <div class="mini-card event-card" data-id="${ev.id}">
                <div class="mc-header">
                  <div class="mc-type">${escapeHtml(label)}</div>
                  <div class="mc-meta">${formatDate(ev.date)||'Sem data'}</div>
                </div>
                <div class="mc-notes">${ev.location ? escapeHtml(ev.location) + '<br/>' : ''}${escapeHtml(ev.notes)}</div>
                <div class="mc-actions"><button class="remove-event" data-id="${ev.id}" title="Remover"><i class="mdi mdi-trash-can" aria-hidden="true"></i></button></div>
              </div>`;
          });
          html += '</div>';
          list.innerHTML = html;
          document.querySelectorAll('.remove-event').forEach(btn=>{
            btn.addEventListener('click', function(){
              const id = this.getAttribute('data-id');
              if(!id) return;
              let events = getEvents();
              events = events.map(ev => ev.id === id ? { ...ev, deletedAt: nowISO(), updatedAt: nowISO() } : ev);
              saveEvents(events);
              renderEventsList(personId);
            });
          });
        }catch(e){}
      }

      function renderRelationsList(personId){
        try{
          const relAll = getRelations();
          const people = loadPeople();
          const list = document.getElementById('relationsList');
          const rels = relAll.filter(r => r.from === personId);
          if(rels.length===0){ list.innerHTML = '<div style="color:#888">Nenhuma relação cadastrada.</div>'; return; }
          const typeDesc = { siblin: 'Irmão / Irmã', ancestor: 'Pai / Mãe', child: 'Filho(a)', mate: 'Companheiro(a)' };
          let html = '<div class="mini-list">';
          rels.forEach(r=>{
            const p = people.find(x=>x.id===r.to);
            let desc = typeDesc[r.type] || r.type || '';
            try{
              const low = (''+desc).toLowerCase();
              const g = p && (p.gender || p.sex) ? String(p.gender || p.sex).toLowerCase() : '';
              if(low.includes('filho')){
                if(g === 'female' || g === 'feminino' || g === 'f') desc = 'Filha';
                else if(g === 'male' || g === 'masculino' || g === 'm') desc = 'Filho';
                else desc = 'Filho(a)';
              }
              if(low.includes('pai') || low.includes('mãe') || low.includes('pai/mãe') || low.includes('pai / mãe')){
                if(g === 'female' || g === 'feminino' || g === 'f') desc = 'Mãe';
                else if(g === 'male' || g === 'masculino' || g === 'm') desc = 'Pai';
                else desc = 'Pai / Mãe';
              }
              if(low.includes('compan') || low.includes('mate') || low.includes('parceiro') || low.includes('conjuge') || low.includes('côn')){
                if(g === 'female' || g === 'feminino' || g === 'f') desc = 'Companheira';
                else if(g === 'male' || g === 'masculino' || g === 'm') desc = 'Companheiro';
                else desc = 'Companheiro(a)';
              }
              if(low.includes('irm') || low.includes('sibling') || low.includes('siblin')){
                if(g === 'female' || g === 'feminino' || g === 'f') desc = 'Irmã';
                else if(g === 'male' || g === 'masculino' || g === 'm') desc = 'Irmão';
                else desc = 'Irmão / Irmã';
              }
            }catch(e){ /* ignore */ }
            const nameHtml = p ? `<a href="#" class="relation-link" data-id="${p.id}">${escapeHtml(p.firstName+' '+p.lastName)}</a>` : escapeHtml(r.to);
            html += `
              <div class="mini-card relation-card" data-to="${escapeHtml(r.to)}" data-type="${escapeHtml(r.type)}">
                <div class="relation-mini">
                  <div style="flex:1">
                    <div class="rel-name">${p ? escapeHtml(p.firstName+' '+p.lastName) : escapeHtml(r.to)}</div>
                    <div class="rel-type">${escapeHtml(desc)}</div>
                  </div>
                  <div class="mc-actions">
                    <button class="open-relation" data-id="${p ? p.id : ''}" title="Abrir"><i class="mdi mdi-link-variant" aria-hidden="true"></i></button>
                    <button class="remove-relation" data-to="${escapeHtml(r.to)}" data-type="${escapeHtml(r.type)}" title="Remover"><i class="mdi mdi-trash-can" aria-hidden="true"></i></button>
                  </div>
                </div>
              </div>`;
          });
          html += '</div>';
          list.innerHTML = html;
          document.querySelectorAll('.relation-link, .open-relation').forEach(a=>{ a.addEventListener('click', function(ev){ ev.preventDefault(); const id=this.getAttribute('data-id'); if(id) loadPageForPerson(id); }); });
          document.querySelectorAll('.remove-relation').forEach(btn=>{ btn.addEventListener('click', function(){ const to = this.getAttribute('data-to'); const type = this.getAttribute('data-type'); let relations = getRelations(); relations = relations.filter(r => !(r.from === personId && r.to === to && r.type === type)); saveRelations(relations); renderRelationsList(personId); }); });
        }catch(e){}
      }

      // --- Photos: storage and rendering ---
      const PHOTO_BASE_KEY = 'photoBase:myLineage';
      const PHOTOS_KEY = 'photos:myLineage';
      const PHOTO_REL_KEY = 'photoRelations:myLineage';

      // IndexedDB helpers to read saved directory handle (saved in configuracao.html)
      function getDirHandleFromDB_local(){
        try{
          const req = indexedDB.open('myLineage-db', 1);
          return new Promise((resolve)=>{
            req.onupgradeneeded = function(e){ const db = e.target.result; if(!db.objectStoreNames.contains('handles')) db.createObjectStore('handles'); };
            req.onsuccess = function(e){ const db = e.target.result; const tx = db.transaction('handles','readonly'); const store = tx.objectStore('handles'); const g = store.get('photoBaseHandle'); g.onsuccess = function(){ resolve(g.result || null); db.close(); }; g.onerror = function(){ resolve(null); db.close(); }; };
            req.onerror = function(){ resolve(null); };
          });
        }catch(e){ return Promise.resolve(null); }
      }

      async function ensureWritePermission(handle){
        if(!handle) return false;
        try{
          if(handle.queryPermission){ const q = await handle.queryPermission({ mode: 'readwrite' }); if(q === 'granted') return true; }
          if(handle.requestPermission){ const r = await handle.requestPermission({ mode: 'readwrite' }); return r === 'granted'; }
          return true;
        }catch(e){ return false; }
      }

      function readPhotoBase(){ try{ return JSON.parse(localStorage.getItem(PHOTO_BASE_KEY)||'null'); }catch(e){ return null; } }
      function getPhotos(){ try{ return JSON.parse(localStorage.getItem(PHOTOS_KEY)||'[]'); }catch(e){ return []; } }
      function savePhotos(list){ localStorage.setItem(PHOTOS_KEY, JSON.stringify(list)); }
      function getPhotoRelations(){ try{ return JSON.parse(localStorage.getItem(PHOTO_REL_KEY)||'{}'); }catch(e){ return {}; } }
      function savePhotoRelations(obj){ localStorage.setItem(PHOTO_REL_KEY, JSON.stringify(obj)); }

      async function renderPhotos(personId){
        try{
          const base = readPhotoBase();
          const baseEl = document.getElementById('photoBaseInfo');
          baseEl.textContent = base && base.folder ? 'Base: ' + base.folder : 'Nenhuma pasta de fotos configurada.';

          const photos = getPhotos();
          const rels = getPhotoRelations();
          const arr = rels[personId] || [];
          const container = document.getElementById('photosList');
          if(!container) return;
          if(arr.length===0){ container.innerHTML = '<div style="color:#888">Nenhuma foto associada.</div>'; return; }
          container.innerHTML = '';

          const dirHandle = await getDirHandleFromDB_local();
          const canAccessDir = dirHandle ? await ensureWritePermission(dirHandle) : false;

          for(const pid of arr){
            const ph = photos.find(p=>p.id===pid);
            if(!ph) continue;
            const card = document.createElement('div');
            card.style.width = '88px';
            card.style.display = 'flex';
            card.style.flexDirection = 'column';
            card.style.alignItems = 'center';
            card.style.gap = '6px';

            const img = document.createElement('img');
            img.alt = ph.name || '';
            img.style.width = '88px';
            img.style.height = '88px';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '8px';
            img.style.boxShadow = '0 6px 16px rgba(0,0,0,0.35)';
            img.style.cursor = 'pointer';
            img.addEventListener('click', function(){ openPhotoModal(ph.id); });

            // Prefer showing the copy in base (location B) when available
            if(ph.baseCopyName && dirHandle && canAccessDir){
              try{
                const fh = await dirHandle.getFileHandle(ph.baseCopyName);
                const file = await fh.getFile();
                const url = URL.createObjectURL(file);
                img.src = url;
              }catch(e){
                // fallback to original data url
                img.src = ph.originalDataUrl || ph.dataUrl || '';
              }
            } else {
              img.src = ph.originalDataUrl || ph.dataUrl || '';
            }

            const btn = document.createElement('button');
            btn.textContent = 'Desvincular';
            btn.style.fontSize = '12px';
            btn.style.padding = '6px 8px';
            btn.style.borderRadius = '8px';
            btn.addEventListener('click', function(){ if(!confirm('Remover vínculo entre a foto e esta pessoa?')) return; let relations = getPhotoRelations(); relations[personId] = (relations[personId]||[]).filter(id=>id!==ph.id); savePhotoRelations(relations); renderPhotos(personId); });

            card.appendChild(img);
            card.appendChild(btn);
            container.appendChild(card);
          }
        }catch(e){ console.error(e); }
      }

      // Upload handler: store photo (dataURL) and link to person
      document.getElementById('uploadPhotoBtn').addEventListener('click', async function(){
        const input = document.getElementById('photoInput');
        const personId = document.getElementById('id').value;
        if(!personId) return alert('Pessoa não selecionada');
        if(!input || !input.files || input.files.length===0) return alert('Selecione uma imagem para upload.');
        const files = Array.from(input.files || []);
        const photos = getPhotos();
        const relations = getPhotoRelations();
        const now = nowISO();

        // try to get saved directory handle
        const dirHandle = await getDirHandleFromDB_local();
        let canWrite = false;
        if(dirHandle){ canWrite = await ensureWritePermission(dirHandle); }

        for(const f of files){
          try{
            // get original dataURL to preserve original link for association/display
            const dataUrl = await new Promise((res, rej)=>{ const r = new FileReader(); r.onload = ()=>res(r.result); r.onerror = ()=>rej(); r.readAsDataURL(f); });
            const id = generateUUID();
            let baseCopyName = null;
            if(canWrite){
              try{
                const fh = await dirHandle.getFileHandle(f.name, { create: true });
                const writable = await fh.createWritable();
                await writable.write(f);
                await writable.close();
                baseCopyName = f.name;
              }catch(err){ console.warn('Não foi possível gravar cópia na pasta base:', err); }
            }
            const rec = { id, name: f.name, originalDataUrl: dataUrl, baseCopyName: baseCopyName, folder: (readPhotoBase() && readPhotoBase().folder) || null, createdAt: now };
            photos.push(rec);
            relations[personId] = relations[personId] || [];
            relations[personId].push(id);
          }catch(err){ console.error('Erro no processamento do ficheiro', err); }
        }
        savePhotos(photos);
        savePhotoRelations(relations);
        input.value = '';
        renderPhotos(personId);
        alert('Upload concluído e foto vinculada.');
      });

      // Photo modal behaviour: open, close, save notes, delete photo record
      let _currentModalPhotoId = null;
      // drawing state
      let _isDrawing = false;
      let _drawStart = null;
      let _currentDrawEl = null;

      async function openPhotoModal(photoId){
        try{
          const photos = getPhotos();
          const ph = photos.find(p=>p.id===photoId);
          if(!ph) return;
          _currentModalPhotoId = photoId;
          const wrapper = document.getElementById('modalImageArea');
          wrapper.innerHTML = '';
          wrapper.style.display = 'flex';
          wrapper.style.alignItems = 'center';
          wrapper.style.justifyContent = 'center';

          const area = document.createElement('div');
          area.className = 'photo-area';
          area.style.maxWidth = '100%';
          area.style.maxHeight = '80vh';
          area.style.overflow = 'hidden';

          const img = document.createElement('img');
          img.id = 'modalImage';
          img.style.display = 'block';
          img.style.maxWidth = '100%';
          img.style.maxHeight = '80vh';
          img.style.borderRadius = '8px';
          img.style.boxShadow = '0 8px 24px rgba(0,0,0,0.5)';

          // overlay container (absolute over image)
          const overlay = document.createElement('div');
          overlay.className = 'tag-overlay';
          overlay.style.position = 'absolute';
          overlay.style.left = '0'; overlay.style.top = '0'; overlay.style.right = '0'; overlay.style.bottom = '0';

          // load image source (prefer base copy)
          (async ()=>{
            const dir = await getDirHandleFromDB_local();
            const canAccess = dir ? await ensureWritePermission(dir) : false;
            if(ph.baseCopyName && dir && canAccess){
              try{ const fh = await dir.getFileHandle(ph.baseCopyName); const file = await fh.getFile(); img.src = URL.createObjectURL(file); }catch(e){ img.src = ph.originalDataUrl || ph.dataUrl || ''; }
            } else { img.src = ph.originalDataUrl || ph.dataUrl || ''; }
          })();

          // container needed to position overlay on top of image
          const container = document.createElement('div');
          container.style.position = 'relative';
          container.appendChild(img);
          container.appendChild(overlay);
          area.appendChild(container);
          wrapper.appendChild(area);

          // notes
          const notesEl = document.getElementById('photoNotes'); notesEl.value = ph.notes || '';
          renderPhotoTags(ph);

          // drawing handlers attached to overlay (pointer events enabled for drawing)
          overlay.style.pointerEvents = 'auto';
          overlay.addEventListener('pointerdown', function(ev){ ev.preventDefault(); startDraw(ev, img, overlay); });
          overlay.addEventListener('pointermove', function(ev){ if(_isDrawing) updateDraw(ev, img, overlay); });
          overlay.addEventListener('pointerup', function(ev){ if(_isDrawing) finishDraw(ev, img, overlay); });

          document.getElementById('photoModal').style.display = 'flex';
        }catch(e){ console.error(e); }
      }

      function closePhotoModal(){ _currentModalPhotoId = null; _isDrawing = false; _drawStart = null; _currentDrawEl = null; document.getElementById('photoModal').style.display = 'none'; const wrapper = document.getElementById('modalImageArea'); if(wrapper) wrapper.innerHTML = ''; }

      document.getElementById('closeModalBtn').addEventListener('click', function(){ closePhotoModal(); });

      document.getElementById('savePhotoNotesBtn').addEventListener('click', function(){
        if(!_currentModalPhotoId) return; const notes = document.getElementById('photoNotes').value || ''; const photos = getPhotos(); const idx = photos.findIndex(p=>p.id===_currentModalPhotoId); if(idx<0) return alert('Foto não encontrada'); photos[idx].notes = notes; photos[idx].updatedAt = nowISO(); savePhotos(photos); alert('Notas salvas'); renderPhotos(document.getElementById('id').value); });

      document.getElementById('deletePhotoBtn').addEventListener('click', function(){
        if(!_currentModalPhotoId) return; if(!confirm('Remover a foto do sistema? Isso irá apagar as notas e desvincular de todas as pessoas. O ficheiro físico em B não será removido.')) return; const photos = getPhotos(); const newPhotos = photos.filter(p=>p.id!==_currentModalPhotoId); savePhotos(newPhotos); // remove from relations
        const rels = getPhotoRelations(); for(const k of Object.keys(rels)){ rels[k] = rels[k].filter(id=>id!==_currentModalPhotoId); if(rels[k].length===0) delete rels[k]; } savePhotoRelations(rels); renderPhotos(document.getElementById('id').value); closePhotoModal(); alert('Foto removida (registro).');
      });

      // Drawing helpers: coordinates saved as percentages relative to image natural/display size
      function getRelativeRect(img, x1, y1, x2, y2){
        const rect = img.getBoundingClientRect();
        const left = Math.min(x1,x2) - rect.left; const top = Math.min(y1,y2) - rect.top; const w = Math.abs(x2-x1); const h = Math.abs(y2-y1);
        const rx = Math.max(0, Math.min(1, left / rect.width));
        const ry = Math.max(0, Math.min(1, top / rect.height));
        const rw = Math.max(0, Math.min(1, w / rect.width));
        const rh = Math.max(0, Math.min(1, h / rect.height));
        return { x: rx, y: ry, w: rw, h: rh };
      }

      function startDraw(ev, img, overlay){ _isDrawing = true; _drawStart = { x: ev.clientX, y: ev.clientY }; _currentDrawEl = document.createElement('div'); _currentDrawEl.className = 'tag-rect'; _currentDrawEl.style.left='0'; _currentDrawEl.style.top='0'; _currentDrawEl.style.width='0'; _currentDrawEl.style.height='0'; overlay.appendChild(_currentDrawEl); }

      function updateDraw(ev, img, overlay){ if(!_isDrawing || !_currentDrawEl || !_drawStart) return; const rect = img.getBoundingClientRect(); const x1 = _drawStart.x; const y1 = _drawStart.y; const x2 = ev.clientX; const y2 = ev.clientY; const left = Math.min(x1,x2) - rect.left; const top = Math.min(y1,y2) - rect.top; const w = Math.abs(x2-x1); const h = Math.abs(y2-y1); _currentDrawEl.style.left = (left / rect.width * 100) + '%'; _currentDrawEl.style.top = (top / rect.height * 100) + '%'; _currentDrawEl.style.width = (w / rect.width * 100) + '%'; _currentDrawEl.style.height = (h / rect.height * 100) + '%'; }

      function finishDraw(ev, img, overlay){ if(!_isDrawing) return; _isDrawing = false; const rect = img.getBoundingClientRect(); const r = getRelativeRect(img, _drawStart.x, _drawStart.y, ev.clientX, ev.clientY); // remove temp element and open form
        if(_currentDrawEl && _currentDrawEl.parentElement) _currentDrawEl.parentElement.removeChild(_currentDrawEl);
        _currentDrawEl = null; _drawStart = null; showTagFormForRect(r, img, overlay); }

      function renderPhotoTags(photo){ try{
          const overlay = (document.querySelector('#modalImageArea .tag-overlay'));
          if(!overlay) return; overlay.innerHTML = '';
          const tags = (photo.tags || []);
          const img = document.getElementById('modalImage');
          tags.forEach(t=>{
            const el = document.createElement('div'); el.className = 'tag-rect';
            el.style.left = (t.bbox.x * 100) + '%'; el.style.top = (t.bbox.y * 100) + '%'; el.style.width = (t.bbox.w * 100) + '%'; el.style.height = (t.bbox.h * 100) + '%';
            el.title = t.personName || t.name || 'Identificado';
            el.addEventListener('click', function(ev){ ev.stopPropagation(); openEditTagForm(t, img, overlay); });
            const label = document.createElement('div'); label.className='tag-label'; label.textContent = t.personName || t.name || 'Pessoa'; el.appendChild(label);
            overlay.appendChild(el);
          });
          // update tagged people list
          const peopleDiv = document.getElementById('photoTaggedPeople'); if(!peopleDiv) return; const unique = Array.from(new Map((tags||[]).map(t=>[t.personId||t.personName, t])).values()); if(unique.length===0){ peopleDiv.innerHTML = '<span style="color:#888">Nenhuma pessoa identificada.</span>'; } else { peopleDiv.innerHTML = '<strong>Pessoas identificadas:</strong> ' + unique.map(t=>escapeHtml(t.personName||t.name||'')).join(', '); }
      }catch(e){ console.error(e); } }

      function showTagFormForRect(bbox, img, overlay){ // bbox: {x,y,w,h} percentages
        const form = document.createElement('div'); form.className='tag-form';
        // position form near top-left of bbox in overlay coords
        const left = (bbox.x * 100); const top = (bbox.y * 100);
        form.style.left = left + '%'; form.style.top = top + '%';
        form.innerHTML = `<div style="font-weight:600;margin-bottom:6px;">Identificar pessoa</div>`;

        const people = loadPeople();
        const input = document.createElement('input'); input.placeholder = 'Pesquisar pessoa (nome)'; input.style.width = '220px';
        const suggestions = document.createElement('div'); suggestions.style.position='absolute'; suggestions.style.left='8px'; suggestions.style.top='38px'; suggestions.style.background='var(--bg-card)'; suggestions.style.border='1px solid rgba(0,0,0,0.06)'; suggestions.style.maxHeight='160px'; suggestions.style.overflow='auto'; suggestions.style.width='220px'; suggestions.style.zIndex='230'; suggestions.style.display='none';
        const saveBtn = document.createElement('button'); saveBtn.textContent='Salvar'; saveBtn.className='btn';
        const cancelBtn = document.createElement('button'); cancelBtn.textContent='Cancelar'; cancelBtn.className='btn';
        form.appendChild(input); form.appendChild(suggestions); const br = document.createElement('div'); br.style.marginTop='6px'; form.appendChild(br); form.appendChild(saveBtn); form.appendChild(cancelBtn);

        // prevent overlay from receiving pointer events when interacting with form
        form.addEventListener('pointerdown', function(ev){ ev.stopPropagation(); });

        let selectedPersonId = null;
        function renderSuggestions(filter){ const q = (filter||'').toLowerCase().trim(); const list = people.filter(p=>{ const full = ((p.firstName||'') + ' ' + (p.lastName||'')).toLowerCase(); return full.includes(q); }).slice(0,30); suggestions.innerHTML = ''; if(list.length===0){ suggestions.style.display='none'; return; } list.forEach(p=>{ const row = document.createElement('div'); row.style.padding='6px'; row.style.cursor='pointer'; row.style.borderBottom='1px solid rgba(255,255,255,0.03)'; row.textContent = p.firstName + ' ' + p.lastName; row.addEventListener('click', function(){ input.value = row.textContent; selectedPersonId = p.id; suggestions.style.display='none'; input.focus(); }); suggestions.appendChild(row); }); suggestions.style.display='block'; }
        input.addEventListener('input', function(){ selectedPersonId = null; renderSuggestions(this.value); });
        input.addEventListener('keydown', function(ev){ if(ev.key==='Enter'){ ev.preventDefault(); saveBtn.click(); } });
        cancelBtn.addEventListener('click', function(){ if(form && form.parentElement) form.parentElement.removeChild(form); });
        saveBtn.addEventListener('click', function(){ const name = input.value.trim(); const pid = selectedPersonId || null; if(!name) return alert('Insira um nome ou selecione uma pessoa.'); saveTagForCurrentPhoto({ personId: pid, personName: name, bbox }); if(form && form.parentElement) form.parentElement.removeChild(form); });
        // auto-focus input
        setTimeout(()=>{ try{ input.focus(); }catch(e){} },50);
        overlay.appendChild(form);

        select.addEventListener('change', function(){ const v=this.value; if(v){ const p = people.find(x=>x.id===v); if(p) input.value = p.firstName+' '+p.lastName; } });
        cancelBtn.addEventListener('click', function(){ if(form && form.parentElement) form.parentElement.removeChild(form); });
        saveBtn.addEventListener('click', function(){ const name = input.value.trim(); const pid = select.value || null; if(!name) return alert('Insira um nome ou selecione uma pessoa.'); saveTagForCurrentPhoto({ personId: pid, personName: name, bbox }); if(form && form.parentElement) form.parentElement.removeChild(form); });
      }

      function openEditTagForm(tag, img, overlay){ // allow delete or change name
        const form = document.createElement('div'); form.className='tag-form'; form.style.left = (tag.bbox.x*100)+'%'; form.style.top = (tag.bbox.y*100)+'%';
        form.innerHTML = `<div style="font-weight:600;margin-bottom:6px;">Editar identificação</div>`;
        const people = loadPeople();
        const input = document.createElement('input'); input.value = tag.personName || tag.name || ''; input.style.width='220px';
        const suggestions = document.createElement('div'); suggestions.style.position='absolute'; suggestions.style.left='8px'; suggestions.style.top='38px'; suggestions.style.background='var(--bg-card)'; suggestions.style.border='1px solid rgba(0,0,0,0.06)'; suggestions.style.maxHeight='160px'; suggestions.style.overflow='auto'; suggestions.style.width='220px'; suggestions.style.zIndex='230'; suggestions.style.display='none';
        const saveBtn = document.createElement('button'); saveBtn.textContent='Salvar'; saveBtn.className='btn';
        const deleteBtn = document.createElement('button'); deleteBtn.textContent='Remover'; deleteBtn.className='btn';
        const cancelBtn = document.createElement('button'); cancelBtn.textContent='Cancelar'; cancelBtn.className='btn';
        form.appendChild(input); form.appendChild(suggestions); const br=document.createElement('div'); br.style.marginTop='6px'; form.appendChild(br); form.appendChild(saveBtn); form.appendChild(deleteBtn); form.appendChild(cancelBtn);
        overlay.appendChild(form);

        form.addEventListener('pointerdown', function(ev){ ev.stopPropagation(); });
        let selectedPersonId = tag.personId || null;
        function renderSuggestions(filter){ const q = (filter||'').toLowerCase().trim(); const list = people.filter(p=>{ const full = ((p.firstName||'') + ' ' + (p.lastName||'')).toLowerCase(); return full.includes(q); }).slice(0,30); suggestions.innerHTML = ''; if(list.length===0){ suggestions.style.display='none'; return; } list.forEach(p=>{ const row = document.createElement('div'); row.style.padding='6px'; row.style.cursor='pointer'; row.style.borderBottom='1px solid rgba(255,255,255,0.03)'; row.textContent = p.firstName + ' ' + p.lastName; row.addEventListener('click', function(){ input.value = row.textContent; selectedPersonId = p.id; suggestions.style.display='none'; input.focus(); }); suggestions.appendChild(row); }); suggestions.style.display='block'; }
        input.addEventListener('input', function(){ selectedPersonId = null; renderSuggestions(this.value); });
        input.addEventListener('keydown', function(ev){ if(ev.key==='Enter'){ ev.preventDefault(); saveBtn.click(); } });
        saveBtn.addEventListener('click', function(){ const name = input.value.trim(); const pid = selectedPersonId || tag.personId || null; if(!name) return alert('Nome obrigatório'); const photos = getPhotos(); const idx = photos.findIndex(p=>p.id===_currentModalPhotoId); if(idx<0) return; const tIdx = (photos[idx].tags||[]).findIndex(x=>x.id===tag.id); if(tIdx<0) return; photos[idx].tags[tIdx].personName = name; photos[idx].tags[tIdx].personId = pid; photos[idx].tags[tIdx].updatedAt = nowISO(); savePhotos(photos); // ensure relation
          if(pid){ const rels = getPhotoRelations(); rels[pid] = rels[pid] || []; if(!rels[pid].includes(_currentModalPhotoId)) rels[pid].push(_currentModalPhotoId); savePhotoRelations(rels); }
          renderPhotoTags(photos[idx]); if(form && form.parentElement) form.parentElement.removeChild(form); renderPhotos(document.getElementById('id').value);
        });
        deleteBtn.addEventListener('click', function(){ if(!confirm('Remover esta identificação?')) return; const photos = getPhotos(); const idx = photos.findIndex(p=>p.id===_currentModalPhotoId); if(idx<0) return; photos[idx].tags = (photos[idx].tags||[]).filter(x=>x.id!==tag.id); savePhotos(photos); renderPhotoTags(photos[idx]); if(form && form.parentElement) form.parentElement.removeChild(form); renderPhotos(document.getElementById('id').value); });
        cancelBtn.addEventListener('click', function(){ if(form && form.parentElement) form.parentElement.removeChild(form); });
        setTimeout(()=>{ try{ input.focus(); }catch(e){} },50);
      }

      function saveTagForCurrentPhoto({ personId, personName, bbox }){
        try{
          const photos = getPhotos(); const idx = photos.findIndex(p=>p.id===_currentModalPhotoId); if(idx<0) return; const tag = { id: generateUUID(), personId: personId || null, personName: personName || '', bbox: bbox, createdAt: nowISO() };
          photos[idx].tags = photos[idx].tags || []; photos[idx].tags.push(tag); photos[idx].updatedAt = nowISO(); savePhotos(photos);
          // ensure association: if personId provided, add relation
          if(personId){ const rels = getPhotoRelations(); rels[personId] = rels[personId] || []; if(!rels[personId].includes(photos[idx].id)) rels[personId].push(photos[idx].id); savePhotoRelations(rels); }
          renderPhotoTags(photos[idx]); renderPhotos(document.getElementById('id').value);
        }catch(e){ console.error(e); }
      }

      function fillRelationPersonSelect(currentId){ const people = loadPeople(); const select = document.getElementById('relationPerson'); select.innerHTML = '<option value="">-- selecione --</option>'; people.forEach(p=>{ if(p.id !== currentId && !p.deletedAt) select.innerHTML += `<option value="${p.id}">${escapeHtml(p.firstName)} ${escapeHtml(p.lastName)}</option>`; }); }

      function loadPageForPerson(id){ window.location.href = 'pessoa-detalhe.html?id=' + encodeURIComponent(id); }

      function showPersonDetail(id){ const people = loadPeople(); const p = people.find(x=>x.id===id); if(!p) { alert('Registro não encontrado'); window.location.href='app.html'; return; } document.getElementById('id').value = p.id; document.getElementById('firstName').value = p.firstName || ''; document.getElementById('lastName').value = p.lastName || ''; document.getElementById('gender').value = p.gender || ''; document.getElementById('notes').value = p.notes || ''; if(document.getElementById('createdAt')) document.getElementById('createdAt').value = p.createdAt || ''; if(document.getElementById('updatedAt')) document.getElementById('updatedAt').value = p.updatedAt || ''; if(document.getElementById('deletedAt')) document.getElementById('deletedAt').value = p.deletedAt || ''; showDatesInfo(p); try{ const evs = getEvents(); const birth = evs.find(e=>e.personId===p.id && e.type==='BIRTH' && !e.deletedAt); const death = evs.find(e=>e.personId===p.id && e.type==='DEATH' && !e.deletedAt); const ageEl = document.getElementById('ageInfo'); if(birth && birth.date){ const ref = death && death.date ? death.date : new Date().toISOString(); const age = computeAge(birth.date, ref); ageEl.textContent = age == null ? '' : (death ? 'Idade ao falecer: ' + age + ' anos' : 'Idade: ' + age + ' anos'); } else if(ageEl) ageEl.textContent = ''; }catch(e){}
      openAccordion('contentDados'); openAccordion('contentEventos'); openAccordion('contentRelacoes'); fillRelationPersonSelect(id); renderRelationsList(id); renderEventsList(id); renderPhotos(id); }

      (function(){ // Small form toggles and wiring
        function showEventForm(show){ const w=document.getElementById('eventFormWrapper'); const list=document.getElementById('eventsList'); if(!w||!list) return; w.style.display = show ? 'block' : 'none'; list.style.display = show ? 'none' : 'block'; }
        function showRelationForm(show){ const w=document.getElementById('relationFormWrapper'); const list=document.getElementById('relationsList'); if(!w||!list) return; w.style.display = show ? 'block' : 'none'; list.style.display = show ? 'none' : 'block'; }
        const openEventBtn = document.getElementById('openEventFormBtn'); if(openEventBtn) openEventBtn.addEventListener('click', function(){ showEventForm(true); openAccordion('contentEventos'); });
        const cancelEventBtn = document.getElementById('cancelEventBtn'); if(cancelEventBtn) cancelEventBtn.addEventListener('click', function(){ const f=document.getElementById('eventForm'); if(f) f.reset(); showEventForm(false); });
        const openRelationBtn = document.getElementById('openRelationFormBtn'); if(openRelationBtn) openRelationBtn.addEventListener('click', function(){ showRelationForm(true); openAccordion('contentRelacoes'); });
        const cancelRelationBtn = document.getElementById('cancelRelationBtn'); if(cancelRelationBtn) cancelRelationBtn.addEventListener('click', function(){ const f=document.getElementById('relationForm'); if(f) f.reset(); showRelationForm(false); });
      })();

      document.getElementById('addEventBtn').addEventListener('click', function(){ const personId = document.getElementById('id').value; if(!personId) return alert('Pessoa não selecionada'); const type = document.getElementById('eventType').value; const date = document.getElementById('eventDate').value || null; const location = document.getElementById('eventLocation').value || null; const notes = document.getElementById('eventNotes').value || ''; if(!type) return alert('Tipo de evento obrigatório'); const events = getEvents(); const now = nowISO(); events.push({ id: generateUUID(), personId, type, date, location, notes, createdAt: now, updatedAt: now, deletedAt: null }); saveEvents(events); renderEventsList(personId); document.getElementById('eventForm').reset(); showEventForm(false); });

      document.getElementById('addRelationBtn').addEventListener('click', function(){ const type = document.getElementById('relationType').value; const to = document.getElementById('relationPerson').value; const from = document.getElementById('id').value; if(!type||!to||!from) return alert('Selecione tipo e pessoa relacionada.'); const relations = getRelations(); relations.push({ from,to,type }); saveRelations(relations); renderRelationsList(from); document.getElementById('relationType').value=''; document.getElementById('relationPerson').value=''; showRelationForm(false); });

      document.getElementById('personForm').addEventListener('submit', function(e){ e.preventDefault(); const id = document.getElementById('id').value || generateUUID(); const firstName = document.getElementById('firstName').value.trim(); const lastName = document.getElementById('lastName').value.trim(); const gender = document.getElementById('gender').value; const notes = document.getElementById('notes').value; const createdAtField = document.getElementById('createdAt').value; const deletedAtField = document.getElementById('deletedAt').value || null; const people = loadPeople(); const existingIndex = people.findIndex(x=>x.id===id); const now = nowISO(); if(existingIndex>=0){ people[existingIndex] = { ...people[existingIndex], firstName, lastName, gender, notes, updatedAt: now, deletedAt: deletedAtField || null }; } else { people.push({ id, firstName, lastName, gender, notes, createdAt: createdAtField || now, updatedAt: now, deletedAt: deletedAtField || null }); } savePeople(people); showDatesInfo(people.find(x=>x.id===id)); alert('Dados salvos'); });

      document.getElementById('resetBtn').addEventListener('click', function(){ document.getElementById('personForm').reset(); });

      // Technical info modal: show raw JSON as stored
      function openTechInfoModal(){
        try{
          const id = document.getElementById('id').value;
          const rawPeople = localStorage.getItem(STORAGE_KEY);
          let personOut = '';
          if(rawPeople){
            try{ const arr = JSON.parse(rawPeople); const p = (arr||[]).find(x=>x.id===id); if(p) personOut = JSON.stringify(p); else personOut = ''; }catch(e){ personOut = rawPeople || ''; }
          }

          // load relations and group into outgoing (from this person) and incoming (to this person)
          let outgoing = [];
          let incoming = [];
          let relRaw = null;
          try{
            relRaw = localStorage.getItem('relations:myLineage');
            if(relRaw){
              try{
                const relArr = JSON.parse(relRaw) || [];
                outgoing = relArr.filter(r => r && r.from === id);
                incoming = relArr.filter(r => r && r.to === id);
              }catch(e){ /* ignore parse error */ }
            }
          }catch(e){}

          let combined = '';
          combined += "Fonte: localStorage key '" + STORAGE_KEY + "'\n";
          combined += 'Pessoa:\n' + (personOut || '') + '\n\n';
          combined += "Fonte: localStorage key 'relations:myLineage'\n";
          combined += 'Relações (da pessoa -> outros):\n' + JSON.stringify(outgoing) + '\n\n';
          combined += 'Relações (outros -> pessoa):\n' + JSON.stringify(incoming) + '\n';
          document.getElementById('techInfoContent').textContent = combined || '';
          document.getElementById('techInfoModal').style.display = 'flex';
        }catch(e){ console.error(e); }
      }
      function closeTechInfoModal(){ document.getElementById('techInfoModal').style.display = 'none'; }
      const techLabel = document.getElementById('techInfoLabel'); if(techLabel) techLabel.addEventListener('click', function(e){ e.preventDefault(); openTechInfoModal(); });
      const closeTechBtn = document.getElementById('closeTechInfoBtn'); if(closeTechBtn) closeTechBtn.addEventListener('click', function(){ closeTechInfoModal(); });
      const techModalEl = document.getElementById('techInfoModal'); if(techModalEl) techModalEl.addEventListener('click', function(ev){ if(ev.target === techModalEl) closeTechInfoModal(); });

      // Init: read id from query and render
      (function(){ const params = new URLSearchParams(window.location.search); const id = params.get('id'); if(!id){ alert('Nenhuma pessoa selecionada'); window.location.href='app.html'; return; } showPersonDetail(id); })();
    </script>
  </body>
</html>
