<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Configuração</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div class="app-shell">
      <aside class="sidebar">
        <div class="logo">XPTO</div>
        <nav>
          <a href="index.html">Cadastro</a>
          <a href="indicadores.html">Indicadores</a>
          <a href="pessoas.html">Pessoas</a>
          <a href="import.html">Importar</a>
          <a href="export.html">Exportar</a>
        </nav>
        <div class="sidebar-footer">
          <a href="configuracao.html" class="active">Configuração</a>
        </div>
      </aside>
      <main class="content">
        <div class="topbar">
          <div><h1 style="margin:0;font-size:1.25rem;">Configuração</h1></div>
          <div></div>
        </div>

        <div class="card" style="max-width:760px;">
          <p style="color:var(--text-secondary);margin-top:6px;">Defina a pasta base que contém o repositório de fotografias. Selecione a pasta (diretório) no seu sistema usando o seletor abaixo. Nota: a seleção de pastas usa o atributo <em>webkitdirectory</em> — disponível na maioria dos navegadores Chromium.</p>

          <div style="display:flex;gap:12px;align-items:center;margin-top:12px;flex-direction:column;align-items:flex-start;">
            <label style="font-weight:600;color:var(--text-secondary);">Selecionar pasta de fotografias</label>
            <input type="file" id="dirPicker" webkitdirectory directory multiple accept="image/*" />
            <div id="selectionInfo" style="color:var(--text-secondary);font-size:0.95rem;min-height:36px;"></div>
            <div style="display:flex;gap:8px;margin-top:6px;">
              <button class="btn" id="saveBaseBtn" disabled>Salvar como base</button>
              <button class="btn" id="clearBaseBtn">Remover configuração</button>
            </div>
            <div id="currentBase" style="margin-top:10px;color:var(--text-secondary);font-size:0.95rem;"></div>
          </div>
        </div>

      </main>
    </div>

    <script>
      function nowISO(){ return new Date().toISOString(); }
      const KEY = 'photoBase:xpto';

      function readSaved(){ try{ return JSON.parse(localStorage.getItem(KEY)||'null'); }catch(e){ return null; } }
      function saveBase(obj){ localStorage.setItem(KEY, JSON.stringify(obj)); }
      function clearBase(){ localStorage.removeItem(KEY); }

      function showCurrent(){ const cur = readSaved(); const el = document.getElementById('currentBase'); if(!cur){ el.innerHTML = '<div style="font-style:italic;color:var(--text-secondary);">Nenhuma pasta base configurada.</div>'; return; } el.innerHTML = `<div>Base configurada: <b>${escapeHtml(cur.folder)}</b> — ${cur.files || 0} ficheiros<br><small style="color:var(--text-secondary);">Salvo em: ${cur.when || ''}</small></div>`; }

      function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

      function commonPrefix(paths){ if(!paths || paths.length===0) return ''; const split = paths.map(p => (p || '').split('/')); const first = split[0] || []; let prefix = []; for(let i=0;i<first.length;i++){ const seg = first[i]; if(split.every(s => s[i] === seg)) prefix.push(seg); else break; } return prefix.join('/'); }

      document.addEventListener('DOMContentLoaded', function(){
        const picker = document.getElementById('dirPicker');
        const info = document.getElementById('selectionInfo');
        const saveBtn = document.getElementById('saveBaseBtn');
        const clearBtn = document.getElementById('clearBaseBtn');
        let lastFolder = null; let lastCount = 0;

        showCurrent();

        picker.addEventListener('change', function(e){
          const files = Array.from(this.files || []);
          if(!files.length){ info.textContent = 'Nenhum ficheiro selecionado.'; saveBtn.disabled = true; return; }
          const paths = files.map(f => f.webkitRelativePath || f.name);
          const root = commonPrefix(paths) || paths[0].split('/')[0] || '';
          lastFolder = root;
          lastCount = files.length;
          info.innerHTML = `<div>Detectado: <b>${escapeHtml(root)}</b> — ${files.length} ficheiros</div>`;
          saveBtn.disabled = false;
        });

        saveBtn.addEventListener('click', function(){ if(!lastFolder) return alert('Nenhuma pasta detectada.'); saveBase({ folder: lastFolder, files: lastCount, when: nowISO() }); showCurrent(); alert('Pasta base salva.'); });
        clearBtn.addEventListener('click', function(){ if(!confirm('Remover a configuração da pasta base?')) return; clearBase(); showCurrent(); alert('Configuração removida.'); });
      });
    </script>
  </body>
</html>
