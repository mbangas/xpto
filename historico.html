<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>myLineage — Histórico</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css" />
    <style>
      /* ── Page layout ──────────────────────────────────────────────────── */
      .hist-wrap {
        margin-top: 24px;
        padding: 0 32px 56px !important;
        display: flex;
        flex-direction: column;
        gap: 18px;
        width: 100%;
        box-sizing: border-box;
        min-height: 100%;
      }

      /* ── Toolbar ────────────────────────────────────────────────────── */
      .hist-toolbar {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }
      .hist-search {
        flex: 1;
        min-width: 160px;
        max-width: 320px;
        background: var(--bg-surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        color: var(--text-main);
        font-size: 0.85rem;
        padding: 7px 12px 7px 34px;
        outline: none;
        transition: border-color var(--transition);
        font-family: var(--font-main);
      }
      .hist-search:focus { border-color: var(--border-accent); }
      .hist-search::placeholder { color: var(--text-disabled); }
      .hist-search-wrap {
        position: relative;
        flex: 1;
        min-width: 160px;
        max-width: 320px;
      }
      .hist-search-wrap .mdi {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-disabled);
        font-size: 1rem;
        pointer-events: none;
      }

      /* ── Category chips ───────────────────────────────────────────────── */
      .hist-chips {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        align-items: center;
      }
      .hist-chip {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        font-size: 0.72rem;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 20px;
        border: 1px solid var(--border);
        background: var(--bg-surface);
        color: var(--text-secondary);
        cursor: pointer;
        transition: background var(--transition), border-color var(--transition), color var(--transition);
        user-select: none;
        white-space: nowrap;
      }
      .hist-chip:hover { background: var(--bg-surface-2); color: var(--text-main); }
      .hist-chip.active { background: var(--accent-soft); border-color: var(--border-accent); color: var(--accent); }
      .hist-chip.active.cat-pessoas   { background: var(--accent-soft);  border-color: rgba(68,147,248,.35); color: var(--accent); }
      .hist-chip.active.cat-eventos   { background: var(--amber-soft);   border-color: rgba(210,153,34,.35); color: var(--amber); }
      .hist-chip.active.cat-relacoes  { background: var(--purple-soft);  border-color: rgba(188,140,255,.35); color: var(--purple); }
      .hist-chip.active.cat-gedcom    { background: var(--green-soft);   border-color: rgba(63,185,80,.35);  color: var(--green); }
      .hist-chip.active.cat-album     { background: var(--red-soft);     border-color: rgba(248,81,73,.35);  color: var(--red); }
      .hist-chip.active.cat-documentos{ background: rgba(255,170,0,.12); border-color: rgba(255,170,0,.35);  color: #ffaa00; }
      .hist-chip.active.cat-geral     { background: var(--bg-surface-2); border-color: var(--border);        color: var(--text-secondary); }

      /* ── Summary bar ──────────────────────────────────────────────────── */
      .hist-summary {
        font-size: 0.78rem;
        color: var(--text-disabled);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }
      .hist-summary-count { font-weight: 600; color: var(--text-secondary); }

      /* ── Day group ────────────────────────────────────────────────────── */
      .hist-day-label {
        font-size: 0.7rem;
        font-weight: 700;
        color: var(--text-disabled);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        padding: 0 0 6px;
        margin-top: 6px;
        border-bottom: 1px solid var(--border-subtle);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* ── Timeline list ────────────────────────────────────────────────── */
      .hist-list {
        display: flex;
        flex-direction: column;
        gap: 0;
      }
      .hist-entry {
        display: flex;
        align-items: flex-start;
        gap: 14px;
        padding: 11px 0;
        border-bottom: 1px solid var(--border-subtle);
        transition: background var(--transition);
      }
      .hist-entry:last-child { border-bottom: none; }

      /* icon pill */
      .hist-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.95rem;
        flex-shrink: 0;
        margin-top: 1px;
      }
      .hist-icon.cat-pessoas    { background: var(--accent-soft);  color: var(--accent); }
      .hist-icon.cat-eventos    { background: var(--amber-soft);   color: var(--amber); }
      .hist-icon.cat-relacoes   { background: var(--purple-soft);  color: var(--purple); }
      .hist-icon.cat-gedcom     { background: var(--green-soft);   color: var(--green); }
      .hist-icon.cat-album      { background: var(--red-soft);     color: var(--red); }
      .hist-icon.cat-documentos { background: rgba(255,170,0,.12); color: #ffaa00; }
      .hist-icon.cat-geral      { background: var(--bg-surface-2); color: var(--text-secondary); }
      .hist-icon.cat-validacao  { background: var(--green-soft);   color: var(--green); }

      /* text */
      .hist-body { flex: 1; min-width: 0; }
      .hist-action {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-main);
        line-height: 1.3;
      }
      .hist-detail {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-top: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* time */
      .hist-time {
        font-size: 0.73rem;
        color: var(--text-disabled);
        white-space: nowrap;
        flex-shrink: 0;
        margin-top: 4px;
        font-variant-numeric: tabular-nums;
      }

      /* ── Empty state ──────────────────────────────────────────────────── */
      .hist-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 14px;
        padding: 64px 24px;
        text-align: center;
        color: var(--text-disabled);
      }
      .hist-empty .mdi { font-size: 3rem; opacity: 0.4; }
      .hist-empty-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-secondary);
        margin: 0;
      }
      .hist-empty-sub {
        font-size: 0.8rem;
        color: var(--text-disabled);
        margin: 0;
        max-width: 280px;
        line-height: 1.5;
      }

      @media (max-width: 700px) {
        .hist-wrap { padding: 0 16px 40px !important; margin-top: 16px; }
        .hist-search-wrap { max-width: 100%; }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <aside class="sidebar">
        <a href="index.html" class="logo"><i class="mdi mdi-tree" aria-hidden="true"></i><span>myLineage</span></a>
        <nav>
          <a href="app.html"><i class="mdi mdi-account-multiple" aria-hidden="true"></i>Cadastro</a>
          <a href="indicadores.html"><i class="mdi mdi-chart-bar" aria-hidden="true"></i>Indicadores</a>
          <a href="arvore.html"><i class="mdi mdi-sitemap" aria-hidden="true"></i>Árvore</a>
          <a href="gedcom.html"><i class="mdi mdi-dna" aria-hidden="true"></i>GEDCOM</a>
          <a href="album.html"><i class="mdi mdi-image-multiple" aria-hidden="true"></i>Álbum</a>
          <a href="documentos.html"><i class="mdi mdi-folder-open" aria-hidden="true"></i>Documentos</a>
          <a href="validacao.html"><i class="mdi mdi-shield-check" aria-hidden="true"></i>Validação</a>
          <a href="historico.html" class="active"><i class="mdi mdi-history" aria-hidden="true"></i>Histórico</a>
        </nav>
        <div class="sidebar-footer">
          <a href="apis.html"><i class="mdi mdi-api" aria-hidden="true"></i>APIs</a>
          <a href="configuracao.html"><i class="mdi mdi-cog" aria-hidden="true"></i>Definições</a>
        </div>
      </aside>

      <main class="content">
        <div class="topbar">
          <div style="display:flex;align-items:center;gap:10px">
            <h1 style="margin:0">Histórico</h1>
          </div>
          <button class="btn btn-ghost" id="clearBtn" style="font-size:0.8rem;padding:6px 14px;color:var(--red);border-color:rgba(248,81,73,.25);">
            <i class="mdi mdi-delete-sweep-outline" aria-hidden="true"></i> Limpar tudo
          </button>
        </div>

        <div class="hist-wrap">

          <!-- Toolbar -->
          <div class="hist-toolbar">
            <div class="hist-search-wrap">
              <i class="mdi mdi-magnify"></i>
              <input id="searchInput" class="hist-search" type="search" placeholder="Pesquisar acções…" autocomplete="off" />
            </div>
            <div class="hist-chips" id="chips">
              <span class="hist-chip active" data-cat="all"><i class="mdi mdi-all-inclusive"></i> Tudo</span>
              <span class="hist-chip cat-pessoas"    data-cat="pessoas">   <i class="mdi mdi-account-multiple"></i> Pessoas</span>
              <span class="hist-chip cat-eventos"    data-cat="eventos">   <i class="mdi mdi-calendar"></i> Eventos</span>
              <span class="hist-chip cat-relacoes"   data-cat="relacoes">  <i class="mdi mdi-graph"></i> Relações</span>
              <span class="hist-chip cat-gedcom"     data-cat="gedcom">    <i class="mdi mdi-dna"></i> GEDCOM</span>
              <span class="hist-chip cat-album"      data-cat="album">     <i class="mdi mdi-image-multiple"></i> Álbum</span>
              <span class="hist-chip cat-documentos" data-cat="documentos"><i class="mdi mdi-folder-open"></i> Documentos</span>
              <span class="hist-chip cat-geral"      data-cat="geral">     <i class="mdi mdi-information-outline"></i> Geral</span>
            </div>
          </div>

          <!-- Summary -->
          <div class="hist-summary">
            <span id="summaryText" class="hist-summary-count"></span>
          </div>

          <!-- List -->
          <div class="hist-list" id="histList"></div>

        </div>
      </main>
    </div>

    <script src="remote-storage.js"></script>
    <script>
      /* ── config ──────────────────────────────────────────────────────── */
      const DB = window.GedcomDB;

      const CAT_META = {
        pessoas:    { icon: 'mdi-account-multiple',    label: 'Pessoas' },
        eventos:    { icon: 'mdi-calendar-check',      label: 'Eventos' },
        relacoes:   { icon: 'mdi-graph',               label: 'Relações' },
        gedcom:     { icon: 'mdi-dna',                 label: 'GEDCOM' },
        album:      { icon: 'mdi-image-multiple',      label: 'Álbum' },
        documentos: { icon: 'mdi-folder-open',         label: 'Documentos' },
        validacao:  { icon: 'mdi-shield-check',        label: 'Validação' },
        geral:      { icon: 'mdi-information-outline', label: 'Geral' },
      };

      /* ── state ───────────────────────────────────────────────────────── */
      let activeCategory = 'all';
      let searchQuery    = '';

      /* ── date helpers ────────────────────────────────────────────────── */
      const MONTHS = ['jan','fev','mar','abr','mai','jun','jul','ago','set','out','nov','dez'];

      function dayKey(ts) {
        const d = new Date(ts);
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      }

      function dayLabel(key) {
        const today     = dayKey(new Date().toISOString());
        const yesterday = dayKey(new Date(Date.now() - 86400000).toISOString());
        if (key === today)     return 'Hoje';
        if (key === yesterday) return 'Ontem';
        const d = new Date(key + 'T00:00:00');
        return `${d.getDate()} ${MONTHS[d.getMonth()]} ${d.getFullYear()}`;
      }

      function timeStr(ts) {
        const d = new Date(ts);
        return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
      }

      /* ── render ──────────────────────────────────────────────────────── */
      function render() {
        const all      = DB.getHistory();
        const q        = searchQuery.trim().toLowerCase();
        const filtered = all.filter(e => {
          if (activeCategory !== 'all' && e.category !== activeCategory) return false;
          if (q && !e.action.toLowerCase().includes(q) && !(e.detail||'').toLowerCase().includes(q)) return false;
          return true;
        });

        const listEl = document.getElementById('histList');
        const sumEl  = document.getElementById('summaryText');

        sumEl.textContent = filtered.length === 0
          ? 'Sem acções registadas'
          : `${filtered.length} ${filtered.length === 1 ? 'acção' : 'acções'}${all.length !== filtered.length ? ' (de ' + all.length + ' no total)' : ''}`;

        if (filtered.length === 0) {
          listEl.innerHTML = `
            <div class="hist-empty">
              <i class="mdi mdi-history" aria-hidden="true"></i>
              <p class="hist-empty-title">${q || activeCategory !== 'all' ? 'Nenhum resultado' : 'Ainda sem histórico'}</p>
              <p class="hist-empty-sub">${q || activeCategory !== 'all'
                ? 'Tente alterar o filtro ou a pesquisa.'
                : 'As acções realizadas na aplicação (criar, editar, importar, exportar…) aparecerão aqui automaticamente.'}</p>
            </div>`;
          return;
        }

        // group by day
        const groups = new Map();
        for (const e of filtered) {
          const k = dayKey(e.ts);
          if (!groups.has(k)) groups.set(k, []);
          groups.get(k).push(e);
        }

        let html = '';
        for (const [key, entries] of groups) {
          html += `<div class="hist-day-label">${escHtml(dayLabel(key))}</div>`;
          for (const e of entries) {
            const cat  = e.category || 'geral';
            const meta = CAT_META[cat] || CAT_META['geral'];
            html += `
              <div class="hist-entry">
                <div class="hist-icon cat-${escHtml(cat)}"><i class="mdi ${escHtml(meta.icon)}" aria-hidden="true"></i></div>
                <div class="hist-body">
                  <div class="hist-action">${escHtml(e.action)}</div>
                  ${e.detail ? `<div class="hist-detail" title="${escHtml(e.detail)}">${escHtml(e.detail)}</div>` : ''}
                </div>
                <div class="hist-time">${timeStr(e.ts)}</div>
              </div>`;
          }
        }

        listEl.innerHTML = html;
      }

      function escHtml(s) {
        return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
      }

      /* ── category chips ──────────────────────────────────────────────── */
      document.getElementById('chips').addEventListener('click', function (e) {
        const chip = e.target.closest('[data-cat]');
        if (!chip) return;
        activeCategory = chip.dataset.cat;
        document.querySelectorAll('.hist-chip').forEach(c => {
          const match = c.dataset.cat === activeCategory;
          c.classList.toggle('active', match);
        });
        render();
      });

      /* ── search ──────────────────────────────────────────────────────── */
      document.getElementById('searchInput').addEventListener('input', function () {
        searchQuery = this.value;
        render();
      });

      /* ── clear ───────────────────────────────────────────────────────── */
      document.getElementById('clearBtn').addEventListener('click', function () {
        if (!confirm('Apagar todo o histórico de acções? Esta operação não pode ser desfeita.')) return;
        DB.clearHistory();
        render();
      });

      /* ── init ────────────────────────────────────────────────────────── */
      render();
    </script>
  </body>
</html>
