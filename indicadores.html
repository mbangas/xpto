    
<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Indicadores</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css">
  </head>
  <body>
    <div class="app-shell">
      <aside class="sidebar">
        <a href="index.html" class="logo"><i class="mdi mdi-tree" aria-hidden="true"></i><span>myLineage</span></a>
        <nav>
          <a href="app.html"><i class="mdi mdi-account-multiple" aria-hidden="true"></i>Cadastro</a>
          <a href="indicadores.html" class="active"><i class="mdi mdi-chart-bar" aria-hidden="true"></i>Indicadores</a>
          <a href="pessoas.html"><i class="mdi mdi-account" aria-hidden="true"></i>Pessoas</a>
          <a href="arvore.html"><i class="mdi mdi-sitemap" aria-hidden="true"></i>Árvore</a>
          <a href="import.html"><i class="mdi mdi-file-import" aria-hidden="true"></i>Importar</a>
          <a href="export.html"><i class="mdi mdi-file-export" aria-hidden="true"></i>Exportar</a>
        </nav>
        <div class="sidebar-footer">
          <a href="configuracao.html"><i class="mdi mdi-cog" aria-hidden="true"></i>Definições</a>
        </div>
      </aside>
      <main class="content">
        <div class="topbar">
          <div><h1 style="margin:0;font-size:1.25rem;">Indicadores Gerais</h1></div>
          <div></div>
        </div>
        <div class="indicadores-cards">
          <div class="indicador-group">
            <h2 class="indicador-group-title">Pessoas</h2>
            <div class="indicador-group-row">
              <div class="indicador-card card indicador-group-total">
                <div class="indicador-icon" title="Pessoas"><i class="mdi mdi-account" aria-hidden="true"></i></div>
                <div class="indicador-num" id="totalPessoas">0</div>
                <div class="indicador-label">Total Pessoas</div>
              </div>
              <div id="topNamesCard" class="indicador-card card" style="min-width:180px;">
                <!-- preenchido por JS: top 3 nomes próprios -->
              </div>
              <div id="genderCards" class="indicador-subcards" aria-live="polite"></div>
            </div>
          </div>

          <div class="indicador-group">
            <h2 class="indicador-group-title">Eventos</h2>
            <div class="indicador-group-row">
              <div class="indicador-card card indicador-group-total">
                <div class="indicador-icon" title="Eventos"><i class="mdi mdi-calendar" aria-hidden="true"></i></div>
                <div class="indicador-num" id="totalEventos">0</div>
                <div class="indicador-label">Total Eventos</div>
              </div>
              <div id="eventTypeCards" class="indicador-subcards" aria-live="polite"></div>
            </div>
          </div>

          <div class="indicador-group">
            <h2 class="indicador-group-title">Relações</h2>
            <div class="indicador-group-row">
              <div class="indicador-card card indicador-group-total">
                <div class="indicador-icon" title="Relações"><i class="mdi mdi-account-multiple" aria-hidden="true"></i></div>
                <div class="indicador-num" id="totalRelacoes">0</div>
                <div class="indicador-label">Total Relações</div>
              </div>
              <div id="relationTypeCards" class="indicador-subcards" aria-live="polite"></div>
            </div>
          </div>

          <div class="indicador-group">
            <h2 class="indicador-group-title">Nascimento por Década</h2>
            <div class="indicador-group-row">
              <div class="indicador-card card indicador-group-total">
                <div class="indicador-icon" title="Nascimentos"><i class="mdi mdi-chart-bar" aria-hidden="true"></i></div>
                <div class="indicador-num" id="totalBirths">0</div>
                <div class="indicador-label">Total Nascimentos</div>
              </div>
              <div id="birthDecadeChart" class="indicador-chart" aria-live="polite"></div>
            </div>
          </div>
        </div>
      </main>
    </div>
    <script>
      function getPeople() {
        try {
          const raw = localStorage.getItem('people:myLineage');
          return raw ? JSON.parse(raw) : [];
        } catch (e) { return []; }
      }
      function getEvents() {
        try {
          const raw = localStorage.getItem('events:myLineage');
          return raw ? JSON.parse(raw) : [];
        } catch (e) { return []; }
      }
      function getRelations() {
        try {
          const raw = localStorage.getItem('relations:myLineage');
          return raw ? JSON.parse(raw) : [];
        } catch (e) { return []; }
      }
      function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }
      function updateIndicadores() {
        const pessoas = getPeople().filter(p => !p.deletedAt);
        const eventos = getEvents().filter(ev => !ev.deletedAt);
        const relacoes = getRelations();
        document.getElementById('totalPessoas').textContent = pessoas.length;
        document.getElementById('totalEventos').textContent = eventos.length;
        document.getElementById('totalRelacoes').textContent = relacoes.length;
        // Contagem por tipo de relação e renderização de cards específicos
        const typeMap = {
          siblin: { label: 'Irmão / Irmã', icon: '<i class="mdi mdi-account-multiple" aria-hidden="true"></i>' },
          ancestor: { label: 'Pai / Mãe', icon: '<i class="mdi mdi-account" aria-hidden="true"></i>' },
          child: { label: 'Filho(a)', icon: '<i class="mdi mdi-baby" aria-hidden="true"></i>' },
          mate: { label: 'Companheiro(a)', icon: '<i class="mdi mdi-heart" aria-hidden="true"></i>' }
        };
        const counts = {};
        relacoes.forEach(r => { if (r && r.type) counts[r.type] = (counts[r.type] || 0) + 1; });
        const container = document.getElementById('relationTypeCards');
        if (container) {
          container.innerHTML = '';
          // Render known types in a stable order
          Object.keys(typeMap).forEach(t => {
            const n = counts[t] || 0;
            const card = document.createElement('div');
            card.className = 'indicador-card card';
            card.style.minWidth = '140px';
            card.innerHTML = `<div class="indicador-icon" title="${typeMap[t].label}">${typeMap[t].icon}</div><div class="indicador-num">${n}</div><div class="indicador-label">${typeMap[t].label}</div>`;
            container.appendChild(card);
            // remove from counts so remaining unknowns can be listed later
            delete counts[t];
          });
          // Render any unknown types that exist in data
          Object.keys(counts).forEach(t => {
            const n = counts[t] || 0;
            const card = document.createElement('div');
            card.className = 'indicador-card card';
            card.style.minWidth = '140px';
            card.innerHTML = `<div class="indicador-icon" title="${t}"><i class="mdi mdi-diamond-stone" aria-hidden="true"></i></div><div class="indicador-num">${n}</div><div class="indicador-label">${t}</div>`;
            container.appendChild(card);
          });
        }
        // Eventos: contar por tipo e renderizar cards
        const eventMap = {
          BIRTH: { label: 'Nascimento', icon: '<i class="mdi mdi-baby" aria-hidden="true"></i>' },
          BAPTISM: { label: 'Batismo', icon: '<i class="mdi mdi-cross" aria-hidden="true"></i>' },
          DEATH: { label: 'Óbito', icon: '<i class="mdi mdi-skull" aria-hidden="true"></i>' },
          MARRIAGE: { label: 'Casamento', icon: '<i class="mdi mdi-ring" aria-hidden="true"></i>' },
          DIVORCE: { label: 'Divórcio', icon: '<i class="mdi mdi-scale" aria-hidden="true"></i>' },
          ADOPTION: { label: 'Adoção', icon: '<i class="mdi mdi-handshake" aria-hidden="true"></i>' },
          CUSTOM: { label: 'Outro', icon: '<i class="mdi mdi-diamond-stone" aria-hidden="true"></i>' }
        };
        const evCounts = {};
        eventos.forEach(ev => { if (ev && ev.type) evCounts[ev.type] = (evCounts[ev.type] || 0) + 1; });
        const evContainer = document.getElementById('eventTypeCards');
        if (evContainer) {
          evContainer.innerHTML = '';
          Object.keys(eventMap).forEach(t => {
            const n = evCounts[t] || 0;
            const card = document.createElement('div');
            card.className = 'indicador-card card';
            card.style.minWidth = '140px';
            card.innerHTML = `<div class="indicador-icon" title="${eventMap[t].label}">${eventMap[t].icon}</div><div class="indicador-num">${n}</div><div class="indicador-label">${eventMap[t].label}</div>`;
            evContainer.appendChild(card);
            delete evCounts[t];
          });
          // Render any unknown event types
          Object.keys(evCounts).forEach(t => {
            const n = evCounts[t] || 0;
            const card = document.createElement('div');
            card.className = 'indicador-card card';
            card.style.minWidth = '140px';
            card.innerHTML = `<div class="indicador-icon" title="${t}"><i class="mdi mdi-rhombus" aria-hidden="true"></i></div><div class="indicador-num">${n}</div><div class="indicador-label">${t}</div>`;
            evContainer.appendChild(card);
          });
        }
        // Gêneros: contar por gênero e renderizar cards
        const genderMap = {
          male: { label: 'Masculino', icon: '<i class="mdi mdi-gender-male" aria-hidden="true"></i>' },
          female: { label: 'Feminino', icon: '<i class="mdi mdi-gender-female" aria-hidden="true"></i>' },
          other: { label: 'Outro', icon: '<i class="mdi mdi-gender-transgender" aria-hidden="true"></i>' },
          unknown: { label: 'Não informado', icon: '<i class="mdi mdi-help-circle" aria-hidden="true"></i>' }
        };
        const gCounts = {};
        pessoas.forEach(p => { const g = p && p.gender ? p.gender : 'unknown'; gCounts[g] = (gCounts[g] || 0) + 1; });
        const gContainer = document.getElementById('genderCards');
        if (gContainer) {
          gContainer.innerHTML = '';
          // Render known genders in stable order
          ['male','female','other','unknown'].forEach(k => {
            const n = gCounts[k] || 0;
            const info = genderMap[k] || { label: k, icon: '❓' };
            const card = document.createElement('div');
            card.className = 'indicador-card card';
            card.style.minWidth = '140px';
            card.innerHTML = `<div class="indicador-icon" title="${info.label}">${info.icon}</div><div class="indicador-num">${n}</div><div class="indicador-label">${info.label}</div>`;
            gContainer.appendChild(card);
            delete gCounts[k];
          });
          // Any unexpected gender keys
          Object.keys(gCounts).forEach(k => {
            const n = gCounts[k] || 0;
            const card = document.createElement('div');
            card.className = 'indicador-card card';
            card.style.minWidth = '140px';
            card.innerHTML = `<div class="indicador-icon" title="${k}"><i class="mdi mdi-diamond-stone" aria-hidden="true"></i></div><div class="indicador-num">${n}</div><div class="indicador-label">${k}</div>`;
            gContainer.appendChild(card);
          });
        }

        // Top 3 first names (separate lists for Masculino / Feminino)
        try{
          const topEl = document.getElementById('topNamesCard');
          if(topEl){
            const maleCounts = {};
            const femaleCounts = {};
            pessoas.forEach(p => {
              // derive first name from available fields
              let fn = (p.firstName || '').toString().trim();
              if(!fn){
                const alt = (p.fullName || p.name || p.displayName || '').toString().trim();
                if(alt) fn = alt.split(/\s+/)[0] || '';
              }
              if(!fn) return;
              const key = fn.replace(/\s+/g,' ').toLowerCase();
              const graw = (p.gender || p.sex || '').toString().toLowerCase();
              const g = (graw === 'male' || graw === 'masculino' || graw === 'm') ? 'male' : (graw === 'female' || graw === 'feminino' || graw === 'f') ? 'female' : 'unknown';
              if(g === 'male') maleCounts[key] = (maleCounts[key] || 0) + 1;
              else if(g === 'female') femaleCounts[key] = (femaleCounts[key] || 0) + 1;
            });
            function topN(counts, n){ return Object.keys(counts).map(k=>({ name:k, n: counts[k] })).sort((a,b)=>b.n - a.n).slice(0,n); }
            const topM = topN(maleCounts, 3);
            const topF = topN(femaleCounts, 3);
            // build HTML with two columns
            let html = `<div class="indicador-icon"><i class="mdi mdi-account-multiple" aria-hidden="true"></i></div><div class="indicador-label">Nomes mais comuns</div>`;
            html += `<div style="display:flex;gap:10px;padding-top:8px;">`;
            function colHtml(arr, label){
              let s = `<div style="flex:1"><div style="font-weight:700;margin-bottom:6px">${label}</div>`;
              if(!arr || arr.length===0) s += `<div style="color:var(--text-secondary)">Sem dados</div>`;
              else arr.forEach((t,i) => { const display = t.name.charAt(0).toUpperCase() + t.name.slice(1); s += `<div>${i+1}. ${escapeHtml(display)} (${t.n})</div>`; });
              s += `</div>`; return s;
            }
            html += colHtml(topM, 'Masculino');
            html += colHtml(topF, 'Feminino');
            html += `</div>`;
            topEl.innerHTML = html;
          }
        }catch(e){ console.warn('top names render failed', e); }
      }
      updateIndicadores();
      // call births by decade chart after updating counts
      try{ renderBirthsByDecade(getPeople().filter(p=>!p.deletedAt), getEvents().filter(ev=>!ev.deletedAt)); }catch(e){}
      // Render births per decade chart based on available events/people
      function renderBirthsByDecade(pessoas, eventos){
        try{
          const birthDates = [];
          (eventos||[]).forEach(ev => { if(!ev) return; const t = (ev.type||'').toString().toUpperCase(); if(t === 'BIRTH'){ if(ev.date) birthDates.push(new Date(ev.date)); } });
          // also collect birth date info from people records if present
          (pessoas||[]).forEach(p => { try{ if(p && p.birthDate) birthDates.push(new Date(p.birthDate)); }catch(e){} });
          const counts = {};
          birthDates.forEach(d => { if(!d || isNaN(d)) return; const dec = Math.floor(d.getFullYear()/10)*10; counts[dec] = (counts[dec]||0) + 1; });
          const decades = Object.keys(counts).map(k=>Number(k)).sort((a,b)=>a-b);
          const total = Object.values(counts).reduce((a,b)=>a+b,0);
          const totalEl = document.getElementById('totalBirths'); if(totalEl) totalEl.textContent = total;
          const container = document.getElementById('birthDecadeChart'); if(!container) return;
          const w = 520, h = 140; let svg = '';
          if(decades.length === 0){ svg = `<div style="color:#888;padding:14px">Sem dados de nascimento</div>`; container.innerHTML = svg; return; }
          const max = Math.max(...Object.values(counts));
          const barW = Math.floor((w - 40)/decades.length);
          svg = `<svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="xMidYMid meet" width="100%" height="140" role="img" aria-label="Nascimentos por década">`;
          decades.forEach((dec,i)=>{
            const val = counts[dec]||0; const barH = Math.round((val/max) * (h-50)); const x = 20 + i*barW; const y = h - 30 - barH;
            svg += `<rect x="${x}" y="${y}" width="${Math.max(6, barW-8)}" height="${barH}" fill="#4a90e2"></rect>`;
            svg += `<text x="${x + (barW-8)/2}" y="${h-10}" font-size="11" fill="#cfd4e6" text-anchor="middle">${dec}s</text>`;
          });
          svg += `</svg>`;
          container.innerHTML = svg;
        }catch(e){ console.warn('renderBirthsByDecade failed', e); }
      }
    </script>
  </body>
</html>
