<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>myLineage — Árvore Genealógica</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css">
    <style>
      .photo-area{position:relative;display:inline-block;}
      .tag-overlay{position:absolute;left:0;top:0;right:0;bottom:0;pointer-events:none}
      .tag-rect{position:absolute;border:2px solid rgba(59,130,246,0.9);background:rgba(59,130,246,0.12);pointer-events:auto;cursor:pointer;border-radius:6px;box-sizing:border-box}
      .tag-label{position:absolute;background:rgba(0,0,0,0.6);color:#fff;padding:2px 6px;border-radius:6px;font-size:12px;transform:translateY(-120%);white-space:nowrap}
      .tag-form{position:absolute;background:var(--bg-card);padding:8px;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,0.4);z-index:620}
      .tag-form input{margin-bottom:6px;}
      #topolaWrap{position:relative;width:100%;height:calc(100vh - 220px);min-height:400px;overflow:hidden;background:var(--bg-main);border-radius:10px;}
      #topolaSvg .link{stroke:#9aa0a6 !important;stroke-width:1.5px !important;}
      #topolaSvg .link.additional-marriage{stroke:#9aa0a6 !important;stroke-dasharray:4 !important;}
      #topolaSvg{width:100%;height:100%;display:block;cursor:grab;user-select:none;}
      #topolaSvg.panning{cursor:grabbing;}
      .chart-zoom-btns{position:absolute;bottom:12px;right:12px;display:flex;flex-direction:column;gap:4px;z-index:10;}
      .chart-zoom-btns button{width:32px;height:32px;padding:0;font-size:1rem;display:flex;align-items:center;justify-content:center;border-radius:6px;}
      .chart-toolbar{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap;}
      .chart-toolbar select,.chart-toolbar button{font-size:0.85rem;}
      .chart-type-btns{display:flex;gap:4px;align-items:center;flex-wrap:wrap;}
      .chart-type-btn{font-size:0.82rem;padding:4px 14px;border-radius:20px;border:1px solid rgba(163,163,255,0.28);background:transparent;color:var(--text-secondary);cursor:pointer;transition:background .15s,border-color .15s,color .15s;white-space:nowrap;}
      .chart-type-btn:hover{border-color:rgba(163,163,255,0.6);color:var(--text-main);}
      .chart-type-btn.active{border-color:var(--accent,#a3a3ff);background:rgba(163,163,255,0.15);color:var(--text-main);font-weight:600;}
      /* Donatso family-chart theme integration */
      #familyChartWrap.f3{--background-color:var(--bg-main,#1a1d2e);--text-color:var(--text-main,#e2e4f0);--female-color:#e26aa6;--male-color:#4493f8;--genderless-color:#9aa0a6;}
      #familyChartWrap .f3-nav-cont{display:none;}
      #familyChartWrap path.link{stroke:rgba(200,210,230,0.7) !important;stroke-width:1.5px !important;}
      #familyChartWrap .card-body-rect{rx:6;ry:6;}
      #familyChartWrap svg.main_svg text{font-size:12px;fill:#fff;}
    </style>
    <link rel="stylesheet" href="css/family-chart.css">
    <script src="remote-storage.js"></script>
    <script src="topola-bundle.js"></script>
    <script src="family-chart-bundle.js"></script>
  </head>
  <body class="page-tree">
    <div class="app-shell">
      <aside class="sidebar">
        <a href="index.html" class="logo"><i class="mdi mdi-tree" aria-hidden="true"></i><span>myLineage</span></a>
        <nav>
          <a href="app.html"><i class="mdi mdi-account-multiple" aria-hidden="true"></i>Cadastro</a>
          <a href="indicadores.html"><i class="mdi mdi-chart-bar" aria-hidden="true"></i>Indicadores</a>
          <a href="arvore.html" class="active"><i class="mdi mdi-sitemap" aria-hidden="true"></i>Árvore</a>
          <a href="gedcom.html"><i class="mdi mdi-dna" aria-hidden="true"></i>GEDCOM</a>
          <a href="album.html"><i class="mdi mdi-image-multiple" aria-hidden="true"></i>Álbum</a>
          <a href="documentos.html"><i class="mdi mdi-folder-open" aria-hidden="true"></i>Documentos</a>
          <a href="validacao.html"><i class="mdi mdi-shield-check" aria-hidden="true"></i>Validação</a>
          <a href="historico.html"><i class="mdi mdi-history" aria-hidden="true"></i>Histórico</a>
        </nav>
        <div class="sidebar-footer">
          <a href="apis.html"><i class="mdi mdi-api" aria-hidden="true"></i>APIs</a>
          <a href="configuracao.html"><i class="mdi mdi-cog" aria-hidden="true"></i>Definições</a>
        </div>
      </aside>
      <main class="content">
        <div class="topbar">
          <div style="display:flex;align-items:center;gap:10px;">
            <i class="mdi mdi-sitemap" style="color:var(--accent);font-size:1.15rem;"></i>
            <h1>Árvore Genealógica</h1>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <button id="resetFocusBtn" class="btn btn-ghost btn-sm" title="Resetar foco para a pessoa configurada">
              <i class="mdi mdi-crosshairs-gps" aria-hidden="true"></i> Reset foco
            </button>
          </div>
        </div>

        <div class="tree-canvas-wrap">
          <div class="chart-toolbar">
            <div class="chart-type-btns" id="chartTypeBtns">
              <button class="chart-type-btn" data-type="hourglass">Hourglass</button>
              <button class="chart-type-btn" data-type="relatives">Relatives</button>
              <button class="chart-type-btn" data-type="fancy">Fancy</button>
              <button class="chart-type-btn" data-type="donatso">Donatso</button>
            </div>
            <label style="font-size:0.85rem;color:var(--text-secondary);margin-left:12px;">Pessoa:</label>
            <div style="position:relative;display:inline-block;" id="focusPersonCombo">
              <input type="text" id="focusPersonInput" placeholder="Pesquisar pessoa…" autocomplete="off"
                style="font-size:0.85rem;padding:4px 28px 4px 8px;border-radius:6px;border:1px solid rgba(163,163,255,0.18);background:var(--bg-card);color:var(--text-main);min-width:220px;">
              <i class="mdi mdi-magnify" style="position:absolute;right:7px;top:50%;transform:translateY(-50%);color:var(--text-secondary);pointer-events:none;font-size:1rem;"></i>
              <input type="hidden" id="focusPersonSelect">
              <div id="focusPersonDropdown" style="display:none;position:absolute;top:calc(100% + 2px);left:0;min-width:100%;max-height:220px;overflow-y:auto;background:var(--bg-card);border:1px solid rgba(163,163,255,0.22);border-radius:6px;box-shadow:0 8px 24px rgba(0,0,0,0.45);z-index:500;"></div>
            </div>
            <button id="renderChartBtn" class="btn btn-sm"><i class="mdi mdi-refresh"></i> Renderizar</button>
          </div>
          <div id="topolaWrap">
            <svg id="topolaSvg"></svg>
            <div class="chart-zoom-btns" id="topolaZoomBtns">
              <button class="btn btn-ghost" id="zoomInBtn" title="Zoom +"><i class="mdi mdi-plus"></i></button>
              <button class="btn btn-ghost" id="fitChartBtn" title="Ver tudo"><i class="mdi mdi-fit-to-screen-outline"></i></button>
              <button class="btn btn-ghost" id="centerChartBtn" title="Centrar na pessoa"><i class="mdi mdi-crosshairs"></i></button>
              <button class="btn btn-ghost" id="zoomOutBtn" title="Zoom −"><i class="mdi mdi-minus"></i></button>
            </div>
          </div>
          <div id="familyChartWrap" class="f3" style="display:none;width:100%;height:calc(100vh - 220px);min-height:400px;border-radius:10px;overflow:hidden;position:relative;"></div>
          <div class="legend">
            <span><span class="avatar" style="background:#4493f8"></span> Masculino</span>
            <span><span class="avatar" style="background:#e26aa6"></span> Feminino</span>
            <span><span class="avatar" style="background:#9aa0a6"></span> Outro</span>
          </div>
        </div>


      </main>
    </div>

    <!-- ── Right drawer overlay ── -->
    <div class="drawer-overlay" id="drawerOverlay"></div>

    <!-- ── Right drawer ── -->
    <div class="drawer" id="personDrawer" role="dialog" aria-modal="true" aria-labelledby="drawerTitle">
      <div class="drawer-header">
        <button class="btn btn-ghost btn-sm" id="drawerBackBtn" style="display:none;padding:2px 6px;margin-right:4px;" title="Voltar"><i class="mdi mdi-arrow-left"></i></button>
        <h2 id="drawerTitle" style="flex:1;">Detalhes da Pessoa</h2>
        <button class="drawer-close" id="drawerCloseBtn" aria-label="Fechar painel"><i class="mdi mdi-close"></i></button>
      </div>
      <div class="drawer-person-header" id="drawerPersonHeader">
        <div class="drawer-avatar" id="drawerAvatar"></div>
        <div>
          <div class="drawer-person-name" id="drawerPersonName">—</div>
          <div class="drawer-person-sub" id="drawerPersonSub"></div>
        </div>
      </div>
      <div class="drawer-body" id="drawerBody"></div>
      <div class="drawer-footer">
        <button class="btn btn-danger btn-sm" id="drawerDeleteBtn"><i class="mdi mdi-delete-outline"></i> Apagar</button>
        <button class="btn btn-ghost btn-sm" id="drawerCancelBtn">Cancelar</button>
        <button class="btn btn-sm" id="drawerSaveBtn"><i class="mdi mdi-content-save-outline"></i> Guardar</button>
      </div>
    </div>

    <!-- ── Drawer photo modal ── -->
    <div id="drawerPhotoModal" style="display:none;position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.72);align-items:flex-start;justify-content:center;z-index:600;overflow-y:auto;padding:24px 0;">
      <div style="background:var(--bg-card);padding:22px;border-radius:12px;max-width:1000px;width:96%;box-sizing:border-box;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <div style="font-weight:700">Visualizar Foto</div>
          <button onclick="_drawerClosePhotoModal()" class="btn">Fechar</button>
        </div>
        <div style="margin-bottom:8px;font-size:0.82rem;color:#aaa;">Arrasta um retângulo sobre a imagem para identificar uma pessoa.</div>
        <div id="drawerModalImageWrapper" style="display:flex;align-items:center;justify-content:center;margin-bottom:16px;padding:8px;">
          <div id="drawerModalImageArea" style="max-width:100%;overflow:visible;"></div>
        </div>
        <div style="margin-bottom:8px;">
          <label style="font-weight:600;color:var(--text-secondary);display:block;margin-bottom:6px;">Notas da Foto</label>
          <textarea id="drawerPhotoNotesArea" style="width:100%;min-height:80px;padding:8px;border-radius:8px;border:1px solid rgba(163,163,255,0.08);background:rgba(35,40,58,0.7);color:var(--text-main);box-sizing:border-box;resize:vertical;"></textarea>
          <div id="drawerPhotoTaggedPeople" style="margin-top:8px;font-size:0.95rem;color:var(--text-main);"></div>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;">
          <button class="btn" onclick="_drawerSavePhotoNotes()">Salvar Notas</button>
        </div>
      </div>
    </div>

    <script>
    (function(){
      'use strict';
      const DB = window.GedcomDB;
      const T = window.TopolaLib;

      /* ── Helpers ──────────────────────────────────────────────────────── */
      const MONTHS_MAP = {JAN:1,FEB:2,MAR:3,APR:4,MAY:5,JUN:6,JUL:7,AUG:8,SEP:9,OCT:10,NOV:11,DEC:12};
      function _esc(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

      function parseGedcomDateToTopola(dateStr){
        if(!dateStr) return undefined;
        const tokens=dateStr.toUpperCase().split(/\s+/);
        let day,month,year;
        for(const t of tokens){
          if(MONTHS_MAP[t]) month=MONTHS_MAP[t];
          else if(/^\d{3,4}$/.test(t)) year=parseInt(t);
          else if(/^\d{1,2}$/.test(t)&&!day) day=parseInt(t);
        }
        if(!year&&!month&&!day) return undefined;
        return {date:{day,month,year}};
      }

      /* ── Build Topola-compatible JSON ─────────────────────────────────── */
      function buildTopolaJson(){
        const indis=DB.getIndividuals();
        const fams=DB.getFamilies();
        // Build a set of valid (non-deleted) family IDs so we can filter refs
        const validFamIds=new Set(fams.map(f=>f.id));
        const validIndiIds=new Set(indis.map(i=>i.id));
        const tIndis=indis.map(indi=>{
          const birth=DB.getBirthEvent(indi);
          const death=DB.getDeathEvent(indi);
          const thumb=DB.getThumbnailForPerson(indi.id);
          // Filter out refs to deleted/missing families
          const famcVal=(indi.famc&&validFamIds.has(indi.famc))?indi.famc:undefined;
          const famsVal=(indi.fams||[]).filter(fid=>validFamIds.has(fid));
          return {
            id: indi.id,
            firstName: DB.getGivenName(indi)||undefined,
            lastName: DB.getSurname(indi)||undefined,
            sex: indi.sex||undefined,
            famc: famcVal,
            fams: famsVal.length?famsVal:undefined,
            birth: birth?{...parseGedcomDateToTopola(birth.date),place:birth.place||undefined}:undefined,
            death: death?{...parseGedcomDateToTopola(death.date),place:death.place||undefined}:undefined,
            images: thumb?[{url:thumb,title:''}]:undefined
          };
        });
        const tFams=fams.map(fam=>{
          const marr=(fam.events||[]).find(e=>e.type==='MARR');
          // Filter out refs to deleted/missing individuals
          const children=(fam.children||[]).filter(cid=>validIndiIds.has(cid));
          return {
            id: fam.id,
            husb: (fam.husb&&validIndiIds.has(fam.husb))?fam.husb:undefined,
            wife: (fam.wife&&validIndiIds.has(fam.wife))?fam.wife:undefined,
            children: children.length?children:undefined,
            marriage: marr?{...parseGedcomDateToTopola(marr.date),place:marr.place||undefined}:undefined
          };
        });
        return {indis:tIndis,fams:tFams};
      }

      /* ── ViewBox pan/zoom state ──────────────────────────────────────── */
      let _vb={x:0,y:0,w:800,h:600};
      let _chartSize=[0,0];
      let _focusPt=[0,0];

      function _applyViewBox(){
        document.getElementById('topolaSvg').setAttribute('viewBox',`${_vb.x} ${_vb.y} ${_vb.w} ${_vb.h}`);
      }

      function _zoomViewBox(factor, cx, cy){
        // cx, cy: centre point in SVG display coords (defaults to viewBox centre)
        const svgEl=document.getElementById('topolaSvg');
        const rect=svgEl.getBoundingClientRect();
        if(cx===undefined) cx=rect.width/2;
        if(cy===undefined) cy=rect.height/2;
        // convert display coords → viewBox coords
        const scaleX=_vb.w/rect.width, scaleY=_vb.h/rect.height;
        const vbCx=_vb.x+cx*scaleX, vbCy=_vb.y+cy*scaleY;
        _vb.w*=factor; _vb.h*=factor;
        _vb.x=vbCx-cx*scaleX*factor;
        _vb.y=vbCy-cy*scaleY*factor;
        _applyViewBox();
      }

      function _centerViewBox(svgX, svgY){
        const svgEl=document.getElementById('topolaSvg');
        const rect=svgEl.getBoundingClientRect();
        _vb.x=svgX-_vb.w/2; _vb.y=svgY-_vb.h/2;
        _applyViewBox();
      }

      function _fitViewBox(){
        _vb.x=0; _vb.y=0; _vb.w=_chartSize[0]; _vb.h=_chartSize[1];
        _applyViewBox();
      }

      /* Pointer-based pan */
      (function _initPan(){
        const svgEl=()=>document.getElementById('topolaSvg');
        let panStart=null;
        document.addEventListener('pointerdown',e=>{
          if(!e.target.closest('#topolaWrap')||e.target.closest('button')) return;
          panStart={px:e.clientX,py:e.clientY,vbx:_vb.x,vby:_vb.y};
          svgEl().classList.add('panning');
          e.currentTarget.setPointerCapture&&e.currentTarget.setPointerCapture(e.pointerId);
        });
        document.addEventListener('pointermove',e=>{
          if(!panStart) return;
          const svgR=svgEl().getBoundingClientRect();
          const sx=_vb.w/svgR.width, sy=_vb.h/svgR.height;
          _vb.x=panStart.vbx-(e.clientX-panStart.px)*sx;
          _vb.y=panStart.vby-(e.clientY-panStart.py)*sy;
          _applyViewBox();
        });
        document.addEventListener('pointerup',()=>{panStart=null; svgEl()&&svgEl().classList.remove('panning');});
        document.addEventListener('wheel',e=>{
          if(!e.target.closest('#topolaWrap')) return;
          e.preventDefault();
          const svgR=svgEl().getBoundingClientRect();
          const cx=e.clientX-svgR.left, cy=e.clientY-svgR.top;
          _zoomViewBox(e.deltaY>0?1.15:1/1.15, cx, cy);
        },{passive:false});
      })();

      /* ── Chart type preference (localStorage) ──────────────────────────── */
      const CHART_TYPE_KEY='myLineage_chartType';
      function getChartType(){
        return localStorage.getItem(CHART_TYPE_KEY)||'donatso';
      }
      function setChartType(type){
        localStorage.setItem(CHART_TYPE_KEY,type);
        document.querySelectorAll('#chartTypeBtns .chart-type-btn').forEach(btn=>{
          btn.classList.toggle('active', btn.dataset.type===type);
        });
      }
      // Bind button clicks
      document.getElementById('chartTypeBtns').addEventListener('click',function(e){
        const btn=e.target.closest('.chart-type-btn');
        if(!btn) return;
        setChartType(btn.dataset.type);
        const id=_getSelectedOrFocusId ? _getSelectedOrFocusId() : null;
        renderChart(id);
      });
      // Init button state
      setChartType(getChartType());

      /* ── Chart rendering ──────────────────────────────────────────────── */
      let chartHandle=null;

      const CHART_TYPES={
        hourglass: T.HourglassChart,
        relatives: T.RelativesChart,
        fancy: T.FancyChart
      };

      /* ── Build Donatso family-chart data ──────────────────────────────── */
      function buildFamilyChartData(){
        const indis=DB.getIndividuals();
        const fams=DB.getFamilies();
        const famMap={};
        fams.forEach(f=>famMap[f.id]=f);
        const validIndiIds=new Set(indis.map(i=>i.id));
        return indis.map(indi=>{
          const parents=[];
          if(indi.famc&&famMap[indi.famc]){
            const fam=famMap[indi.famc];
            if(fam.husb&&validIndiIds.has(fam.husb)) parents.push(fam.husb);
            if(fam.wife&&validIndiIds.has(fam.wife)) parents.push(fam.wife);
          }
          const spouses=[],children=[];
          (indi.fams||[]).forEach(famId=>{
            const fam=famMap[famId]; if(!fam) return;
            if(fam.husb&&fam.husb!==indi.id&&validIndiIds.has(fam.husb)&&!spouses.includes(fam.husb)) spouses.push(fam.husb);
            if(fam.wife&&fam.wife!==indi.id&&validIndiIds.has(fam.wife)&&!spouses.includes(fam.wife)) spouses.push(fam.wife);
            (fam.children||[]).forEach(cid=>{ if(validIndiIds.has(cid)&&!children.includes(cid)) children.push(cid); });
          });
          const birth=DB.getBirthEvent(indi),death=DB.getDeathEvent(indi);
          const thumb=DB.getThumbnailForPerson(indi.id);
          return {
            id: indi.id,
            data: {
              gender: indi.sex==='F'?'F':'M',
              first_name: DB.getGivenName(indi)||'',
              last_name: DB.getSurname(indi)||'',
              birthday: birth&&birth.date?birth.date:'',
              deathday: death&&death.date?death.date:'',
              avatar: thumb||undefined
            },
            rels:{parents,spouses,children}
          };
        });
      }

      let f3ChartHandle=null;

      function renderChart(startIndi){
        const selectedType=getChartType();

        /* ── Donatso Family Chart ──────────────────────────────────────── */
        if(selectedType==='donatso'){
          document.getElementById('topolaWrap').style.display='none';
          const fcWrap=document.getElementById('familyChartWrap');
          fcWrap.style.display='';
          fcWrap.innerHTML='';
          f3ChartHandle=null;
          const fcData=buildFamilyChartData();
          if(!fcData.length){
            fcWrap.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#888;font-size:16px;">Sem dados. Adicione pessoas no Cadastro.</div>';
            return;
          }
          const validFcIds=new Set(fcData.map(d=>d.id));
          if(!startIndi||!validFcIds.has(startIndi)) startIndi=fcData[0].id;
          try{
            const F3=window.F3Lib;
            f3ChartHandle=F3.createChart(fcWrap, fcData);
            const card=f3ChartHandle.setCardSvg();
            card.setCardDisplay([
              function(d){ return [d.data.first_name, d.data.last_name].filter(Boolean).join(' ')||'—'; },
              function(d){ return d.data.birthday ? '\u2605 '+d.data.birthday : ''; },
              function(d){ return d.data.deathday ? '\u271D '+d.data.deathday : ''; }
            ]);
            card.setCardDim({w:230, h:80, text_x:75, text_y:12, img_w:62, img_h:72, img_x:4, img_y:4});
            card.setMiniTree(false);
            card.setOnCardClick(function(e,d){
              if(d&&d.data&&d.data.id) openDrawer('edit',d.data.id);
            });
            f3ChartHandle
              .updateMainId(startIndi)
              .updateTree({initial:true, tree_position:'main_to_middle'});
          }catch(err){
            console.error('Donatso render error:',err);
            fcWrap.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#e06060;font-size:14px;">Erro ao renderizar: '+_esc(err.message)+'</div>';
          }
          return;
        }

        /* ── Topola charts ─────────────────────────────────────────────── */
        document.getElementById('familyChartWrap').style.display='none';
        document.getElementById('topolaWrap').style.display='';
        f3ChartHandle=null;

        const json=buildTopolaJson();
        const svgEl=document.getElementById('topolaSvg');
        if(!json.indis.length){
          _chartSize=[800,400]; _vb={x:0,y:0,w:800,h:400};
          svgEl.setAttribute('viewBox','0 0 800 400');
          svgEl.innerHTML='<text x="400" y="200" text-anchor="middle" fill="#888" font-size="16">Sem dados. Adicione pessoas no Cadastro.</text>';
          return;
        }
        // Ensure startIndi exists in the current dataset; fall back to first person
        const validIds=new Set(json.indis.map(i=>i.id));
        if(!startIndi||!validIds.has(startIndi)) startIndi=json.indis[0].id;
        const chartType=CHART_TYPES[getChartType()]||T.HourglassChart;
        svgEl.removeAttribute('viewBox');
        svgEl.innerHTML=''; // clear
        try{
          chartHandle=T.createChart({
            json,
            chartType,
            renderer: T.DetailedRenderer,
            svgSelector: '#topolaSvg',
            indiCallback: function(info){ if(info&&info.id) openDrawer('edit',info.id); },
            animate: false,
            updateSvgSize: false,
            horizontal: false,
            locale: 'pt'
          });
          const info=chartHandle.render({startIndi:startIndi||undefined});
          _chartSize=info.size;
          _focusPt=[info.origin[0], info.origin[1]];
          // Initial view: 1:1 scale centred on focus person
          const wrap=document.getElementById('topolaWrap');
          const W=wrap.clientWidth||900, H=wrap.clientHeight||600;
          _vb={x:_focusPt[0]-W/2, y:_focusPt[1]-H/2, w:W, h:H};
          _applyViewBox();
        }catch(err){
          console.error('Topola render error:',err);
          _chartSize=[800,400]; _vb={x:0,y:0,w:800,h:400};
          svgEl.setAttribute('viewBox','0 0 800 400');
          svgEl.innerHTML='<text x="400" y="200" text-anchor="middle" fill="#e06060" font-size="14">Erro ao renderizar: '+_esc(err.message)+'</text>';
        }
      }

      /* ── Focus person ─────────────────────────────────────────────────── */
      function getFocusPersonId(){
        const validIds=new Set(DB.getIndividuals().map(i=>i.id));
        // Check temp setting (from Cadastro "Ver na Árvore")
        const temp=DB.getSetting('tempFocusPerson');
        if(temp){ DB.setSetting('tempFocusPerson',null); if(validIds.has(temp)) return temp; }
        // Check configured focus person — stored as {id, name, when} object
        const focused=DB.getSetting('focusedPerson');
        const focusedId=focused&&(typeof focused==='object'?focused.id:focused);
        if(focusedId && validIds.has(focusedId)) return focusedId;
        // Default: first individual
        const indis=DB.getIndividuals();
        return indis.length?indis[0].id:null;
      }

      // ── Searchable person combo ────────────────────────────────────
      let _allPersons=[];
      let _autoFocusId=null; // focus person from settings, used when nothing manually selected

      function populateFocusSelect(focusId){
        _allPersons=DB.getIndividuals().map(indi=>({id:indi.id,name:DB.getDisplayName(indi)}));
        _autoFocusId=focusId||null;
        // Leave input empty — search is user-initiated only
        document.getElementById('focusPersonSelect').value='';
        document.getElementById('focusPersonInput').value='';
        _renderDropdown('');
      }

      function _getSelectedOrFocusId(){
        const v=document.getElementById('focusPersonSelect').value;
        return v||_autoFocusId||(_allPersons.length?_allPersons[0].id:null);
      }

      function _renderDropdown(query){
        const dd=document.getElementById('focusPersonDropdown');
        const q=query.trim().toLowerCase();
        const filtered=q?_allPersons.filter(p=>p.name.toLowerCase().includes(q)):_allPersons;
        dd.innerHTML='';
        if(!filtered.length){
          dd.innerHTML='<div style="padding:8px 12px;color:var(--text-secondary);font-size:0.85rem;">Sem resultados</div>';
        } else {
          const hidden=document.getElementById('focusPersonSelect');
          filtered.forEach(p=>{
            const item=document.createElement('div');
            item.textContent=p.name;
            item.dataset.id=p.id;
            item.style.cssText='padding:7px 12px;cursor:pointer;font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;';
            if(p.id===hidden.value) item.style.background='rgba(68,147,248,0.18)';
            item.addEventListener('mouseenter',()=>item.style.background='rgba(68,147,248,0.12)');
            item.addEventListener('mouseleave',()=>item.style.background=p.id===hidden.value?'rgba(68,147,248,0.18)':'');
            item.addEventListener('mousedown',e=>{
              e.preventDefault();
              _selectPerson(p.id,p.name);
            });
            dd.appendChild(item);
          });
        }
      }

      function _selectPerson(id,name){
        document.getElementById('focusPersonSelect').value=id;
        document.getElementById('focusPersonInput').value=name;
        document.getElementById('focusPersonDropdown').style.display='none';
      }

      (function _bindCombo(){
        const input=document.getElementById('focusPersonInput');
        const dd=document.getElementById('focusPersonDropdown');
        input.addEventListener('focus',()=>{ _renderDropdown(input.value); dd.style.display='block'; });
        input.addEventListener('input',()=>{ _renderDropdown(input.value); dd.style.display='block'; });
        input.addEventListener('blur',()=>{ setTimeout(()=>{ dd.style.display='none'; },150); });
        input.addEventListener('keydown',e=>{
          if(e.key==='Escape'){ dd.style.display='none'; input.blur(); }
          if(e.key==='Enter'){
            const first=dd.querySelector('[data-id]');
            if(first){ _selectPerson(first.dataset.id,first.textContent); input.blur(); }
          }
          if(e.key==='ArrowDown'){
            e.preventDefault();
            const items=[...dd.querySelectorAll('[data-id]')];
            if(items.length){ items[0].dispatchEvent(new MouseEvent('mousedown',{bubbles:true,cancelable:true})); }
          }
        });
      })();

      function showFocusInfo(){}

      /* ── Init ──────────────────────────────────────────────────────────── */
      const focusId=getFocusPersonId();
      populateFocusSelect(focusId);
      renderChart(focusId);

      document.getElementById('renderChartBtn').addEventListener('click',function(){
        const id=_getSelectedOrFocusId();
        renderChart(id);
      });

      document.getElementById('zoomInBtn').addEventListener('click',()=>_zoomViewBox(1/1.3));
      document.getElementById('zoomOutBtn').addEventListener('click',()=>_zoomViewBox(1.3));
      document.getElementById('fitChartBtn').addEventListener('click',()=>_fitViewBox());
      document.getElementById('centerChartBtn').addEventListener('click',()=>_centerViewBox(_focusPt[0],_focusPt[1]));

      document.getElementById('resetFocusBtn').addEventListener('click',function(){
        // Clear manual selection, revert to settings focus
        document.getElementById('focusPersonSelect').value='';
        document.getElementById('focusPersonInput').value='';
        const id=_getSelectedOrFocusId();
        if(id) renderChart(id);
      });

      /* ═══════════════════════════════════════════════════════════════════
         DRAWER (same pattern as app.html)
         ═══════════════════════════════════════════════════════════════════ */
      let _drawerPersonId=null,_drawerMode='edit';

      function openDrawer(mode,personId){
        const footer=document.querySelector('.drawer-footer'); if(footer) footer.style.display='';
        const backBtn=document.getElementById('drawerBackBtn'); if(backBtn){ backBtn.style.display='none'; backBtn._personId=null; }
        const phdr=document.getElementById('drawerPersonHeader'); if(phdr) phdr.style.display='';
        _drawerMode=mode; _drawerPersonId=personId||null;
        const indi=personId?DB.getIndividual(personId):null;
        document.getElementById('drawerTitle').textContent=mode==='create'?'Nova Pessoa':'Editar Pessoa';
        const nameEl=document.getElementById('drawerPersonName'),subEl=document.getElementById('drawerPersonSub'),avatarEl=document.getElementById('drawerAvatar');
        if(indi){
          nameEl.textContent=DB.getDisplayName(indi);
          let sub=[];
          const birth=DB.getBirthEvent(indi); if(birth&&birth.date) sub.push('\u2605 '+birth.date);
          const death=DB.getDeathEvent(indi); if(death&&death.date) sub.push('\u271D '+death.date);
          subEl.textContent=sub.join('  ·  ');
          const thumb=DB.getThumbnailForPerson(indi.id);
          if(thumb){avatarEl.style.backgroundImage='url('+thumb+')';avatarEl.style.backgroundSize='cover';avatarEl.style.backgroundPosition='center';}
          else{avatarEl.style.backgroundImage='';avatarEl.style.background=indi.sex==='F'?'#e26aa6':indi.sex==='M'?'#4493f8':'#9aa0a6';}
        } else {
          nameEl.textContent='Nova Pessoa'; subEl.textContent='';
          avatarEl.style.backgroundImage=''; avatarEl.style.background='var(--bg-surface-2)';
        }
        const body=document.getElementById('drawerBody');
        const given=indi?DB.getGivenName(indi):'';
        const surname=indi?DB.getSurname(indi):'';
        const sex=indi?(indi.sex||''):'';
        const notes=indi?(indi.notes||''):'';
        body.innerHTML=[
          '<div class="drawer-section-label">Identidade</div>',
          '<div class="form-row"><div><label>Primeiro nome</label><input type="text" id="df_firstName" value="'+_esc(given)+'" placeholder="Nome" /></div><div><label>Apelido</label><input type="text" id="df_lastName" value="'+_esc(surname)+'" placeholder="Apelido" /></div></div>',
          '<div><label>Género</label><select id="df_gender"><option value=""'+(!sex?' selected':'')+'>​(n/a)</option><option value="M"'+(sex==='M'?' selected':'')+'>Masculino</option><option value="F"'+(sex==='F'?' selected':'')+'>Feminino</option><option value="X"'+(sex==='X'?' selected':'')+'>Outro</option></select></div>',
          '<div class="drawer-section-label" style="margin-top:8px;">Notas</div>',
          '<div><textarea id="df_notes" rows="3" placeholder="Notas...">'+_esc(notes)+'</textarea></div>',
          indi?'<div style="margin-top:6px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;"><button class="btn btn-ghost btn-sm" style="font-size:0.82rem;" onclick="openDrawerSection(\''+indi.id+'\',\'relacoes\')"><i class="mdi mdi-account-multiple-outline"></i> Relações</button><button class="btn btn-ghost btn-sm" style="font-size:0.82rem;" onclick="openDrawerSection(\''+indi.id+'\',\'eventos\')"><i class="mdi mdi-calendar-check-outline"></i> Eventos</button><button class="btn btn-ghost btn-sm" style="font-size:0.82rem;" onclick="openDrawerSection(\''+indi.id+'\',\'fotos\')"><i class="mdi mdi-image-multiple-outline"></i> Fotos</button></div>':''
        ].join('');
        document.getElementById('personDrawer').classList.add('open');
        document.getElementById('drawerOverlay').classList.add('open');
        setTimeout(()=>{const fi=document.getElementById('df_firstName');if(fi) fi.focus();},50);
      }

      function closeDrawer(){
        document.getElementById('personDrawer').classList.remove('open');
        document.getElementById('drawerOverlay').classList.remove('open');
      }

      window.openDrawerSection=function(personId,section){
        const indi=DB.getIndividual(personId); if(!indi) return;
        const footer=document.querySelector('.drawer-footer'); if(footer) footer.style.display='none';
        const phdr=document.getElementById('drawerPersonHeader'); if(phdr) phdr.style.display='none';
        const backBtn=document.getElementById('drawerBackBtn'); if(backBtn){backBtn.style.display='';backBtn._personId=personId;}
        document.getElementById('drawerTitle').textContent=(section==='relacoes'?'Relações':section==='fotos'?'Fotos':'Eventos')+' — '+DB.getDisplayName(indi);
        const body=document.getElementById('drawerBody');
        if(section==='relacoes') body.innerHTML=_renderRelations(personId);
        else if(section==='fotos') body.innerHTML=_renderPhotos(personId);
        else body.innerHTML=_renderEvents(personId);
      };

      /* ── Events section (simplified for tree page) ─────────────────────── */
      const EVENT_TYPES={BIRT:'Nascimento',BAPM:'Batismo',CHR:'Batizado',DEAT:'Óbito',BURI:'Sepultamento',CREM:'Cremação',ADOP:'Adoção',OCCU:'Ocupação',RESI:'Residência',EVEN:'Outro'};
      function fmtEventDate(ev){ if(!ev||!ev.date) return ''; return ev.date; }

      function _renderEvents(personId){
        const indi=DB.getIndividual(personId);
        const evs=(indi&&indi.events||[]);
        let html='<div style="margin-bottom:12px;"><button class="btn btn-sm" onclick="_treeAddEvent(\''+_esc(personId)+'\')" style="font-size:0.83rem;"><i class="mdi mdi-plus"></i> Adicionar</button></div>';
        if(!evs.length) return html+'<div style="color:#888;">Nenhum evento.</div>';
        html+='<div class="mini-list">';
        evs.forEach((ev,i)=>{
          html+='<div class="mini-card" style="padding:10px 12px;"><span style="font-weight:600;">'+(EVENT_TYPES[ev.type]||ev.type)+'</span> <span style="color:#888;margin-left:8px;">'+_esc(fmtEventDate(ev))+'</span>'+(ev.place?' <span style="color:#aaa;margin-left:8px;">'+_esc(ev.place)+'</span>':'')+'</div>';
        });
        html+='</div>';
        return html;
      }

      window._treeAddEvent=function(personId){
        // Navigate to app.html drawer for full event editing
        window.location.href='app.html?edit='+encodeURIComponent(personId);
      };

      /* ── Relations section ─────────────────────────────────────────────── */
      function _renderRelations(personId){
        const rels=[];
        DB.getParents(personId).forEach(p=>rels.push({type:'Pai / Mãe',name:DB.getDisplayName(p),id:p.id,sex:p.sex}));
        DB.getSpouses(personId).forEach(s=>rels.push({type:'Companheiro(a)',name:DB.getDisplayName(s),id:s.id,sex:s.sex}));
        DB.getChildren(personId).forEach(c=>rels.push({type:'Filho(a)',name:DB.getDisplayName(c),id:c.id,sex:c.sex}));
        DB.getSiblings(personId).forEach(s=>rels.push({type:'Irmão / Irmã',name:DB.getDisplayName(s),id:s.id,sex:s.sex}));
        let html='';
        if(!rels.length) return '<div style="color:#888;">Sem relações.</div>';
        html+='<div class="mini-list">';
        rels.forEach(r=>{
          let desc=r.type;
          if(r.sex==='F'){if(desc.includes('Filho'))desc='Filha';if(desc.includes('Pai'))desc='Mãe';if(desc.includes('Compan'))desc='Companheira';if(desc.includes('Irm'))desc='Irmã';}
          else if(r.sex==='M'){if(desc.includes('Filho'))desc='Filho';if(desc.includes('Mãe'))desc='Pai';if(desc.includes('Compan'))desc='Companheiro';if(desc.includes('Irm'))desc='Irmão';}
          html+='<div class="mini-card" style="padding:10px 12px;cursor:pointer;" onclick="(function(){_selectPerson(\''+r.id+'\',\''+r.name.replace(/'/g,"\\'")+'\'  );document.getElementById(\'renderChartBtn\').click();closeDrawer();}())"><span style="font-weight:600;">'+_esc(r.name)+'</span> <span style="color:#aaa;margin-left:8px;">'+_esc(desc)+'</span></div>';
        });
        html+='</div>';
        return html;
      }

      /* ── Photos section (minimal for tree) ─────────────────────────────── */
      function _renderPhotos(personId){
        const media=DB.getMultimediaForIndividual(personId);
        if(!media.length) return '<div style="color:#888;">Nenhuma foto.</div>';
        let html='<div style="display:flex;flex-wrap:wrap;gap:10px;">';
        media.forEach(m=>{
          const src=m.dataUrl||(m.files&&m.files[0]?m.files[0].file:'')||'';
          html+='<img src="'+src+'" style="width:72px;height:72px;object-fit:cover;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,0.3);" title="'+_esc(m.title||'')+'" />';
        });
        html+='</div>';
        return html;
      }

      /* ── Drawer save/delete/close ──────────────────────────────────────── */
      function drawerSave(){
        const given=(document.getElementById('df_firstName')||{}).value||'';
        const surname=(document.getElementById('df_lastName')||{}).value||'';
        const sex=(document.getElementById('df_gender')||{}).value||'U';
        const notes=(document.getElementById('df_notes')||{}).value||'';
        if(_drawerMode==='create'){
          DB.saveIndividual({names:[{given:given.trim(),surname:surname.trim(),type:'birth'}],sex,notes,events:[]});
        } else if(_drawerPersonId){
          const indi=DB.getIndividual(_drawerPersonId);
          if(indi){indi.names=[{given:given.trim(),surname:surname.trim(),type:'birth'}];indi.sex=sex;indi.notes=notes;DB.saveIndividual(indi);}
        }
        closeDrawer();
        populateFocusSelect(document.getElementById('focusPersonSelect').value);
        renderChart(document.getElementById('focusPersonSelect').value);
      }

      function drawerDeletePerson(){
        if(!_drawerPersonId||!confirm('Apagar esta pessoa?')) return;
        DB.deleteIndividual(_drawerPersonId);
        closeDrawer();
        populateFocusSelect(null);
        renderChart(null);
      }

      document.getElementById('drawerCloseBtn').addEventListener('click',closeDrawer);
      document.getElementById('drawerCancelBtn').addEventListener('click',closeDrawer);
      document.getElementById('drawerOverlay').addEventListener('click',closeDrawer);
      document.getElementById('drawerSaveBtn').addEventListener('click',drawerSave);
      document.getElementById('drawerDeleteBtn').addEventListener('click',drawerDeletePerson);
      document.getElementById('drawerBackBtn').addEventListener('click',function(){const pid=this._personId;if(pid) openDrawer('edit',pid);});

      /* ── Photo modal stubs ─────────────────────────────────────────────── */
      window._drawerClosePhotoModal=function(){document.getElementById('drawerPhotoModal').style.display='none';};
      window._drawerSavePhotoNotes=function(){};

    })();
    </script>
    <script src="history-logger.js"></script>
  </body>
</html>
