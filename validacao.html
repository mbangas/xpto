<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Validação – myLineage</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css">
    <script src="remote-storage.js"></script>
    <style>
      /* ── Layout ───────────────────────────────────────────────────────── */
      .val-content { background: #0f1117; }

      .val-grid {
        padding: 0 20px 40px;
        margin-top: 24px;
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      /* KPI row */
      .val-kpi-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
      }

      .kpi-card {
        background: #1a1d27;
        border: 1px solid rgba(255,255,255,0.07);
        border-radius: 6px;
        padding: 14px 18px;
        display: flex;
        flex-direction: column;
        gap: 4px;
        border-left: 4px solid var(--kpi-clr, #5294e2);
      }
      .kpi-label {
        font-size: 0.68rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.07em;
        color: #9fa7b3;
      }
      .kpi-value {
        font-size: 2.2rem;
        font-weight: 700;
        color: #fff;
        line-height: 1;
      }
      .kpi-sub {
        font-size: 0.74rem;
        color: #9fa7b3;
      }
      .kpi-erro   { --kpi-clr: #e05252; }
      .kpi-aviso  { --kpi-clr: #e0a132; }
      .kpi-info   { --kpi-clr: #5294e2; }
      .kpi-ok     { --kpi-clr: #52c47a; }

      /* Section panel */
      .val-section {
        background: #1a1d27;
        border: 1px solid rgba(255,255,255,0.07);
        border-radius: 6px;
        overflow: hidden;
      }
      .val-section-header {
        padding: 10px 16px;
        border-bottom: 1px solid rgba(255,255,255,0.06);
        font-size: 0.73rem;
        font-weight: 700;
        color: #9fa7b3;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 8px;
        user-select: none;
        cursor: pointer;
      }
      .val-section-header .mdi { font-size: 1rem; }
      .val-section-header .badge {
        margin-left: auto;
        background: rgba(255,255,255,0.08);
        border-radius: 12px;
        padding: 1px 9px;
        font-size: 0.68rem;
        color: #ccc;
        font-weight: 600;
      }
      .val-section-body {
        overflow: hidden;
      }

      /* Issue table */
      .issue-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.83rem;
      }
      .issue-table th {
        text-align: left;
        padding: 8px 16px;
        background: rgba(255,255,255,0.03);
        color: #9fa7b3;
        font-weight: 600;
        font-size: 0.71rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 1px solid rgba(255,255,255,0.05);
      }
      .issue-table td {
        padding: 9px 16px;
        border-bottom: 1px solid rgba(255,255,255,0.04);
        color: #d0d5e0;
        vertical-align: middle;
      }
      .issue-table tr:last-child td { border-bottom: none; }
      .issue-table tr:hover td { background: rgba(255,255,255,0.025); }

      /* Severity pill */
      .severity {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 9px;
        border-radius: 12px;
        font-size: 0.69rem;
        font-weight: 700;
        text-transform: uppercase;
        white-space: nowrap;
      }
      .sev-erro   { background: rgba(224,82,82,0.18);  color: #f07070; border: 1px solid rgba(224,82,82,0.35); }
      .sev-aviso  { background: rgba(224,161,50,0.18); color: #f0b84a; border: 1px solid rgba(224,161,50,0.35); }
      .sev-info   { background: rgba(82,148,226,0.18); color: #6dabee; border: 1px solid rgba(82,148,226,0.35); }

      /* Person link */
      .person-link {
        color: #7eb8f7;
        text-decoration: none;
        font-weight: 500;
      }
      .person-link:hover { text-decoration: underline; }

      /* Empty state */
      .empty-state {
        padding: 32px 16px;
        text-align: center;
        color: #556;
        font-size: 0.88rem;
      }
      .empty-state .mdi { font-size: 2rem; display: block; margin-bottom: 8px; color: #52c47a; }

      /* Toolbar */
      .val-toolbar {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }
      .filter-btn {
        padding: 5px 14px;
        border-radius: 18px;
        border: 1px solid rgba(255,255,255,0.1);
        background: transparent;
        color: #9fa7b3;
        font-size: 0.78rem;
        cursor: pointer;
        transition: background 0.15s, color 0.15s;
      }
      .filter-btn.active {
        background: rgba(82,148,226,0.18);
        color: #7eb8f7;
        border-color: rgba(82,148,226,0.4);
      }
      .filter-btn:hover:not(.active) { background: rgba(255,255,255,0.05); color: #ccc; }

      .run-btn {
        margin-left: auto;
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 16px;
        border-radius: 6px;
        border: none;
        background: #5294e2;
        color: #fff;
        font-size: 0.82rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.15s;
      }
      .run-btn:hover { background: #3d7cc9; }

      @media (max-width: 700px) {
        .val-kpi-row { grid-template-columns: repeat(2, 1fr); }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <aside class="sidebar">
        <a href="index.html" class="logo"><i class="mdi mdi-tree" aria-hidden="true"></i><span>myLineage</span></a>
        <nav>
          <a href="app.html"><i class="mdi mdi-account-multiple" aria-hidden="true"></i>Cadastro</a>
          <a href="indicadores.html"><i class="mdi mdi-chart-bar" aria-hidden="true"></i>Indicadores</a>
          <a href="arvore.html"><i class="mdi mdi-sitemap" aria-hidden="true"></i>Árvore</a>
          <a href="gedcom.html"><i class="mdi mdi-dna" aria-hidden="true"></i>GEDCOM</a>
          <a href="album.html"><i class="mdi mdi-image-multiple" aria-hidden="true"></i>Álbum</a>
          <a href="documentos.html"><i class="mdi mdi-folder-open" aria-hidden="true"></i>Documentos</a>
          <a href="validacao.html" class="active"><i class="mdi mdi-shield-check" aria-hidden="true"></i>Validação</a>
        </nav>
        <div class="sidebar-footer">
          <a href="apis.html"><i class="mdi mdi-api" aria-hidden="true"></i>APIs</a>
          <a href="configuracao.html"><i class="mdi mdi-cog" aria-hidden="true"></i>Definições</a>
        </div>
      </aside>

      <main class="content val-content">
        <div class="topbar">
          <div style="display:flex;align-items:center;gap:12px">
            <h1>Validação de Dados</h1>
          </div>
        </div>

        <div class="val-grid">
          <!-- KPI Summary -->
          <div class="val-kpi-row" id="kpiRow">
            <div class="kpi-card kpi-erro">
              <div class="kpi-label">Erros</div>
              <div class="kpi-value" id="kpiErros">–</div>
              <div class="kpi-sub">impacto crítico</div>
            </div>
            <div class="kpi-card kpi-aviso">
              <div class="kpi-label">Avisos</div>
              <div class="kpi-value" id="kpiAvisos">–</div>
              <div class="kpi-sub">requer atenção</div>
            </div>
            <div class="kpi-card kpi-info">
              <div class="kpi-label">Informações</div>
              <div class="kpi-value" id="kpiInfos">–</div>
              <div class="kpi-sub">boa prática</div>
            </div>
            <div class="kpi-card kpi-ok">
              <div class="kpi-label">Pessoas</div>
              <div class="kpi-value" id="kpiPessoas">–</div>
              <div class="kpi-sub">registos analisados</div>
            </div>
          </div>

          <!-- Toolbar -->
          <div class="val-toolbar">
            <button class="filter-btn active" data-filter="all" onclick="setFilter('all',this)">Todos</button>
            <button class="filter-btn" data-filter="erro" onclick="setFilter('erro',this)"><i class="mdi mdi-alert-circle-outline"></i> Erros</button>
            <button class="filter-btn" data-filter="aviso" onclick="setFilter('aviso',this)"><i class="mdi mdi-alert-outline"></i> Avisos</button>
            <button class="filter-btn" data-filter="info" onclick="setFilter('info',this)"><i class="mdi mdi-information-outline"></i> Informações</button>
            <button class="filter-btn" data-filter="funcional" onclick="setFilter('funcional',this)">Funcional</button>
            <button class="filter-btn" data-filter="tecnico" onclick="setFilter('tecnico',this)">Técnico</button>
            <button class="run-btn" onclick="runValidation()"><i class="mdi mdi-refresh"></i> Executar Análise</button>
          </div>

          <!-- Functional Issues Section -->
          <div class="val-section" id="sectionFuncional">
            <div class="val-section-header" onclick="toggleSection('bodyFuncional','arrowFuncional')">
              <i class="mdi mdi-account-group-outline"></i>
              Inconsistências Funcionais
              <span style="font-size:0.7rem;font-weight:400;color:#666;text-transform:none;letter-spacing:0;margin-left:4px;">Impacto na apresentação e navegação da família</span>
              <span class="badge" id="badgeFuncional">0</span>
              <i class="mdi mdi-chevron-down" id="arrowFuncional" style="margin-left:4px;transition:transform 0.2s;"></i>
            </div>
            <div class="val-section-body" id="bodyFuncional">
              <div class="empty-state"><i class="mdi mdi-check-circle-outline"></i>Sem problemas funcionais encontrados</div>
            </div>
          </div>

          <!-- Technical Issues Section -->
          <div class="val-section" id="sectionTecnico">
            <div class="val-section-header" onclick="toggleSection('bodyTecnico','arrowTecnico')">
              <i class="mdi mdi-wrench-outline"></i>
              Inconsistências Técnicas
              <span style="font-size:0.7rem;font-weight:400;color:#666;text-transform:none;letter-spacing:0;margin-left:4px;">Integridade dos dados armazenados</span>
              <span class="badge" id="badgeTecnico">0</span>
              <i class="mdi mdi-chevron-down" id="arrowTecnico" style="margin-left:4px;transition:transform 0.2s;"></i>
            </div>
            <div class="val-section-body" id="bodyTecnico">
              <div class="empty-state"><i class="mdi mdi-check-circle-outline"></i>Sem problemas técnicos encontrados</div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
    // ── Data helpers ────────────────────────────────────────────────────────
    function getPeople()    { try{ const r=localStorage.getItem('people:myLineage');    return r?JSON.parse(r):[]; }catch(e){ return []; } }
    function getRelations() { try{ const r=localStorage.getItem('relations:myLineage'); return r?JSON.parse(r):[]; }catch(e){ return []; } }
    function getEvents()    { try{ const r=localStorage.getItem('events:myLineage');    return r?JSON.parse(r):[]; }catch(e){ return []; } }

    function personName(p){ return (((p.firstName||'')+' '+(p.lastName||'')).trim()) || ('<id:'+p.id+'>'); }
    function personLink(p){ const n=personName(p); const id=p.id.replace(/\\/g,'\\\\').replace(/'/g,"\\'"); return `<a class="person-link" href="#" onclick="event.preventDefault();openDrawer('edit','${id}')" title="Editar Pessoa">${esc(n)}</a>`; }
    function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    // Parse a rough year from an event with dateYear / date fields
    function eventYear(ev){
      if(ev.dateYear) return parseInt(ev.dateYear,10);
      if(ev.date){ const m=String(ev.date).match(/^(\d{4})/); if(m) return parseInt(m[1],10); }
      return null;
    }

    // ── Filter state ─────────────────────────────────────────────────────────
    let currentFilter = 'all';
    function setFilter(f, btn){
      currentFilter = f;
      document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      renderTables();
    }

    // ── Section toggle ────────────────────────────────────────────────────────
    function toggleSection(bodyId, arrowId){
      const body  = document.getElementById(bodyId);
      const arrow = document.getElementById(arrowId);
      const hidden = body.style.display === 'none';
      body.style.display = hidden ? '' : 'none';
      if(arrow) arrow.style.transform = hidden ? '' : 'rotate(-90deg)';
    }

    // ── Global issues storage ─────────────────────────────────────────────────
    let allIssues = [];

    // ── Main validation engine ────────────────────────────────────────────────
    function runValidation(){
      const people    = getPeople();
      const relations = getRelations();
      const events    = getEvents();
      const issues    = [];

      // Active (non-deleted) people map
      const active = people.filter(p => !p.deletedAt);
      const activeIds = new Set(active.map(p=>String(p.id)));
      const peopleMap = {};
      people.forEach(p=>{ peopleMap[String(p.id)]=p; });

      // Active events
      const activeEvents = events.filter(e=>!e.deletedAt);

      // ── Functional checks ─────────────────────────────────────────────────

      // F1 – Person without first name or only `<desconhecido>`
      active.forEach(p=>{
        const fn=(p.firstName||'').trim();
        const ln=(p.lastName||'').trim();
        const isUnknown = fn==='<desconhecido>'||fn==='desconhecido'||fn==='';
        if(isUnknown){
          issues.push({
            tipo:'funcional', severidade:'aviso',
            codigo:'F1',
            titulo:'Pessoa sem nome identificado',
            descricao:`A pessoa <b>${esc(fn||ln||'(sem nome)')}</b> não tem nome definido. Pode comprometer a apresentação na árvore.`,
            pessoa: p,
            sugestao:'Atualizar o nome no Cadastro.'
          });
        }
      });

      // F2 – Person without gender
      active.forEach(p=>{
        if(!p.gender||p.gender===''){
          issues.push({
            tipo:'funcional', severidade:'info',
            codigo:'F2',
            titulo:'Género não definido',
            descricao:`${personLink(p)} não tem género definido. A árvore usa o género para colorir e posicionar nós.`,
            pessoa: p,
            sugestao:'Definir o género (Masculino / Feminino) no Cadastro.'
          });
        }
      });

      // F3 – Child without any parent
      active.forEach(p=>{
        const ancestors = relations.filter(r=>String(r.from)===String(p.id)&&r.type==='ancestor'&&activeIds.has(String(r.to)));
        const isRoot = relations.filter(r=>String(r.to)===String(p.id)&&r.type==='child'&&activeIds.has(String(r.from))).length === 0;
        // Only flag if they also have no ancestor relations at all AND are not an orphan root consciously
        if(ancestors.length===0 && isRoot){
          // Has at least one child or sibling? Then flagging as isolated root could be noise; only flag if completely isolated
          const hasSomething = relations.some(r=>(String(r.from)===String(p.id)||String(r.to)===String(p.id))&&activeIds.has(String(r.from))&&activeIds.has(String(r.to)));
          if(!hasSomething && active.length > 1){
            issues.push({
              tipo:'funcional', severidade:'info',
              codigo:'F3',
              titulo:'Pessoa sem ligações familiares',
              descricao:`${personLink(p)} não tem qualquer relação com outros membros. Não aparecerá na árvore.`,
              pessoa: p,
              sugestao:'Adicionar relações (progenitor, filho, irmão ou cônjuge) no Cadastro.'
            });
          }
        }
      });

      // F4 – More than 2 parents
      active.forEach(p=>{
        const parents = relations.filter(r=>String(r.from)===String(p.id)&&r.type==='ancestor'&&activeIds.has(String(r.to)));
        if(parents.length>2){
          issues.push({
            tipo:'funcional', severidade:'erro',
            codigo:'F4',
            titulo:'Mais de 2 progenitores',
            descricao:`${personLink(p)} tem ${parents.length} progenitores registados. Uma pessoa não pode ter mais de 2 progenitores biológicos.`,
            pessoa: p,
            sugestao:'Revisar e remover relações de ascendência redundantes.'
          });
        }
      });

      // F5 – Birth after death
      active.forEach(p=>{
        const births = activeEvents.filter(e=>String(e.personId)===String(p.id)&&e.type==='BIRTH');
        const deaths = activeEvents.filter(e=>String(e.personId)===String(p.id)&&e.type==='DEATH');
        births.forEach(b=>{
          deaths.forEach(d=>{
            const by=eventYear(b), dy=eventYear(d);
            if(by!==null&&dy!==null&&by>dy){
              issues.push({
                tipo:'funcional', severidade:'erro',
                codigo:'F5',
                titulo:'Data de nascimento posterior à morte',
                descricao:`${personLink(p)} tem nascimento em <b>${by}</b> mas morte em <b>${dy}</b>.`,
                pessoa: p,
                sugestao:'Corrigir as datas dos eventos de nascimento ou morte.'
              });
            }
          });
        });
      });

      // F6 – Birth in the future
      const currentYear = new Date().getFullYear();
      active.forEach(p=>{
        const births = activeEvents.filter(e=>String(e.personId)===String(p.id)&&e.type==='BIRTH');
        births.forEach(b=>{
          const by=eventYear(b);
          if(by!==null&&by>currentYear){
            issues.push({
              tipo:'funcional', severidade:'aviso',
              codigo:'F6',
              titulo:'Nascimento no futuro',
              descricao:`${personLink(p)} tem data de nascimento em <b>${by}</b>, que é posterior ao ano atual (${currentYear}).`,
              pessoa: p,
              sugestao:'Verificar se o ano foi introduzido corretamente.'
            });
          }
        });
      });

      // F7 – Age over 120 years
      active.forEach(p=>{
        const births = activeEvents.filter(e=>String(e.personId)===String(p.id)&&e.type==='BIRTH');
        const deaths = activeEvents.filter(e=>String(e.personId)===String(p.id)&&e.type==='DEATH');
        const isAlive = deaths.length===0;
        births.forEach(b=>{
          const by=eventYear(b);
          if(by!==null){
            const age = isAlive ? currentYear-by : null;
            if(age!==null&&age>120){
              issues.push({
                tipo:'funcional', severidade:'aviso',
                codigo:'F7',
                titulo:'Idade implausível (> 120 anos)',
                descricao:`${personLink(p)} nasceu em <b>${by}</b> e não tem registo de falecimento, o que implicaria ${age} anos de vida.`,
                pessoa: p,
                sugestao:'Verificar se falta registar um evento de falecimento.'
              });
            }
          }
        });
      });

      // F8 – Child born before parent
      active.forEach(p=>{
        const childBirths = activeEvents.filter(e=>String(e.personId)===String(p.id)&&e.type==='BIRTH');
        const childYear = childBirths.length>0?eventYear(childBirths[0]):null;
        if(childYear===null) return;
        const parents = relations.filter(r=>String(r.from)===String(p.id)&&r.type==='ancestor'&&activeIds.has(String(r.to)));
        parents.forEach(rel=>{
          const par=peopleMap[String(rel.to)];
          if(!par||par.deletedAt) return;
          const parBirths=activeEvents.filter(e=>String(e.personId)===String(par.id)&&e.type==='BIRTH');
          if(!parBirths.length) return;
          const parYear=eventYear(parBirths[0]);
          if(parYear===null) return;
          if(childYear<=parYear){
            issues.push({
              tipo:'funcional', severidade:'erro',
              codigo:'F8',
              titulo:'Filho nascido antes do progenitor',
              descricao:`${personLink(p)} (nascimento <b>${childYear}</b>) foi registado como filho de ${personLink(par)} (nascimento <b>${parYear}</b>).`,
              pessoa: p,
              sugestao:'Verificar as datas ou a relação de descendência.'
            });
          } else if(childYear-parYear<13){
            issues.push({
              tipo:'funcional', severidade:'aviso',
              codigo:'F8b',
              titulo:'Progenitor com idade improvável ao nascimento do filho',
              descricao:`${personLink(par)} teria apenas <b>${childYear-parYear} anos</b> quando ${personLink(p)} nasceu.`,
              pessoa: par,
              sugestao:'Verificar as datas ou a relação de descendência.'
            });
          }
        });
      });

      // F9 – Multiple birth or death events
      active.forEach(p=>{
        ['BIRTH','DEATH'].forEach(evType=>{
          const evs=activeEvents.filter(e=>String(e.personId)===String(p.id)&&e.type===evType);
          if(evs.length>1){
            issues.push({
              tipo:'funcional', severidade:'aviso',
              codigo:'F9',
              titulo:`Múltiplos eventos de ${evType==='BIRTH'?'nascimento':'falecimento'}`,
              descricao:`${personLink(p)} tem <b>${evs.length}</b> eventos de ${evType==='BIRTH'?'nascimento':'falecimento'} registados.`,
              pessoa: p,
              sugestao:'Manter apenas um evento de nascimento e um de falecimento por pessoa.'
            });
          }
        });
      });

      // ── Technical checks ──────────────────────────────────────────────────

      // T1 – Relations pointing to non-existent people
      relations.forEach((r,idx)=>{
        const fromExists = !!peopleMap[String(r.from||'')];
        const toExists   = !!peopleMap[String(r.to||'')];
        if(!fromExists||!toExists){
          const srcLabel = fromExists ? esc(personName(peopleMap[String(r.from)]||{})) : `<span style="color:#f07070">${esc(String(r.from))}</span>`;
          const dstLabel = toExists   ? esc(personName(peopleMap[String(r.to)]||{}))   : `<span style="color:#f07070">${esc(String(r.to))}</span>`;
          issues.push({
            tipo:'tecnico', severidade:'erro',
            codigo:'T1',
            titulo:'Relação com ID inexistente',
            descricao:`Relação #${idx} (tipo <b>${esc(r.type)}</b>) referencia ${!fromExists?'origem':'destino'} <b>${!fromExists?srcLabel:dstLabel}</b> que não existe na base de dados.`,
            pessoa: null,
            sugestao:'Limpar relações órfãs. Exportar e reimportar via GEDCOM pode resolver.'
          });
        }
      });

      // T2 – Missing reciprocal relations
      const relSet = new Set(relations.map(r=>`${r.from}|${r.to}|${r.type}`));
      relations.forEach(r=>{
        if(!activeIds.has(String(r.from))||!activeIds.has(String(r.to))) return;
        let expectedType=null, label='';
        if(r.type==='child')    { expectedType='ancestor'; label='ancestor recíproco'; }
        if(r.type==='ancestor') { expectedType='child';    label='child recíproco'; }
        if(r.type==='mate')     { expectedType='mate';     label='mate recíproco'; }
        if(r.type==='siblin')   { expectedType='siblin';   label='siblin recíproco'; }
        if(!expectedType) return;
        const recip=`${r.to}|${r.from}|${expectedType}`;
        if(!relSet.has(recip)){
          const pA=peopleMap[String(r.from)], pB=peopleMap[String(r.to)];
          if(!pA||!pB||pA.deletedAt||pB.deletedAt) return;
          issues.push({
            tipo:'tecnico', severidade:'aviso',
            codigo:'T2',
            titulo:'Relação sem reciprocidade',
            descricao:`${personLink(pA)} → <b>${esc(r.type)}</b> → ${personLink(pB)}, mas falta o ${label} inverso.`,
            pessoa: pA,
            sugestao:'Reeditar a relação no Cadastro para regenerar os índices recíprocos.'
          });
        }
      });

      // T3 – Duplicate relations (same from/to/type)
      const seen = new Map();
      relations.forEach((r,idx)=>{
        const key=`${r.from}|${r.to}|${r.type}`;
        if(seen.has(key)){
          const pA=peopleMap[String(r.from)], pB=peopleMap[String(r.to)];
          if(pA&&pB&&!pA.deletedAt&&!pB.deletedAt)
            issues.push({
              tipo:'tecnico', severidade:'aviso',
              codigo:'T3',
              titulo:'Relação duplicada',
              descricao:`Existe mais de uma entrada para ${personLink(pA)} → <b>${esc(r.type)}</b> → ${personLink(pB)}.`,
              pessoa: pA,
              sugestao:'Remover entradas duplicadas na tabela de relações (poderá ser feito via exportação/importação GEDCOM).'
            });
        } else {
          seen.set(key,idx);
        }
      });

      // T4 – Duplicate person IDs
      const idCount = {};
      people.forEach(p=>{ idCount[String(p.id)]=(idCount[String(p.id)]||0)+1; });
      Object.entries(idCount).forEach(([id,count])=>{
        if(count>1){
          const p=peopleMap[id];
          issues.push({
            tipo:'tecnico', severidade:'erro',
            codigo:'T4',
            titulo:'ID de pessoa duplicado',
            descricao:`O ID <b>${esc(id)}</b> ${p?`(${esc(personName(p))}) `:''} aparece <b>${count}</b> vezes na lista de pessoas.`,
            pessoa: p||null,
            sugestao:'Exportar os dados, remover duplicados manualmente no JSON e reimportar.'
          });
        }
      });

      // T5 – Circular ancestry (A is ancestor of B and B is ancestor of A)
      const ancestorRels = relations.filter(r=>r.type==='ancestor'&&activeIds.has(String(r.from))&&activeIds.has(String(r.to)));
      ancestorRels.forEach(r=>{
        const reverse=ancestorRels.find(x=>String(x.from)===String(r.to)&&String(x.to)===String(r.from));
        if(reverse){
          const pA=peopleMap[String(r.from)], pB=peopleMap[String(r.to)];
          if(pA&&pB&&!pA.deletedAt&&!pB.deletedAt){
            // avoid duplicate alerts
            const alreadyFlagged=issues.some(i=>i.codigo==='T5'&&i.pessoa&&String(i.pessoa.id)===String(pB.id));
            if(!alreadyFlagged)
              issues.push({
                tipo:'tecnico', severidade:'erro',
                codigo:'T5',
                titulo:'Ciclo de ascendência',
                descricao:`${personLink(pA)} é ancestral de ${personLink(pB)} e vice-versa, formando um ciclo impossível.`,
                pessoa: pA,
                sugestao:'Rever a cadeia de ascendência e corrigir a relação incorreta.'
              });
          }
        }
      });

      // T6 – Events with no valid date (optional, info only)
      active.forEach(p=>{
        const evs=activeEvents.filter(e=>String(e.personId)===String(p.id)&&(e.type==='BIRTH'||e.type==='DEATH'));
        evs.forEach(ev=>{
          const y=eventYear(ev);
          if(y===null){
            issues.push({
              tipo:'tecnico', severidade:'info',
              codigo:'T6',
              titulo:'Evento sem data válida',
              descricao:`${personLink(p)} tem um evento de <b>${ev.type==='BIRTH'?'nascimento':'falecimento'}</b> sem data ou com data incompleta.`,
              pessoa: p,
              sugestao:'Preencher o ano no evento para ativar cálculos de idade e deteção de inconsistências.'
            });
          }
        });
      });

      allIssues = issues;
      updateKPIs(active.length);
      renderTables();
    }

    // ── Update KPI cards ──────────────────────────────────────────────────────
    function updateKPIs(totalPeople){
      const erros  = allIssues.filter(i=>i.severidade==='erro').length;
      const avisos = allIssues.filter(i=>i.severidade==='aviso').length;
      const infos  = allIssues.filter(i=>i.severidade==='info').length;
      document.getElementById('kpiErros').textContent   = erros;
      document.getElementById('kpiAvisos').textContent  = avisos;
      document.getElementById('kpiInfos').textContent   = infos;
      document.getElementById('kpiPessoas').textContent = totalPeople;
    }

    // ── Render issue tables ───────────────────────────────────────────────────
    function renderTables(){
      const filtered = filterIssues(allIssues, currentFilter);
      const funcional = filtered.filter(i=>i.tipo==='funcional');
      const tecnico   = filtered.filter(i=>i.tipo==='tecnico');

      document.getElementById('badgeFuncional').textContent = funcional.length;
      document.getElementById('badgeTecnico').textContent   = tecnico.length;

      document.getElementById('bodyFuncional').innerHTML = buildTable(funcional);
      document.getElementById('bodyTecnico').innerHTML   = buildTable(tecnico);
    }

    function filterIssues(issues, filter){
      if(filter==='all')       return issues;
      if(filter==='funcional') return issues.filter(i=>i.tipo==='funcional');
      if(filter==='tecnico')   return issues.filter(i=>i.tipo==='tecnico');
      return issues.filter(i=>i.severidade===filter);
    }

    function buildTable(issues){
      if(!issues.length){
        return '<div class="empty-state"><i class="mdi mdi-check-circle-outline"></i>Nenhum problema nesta categoria</div>';
      }
      let rows='';
      issues.forEach(issue=>{
        const sevClass = {erro:'sev-erro',aviso:'sev-aviso',info:'sev-info'}[issue.severidade]||'sev-info';
        const sevLabel = {erro:'Erro',aviso:'Aviso',info:'Info'}[issue.severidade]||'Info';
        const sevIcon  = {erro:'mdi-alert-circle-outline',aviso:'mdi-alert-outline',info:'mdi-information-outline'}[issue.severidade]||'mdi-information-outline';
        rows+=`<tr>
          <td style="width:90px;"><span class="severity ${sevClass}"><i class="mdi ${sevIcon}"></i>${sevLabel}</span></td>
          <td style="width:60px;color:#666;font-family:monospace;font-size:0.75rem;">${esc(issue.codigo)}</td>
          <td style="font-weight:600;color:#e0e4ef;">${esc(issue.titulo)}</td>
          <td>${issue.descricao}</td>
          <td style="color:#8a949e;font-size:0.78rem;">${esc(issue.sugestao)}</td>
        </tr>`;
      });
      return `<table class="issue-table">
        <thead><tr>
          <th>Severidade</th><th>Código</th><th>Problema</th><th>Detalhe</th><th>Sugestão</th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
    }

    // ── Init ──────────────────────────────────────────────────────────────────
    runValidation();
    </script>

    <!-- ── Drawer overlay ── -->
    <div class="drawer-overlay" id="drawerOverlay"></div>

    <!-- ── Person drawer ── -->
    <div class="drawer" id="personDrawer" role="dialog" aria-modal="true" aria-labelledby="drawerTitle">
      <div class="drawer-header">
        <button class="btn btn-ghost btn-sm" id="drawerBackBtn" style="display:none;padding:2px 6px;margin-right:4px;" title="Voltar"><i class="mdi mdi-arrow-left"></i></button>
        <h2 id="drawerTitle" style="flex:1;">Editar Pessoa</h2>
        <button class="drawer-close" id="drawerCloseBtn" aria-label="Fechar painel"><i class="mdi mdi-close"></i></button>
      </div>
      <div class="drawer-person-header" id="drawerPersonHeader">
        <div class="drawer-avatar" id="drawerAvatar"></div>
        <div>
          <div class="drawer-person-name" id="drawerPersonName">—</div>
          <div class="drawer-person-sub" id="drawerPersonSub"></div>
        </div>
      </div>
      <div class="drawer-body" id="drawerBody"></div>
      <div class="drawer-footer">
        <button class="btn btn-danger btn-sm" id="drawerDeleteBtn"><i class="mdi mdi-delete-outline"></i> Apagar</button>
        <button class="btn btn-ghost btn-sm" id="drawerCancelBtn">Cancelar</button>
        <button class="btn btn-sm" id="drawerSaveBtn"><i class="mdi mdi-content-save-outline"></i> Guardar</button>
      </div>
    </div>

    <!-- ── Drawer photo modal ── -->
    <div id="drawerPhotoModal" style="display:none;position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.72);align-items:flex-start;justify-content:center;z-index:600;overflow-y:auto;padding:24px 0;">
      <div style="background:var(--bg-card);padding:22px;border-radius:12px;max-width:1000px;width:96%;box-sizing:border-box;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <div style="font-weight:700">Visualizar Foto</div>
          <button onclick="_drawerClosePhotoModal()" class="btn">Fechar</button>
        </div>
        <div id="drawerModalImageWrapper" style="display:flex;align-items:center;justify-content:center;margin-bottom:16px;padding:8px;">
          <div id="drawerModalImageArea" style="max-width:100%;overflow:visible;"></div>
        </div>
        <div style="margin-bottom:8px;">
          <label style="font-weight:600;color:var(--text-secondary);display:block;margin-bottom:6px;">Notas da Foto</label>
          <textarea id="drawerPhotoNotesArea" style="width:100%;min-height:80px;padding:8px;border-radius:8px;border:1px solid rgba(163,163,255,0.08);background:rgba(35,40,58,0.7);color:var(--text-main);box-sizing:border-box;resize:vertical;"></textarea>
          <div id="drawerPhotoTaggedPeople" style="margin-top:8px;font-size:0.95rem;color:var(--text-main);"></div>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;">
          <button class="btn" onclick="_drawerSavePhotoNotes()">Salvar Notas</button>
        </div>
      </div>
    </div>

    <script>
      // ── Drawer: aliases and helpers ─────────────────────────────────────────
      function loadPeople(){ return getPeople(); }
      function savePeople(p){ localStorage.setItem('people:myLineage', JSON.stringify(p)); }
      function renderTable(){ runValidation(); }
      function _esc(s){ return esc(s); }
      function fmtEventDate(ev){
        if(!ev) return '';
        if(!ev.dateYear&&!ev.dateMonth&&!ev.dateDay){ if(!ev.date) return ''; const p=ev.date.split(/[-T]/); return p.length>=3?p[2]+'/'+p[1]+'/'+p[0]:ev.date; }
        const qualMap={'Antes de':'ant.','Depois de':'dep.','Cerca de':'c.'};
        const q=ev.dateQualifier&&ev.dateQualifier!=='Exatamente'?(qualMap[ev.dateQualifier]||ev.dateQualifier)+' ':'';
        let parts=[];
        if(ev.dateDay) parts.push(String(ev.dateDay).padStart(2,'0'));
        if(ev.dateMonth) parts.push(String(ev.dateMonth).padStart(2,'0'));
        if(ev.dateYear) parts.push(String(ev.dateYear));
        return q+(parts.length?parts.join('/'):'');
      }
      function getPhotos(){ try{ const r=localStorage.getItem('photos:myLineage'); return r?JSON.parse(r):[]; }catch(e){ return []; } }
      function getPhotoRelations(){ try{ const r=localStorage.getItem('photoRelations:myLineage'); return r?JSON.parse(r):{}; }catch(e){ return {}; } }
      function getThumbnailForPerson(pid){ try{ const rels=getPhotoRelations(); const photos=getPhotos(); const ids=rels[pid]||[]; if(Array.isArray(ids)&&ids.length){ for(const id of ids){ const ph=photos.find(p=>String(p.id)===String(id)); if(ph) return ph.originalDataUrl||ph.dataUrl||null; } } return null; }catch(e){ return null; } }

      // ── Drawer state & core ─────────────────────────────────────────────────
      let _drawerPersonId=null, _drawerMode='edit';

      function openDrawer(mode, personId){
        const _footer=document.querySelector('.drawer-footer');
        if(_footer) _footer.style.display='';
        const _backBtn=document.getElementById('drawerBackBtn');
        if(_backBtn){ _backBtn.style.display='none'; _backBtn._personId=null; }
        const _phdr=document.getElementById('drawerPersonHeader');
        if(_phdr) _phdr.style.display='';
        _drawerMode=mode;
        _drawerPersonId=personId?String(personId):null;
        const people=loadPeople();
        const person=personId?people.find(p=>String(p.id)===String(personId)):null;
        const drawer=document.getElementById('personDrawer');
        const overlay=document.getElementById('drawerOverlay');
        document.getElementById('drawerTitle').textContent=mode==='create'?'Nova Pessoa':'Editar Pessoa';
        const nameEl=document.getElementById('drawerPersonName');
        const subEl=document.getElementById('drawerPersonSub');
        const avatarEl=document.getElementById('drawerAvatar');
        if(person){
          const fullName=(((person.firstName||'')+' '+(person.lastName||'')).trim())||'(sem nome)';
          nameEl.textContent=fullName;
          let sub=[];
          const evAll=(function(){ try{ return JSON.parse(localStorage.getItem('events:myLineage')||'[]'); }catch(e){ return []; } })();
          const evB=evAll.find(e=>String(e.personId)===String(person.id)&&(e.type==='BIRTH'||e.type==='birth')&&!e.deletedAt);
          if(evB&&evB.date) sub.push('\u2605 '+evB.date);
          const evD=evAll.find(e=>String(e.personId)===String(person.id)&&(e.type==='DEATH'||e.type==='death')&&!e.deletedAt);
          if(evD&&evD.date) sub.push('\u271D '+evD.date);
          subEl.textContent=sub.join('  \u00b7  ');
          const thumb=getThumbnailForPerson(person.id);
          if(thumb){ avatarEl.style.backgroundImage='url('+thumb+')'; avatarEl.style.backgroundSize='cover'; avatarEl.style.backgroundPosition='center'; }
          else{ avatarEl.style.backgroundImage=''; const g=(person.gender||'').toLowerCase(); avatarEl.style.background=(g==='female'||g==='feminino'||g==='f')?'#e26aa6':(g==='male'||g==='masculino'||g==='m')?'#4493f8':'#9aa0a6'; }
        } else {
          nameEl.textContent='Nova Pessoa'; subEl.textContent='';
          avatarEl.style.backgroundImage=''; avatarEl.style.background='var(--bg-surface-2)';
        }
        const body=document.getElementById('drawerBody');
        const firstName=person?(person.firstName||''):'';
        const lastName=person?(person.lastName||''):'';
        const gender=person?(person.gender||''):'';
        const notes=person?(person.notes||''):'';
        body.innerHTML=[
          '<div class="drawer-section-label">Identidade</div>',
          '<div class="form-row">',
            '<div><label>Primeiro nome</label><input type="text" id="df_firstName" value="'+_esc(firstName)+'" placeholder="Nome" /></div>',
            '<div><label>Apelido</label><input type="text" id="df_lastName" value="'+_esc(lastName)+'" placeholder="Apelido" /></div>',
          '</div>',
          '<div><label>G\u00e9nero</label>',
            '<select id="df_gender">',
              '<option value=""'+(!gender?'selected':'')+'>\u200b(n/a)</option>',
              '<option value="male"'+(gender==='male'||gender==='masculino'||gender==='m'?'selected':'')+'>Masculino</option>',
              '<option value="female"'+(gender==='female'||gender==='feminino'||gender==='f'?'selected':'')+'>Feminino</option>',
            '</select></div>',
          '<div class="drawer-section-label" style="margin-top:8px;">Notas</div>',
          '<div><textarea id="df_notes" rows="3" placeholder="Notas...">'+_esc(notes)+'</textarea></div>',
          person?'<div style="margin-top:6px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;"><button class="btn btn-ghost btn-sm" style="font-size:0.82rem;" onclick="openDrawerSection(\''+person.id+'\',\'relacoes\')"><i class="mdi mdi-account-multiple-outline"></i> Rela\u00e7\u00f5es</button><button class="btn btn-ghost btn-sm" style="font-size:0.82rem;" onclick="openDrawerSection(\''+person.id+'\',\'eventos\')"><i class="mdi mdi-calendar-check-outline"></i> Eventos</button><button class="btn btn-ghost btn-sm" style="font-size:0.82rem;" onclick="openDrawerSection(\''+person.id+'\',\'fotos\')"><i class="mdi mdi-image-multiple-outline"></i> Fotos</button><button class="btn btn-ghost btn-sm" style="font-size:0.82rem;" onclick="_drawerShowAddPerson(\''+person.id+'\')" ><i class="mdi mdi-account-plus-outline"></i> Adicionar</button><button class="btn btn-ghost btn-sm" style="font-size:0.82rem;" onclick="_drawerShowLinkPerson(\''+person.id+'\')" ><i class="mdi mdi-link-variant"></i> Ligar</button></div>':''
        ].join('');
        drawer.classList.add('open');
        overlay.classList.add('open');
        setTimeout(()=>{ const fi=document.getElementById('df_firstName'); if(fi) fi.focus(); }, 50);
      }

      function closeDrawer(){
        document.getElementById('personDrawer').classList.remove('open');
        document.getElementById('drawerOverlay').classList.remove('open');
      }

      function openDrawerSection(personId, section){
        const people=loadPeople();
        const person=people.find(p=>String(p.id)===String(personId));
        if(!person) return;
        const footer=document.querySelector('.drawer-footer');
        if(footer) footer.style.display='none';
        const phdr=document.getElementById('drawerPersonHeader');
        if(phdr) phdr.style.display='none';
        const backBtn=document.getElementById('drawerBackBtn');
        if(backBtn){ backBtn.style.display=''; backBtn._personId=String(personId); }
        const sectionLabel=section==='relacoes'?'Rela\u00e7\u00f5es':section==='fotos'?'Fotos':'Eventos';
        const pName=(((person.firstName||'')+' '+(person.lastName||'')).trim())||'';
        document.getElementById('drawerTitle').textContent=sectionLabel+'\u2014 '+pName;
        const body=document.getElementById('drawerBody');
        body.innerHTML=section==='relacoes'?_renderDrawerRelations(String(personId),people):section==='fotos'?_renderDrawerPhotos(String(personId)):_renderDrawerEvents(String(personId));
      }

      function _drawerGetEvents(){ return getEvents(); }

      function _renderDrawerEvents(personId){
        const evs=_drawerGetEvents().filter(ev=>String(ev.personId)===personId&&!ev.deletedAt);
        const typeLabels={BIRTH:'Nascimento',BAPTISM:'Batismo',DEATH:'\u00d3bito',MARRIAGE:'Casamento',DIVORCE:'Div\u00f3rcio',ADOPTION:'Ado\u00e7\u00e3o',CUSTOM:'Outro'};
        let html=`<div style="margin-bottom:12px;"><button class="btn btn-sm" onclick="_drawerShowAddEvent('${_esc(personId)}')" style="font-size:0.83rem;"><i class="mdi mdi-plus"></i> Adicionar Evento</button></div>`;
        if(!evs.length){ html+='<div style="color:#888;padding:4px 0 12px;">Nenhum evento cadastrado.</div>'; return html; }
        html+='<div class="mini-list">';
        evs.forEach(ev=>{
          const label=typeLabels[(ev.type||'').toUpperCase()]||ev.type||'';
          html+=`<div class="mini-card" style="padding:10px 12px;"><div style="display:flex;justify-content:space-between;align-items:center;gap:8px;"><div style="flex:1;"><span style="font-weight:600;font-size:0.9rem;">${_esc(label)}</span><span style="color:#888;font-size:0.82rem;margin-left:8px;">${_esc(fmtEventDate(ev))}</span></div><div style="display:flex;gap:2px;flex-shrink:0;"><button onclick="_drawerShowEditEvent('${_esc(ev.id)}','${_esc(personId)}')" title="Editar" style="background:none;border:none;cursor:pointer;color:#4493f8;padding:2px 4px;font-size:1rem;line-height:1;"><i class="mdi mdi-pencil-outline"></i></button><button onclick="_drawerDeleteEvent('${_esc(ev.id)}','${_esc(personId)}')" title="Apagar" style="background:none;border:none;cursor:pointer;color:#e06060;padding:2px 4px;font-size:1rem;line-height:1;"><i class="mdi mdi-trash-can-outline"></i></button></div></div>${ev.location?`<div style="color:#aaa;font-size:0.82rem;margin-top:3px;">&#128205; ${_esc(ev.location)}</div>`:''}${ev.notes?`<div style="color:#bbb;font-size:0.82rem;margin-top:3px;">${_esc(ev.notes)}</div>`:''}</div>`;
        });
        html+='</div>';
        return html;
      }

      function _drawerDeleteEvent(eventId,personId){
        if(!confirm('Apagar este evento?')) return;
        let events=_drawerGetEvents();
        events=events.map(ev=>ev.id===eventId?{...ev,deletedAt:new Date().toISOString()}:ev);
        localStorage.setItem('events:myLineage',JSON.stringify(events));
        const body=document.getElementById('drawerBody');
        if(body) body.innerHTML=_renderDrawerEvents(personId);
      }

      function _drawerShowEditEvent(eventId,personId){
        const ev=_drawerGetEvents().find(e=>e.id===eventId);
        if(!ev){ alert('Evento n\u00e3o encontrado.'); return; }
        const body=document.getElementById('drawerBody');
        if(!body) return;
        const typeUp=(ev.type||'').toUpperCase();
        body.innerHTML=`<div style="padding:4px 0 8px;"><h3 style="font-size:0.95rem;margin:0 0 14px;color:var(--text-primary);">Editar Evento</h3><div class="form-group" style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Tipo</label><select id="editEvType" style="width:100%;"><option value="BIRTH"${typeUp==='BIRTH'?' selected':''}>Nascimento</option><option value="BAPTISM"${typeUp==='BAPTISM'?' selected':''}>Batismo</option><option value="DEATH"${typeUp==='DEATH'?' selected':''}>Óbito</option><option value="MARRIAGE"${typeUp==='MARRIAGE'?' selected':''}>Casamento</option><option value="DIVORCE"${typeUp==='DIVORCE'?' selected':""}}>Div\u00f3rcio</option><option value="ADOPTION"${typeUp==='ADOPTION'?' selected':''}>Ado\u00e7\u00e3o</option><option value="CUSTOM"${typeUp==='CUSTOM'||!typeUp?' selected':''}>Outro</option></select></div><div class="form-group" style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Data</label><select id="editEvQualifier" style="width:100%;margin-bottom:6px;"><option value="Exatamente"${(ev.dateQualifier||'Exatamente')==='Exatamente'?' selected':''}>Exatamente</option><option value="Antes de"${ev.dateQualifier==='Antes de'?' selected':''}>Antes de</option><option value="Depois de"${ev.dateQualifier==='Depois de'?' selected':''}>Depois de</option><option value="Cerca de"${ev.dateQualifier==='Cerca de'?' selected':''}>Cerca de</option></select><div style="display:flex;gap:6px;"><input id="editEvDay" type="number" min="1" max="31" placeholder="Dia" value="${ev.dateDay||''}" style="flex:1;min-width:0;text-align:center;" /><input id="editEvMonth" type="number" min="1" max="12" placeholder="M\u00eas" value="${ev.dateMonth||''}" style="flex:1;min-width:0;text-align:center;" /><input id="editEvYear" type="number" min="1" max="9999" placeholder="Ano" value="${ev.dateYear||''}" style="flex:2;min-width:0;text-align:center;" /></div></div><div class="form-group" style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Local</label><input id="editEvLocation" type="text" placeholder="Local do evento" value="${_esc(ev.location||'')}" style="width:100%;" /></div><div class="form-group" style="margin-bottom:14px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Notas</label><textarea id="editEvNotes" rows="3" style="width:100%;resize:vertical;">${_esc(ev.notes||'')}</textarea></div><div style="display:flex;gap:8px;justify-content:flex-end;"><button class="btn btn-ghost btn-sm" onclick="openDrawerSection('${_esc(personId)}','eventos')">Cancelar</button><button class="btn btn-sm" onclick="_drawerSaveEditEvent('${_esc(eventId)}','${_esc(personId)}')"><i class="mdi mdi-content-save-outline"></i> Guardar</button></div></div>`;
      }

      function _drawerSaveEditEvent(eventId,personId){
        const type=(document.getElementById('editEvType')||{}).value||'CUSTOM';
        const qualifier=(document.getElementById('editEvQualifier')||{}).value||'Exatamente';
        const day=parseInt((document.getElementById('editEvDay')||{}).value||'')||null;
        const month=parseInt((document.getElementById('editEvMonth')||{}).value||'')||null;
        const year=parseInt((document.getElementById('editEvYear')||{}).value||'')||null;
        if(!day&&!month&&!year){ alert('Preencha pelo menos um campo de data.'); return; }
        const location=((document.getElementById('editEvLocation')||{}).value||'').trim();
        const notes=((document.getElementById('editEvNotes')||{}).value||'').trim();
        let events=_drawerGetEvents();
        events=events.map(ev=>{
          if(ev.id!==eventId) return ev;
          const updated={...ev,type:type.toUpperCase(),dateQualifier:qualifier,updatedAt:new Date().toISOString()};
          delete updated.dateDay; delete updated.dateMonth; delete updated.dateYear;
          if(day) updated.dateDay=day;
          if(month) updated.dateMonth=month;
          if(year) updated.dateYear=year;
          updated.location=location||null; updated.notes=notes||null;
          return updated;
        });
        localStorage.setItem('events:myLineage',JSON.stringify(events));
        openDrawerSection(personId,'eventos');
      }

      function _renderDrawerRelations(personId,people){
        let relations=[];
        try{ relations=JSON.parse(localStorage.getItem('relations:myLineage')||'[]'); }catch(e){}
        const rels=relations.filter(r=>r&&String(r.from)===personId);
        const typeDesc={siblin:'Irm\u00e3o / Irm\u00e3',ancestor:'Pai / M\u00e3e',child:'Filho(a)',mate:'Companheiro(a)'};
        let html=`<div style="margin-bottom:12px;"><button class="btn btn-sm" onclick="_drawerShowAddRelation('${_esc(personId)}')" style="font-size:0.83rem;"><i class="mdi mdi-plus"></i> Adicionar Rela\u00e7\u00e3o</button></div>`;
        if(!rels.length){ html+='<div style="color:#888;padding:4px 0 12px;">Nenhuma rela\u00e7\u00e3o cadastrada.</div>'; return html; }
        html+='<div class="mini-list">';
        rels.forEach(r=>{
          const p=people.find(x=>x.id===r.to);
          let desc=typeDesc[r.type]||r.type||'';
          if(p){ const g=((p.gender||'')+'').toLowerCase(); const isFem=g==='female'||g==='feminino'||g==='f'; const isMal=g==='male'||g==='masculino'||g==='m'; if(desc.includes('Filho')) desc=isFem?'Filha':isMal?'Filho':'Filho(a)'; if(desc.includes('Pai')||desc.includes('M\u00e3e')) desc=isFem?'M\u00e3e':isMal?'Pai':'Pai / M\u00e3e'; if(desc.toLowerCase().includes('compan')) desc=isFem?'Companheira':isMal?'Companheiro':'Companheiro(a)'; if(desc.includes('Irm')) desc=isFem?'Irm\u00e3':isMal?'Irm\u00e3o':'Irm\u00e3o / Irm\u00e3'; }
          const name=p?(((p.firstName||'')+' '+(p.lastName||'')).trim()):r.to;
          html+=`<div class="mini-card" style="padding:10px 12px;"><div style="display:flex;justify-content:space-between;align-items:center;gap:8px;"><div style="flex:1;"><span style="font-weight:600;font-size:0.9rem;">${_esc(name)}</span><span style="color:#aaa;font-size:0.82rem;margin-left:8px;">${_esc(desc)}</span></div><button onclick="_drawerDeleteRelation('${_esc(personId)}','${_esc(r.to)}','${_esc(r.type)}')" title="Apagar" style="background:none;border:none;cursor:pointer;color:#e06060;padding:2px 4px;font-size:1rem;line-height:1;flex-shrink:0;"><i class="mdi mdi-trash-can-outline"></i></button></div></div>`;
        });
        html+='</div>';
        return html;
      }

      function _drawerShowAddRelation(personId){
        const people=loadPeople().filter(p=>!p.deletedAt&&String(p.id)!==String(personId));
        const body=document.getElementById('drawerBody');
        if(!body) return;
        const opts=people.map(p=>{ const name=(((p.firstName||'')+' '+(p.lastName||'')).trim())||p.id; return `<option value="${_esc(String(p.id))}">${_esc(name)}</option>`; }).join('');
        body.innerHTML=`<div style="padding:4px 0 8px;"><h3 style="font-size:0.95rem;margin:0 0 14px;">Nova Rela\u00e7\u00e3o</h3><div class="form-group" style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Tipo de rela\u00e7\u00e3o</label><select id="addRelType" style="width:100%;"><option value="ancestor">Pai / M\u00e3e</option><option value="child">Filho(a)</option><option value="mate">Companheiro(a)</option><option value="siblin">Irm\u00e3o / Irm\u00e3</option></select></div><div class="form-group" style="margin-bottom:14px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Pessoa</label><select id="addRelTo" style="width:100%;">${opts||'<option disabled>Nenhuma pessoa dispon\u00edvel</option>'}</select></div><div style="display:flex;gap:8px;justify-content:flex-end;"><button class="btn btn-ghost btn-sm" onclick="openDrawerSection('${_esc(personId)}','relacoes')">Cancelar</button><button class="btn btn-sm" onclick="_drawerSaveNewRelation('${_esc(personId)}')"><i class="mdi mdi-content-save-outline"></i> Guardar</button></div></div>`;
      }

      function _drawerSaveNewRelation(personId){
        const toId=(document.getElementById('addRelTo')||{}).value||'';
        const type=(document.getElementById('addRelType')||{}).value||'mate';
        if(!toId){ alert('Seleciona uma pessoa.'); return; }
        let relations=[];
        try{ relations=JSON.parse(localStorage.getItem('relations:myLineage')||'[]'); }catch(e){}
        const already=relations.some(r=>String(r.from)===String(personId)&&String(r.to)===String(toId)&&String(r.type)===String(type));
        if(already){ alert('Esta rela\u00e7\u00e3o j\u00e1 existe.'); return; }
        relations.push({from:String(personId),to:String(toId),type});
        const revType=type==='ancestor'?'child':type==='child'?'ancestor':type;
        const alreadyRev=relations.some(r=>String(r.from)===String(toId)&&String(r.to)===String(personId)&&String(r.type)===revType);
        if(!alreadyRev) relations.push({from:String(toId),to:String(personId),type:revType});
        localStorage.setItem('relations:myLineage',JSON.stringify(relations));
        openDrawerSection(personId,'relacoes');
      }

      function _drawerDeleteRelation(fromId,toId,relType){
        if(!confirm('Apagar esta rela\u00e7\u00e3o?')) return;
        let relations=[];
        try{ relations=JSON.parse(localStorage.getItem('relations:myLineage')||'[]'); }catch(e){}
        relations=relations.filter(r=>!(String(r.from)===String(fromId)&&String(r.to)===String(toId)&&String(r.type)===String(relType)));
        const reverseType=relType==='ancestor'?'child':relType==='child'?'ancestor':relType;
        relations=relations.filter(r=>!(String(r.from)===String(toId)&&String(r.to)===String(fromId)&&String(r.type)===reverseType));
        localStorage.setItem('relations:myLineage',JSON.stringify(relations));
        const body=document.getElementById('drawerBody');
        if(body) body.innerHTML=_renderDrawerRelations(fromId,loadPeople());
      }

      function _drawerShowAddEvent(personId){
        const body=document.getElementById('drawerBody');
        if(!body) return;
        body.innerHTML=`<div style="padding:4px 0 8px;"><h3 style="font-size:0.95rem;margin:0 0 14px;">Novo Evento</h3><div class="form-group" style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Tipo</label><select id="addEvType" style="width:100%;"><option value="BIRTH">Nascimento</option><option value="BAPTISM">Batismo</option><option value="DEATH">\u00d3bito</option><option value="MARRIAGE">Casamento</option><option value="DIVORCE">Div\u00f3rcio</option><option value="ADOPTION">Ado\u00e7\u00e3o</option><option value="CUSTOM">Outro</option></select></div><div class="form-group" style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Data</label><select id="addEvQualifier" style="width:100%;margin-bottom:6px;"><option value="Exatamente" selected>Exatamente</option><option value="Antes de">Antes de</option><option value="Depois de">Depois de</option><option value="Cerca de">Cerca de</option></select><div style="display:flex;gap:6px;"><input id="addEvDay" type="number" min="1" max="31" placeholder="Dia" style="flex:1;min-width:0;text-align:center;" /><input id="addEvMonth" type="number" min="1" max="12" placeholder="M\u00eas" style="flex:1;min-width:0;text-align:center;" /><input id="addEvYear" type="number" min="1" max="9999" placeholder="Ano" style="flex:2;min-width:0;text-align:center;" /></div></div><div class="form-group" style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Local</label><input id="addEvLocation" type="text" placeholder="Local do evento" style="width:100%;" /></div><div class="form-group" style="margin-bottom:14px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Notas</label><textarea id="addEvNotes" rows="3" style="width:100%;resize:vertical;"></textarea></div><div style="display:flex;gap:8px;justify-content:flex-end;"><button class="btn btn-ghost btn-sm" onclick="openDrawerSection('${_esc(personId)}','eventos')">Cancelar</button><button class="btn btn-sm" onclick="_drawerSaveNewEvent('${_esc(personId)}')"><i class="mdi mdi-content-save-outline"></i> Guardar</button></div></div>`;
      }

      function _drawerSaveNewEvent(personId){
        const type=(document.getElementById('addEvType')||{}).value||'CUSTOM';
        const qualifier=(document.getElementById('addEvQualifier')||{}).value||'Exatamente';
        const day=parseInt((document.getElementById('addEvDay')||{}).value||'')||null;
        const month=parseInt((document.getElementById('addEvMonth')||{}).value||'')||null;
        const year=parseInt((document.getElementById('addEvYear')||{}).value||'')||null;
        if(!day&&!month&&!year){ alert('Preencha pelo menos um campo de data.'); return; }
        const location=((document.getElementById('addEvLocation')||{}).value||'').trim();
        const notes=((document.getElementById('addEvNotes')||{}).value||'').trim();
        let events=_drawerGetEvents();
        const newEv={id:'ev_'+Date.now(),personId:String(personId),type:type.toUpperCase(),dateQualifier:qualifier};
        if(day) newEv.dateDay=day;
        if(month) newEv.dateMonth=month;
        if(year) newEv.dateYear=year;
        if(location) newEv.location=location;
        if(notes) newEv.notes=notes;
        events.push(newEv);
        localStorage.setItem('events:myLineage',JSON.stringify(events));
        openDrawerSection(personId,'eventos');
      }

      function _drawerShowAddPerson(personId){
        const people=loadPeople();
        const person=people.find(p=>String(p.id)===String(personId));
        if(!person) return;
        let relations=[];
        try{ relations=JSON.parse(localStorage.getItem('relations:myLineage')||'[]'); }catch(e){}
        const parentCount=relations.filter(r=>String(r.from)===String(personId)&&r.type==='ancestor').length;
        const footer=document.querySelector('.drawer-footer');
        if(footer) footer.style.display='none';
        const phdr=document.getElementById('drawerPersonHeader');
        if(phdr) phdr.style.display='none';
        const backBtn=document.getElementById('drawerBackBtn');
        if(backBtn){ backBtn.style.display=''; backBtn._personId=String(personId); }
        const pName=(((person.firstName||'')+' '+(person.lastName||'')).trim())||'';
        document.getElementById('drawerTitle').textContent='Adicionar \u2014 '+pName;
        const body=document.getElementById('drawerBody');
        if(!body) return;
        let kinshipOpts=`<option value="sibling_male">Irm\u00e3o</option><option value="sibling_female">Irm\u00e3</option><option value="child_male">Filho</option><option value="child_female">Filha</option>`;
        if(parentCount<2) kinshipOpts+=`<option value="ancestor_male">Pai</option><option value="ancestor_female">M\u00e3e</option>`;
        kinshipOpts+=`<option value="mate_male">Companheiro</option><option value="mate_female">Companheira</option>`;
        body.innerHTML=`<div style="padding:4px 0 8px;"><h3 style="font-size:0.95rem;margin:0 0 14px;">Nova Pessoa</h3><div class="form-group" style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Grau de parentesco</label><select id="addPersKinship" style="width:100%;" onchange="_drawerUpdateCoParentSection('${_esc(personId)}')">${kinshipOpts}</select></div><div id="addPersCoParentSection" class="form-group" style="margin-bottom:10px;display:none;"></div><div class="form-group" style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Primeiro nome</label><input id="addPersFirstName" type="text" placeholder="Nome" style="width:100%;" /></div><div class="form-group" style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Apelido</label><input id="addPersLastName" type="text" placeholder="Apelido" style="width:100%;" /></div><div class="form-group" style="margin-bottom:14px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Notas</label><textarea id="addPersNotes" rows="2" style="width:100%;resize:vertical;"></textarea></div><div style="display:flex;gap:8px;justify-content:flex-end;"><button class="btn btn-ghost btn-sm" onclick="openDrawer('edit','${_esc(personId)}')">Cancelar</button><button class="btn btn-sm" onclick="_drawerSaveNewPerson('${_esc(personId)}')"><i class="mdi mdi-content-save-outline"></i> Guardar</button></div></div>`;
        setTimeout(()=>{ const fi=document.getElementById('addPersFirstName'); if(fi) fi.focus(); },50);
      }

      function _drawerUpdateCoParentSection(personId){
        const kinship=(document.getElementById('addPersKinship')||{}).value||'';
        const section=document.getElementById('addPersCoParentSection');
        if(!section) return;
        if(kinship!=='child_male'&&kinship!=='child_female'){ section.style.display='none'; section.innerHTML=''; return; }
        let relations=[];
        try{ relations=JSON.parse(localStorage.getItem('relations:myLineage')||'[]'); }catch(e){}
        const mates=relations.filter(r=>String(r.from)===String(personId)&&r.type==='mate');
        if(mates.length<=1){ section.style.display='none'; section.innerHTML=''; return; }
        const people=loadPeople();
        const opts=mates.map(r=>{ const p=people.find(x=>String(x.id)===String(r.to)); const name=p?(((p.firstName||'')+' '+(p.lastName||'')).trim())||p.id:r.to; return `<option value="${_esc(String(r.to))}">${_esc(name)}</option>`; }).join('');
        section.innerHTML=`<label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Outro progenitor</label><select id="addPersCoParent" style="width:100%;">${opts}</select>`;
        section.style.display='block';
      }

      function _drawerSaveNewPerson(personId){
        const kinship=((document.getElementById('addPersKinship')||{}).value||'');
        const firstName=((document.getElementById('addPersFirstName')||{}).value||'').trim();
        const lastName=((document.getElementById('addPersLastName')||{}).value||'').trim();
        const notes=((document.getElementById('addPersNotes')||{}).value||'').trim();
        if(!firstName&&!lastName){ alert('Introduza pelo menos um nome.'); return; }
        let gender='',relType='';
        if(kinship==='sibling_male'){ gender='male'; relType='siblin'; }
        else if(kinship==='sibling_female'){ gender='female'; relType='siblin'; }
        else if(kinship==='child_male'){ gender='male'; relType='child'; }
        else if(kinship==='child_female'){ gender='female'; relType='child'; }
        else if(kinship==='ancestor_male'){ gender='male'; relType='ancestor'; }
        else if(kinship==='ancestor_female'){ gender='female'; relType='ancestor'; }
        else if(kinship==='mate_male'){ gender='male'; relType='mate'; }
        else if(kinship==='mate_female'){ gender='female'; relType='mate'; }
        let people=loadPeople();
        const newId='p_'+Date.now();
        people.push({id:newId,firstName,lastName,gender,notes,createdAt:new Date().toISOString()});
        savePeople(people);
        if(relType){
          let relations=[];
          try{ relations=JSON.parse(localStorage.getItem('relations:myLineage')||'[]'); }catch(e){}
          relations.push({from:String(personId),to:String(newId),type:relType});
          if(relType==='siblin') relations.filter(r=>String(r.from)===String(personId)&&r.type==='ancestor').forEach(r=>{ relations.push({from:String(newId),to:String(r.to),type:'ancestor'}); });
          if(relType==='ancestor'){
            relations.push({from:String(newId),to:String(personId),type:'child'});
            const existingParents=relations.filter(r=>String(r.from)===String(personId)&&r.type==='ancestor'&&String(r.to)!==String(newId));
            if(existingParents.length===0){ const autoGender=(gender==='male')?'female':'male'; const autoId='p_auto_'+Date.now(); people.push({id:autoId,firstName:'<desconhecido>',lastName:'',gender:autoGender,notes:'',createdAt:new Date().toISOString()}); savePeople(people); relations.push({from:String(personId),to:String(autoId),type:'ancestor'}); relations.push({from:String(autoId),to:String(personId),type:'child'}); relations.push({from:String(newId),to:String(autoId),type:'mate'}); relations.push({from:String(autoId),to:String(newId),type:'mate'}); }
            else{ const existingParentId=existingParents[0].to; relations.push({from:String(newId),to:String(existingParentId),type:'mate'}); relations.push({from:String(existingParentId),to:String(newId),type:'mate'}); }
          }
          if(relType==='mate'){ relations.push({from:String(newId),to:String(personId),type:'mate'}); }
          if(relType==='child'){
            relations.push({from:String(newId),to:String(personId),type:'ancestor'});
            const mates=relations.filter(r=>String(r.from)===String(personId)&&r.type==='mate');
            if(mates.length===0){ const basePerson=people.find(p=>String(p.id)===String(personId)); const baseGender=((basePerson&&basePerson.gender)||'').toLowerCase(); const autoGender=(baseGender==='male'||baseGender==='masculino'||baseGender==='m')?'female':'male'; const autoId='p_auto_'+Date.now(); people.push({id:autoId,firstName:'<desconhecido>',lastName:'',gender:autoGender,notes:'',createdAt:new Date().toISOString()}); savePeople(people); relations.push({from:String(personId),to:String(autoId),type:'mate'}); relations.push({from:String(autoId),to:String(personId),type:'mate'}); relations.push({from:String(autoId),to:String(newId),type:'child'}); relations.push({from:String(newId),to:String(autoId),type:'ancestor'}); }
            else if(mates.length===1){ relations.push({from:String(mates[0].to),to:String(newId),type:'child'}); relations.push({from:String(newId),to:String(mates[0].to),type:'ancestor'}); }
            else{ const coParentId=((document.getElementById('addPersCoParent')||{}).value||''); if(coParentId){ relations.push({from:String(coParentId),to:String(newId),type:'child'}); relations.push({from:String(newId),to:String(coParentId),type:'ancestor'}); } }
          }
          localStorage.setItem('relations:myLineage',JSON.stringify(relations));
        }
        openDrawer('edit',personId);
      }

      function _drawerShowLinkPerson(personId){
        const people=loadPeople();
        const person=people.find(p=>String(p.id)===String(personId));
        if(!person) return;
        let relations=[];
        try{ relations=JSON.parse(localStorage.getItem('relations:myLineage')||'[]'); }catch(e){}
        const parentCount=relations.filter(r=>String(r.from)===String(personId)&&r.type==='ancestor').length;
        const footer=document.querySelector('.drawer-footer');
        if(footer) footer.style.display='none';
        const phdr=document.getElementById('drawerPersonHeader');
        if(phdr) phdr.style.display='none';
        const backBtn=document.getElementById('drawerBackBtn');
        if(backBtn){ backBtn.style.display=''; backBtn._personId=String(personId); }
        const pName=(((person.firstName||'')+' '+(person.lastName||'')).trim())||'';
        document.getElementById('drawerTitle').textContent='Ligar \u2014 '+pName;
        const body=document.getElementById('drawerBody');
        if(!body) return;
        let kinshipOpts=`<option value="sibling_male">Irm\u00e3o</option><option value="sibling_female">Irm\u00e3</option><option value="child_male">Filho</option><option value="child_female">Filha</option>`;
        if(parentCount<2) kinshipOpts+=`<option value="ancestor_male">Pai</option><option value="ancestor_female">M\u00e3e</option>`;
        kinshipOpts+=`<option value="mate_male">Companheiro</option><option value="mate_female">Companheira</option>`;
        const otherPeople=people.filter(p=>String(p.id)!==String(personId));
        const peopleOpts=otherPeople.map(p=>{ const name=(((p.firstName||'')+' '+(p.lastName||'')).trim())||p.id; const _g=((p.gender||'')).toLowerCase(); const _pg=(_g==='male'||_g==='masculino'||_g==='m')?'male':(_g==='female'||_g==='feminino'||_g==='f')?'female':''; return `<option value="${_esc(String(p.id))}" data-gender="${_pg}">${_esc(name)}</option>`; }).join('');
        body.innerHTML=`<div style="padding:4px 0 8px;"><h3 style="font-size:0.95rem;margin:0 0 14px;">Ligar Pessoa Existente</h3><div class="form-group" style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Grau de parentesco</label><select id="linkPersKinship" style="width:100%;" onchange="_drawerUpdateLinkCoParentSection('${_esc(personId)}');_drawerFilterLinkPersons()">${kinshipOpts}</select></div><div id="linkPersCoParentSection" class="form-group" style="margin-bottom:10px;display:none;"></div><div class="form-group" style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Pesquisar pessoa</label><input id="linkPersSearch" type="text" placeholder="Pesquisar por nome..." style="width:100%;margin-bottom:6px;" oninput="_drawerFilterLinkPersons()" /><select id="linkPersTarget" size="6" style="width:100%;min-height:110px;">${peopleOpts}</select></div><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;"><button class="btn btn-ghost btn-sm" onclick="openDrawer('edit','${_esc(personId)}')">Cancelar</button><button class="btn btn-sm" onclick="_drawerSaveLinkPerson('${_esc(personId)}')"><i class="mdi mdi-content-save-outline"></i> Guardar</button></div></div>`;
        const sel=document.getElementById('linkPersTarget');
        if(sel) sel._allOptions=Array.from(sel.options).map(o=>({value:o.value,text:o.text,gender:o.getAttribute('data-gender')||''}));
        _drawerFilterLinkPersons();
        const si=document.getElementById('linkPersSearch');
        if(si) si.focus();
      }

      function _drawerFilterLinkPersons(){
        const search=((document.getElementById('linkPersSearch')||{}).value||'').toLowerCase();
        const kinship=((document.getElementById('linkPersKinship')||{}).value||'');
        const _kg={sibling_male:'male',child_male:'male',ancestor_male:'male',mate_male:'male',sibling_female:'female',child_female:'female',ancestor_female:'female',mate_female:'female'};
        const expectedGender=_kg[kinship]||'';
        const sel=document.getElementById('linkPersTarget');
        if(!sel) return;
        const all=sel._allOptions||[];
        sel.innerHTML=all.filter(o=>{
          if(search&&!o.text.toLowerCase().includes(search)) return false;
          if(expectedGender&&o.gender&&o.gender!==expectedGender) return false;
          return true;
        }).map(o=>`<option value="${_esc(o.value)}">${_esc(o.text)}</option>`).join('');
      }

      function _drawerUpdateLinkCoParentSection(personId){
        const kinship=((document.getElementById('linkPersKinship')||{}).value||'');
        const section=document.getElementById('linkPersCoParentSection');
        if(!section) return;
        if(kinship!=='child_male'&&kinship!=='child_female'){ section.style.display='none'; section.innerHTML=''; return; }
        let relations=[];
        try{ relations=JSON.parse(localStorage.getItem('relations:myLineage')||'[]'); }catch(e){}
        const mates=relations.filter(r=>String(r.from)===String(personId)&&r.type==='mate');
        if(mates.length<=1){ section.style.display='none'; section.innerHTML=''; return; }
        const people=loadPeople();
        const opts=mates.map(r=>{ const p=people.find(x=>String(x.id)===String(r.to)); const name=p?(((p.firstName||'')+' '+(p.lastName||'')).trim())||p.id:r.to; return `<option value="${_esc(String(r.to))}">${_esc(name)}</option>`; }).join('');
        section.innerHTML=`<label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Outro progenitor</label><select id="linkPersCoParent" style="width:100%;">${opts}</select>`;
        section.style.display='block';
      }

      function _drawerSaveLinkPerson(personId){
        const kinship=((document.getElementById('linkPersKinship')||{}).value||'');
        const sel=document.getElementById('linkPersTarget');
        const newId=sel&&sel.value?sel.value:'';
        if(!newId){ alert('Selecione uma pessoa para ligar.'); return; }
        if(String(newId)===String(personId)){ alert('N\u00e3o pode ligar uma pessoa a si pr\u00f3pria.'); return; }
        let gender='',relType='';
        if(kinship==='sibling_male'){ gender='male'; relType='siblin'; }
        else if(kinship==='sibling_female'){ gender='female'; relType='siblin'; }
        else if(kinship==='child_male'){ gender='male'; relType='child'; }
        else if(kinship==='child_female'){ gender='female'; relType='child'; }
        else if(kinship==='ancestor_male'){ gender='male'; relType='ancestor'; }
        else if(kinship==='ancestor_female'){ gender='female'; relType='ancestor'; }
        else if(kinship==='mate_male'){ gender='male'; relType='mate'; }
        else if(kinship==='mate_female'){ gender='female'; relType='mate'; }
        if(!relType){ openDrawer('edit',personId); return; }
        let relations=[];
        try{ relations=JSON.parse(localStorage.getItem('relations:myLineage')||'[]'); }catch(e){}
        if(relations.some(r=>String(r.from)===String(personId)&&String(r.to)===String(newId)&&r.type===relType)){ alert('Esta liga\u00e7\u00e3o j\u00e1 existe.'); return; }
        if(relType==='siblin'){ relations.push({from:String(personId),to:String(newId),type:'siblin'}); relations.push({from:String(newId),to:String(personId),type:'siblin'}); relations.filter(r=>String(r.from)===String(personId)&&r.type==='ancestor').forEach(r=>{ if(!relations.some(x=>String(x.from)===String(newId)&&String(x.to)===String(r.to)&&x.type==='ancestor')) relations.push({from:String(newId),to:String(r.to),type:'ancestor'}); }); }
        if(relType==='ancestor'){ relations.push({from:String(personId),to:String(newId),type:'ancestor'}); if(!relations.some(r=>String(r.from)===String(newId)&&String(r.to)===String(personId)&&r.type==='child')) relations.push({from:String(newId),to:String(personId),type:'child'}); const existingParents=relations.filter(r=>String(r.from)===String(personId)&&r.type==='ancestor'&&String(r.to)!==String(newId)); if(existingParents.length>0){ const otherParentId=existingParents[0].to; if(!relations.some(r=>String(r.from)===String(newId)&&String(r.to)===String(otherParentId)&&r.type==='mate')){ relations.push({from:String(newId),to:String(otherParentId),type:'mate'}); relations.push({from:String(otherParentId),to:String(newId),type:'mate'}); } } }
        if(relType==='mate'){ relations.push({from:String(personId),to:String(newId),type:'mate'}); if(!relations.some(r=>String(r.from)===String(newId)&&String(r.to)===String(personId)&&r.type==='mate')) relations.push({from:String(newId),to:String(personId),type:'mate'}); }
        if(relType==='child'){
          relations.push({from:String(personId),to:String(newId),type:'child'});
          if(!relations.some(r=>String(r.from)===String(newId)&&String(r.to)===String(personId)&&r.type==='ancestor')) relations.push({from:String(newId),to:String(personId),type:'ancestor'});
          const mates=relations.filter(r=>String(r.from)===String(personId)&&r.type==='mate');
          if(mates.length===1){ if(!relations.some(r=>String(r.from)===String(mates[0].to)&&String(r.to)===String(newId)&&r.type==='child')) relations.push({from:String(mates[0].to),to:String(newId),type:'child'}); if(!relations.some(r=>String(r.from)===String(newId)&&String(r.to)===String(mates[0].to)&&r.type==='ancestor')) relations.push({from:String(newId),to:String(mates[0].to),type:'ancestor'}); }
          else if(mates.length>1){ const coParentId=((document.getElementById('linkPersCoParent')||{}).value||''); if(coParentId){ if(!relations.some(r=>String(r.from)===String(coParentId)&&String(r.to)===String(newId)&&r.type==='child')) relations.push({from:String(coParentId),to:String(newId),type:'child'}); if(!relations.some(r=>String(r.from)===String(newId)&&String(r.to)===String(coParentId)&&r.type==='ancestor')) relations.push({from:String(newId),to:String(coParentId),type:'ancestor'}); } }
        }
        localStorage.setItem('relations:myLineage',JSON.stringify(relations));
        openDrawer('edit',personId);
      }

      function _renderDrawerPhotos(personId){
        const photos=getPhotos(); const rels=getPhotoRelations();
        const linked=(rels[personId]||[]).map(id=>photos.find(p=>String(p.id)===String(id))).filter(Boolean);
        let html=`<div style="margin-bottom:14px;"><div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:6px;"><label for="drawerPhotoInput" class="btn btn-sm" style="cursor:pointer;font-size:0.83rem;"><i class="mdi mdi-image-plus"></i> Escolher Ficheiro</label><span id="drawerPhotoName" style="color:#aaa;font-size:0.82rem;">Nenhum ficheiro</span><button class="btn btn-sm" onclick="_drawerUploadPhoto('${_esc(personId)}')" style="font-size:0.83rem;"><i class="mdi mdi-upload"></i> Upload</button></div><input type="file" id="drawerPhotoInput" accept="image/*" style="display:none;" onchange="document.getElementById('drawerPhotoName').textContent=this.files&&this.files.length?this.files[0].name:'Nenhum ficheiro'" /></div>`;
        if(!linked.length){ html+='<div style="color:#888;padding:4px 0 12px;">Nenhuma foto associada.</div>'; return html; }
        html+='<div style="display:flex;flex-wrap:wrap;gap:10px;">';
        linked.forEach(ph=>{
          const src=ph.originalDataUrl||ph.dataUrl||'';
          html+=`<div style="position:relative;display:inline-block;"><img src="${src}" style="width:72px;height:72px;object-fit:cover;border-radius:6px;cursor:pointer;" onclick="_drawerViewPhoto('${_esc(ph.id)}')" title="${_esc(ph.name||'')}" /><button onclick="_drawerUnlinkPhoto('${_esc(ph.id)}','${_esc(personId)}')" title="Remover v\u00ednculo" style="position:absolute;top:-6px;right:-6px;background:#e06060;border:none;color:#fff;border-radius:50%;width:18px;height:18px;font-size:0.65rem;cursor:pointer;padding:0;display:flex;align-items:center;justify-content:center;"><i class="mdi mdi-close"></i></button></div>`;
        });
        html+='</div>';
        return html;
      }

      async function _drawerUploadPhoto(personId){
        const input=document.getElementById('drawerPhotoInput');
        if(!input||!input.files||!input.files.length) return alert('Selecione uma imagem para upload.');
        const photos=getPhotos(); const rels=getPhotoRelations(); const f=input.files[0];
        try{
          const dataUrl=await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=()=>rej(); r.readAsDataURL(f); });
          const id='ph_'+Date.now();
          photos.push({id,name:f.name,originalDataUrl:dataUrl,createdAt:new Date().toISOString()});
          rels[personId]=rels[personId]||[]; rels[personId].push(id);
          localStorage.setItem('photos:myLineage',JSON.stringify(photos));
          localStorage.setItem('photoRelations:myLineage',JSON.stringify(rels));
          input.value=''; openDrawerSection(personId,'fotos');
        }catch(err){ alert('Erro no upload: '+err); }
      }

      function _drawerUnlinkPhoto(photoId,personId){
        if(!confirm('Remover v\u00ednculo desta foto?')) return;
        const rels=getPhotoRelations();
        if(rels[personId]) rels[personId]=rels[personId].filter(id=>String(id)!==String(photoId));
        localStorage.setItem('photoRelations:myLineage',JSON.stringify(rels));
        openDrawerSection(personId,'fotos');
      }

      let _drawerCurrentPhotoId=null,_drawerIsDrawing=false,_drawerDrawStart=null,_drawerCurrentDrawEl=null;

      function _drawerViewPhoto(photoId){
        const ph=getPhotos().find(p=>String(p.id)===String(photoId)); if(!ph) return;
        _drawerCurrentPhotoId=photoId;
        const area=document.getElementById('drawerModalImageArea'); area.innerHTML='';
        const photoArea=document.createElement('div'); photoArea.style.maxWidth='100%';
        const img=document.createElement('img'); img.id='drawerModalImage';
        img.style.cssText='display:block;max-width:100%;max-height:70vh;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.5);';
        img.src=ph.originalDataUrl||ph.dataUrl||'';
        const overlay=document.createElement('div');
        overlay.style.cssText='position:absolute;left:0;top:0;right:0;bottom:0;pointer-events:auto;';
        const container=document.createElement('div'); container.style.position='relative';
        container.appendChild(img); container.appendChild(overlay); photoArea.appendChild(container); area.appendChild(photoArea);
        const notesEl=document.getElementById('drawerPhotoNotesArea'); if(notesEl) notesEl.value=ph.notes||'';
        _drawerRenderPhotoTags(ph);
        overlay.addEventListener('pointerdown',function(ev){ ev.preventDefault(); _drawerStartDraw(ev,img,overlay); });
        overlay.addEventListener('pointermove',function(ev){ if(_drawerIsDrawing) _drawerUpdateDraw(ev,img,overlay); });
        overlay.addEventListener('pointerup',function(ev){ if(_drawerIsDrawing) _drawerFinishDraw(ev,img,overlay); });
        document.getElementById('drawerPhotoModal').style.display='flex';
      }

      function _drawerClosePhotoModal(){
        _drawerCurrentPhotoId=null; _drawerIsDrawing=false; _drawerDrawStart=null; _drawerCurrentDrawEl=null;
        document.getElementById('drawerPhotoModal').style.display='none';
        const a=document.getElementById('drawerModalImageArea'); if(a) a.innerHTML='';
      }

      function _drawerSavePhotoNotes(){
        if(!_drawerCurrentPhotoId) return;
        const notes=((document.getElementById('drawerPhotoNotesArea')||{}).value||'');
        const photos=getPhotos(); const idx=photos.findIndex(p=>p.id===_drawerCurrentPhotoId); if(idx<0) return;
        photos[idx].notes=notes; photos[idx].updatedAt=new Date().toISOString();
        localStorage.setItem('photos:myLineage',JSON.stringify(photos)); alert('Notas guardadas.');
      }

      function _drawerRenderPhotoTags(photo){
        try{
          const overlay=document.querySelector('#drawerModalImageArea div[style*="position:absolute"]'); if(!overlay) return;
          overlay.innerHTML='';
          const tags=photo.tags||[];
          tags.forEach(t=>{
            const el=document.createElement('div'); el.style.cssText='position:absolute;border:2px solid #4493f8;box-sizing:border-box;cursor:pointer;';
            el.style.left=(t.bbox.x*100)+'%'; el.style.top=(t.bbox.y*100)+'%';
            el.style.width=(t.bbox.w*100)+'%'; el.style.height=(t.bbox.h*100)+'%';
            el.title=t.personName||t.name||'Identificado';
            const lbl=document.createElement('div'); lbl.style.cssText='position:absolute;bottom:0;left:0;background:rgba(0,0,0,0.6);color:#fff;font-size:0.7rem;padding:1px 4px;'; lbl.textContent=t.personName||t.name||'Pessoa'; el.appendChild(lbl);
            overlay.appendChild(el);
          });
          const ppl=document.getElementById('drawerPhotoTaggedPeople'); if(!ppl) return;
          const unique=Array.from(new Map((tags||[]).map(t=>[t.personId||t.personName,t])).values());
          ppl.innerHTML=unique.length===0?'<span style="color:#888">Nenhuma pessoa identificada.</span>':'<strong>Pessoas identificadas:</strong> '+unique.map(t=>_esc(t.personName||t.name||'')).join(', ');
        }catch(e){}
      }

      function _drawerStartDraw(ev,img,overlay){ _drawerIsDrawing=true; _drawerDrawStart={x:ev.clientX,y:ev.clientY}; _drawerCurrentDrawEl=document.createElement('div'); _drawerCurrentDrawEl.style.cssText='position:absolute;border:2px dashed #ffcc00;box-sizing:border-box;'; _drawerCurrentDrawEl.style.left='0'; _drawerCurrentDrawEl.style.top='0'; _drawerCurrentDrawEl.style.width='0'; _drawerCurrentDrawEl.style.height='0'; overlay.appendChild(_drawerCurrentDrawEl); }
      function _drawerUpdateDraw(ev,img,overlay){ if(!_drawerIsDrawing||!_drawerCurrentDrawEl||!_drawerDrawStart) return; const r=img.getBoundingClientRect(); const l=Math.min(_drawerDrawStart.x,ev.clientX)-r.left; const t=Math.min(_drawerDrawStart.y,ev.clientY)-r.top; const w=Math.abs(ev.clientX-_drawerDrawStart.x); const h=Math.abs(ev.clientY-_drawerDrawStart.y); _drawerCurrentDrawEl.style.left=(l/r.width*100)+'%'; _drawerCurrentDrawEl.style.top=(t/r.height*100)+'%'; _drawerCurrentDrawEl.style.width=(w/r.width*100)+'%'; _drawerCurrentDrawEl.style.height=(h/r.height*100)+'%'; }
      function _drawerFinishDraw(ev,img,overlay){ if(!_drawerIsDrawing) return; _drawerIsDrawing=false; const r=img.getBoundingClientRect(); const bbox={x:Math.max(0,Math.min(1,(Math.min(_drawerDrawStart.x,ev.clientX)-r.left)/r.width)),y:Math.max(0,Math.min(1,(Math.min(_drawerDrawStart.y,ev.clientY)-r.top)/r.height)),w:Math.max(0,Math.min(1,Math.abs(ev.clientX-_drawerDrawStart.x)/r.width)),h:Math.max(0,Math.min(1,Math.abs(ev.clientY-_drawerDrawStart.y)/r.height))}; if(_drawerCurrentDrawEl&&_drawerCurrentDrawEl.parentElement) _drawerCurrentDrawEl.parentElement.removeChild(_drawerCurrentDrawEl); _drawerCurrentDrawEl=null; _drawerDrawStart=null; if(bbox.w>0.01&&bbox.h>0.01) _drawerShowTagForm(bbox,img,overlay); }

      function _drawerShowTagForm(bbox,img,overlay){
        const form=document.createElement('div'); form.style.cssText='position:absolute;background:var(--bg-card,#1a1d27);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:10px;z-index:620;min-width:220px;'; form.style.left=(bbox.x*100)+'%'; form.style.top=(bbox.y*100)+'%';
        form.innerHTML='<div style="font-weight:600;margin-bottom:6px;">Identificar pessoa</div>';
        const people=loadPeople();
        const input=document.createElement('input'); input.placeholder='Pesquisar pessoa (nome)'; input.style.width='220px';
        const sugg=document.createElement('div'); sugg.style.cssText='position:absolute;left:8px;top:38px;background:var(--bg-card,#1a1d27);border:1px solid rgba(255,255,255,0.1);max-height:160px;overflow:auto;width:220px;z-index:630;display:none;border-radius:6px;';
        const saveBtn=document.createElement('button'); saveBtn.textContent='Salvar'; saveBtn.className='btn';
        const cancelBtn=document.createElement('button'); cancelBtn.textContent='Cancelar'; cancelBtn.className='btn';
        const br=document.createElement('div'); br.style.marginTop='6px';
        form.appendChild(input); form.appendChild(sugg); form.appendChild(br); form.appendChild(saveBtn); form.appendChild(cancelBtn);
        form.addEventListener('pointerdown',ev=>ev.stopPropagation());
        let selectedPersonId=null;
        function renderSugg(q){ const list=people.filter(p=>!p.deletedAt&&((p.firstName||'')+' '+(p.lastName||'')).toLowerCase().includes((q||'').toLowerCase())).slice(0,30); sugg.innerHTML=''; if(!list.length){sugg.style.display='none';return;} list.forEach(p=>{ const row=document.createElement('div'); row.style.cssText='padding:6px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.04);'; row.textContent=((p.firstName||'')+' '+(p.lastName||'')).trim(); row.addEventListener('click',()=>{input.value=row.textContent;selectedPersonId=p.id;sugg.style.display='none';input.focus();}); sugg.appendChild(row); }); sugg.style.display='block'; }
        input.addEventListener('input',function(){selectedPersonId=null;renderSugg(this.value);});
        input.addEventListener('keydown',ev=>{if(ev.key==='Enter'){ev.preventDefault();saveBtn.click();}});
        cancelBtn.addEventListener('click',()=>{if(form.parentElement)form.parentElement.removeChild(form);});
        saveBtn.addEventListener('click',()=>{const name=input.value.trim();if(!name)return alert('Insira um nome ou selecione uma pessoa.');_drawerSaveTag({personId:selectedPersonId||null,personName:name,bbox});if(form.parentElement)form.parentElement.removeChild(form);});
        setTimeout(()=>{try{input.focus();}catch(e){}},50);
        overlay.appendChild(form);
      }

      function _drawerSaveTag({personId,personName,bbox}){
        try{
          const photos=getPhotos(); const idx=photos.findIndex(p=>p.id===_drawerCurrentPhotoId); if(idx<0)return;
          const tag={id:'tag_'+Date.now()+Math.random().toString(36).slice(2,6),personId:personId||null,personName:personName||'',bbox,createdAt:new Date().toISOString()};
          photos[idx].tags=photos[idx].tags||[]; photos[idx].tags.push(tag); photos[idx].updatedAt=new Date().toISOString();
          localStorage.setItem('photos:myLineage',JSON.stringify(photos));
          if(personId){const rels=getPhotoRelations();rels[personId]=rels[personId]||[];if(!rels[personId].includes(photos[idx].id))rels[personId].push(photos[idx].id);localStorage.setItem('photoRelations:myLineage',JSON.stringify(rels));}
          _drawerRenderPhotoTags(photos[idx]);
        }catch(e){}
      }

      function drawerSave(){
        const firstName=(document.getElementById('df_firstName')||{}).value||'';
        const lastName=(document.getElementById('df_lastName')||{}).value||'';
        const gender=(document.getElementById('df_gender')||{}).value||'';
        const notes=(document.getElementById('df_notes')||{}).value||'';
        let people=loadPeople();
        if(_drawerMode==='create'){
          people.push({id:'p_'+Date.now(),firstName:firstName.trim(),lastName:lastName.trim(),gender,notes,createdAt:new Date().toISOString()});
          savePeople(people);
        } else {
          const idx=people.findIndex(p=>String(p.id)===String(_drawerPersonId));
          if(idx!==-1){ people[idx]=Object.assign({},people[idx],{firstName:firstName.trim(),lastName:lastName.trim(),gender,notes,updatedAt:new Date().toISOString()}); savePeople(people); }
        }
        closeDrawer();
        runValidation();
      }

      function drawerDeletePerson(){
        if(!_drawerPersonId) return;
        if(!confirm('Apagar esta pessoa?')) return;
        const pid=String(_drawerPersonId);
        let people=loadPeople();
        const idx=people.findIndex(p=>String(p.id)===pid);
        if(idx!==-1){ people[idx]=Object.assign({},people[idx],{deletedAt:new Date().toISOString()}); savePeople(people); }
        let relations=[];
        try{ relations=JSON.parse(localStorage.getItem('relations:myLineage')||'[]'); }catch(e){}
        relations=relations.filter(r=>String(r.from)!==pid&&String(r.to)!==pid);
        localStorage.setItem('relations:myLineage',JSON.stringify(relations));
        closeDrawer();
        runValidation();
      }

      document.getElementById('drawerCloseBtn').addEventListener('click', closeDrawer);
      document.getElementById('drawerCancelBtn').addEventListener('click', closeDrawer);
      document.getElementById('drawerOverlay').addEventListener('click', closeDrawer);
      document.getElementById('drawerSaveBtn').addEventListener('click', drawerSave);
      document.getElementById('drawerDeleteBtn').addEventListener('click', drawerDeletePerson);
      document.getElementById('drawerBackBtn').addEventListener('click', function(){ const pid=this._personId; if(pid) openDrawer('edit',pid); });
    </script>
  </body>
</html>
