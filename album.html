<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Álbum de Fotos – myLineage</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css">
    <style>
      /* ── Album grid ─────────────────────────────────────────────────── */
      .album-topbar-actions {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }
      .album-search {
        padding: 7px 12px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--bg-surface-2);
        color: var(--text-main);
        font-family: var(--font-main);
        font-size: 0.88rem;
        width: 220px;
        outline: none;
        transition: border-color var(--transition);
      }
      .album-search:focus { border-color: var(--accent); }
      .album-count-badge {
        font-size: 0.78rem;
        color: var(--text-secondary);
        background: var(--bg-surface-2);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 4px 12px;
        white-space: nowrap;
      }
      .album-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 12px;
        padding: 60px 20px;
        color: var(--text-secondary);
        text-align: center;
      }
      .album-empty .mdi { font-size: 3rem; opacity: 0.3; }
      .album-empty p { font-size: 0.95rem; max-width: 380px; }
      .album-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 12px;
        padding: 20px;
      }
      .album-thumb {
        background: var(--bg-surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        overflow: hidden;
        cursor: pointer;
        transition: border-color var(--transition), box-shadow var(--transition), transform var(--transition);
        display: flex;
        flex-direction: column;
      }
      .album-thumb:hover {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px var(--accent-soft), var(--shadow);
        transform: translateY(-2px);
      }
      .album-thumb-img-wrap {
        width: 100%;
        aspect-ratio: 1 / 1;
        background: var(--bg-surface-2);
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .album-thumb-img-wrap img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        transition: transform 0.22s ease;
      }
      .album-thumb:hover .album-thumb-img-wrap img { transform: scale(1.05); }
      .album-thumb-info {
        padding: 8px 10px 10px;
        display: flex;
        flex-direction: column;
        gap: 3px;
        min-height: 0;
      }
      .album-thumb-name {
        font-size: 0.78rem;
        font-weight: 600;
        color: var(--text-main);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .album-thumb-meta {
        font-size: 0.7rem;
        color: var(--text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .album-thumb-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 4px;
      }
      .album-tag-chip {
        font-size: 0.65rem;
        padding: 2px 6px;
        border-radius: 10px;
        background: var(--accent-soft);
        color: var(--accent);
        border: 1px solid var(--border-accent);
        white-space: nowrap;
        max-width: 110px;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .album-no-img {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-disabled);
        flex-direction: column;
        gap: 4px;
        font-size: 0.75rem;
      }
      .album-no-img .mdi { font-size: 2.2rem; opacity: 0.35; }

      /* ── Photo modal ────────────────────────────────────────────────── */
      #albumModal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.78);
        align-items: center;
        justify-content: center;
        z-index: 300;
        padding: 16px;
      }
      #albumModal.open { display: flex; }
      .album-modal-inner {
        background: var(--bg-surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        max-width: 900px;
        width: 100%;
        max-height: 92vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        animation: modalIn 0.18s ease;
        transition: max-width 0.2s ease, max-height 0.2s ease, border-radius 0.2s ease;
      }
      .album-modal-inner.maximized {
        max-width: 100vw;
        width: 100vw;
        max-height: 100vh;
        height: 100vh;
        border-radius: 0;
        box-shadow: none;
      }
      #albumModal:has(.album-modal-inner.maximized) { padding: 0; }
      .album-modal-inner.maximized .album-modal-img-pane img,
      .album-modal-inner.maximized .album-modal-img-pane .album-photo-wrap img { max-height: calc(100vh - 57px); }
      @keyframes modalIn {
        from { opacity: 0; transform: scale(0.96) translateY(8px); }
        to   { opacity: 1; transform: scale(1) translateY(0); }
      }
      .album-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 20px;
        border-bottom: 1px solid var(--border);
        flex-shrink: 0;
      }
      .album-modal-header h2 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-main);
        margin: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: calc(100% - 48px);
      }
      .album-modal-close,
      .album-modal-maximize {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 1.4rem;
        line-height: 1;
        padding: 4px 6px;
        border-radius: 6px;
        transition: color var(--transition), background var(--transition);
        flex-shrink: 0;
      }
      .album-modal-close:hover,
      .album-modal-maximize:hover { color: var(--text-main); background: var(--bg-surface-2); }
      .album-modal-body {
        display: flex;
        flex: 1;
        min-height: 0;
        overflow: hidden;
      }
      .album-modal-img-pane {
        flex: 1;
        min-width: 0;
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        padding: 12px;
      }
      .album-modal-img-pane img {
        max-width: 100%;
        max-height: 75vh;
        object-fit: contain;
        border-radius: 6px;
        display: block;
      }
      .album-modal-sidebar {
        width: 260px;
        flex-shrink: 0;
        border-left: 1px solid var(--border);
        overflow-y: auto;
        padding: 18px 16px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        background: var(--bg-surface);
      }
      .album-info-section { display: flex; flex-direction: column; gap: 6px; }
      .album-info-label {
        font-size: 0.68rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: var(--text-secondary);
      }
      .album-info-value {
        font-size: 0.88rem;
        color: var(--text-main);
        word-break: break-word;
      }
      .album-info-value.muted { color: var(--text-secondary); font-style: italic; }
      .album-info-notes {
        font-size: 0.85rem;
        color: var(--text-main);
        background: var(--bg-surface-2);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 8px 10px;
        white-space: pre-wrap;
        word-break: break-word;
        max-height: 120px;
        overflow-y: auto;
        line-height: 1.5;
      }
      .album-info-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
      }
      .album-info-chip {
        font-size: 0.75rem;
        padding: 3px 9px;
        border-radius: 12px;
        background: var(--accent-soft);
        color: var(--accent);
        border: 1px solid var(--border-accent);
      }
      .album-loader {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        color: var(--text-secondary);
        font-size: 0.9rem;
        gap: 8px;
      }
      @media (max-width: 600px) {
        .album-modal-body { flex-direction: column; }
        .album-modal-sidebar { width: 100%; border-left: none; border-top: 1px solid var(--border); max-height: 40vh; }
        .album-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; padding: 12px; }
      }      /* ── Tag zones overlay (read-only) ──────────────────────────────────── */
      .album-photo-wrap {
        position: relative;
        display: inline-block;
        max-width: 100%;
        max-height: 75vh;
        line-height: 0;
      }
      .album-photo-wrap img {
        display: block;
        max-width: 100%;
        max-height: 75vh;
        object-fit: contain;
        border-radius: 6px;
      }
      .album-tag-overlay {
        position: absolute;
        inset: 0;
        pointer-events: none;
      }
      .album-tag-zone {
        position: absolute;
        border: 2px solid rgba(59,130,246,0.85);
        background: rgba(59,130,246,0.10);
        border-radius: 5px;
        box-sizing: border-box;
        pointer-events: auto;
        cursor: default;
        transition: background 0.15s;
      }
      .album-tag-zone:hover {
        background: rgba(59,130,246,0.22);
      }
      .album-tag-zone-label {
        position: absolute;
        bottom: calc(100% + 3px);
        left: 0;
        white-space: nowrap;
        background: rgba(30,40,60,0.88);
        color: #e8eaf6;
        font-size: 0.72rem;
        font-weight: 600;
        padding: 2px 7px;
        border-radius: 4px;
        pointer-events: none;
        line-height: 1.5;
        max-width: 180px;
        overflow: hidden;
        text-overflow: ellipsis;
        box-shadow: 0 2px 6px rgba(0,0,0,0.35);
        opacity: 0;
        transform: translateY(4px);
        transition: opacity 0.15s, transform 0.15s;
      }
      .album-tag-zone:hover .album-tag-zone-label,
      .album-tag-zone:focus  .album-tag-zone-label {
        opacity: 1;
        transform: translateY(0);
      }
      .album-tag-zone-label-always {
        opacity: 1 !important;
        transform: translateY(0) !important;
      }      /* ── Delete button ──────────────────────────────────────────────── */
      .album-modal-header-actions {
        display: flex;
        align-items: center;
        gap: 4px;
        flex-shrink: 0;
      }
      .album-modal-delete {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 1.3rem;
        line-height: 1;
        padding: 4px 6px;
        border-radius: 6px;
        transition: color var(--transition), background var(--transition);
      }
      .album-modal-delete:hover { color: #e53935; background: rgba(229,57,53,0.10); }
      /* ── Confirm dialog ─────────────────────────────────────────────── */
      #deleteConfirmOverlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.60);
        align-items: center;
        justify-content: center;
        z-index: 400;
      }
      #deleteConfirmOverlay.open { display: flex; }
      .delete-confirm-box {
        background: var(--bg-surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        padding: 28px 28px 22px;
        max-width: 380px;
        width: 90%;
        display: flex;
        flex-direction: column;
        gap: 14px;
        animation: modalIn 0.15s ease;
      }
      .delete-confirm-box h3 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-main);
        margin: 0;
      }
      .delete-confirm-box p {
        font-size: 0.88rem;
        color: var(--text-secondary);
        margin: 0;
        line-height: 1.5;
      }
      .delete-confirm-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 4px;
      }
      .btn-cancel {
        padding: 7px 16px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--bg-surface-2);
        color: var(--text-main);
        font-size: 0.88rem;
        cursor: pointer;
        transition: background var(--transition);
      }
      .btn-cancel:hover { background: var(--bg-surface); }
      .btn-delete-confirm {
        padding: 7px 16px;
        border-radius: 8px;
        border: none;
        background: #e53935;
        color: #fff;
        font-size: 0.88rem;
        cursor: pointer;
        font-weight: 600;
        transition: background var(--transition);
      }
      .btn-delete-confirm:hover { background: #c62828; }

      /* ── Modal navigation arrows ────────────────────────────────────── */
      .album-nav-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        z-index: 10;
        background: rgba(0,0,0,0.45);
        border: none;
        color: #fff;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.6rem;
        cursor: pointer;
        transition: background 0.18s, opacity 0.18s;
        opacity: 0.7;
        flex-shrink: 0;
      }
      .album-nav-btn:hover { background: rgba(0,0,0,0.72); opacity: 1; }
      .album-nav-btn:disabled { opacity: 0.18; cursor: default; pointer-events: none; }
      .album-nav-prev { left: 10px; }
      .album-nav-next { right: 10px; }
    </style>
    <script src="remote-storage.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  </head>
  <body>
    <div class="app-shell">
      <aside class="sidebar">
        <a href="index.html" class="logo"><i class="mdi mdi-tree" aria-hidden="true"></i><span>myLineage</span></a>
        <nav>
          <a href="app.html"><i class="mdi mdi-account-multiple" aria-hidden="true"></i>Cadastro</a>
          <a href="indicadores.html"><i class="mdi mdi-chart-bar" aria-hidden="true"></i>Indicadores</a>
          <a href="arvore.html"><i class="mdi mdi-sitemap" aria-hidden="true"></i>Árvore</a>
          <a href="gedcom.html"><i class="mdi mdi-dna" aria-hidden="true"></i>GEDCOM</a>
          <a href="album.html" class="active"><i class="mdi mdi-image-multiple" aria-hidden="true"></i>Álbum</a>
          <a href="documentos.html"><i class="mdi mdi-folder-open" aria-hidden="true"></i>Documentos</a>
          <a href="validacao.html"><i class="mdi mdi-shield-check" aria-hidden="true"></i>Validação</a>
          <a href="historico.html"><i class="mdi mdi-history" aria-hidden="true"></i>Histórico</a>
        </nav>
        <div class="sidebar-footer">
          <a href="apis.html"><i class="mdi mdi-api" aria-hidden="true"></i>APIs</a>
          <a href="configuracao.html"><i class="mdi mdi-cog" aria-hidden="true"></i>Definições</a>
        </div>
      </aside>
      <main class="content">
        <div class="topbar">
          <div style="flex:1;display:flex;align-items:center;gap:12px;min-width:0;">
            <h1>Álbum de Fotos</h1>
            <span class="album-count-badge" id="photoBadge" style="display:none;"></span>
          </div>
          <div style="flex:1;display:flex;justify-content:center;align-items:center;">
            <input type="search" class="album-search" id="albumSearch" placeholder="Pesquisar por nome ou pessoa..." />
          </div>
          <div style="flex:1;display:flex;justify-content:flex-end;align-items:center;">
            <button class="btn btn-ghost btn-sm" id="btnExportPdf" title="Exportar todas as fotos para PDF">
              <i class="mdi mdi-file-pdf-box" aria-hidden="true"></i> Exportar PDF
            </button>
          </div>
        </div>

        <!-- Content area -->
        <div id="albumContent">
          <div class="album-loader" id="albumLoader">
            <i class="mdi mdi-loading mdi-spin" aria-hidden="true"></i> A carregar fotos…
          </div>
        </div>
      </main>
    </div>

    <!-- PDF progress overlay -->
    <div id="pdfProgressOverlay" aria-live="polite">
      <div class="pdf-progress-box">
        <i class="mdi mdi-file-pdf-box" aria-hidden="true"></i>
        <div class="pdf-progress-title">A gerar PDF&hellip;</div>
        <div class="pdf-progress-msg" id="pdfProgressMsg">A iniciar&hellip;</div>
        <div class="pdf-progress-bar-wrap">
          <div class="pdf-progress-bar" id="pdfProgressBar"></div>
        </div>
      </div>
    </div>

    <!-- Delete confirmation dialog -->
    <div id="deleteConfirmOverlay" role="dialog" aria-modal="true" aria-labelledby="deleteConfirmTitle">
      <div class="delete-confirm-box">
        <h3 id="deleteConfirmTitle">Apagar foto?</h3>
        <p id="deleteConfirmMsg">A foto será removida do álbum e todas as associações a pessoas serão eliminadas. Esta ação não pode ser desfeita.</p>
        <div class="delete-confirm-actions">
          <button class="btn-cancel" id="deleteCancelBtn">Cancelar</button>
          <button class="btn-delete-confirm" id="deleteConfirmBtn">Apagar</button>
        </div>
      </div>
    </div>

    <!-- Photo detail modal -->
    <div id="albumModal" role="dialog" aria-modal="true" aria-labelledby="modalPhotoName">
      <div class="album-modal-inner">
        <div class="album-modal-header">
          <h2 id="modalPhotoName">Foto</h2>
          <div class="album-modal-header-actions">
            <button class="album-modal-delete" id="albumModalDelete" title="Apagar foto">
              <i class="mdi mdi-delete-outline" aria-hidden="true"></i>
            </button>
            <button class="album-modal-maximize" id="albumModalDownload" title="Descarregar foto">
              <i class="mdi mdi-download" aria-hidden="true"></i>
            </button>
            <button class="album-modal-maximize" id="albumModalMaximize" title="Maximizar (F)">
              <i class="mdi mdi-arrow-expand" aria-hidden="true" id="albumModalMaximizeIcon"></i>
            </button>
            <button class="album-modal-close" id="albumModalClose" title="Fechar (Esc)">
              <i class="mdi mdi-close" aria-hidden="true"></i>
            </button>
          </div>
        </div>
        <div class="album-modal-body">
          <div class="album-modal-img-pane" id="modalImgPane" style="position:relative;">
            <button class="album-nav-btn album-nav-prev" id="albumNavPrev" title="Foto anterior (←)" aria-label="Foto anterior">
              <i class="mdi mdi-chevron-left" aria-hidden="true"></i>
            </button>
            <button class="album-nav-btn album-nav-next" id="albumNavNext" title="Próxima foto (→)" aria-label="Próxima foto">
              <i class="mdi mdi-chevron-right" aria-hidden="true"></i>
            </button>
            <div class="album-photo-wrap" id="modalPhotoWrap">
              <img id="modalImg" src="" alt="" />
              <div class="album-tag-overlay" id="modalTagOverlay"></div>
            </div>
          </div>
          <aside class="album-modal-sidebar" id="modalSidebar">
            <!-- filled by JS -->
          </aside>
        </div>
      </div>
    </div>

    <script>
      'use strict';

      const DB = window.GedcomDB;

      // ── Helpers ──────────────────────────────────────────────────────
      function readPhotoBase(){ return DB.getSetting('photoBase') || null; }
      function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
      function fmtDate(iso){ if(!iso) return ''; try{ return new Date(iso).toLocaleDateString('pt-PT',{day:'2-digit',month:'2-digit',year:'numeric'}); }catch(e){ return iso; } }

      /** Extract a single string from multimedia notes (which may be array or string). */
      function mmNotes(m){ const n = m.notes; if(!n) return ''; if(typeof n === 'string') return n; if(Array.isArray(n)) return n.join('\n'); return ''; }

      /** Derive display-name from a multimedia file list entry or id. */
      function mmFileName(m){
        if(m.files && m.files.length && m.files[0].file) return m.files[0].file;
        return m.title || m.id || '';
      }

      // ── IndexedDB: retrieve saved directory handle ───────────────────
      function getDirHandleFromDB(){
        try{
          const req = indexedDB.open('myLineage-db', 1);
          return new Promise(resolve => {
            req.onupgradeneeded = e => { const db = e.target.result; if(!db.objectStoreNames.contains('handles')) db.createObjectStore('handles'); };
            req.onsuccess = e => {
              const db = e.target.result;
              const tx = db.transaction('handles','readonly');
              const g  = tx.objectStore('handles').get('photoBaseHandle');
              g.onsuccess = () => { db.close(); resolve(g.result || null); };
              g.onerror   = () => { db.close(); resolve(null); };
            };
            req.onerror = () => resolve(null);
          });
        }catch(e){ return Promise.resolve(null); }
      }

      async function ensureReadPermission(handle){
        if(!handle) return false;
        try{
          if(handle.queryPermission){
            const q = await handle.queryPermission({ mode: 'read' });
            if(q === 'granted') return true;
          }
          if(handle.requestPermission){
            const r = await handle.requestPermission({ mode: 'read' });
            return r === 'granted';
          }
          return true;
        }catch(e){ return false; }
      }

      // ── Recursively collect all image files from a directory handle ──
      const IMAGE_EXTS = new Set(['jpg','jpeg','png','gif','webp','bmp','tiff','tif','heic','avif','svg']);
      async function collectImagesFromDir(dirHandle, pathPrefix){
        const results = [];
        try{
          for await (const [name, handle] of dirHandle.entries()){
            const fullPath = pathPrefix ? pathPrefix + '/' + name : name;
            if(handle.kind === 'file'){
              const ext = name.split('.').pop().toLowerCase();
              if(IMAGE_EXTS.has(ext)) results.push({ name, fullPath, handle });
            } else if(handle.kind === 'directory'){
              const sub = await collectImagesFromDir(handle, fullPath);
              results.push(...sub);
            }
          }
        }catch(e){ console.warn('Erro ao listar pasta:', e); }
        return results;
      }

      // ── Build reverse map: multimediaId → [personDisplayName, …] ────
      function buildMediaPersonMap(){
        const map = {};
        const indis = DB.getIndividuals();
        for(const indi of indis){
          if(!indi.multimediaRefs || !indi.multimediaRefs.length) continue;
          const name = DB.getDisplayName(indi);
          for(const mid of indi.multimediaRefs){
            if(!map[mid]) map[mid] = [];
            if(!map[mid].includes(name)) map[mid].push(name);
          }
        }
        return map;
      }

      // ── State ────────────────────────────────────────────────────────
      let _allItems   = [];   // { id, name, fullPath, src, notes, tags, persons, createdAt, fromFs }
      let _filteredItems = [];
      let _dirHandle  = null;
      let _dirGranted = false;
      let _currentModalItem = null;
      let _currentModalIndex = -1;

      // ── Render thumbnails ────────────────────────────────────────────
      function renderGrid(items){
        const content = document.getElementById('albumContent');
        const badge   = document.getElementById('photoBadge');
        badge.textContent = items.length + ' foto' + (items.length !== 1 ? 's' : '');
        badge.style.display = items.length > 0 ? 'inline-block' : 'none';

        if(items.length === 0){
          const base = readPhotoBase();
          content.innerHTML = `
            <div class="album-empty">
              <i class="mdi mdi-image-off-outline" aria-hidden="true"></i>
              <p>${base && base.folder
                  ? 'Nenhuma foto encontrada na biblioteca <strong>' + escapeHtml(base.folder) + '</strong>.'
                  : 'Nenhuma pasta de fotos configurada.<br>Configure a Biblioteca de Fotos nas <a href="configuracao.html">Definições</a>.'
                }</p>
            </div>`;
          return;
        }

        const grid = document.createElement('div');
        grid.className = 'album-grid';
        for(const item of items){
          grid.appendChild(buildThumb(item));
        }
        content.innerHTML = '';
        content.appendChild(grid);
      }

      function buildThumb(item){
        const card = document.createElement('div');
        card.className = 'album-thumb';
        card.title = item.fullPath || item.name;
        card.addEventListener('click', () => openModal(item));

        const wrap = document.createElement('div');
        wrap.className = 'album-thumb-img-wrap';

        if(item.src){
          const img = document.createElement('img');
          img.src   = item.src;
          img.alt   = item.name;
          img.loading = 'lazy';
          img.onerror = () => { wrap.innerHTML = '<div class="album-no-img"><i class="mdi mdi-image-broken-variant" aria-hidden="true"></i><span>Sem pré-visualização</span></div>'; };
          wrap.appendChild(img);
        } else {
          wrap.innerHTML = '<div class="album-no-img"><i class="mdi mdi-image-outline" aria-hidden="true"></i><span>Sem pré-visualização</span></div>';
        }

        const info = document.createElement('div');
        info.className = 'album-thumb-info';

        const nameEl = document.createElement('div');
        nameEl.className = 'album-thumb-name';
        nameEl.textContent = item.name;

        const metaEl = document.createElement('div');
        metaEl.className = 'album-thumb-meta';
        metaEl.textContent = item.createdAt ? fmtDate(item.createdAt) : (item.fullPath && item.fullPath !== item.name ? item.fullPath : '');

        info.appendChild(nameEl);
        info.appendChild(metaEl);

        if(item.persons && item.persons.length > 0){
          const tagsEl = document.createElement('div');
          tagsEl.className = 'album-thumb-tags';
          item.persons.slice(0, 3).forEach(name => {
            const chip = document.createElement('span');
            chip.className = 'album-tag-chip';
            chip.textContent = name;
            tagsEl.appendChild(chip);
          });
          if(item.persons.length > 3){
            const more = document.createElement('span');
            more.className = 'album-tag-chip';
            more.textContent = '+' + (item.persons.length - 3);
            tagsEl.appendChild(more);
          }
          info.appendChild(tagsEl);
        }

        card.appendChild(wrap);
        card.appendChild(info);
        return card;
      }

      // ── Modal ────────────────────────────────────────────────────────
      function renderTagZones(item){
        const overlay = document.getElementById('modalTagOverlay');
        overlay.innerHTML = '';
        const tags = (item.tags || []).filter(t => t.bbox && t.bbox.w > 0 && t.bbox.h > 0);
        if(!tags.length) return;
        const showAlways = tags.length <= 6;
        tags.forEach(t => {
          const zone = document.createElement('div');
          zone.className = 'album-tag-zone';
          zone.style.left   = (t.bbox.x * 100) + '%';
          zone.style.top    = (t.bbox.y * 100) + '%';
          zone.style.width  = (t.bbox.w * 100) + '%';
          zone.style.height = (t.bbox.h * 100) + '%';
          zone.setAttribute('tabindex', '0');
          zone.setAttribute('title', t.personName || t.name || 'Pessoa identificada');
          const lbl = document.createElement('div');
          lbl.className = 'album-tag-zone-label' + (showAlways ? ' album-tag-zone-label-always' : '');
          lbl.textContent = t.personName || t.name || 'Pessoa';
          zone.appendChild(lbl);
          overlay.appendChild(zone);
        });
      }

      function openModalByIndex(idx){
        if(idx < 0 || idx >= _filteredItems.length) return;
        _currentModalIndex = idx;
        openModal(_filteredItems[idx]);
      }

      function updateNavButtons(){
        const prev = document.getElementById('albumNavPrev');
        const next = document.getElementById('albumNavNext');
        if(!prev || !next) return;
        prev.disabled = (_currentModalIndex <= 0);
        next.disabled = (_currentModalIndex < 0 || _currentModalIndex >= _filteredItems.length - 1);
      }

      function openModal(item){
        // Sync index if not set via openModalByIndex
        const idx = _filteredItems.indexOf(item);
        if(idx !== -1) _currentModalIndex = idx;
        _currentModalItem = item;
        updateNavButtons();
        document.getElementById('modalPhotoName').textContent = item.name;
        const img = document.getElementById('modalImg');
        document.getElementById('modalTagOverlay').innerHTML = '';
        img.src = item.src || '';
        img.alt = item.name;
        img.onload = () => renderTagZones(item);
        if(img.complete && img.naturalWidth > 0) renderTagZones(item);

        const sidebar = document.getElementById('modalSidebar');
        sidebar.innerHTML = '';

        function section(label, valueHtml, muted){
          const s = document.createElement('div');
          s.className = 'album-info-section';
          s.innerHTML = `<div class="album-info-label">${escapeHtml(label)}</div>
                         <div class="album-info-value${muted?' muted':''}">${valueHtml}</div>`;
          return s;
        }

        sidebar.appendChild(section('Ficheiro', escapeHtml(item.name)));

        if(item.fullPath && item.fullPath !== item.name){
          sidebar.appendChild(section('Caminho', escapeHtml(item.fullPath)));
        }

        if(item.createdAt){
          sidebar.appendChild(section('Adicionado em', escapeHtml(fmtDate(item.createdAt))));
        }

        // Persons tagged or linked
        const allPersons = [];
        if(item.persons && item.persons.length){ allPersons.push(...item.persons); }
        if(item.tags && item.tags.length){
          item.tags.forEach(t => { if(t.personName && !allPersons.includes(t.personName)) allPersons.push(t.personName); });
        }
        if(allPersons.length){
          const s = document.createElement('div');
          s.className = 'album-info-section';
          s.innerHTML = '<div class="album-info-label">Pessoas</div>';
          const chips = document.createElement('div');
          chips.className = 'album-info-chips';
          allPersons.forEach(name => {
            const c = document.createElement('span');
            c.className = 'album-info-chip';
            c.textContent = name;
            chips.appendChild(c);
          });
          s.appendChild(chips);
          sidebar.appendChild(s);
        } else {
          sidebar.appendChild(section('Pessoas', 'Nenhuma pessoa associada', true));
        }

        // Notes
        const notesSection = document.createElement('div');
        notesSection.className = 'album-info-section';
        notesSection.innerHTML = '<div class="album-info-label">Notas</div>';
        if(item.notes && item.notes.trim()){
          const notesEl = document.createElement('div');
          notesEl.className = 'album-info-notes';
          notesEl.textContent = item.notes;
          notesSection.appendChild(notesEl);
        } else {
          const noNotes = document.createElement('div');
          noNotes.className = 'album-info-value muted';
          noNotes.textContent = 'Sem notas.';
          notesSection.appendChild(noNotes);
        }
        sidebar.appendChild(notesSection);

        // Folder
        const base = readPhotoBase();
        if(base && base.folder){
          sidebar.appendChild(section('Biblioteca', escapeHtml(base.folder)));
        }

        document.getElementById('albumModal').classList.add('open');
        document.getElementById('albumModal').focus();
      }

      function closeModal(){
        setMaximized(false);
        document.getElementById('albumModal').classList.remove('open');
        const img = document.getElementById('modalImg');
        img.onload = null;
        if(img.src && img.src.startsWith('blob:')) URL.revokeObjectURL(img.src);
        img.src = '';
        document.getElementById('modalTagOverlay').innerHTML = '';
        _currentModalItem = null;
      }

      // ── Delete photo ─────────────────────────────────────────────────
      function deletePhoto(item){
        if(!item) return;
        if(item.fromFs){
          alert('Esta foto é lida diretamente da pasta do sistema de ficheiros e não pode ser apagada pelo álbum. Por favor elimine o ficheiro diretamente na pasta.');
          return;
        }

        // Soft-delete the multimedia record on the server
        DB.deleteMultimedia(item.id);

        // Remove the multimedia reference from every individual that had it
        const indis = DB.getIndividuals();
        for(const indi of indis){
          if(!indi.multimediaRefs || !indi.multimediaRefs.length) continue;
          const idx = indi.multimediaRefs.indexOf(item.id);
          if(idx !== -1){
            indi.multimediaRefs.splice(idx, 1);
            DB.saveIndividual(indi);
          }
        }

        // Update in-memory state
        _allItems      = _allItems.filter(i => i.id !== item.id);
        _filteredItems = _filteredItems.filter(i => i.id !== item.id);

        closeModal();
        renderGrid(_filteredItems);
      }

      // ── Confirm dialog wiring ────────────────────────────────────────
      document.getElementById('deleteCancelBtn').addEventListener('click', () => {
        document.getElementById('deleteConfirmOverlay').classList.remove('open');
      });
      document.getElementById('deleteConfirmBtn').addEventListener('click', () => {
        const item = _currentModalItem;
        document.getElementById('deleteConfirmOverlay').classList.remove('open');
        deletePhoto(item);
      });

      document.getElementById('albumModalDelete').addEventListener('click', () => {
        if(!_currentModalItem) return;
        if(_currentModalItem.fromFs){
          deletePhoto(_currentModalItem);
          return;
        }
        const msg = document.getElementById('deleteConfirmMsg');
        msg.textContent = 'A foto "' + _currentModalItem.name + '" será removida do álbum e todas as associações a pessoas serão eliminadas. Esta ação não pode ser desfeita.';
        document.getElementById('deleteConfirmOverlay').classList.add('open');
      });

      // ── Download helper ─────────────────────────────────────────────
      async function _downloadPhoto(src, name){
        if (!src) return;
        try {
          let url = src;
          let revoke = false;
          if (/^https?:\/\//i.test(src)) {
            const resp = await fetch(src);
            const blob = await resp.blob();
            url = URL.createObjectURL(blob);
            revoke = true;
          }
          const a = document.createElement('a');
          a.href = url;
          a.download = name || 'foto';
          document.body.appendChild(a);
          a.click();
          a.remove();
          if (revoke) setTimeout(() => URL.revokeObjectURL(url), 10000);
        } catch(e) { console.error('Erro ao descarregar foto:', e); }
      }

      // ── Maximize / restore ───────────────────────────────────────────
      function setMaximized(val){
        const inner = document.querySelector('.album-modal-inner');
        const icon  = document.getElementById('albumModalMaximizeIcon');
        const btn   = document.getElementById('albumModalMaximize');
        if(val){
          inner.classList.add('maximized');
          icon.classList.replace('mdi-arrow-expand', 'mdi-arrow-collapse');
          btn.title = 'Restaurar (F)';
        } else {
          inner.classList.remove('maximized');
          icon.classList.replace('mdi-arrow-collapse', 'mdi-arrow-expand');
          btn.title = 'Maximizar (F)';
        }
      }
      document.getElementById('albumModalMaximize').addEventListener('click', () => {
        const inner = document.querySelector('.album-modal-inner');
        setMaximized(!inner.classList.contains('maximized'));
      });

      document.getElementById('albumModalDownload').addEventListener('click', async () => {
        if (!_currentModalItem) return;
        await _downloadPhoto(_currentModalItem.src, _currentModalItem.name);
      });

      document.getElementById('albumModalClose').addEventListener('click', closeModal);
      document.getElementById('albumModal').addEventListener('click', e => { if(e.target === document.getElementById('albumModal')) closeModal(); });
      document.getElementById('albumNavPrev').addEventListener('click', () => openModalByIndex(_currentModalIndex - 1));
      document.getElementById('albumNavNext').addEventListener('click', () => openModalByIndex(_currentModalIndex + 1));
      document.addEventListener('keydown', e => {
        const modalOpen = document.getElementById('albumModal').classList.contains('open');
        if(e.key === 'Escape'){
          const overlay = document.getElementById('deleteConfirmOverlay');
          if(overlay.classList.contains('open')){ overlay.classList.remove('open'); return; }
          closeModal();
          return;
        }
        if(modalOpen && e.key === 'ArrowLeft')  { e.preventDefault(); openModalByIndex(_currentModalIndex - 1); }
        if(modalOpen && e.key === 'ArrowRight') { e.preventDefault(); openModalByIndex(_currentModalIndex + 1); }
        if(modalOpen && e.key.toLowerCase() === 'f') {
          const inner = document.querySelector('.album-modal-inner');
          setMaximized(!inner.classList.contains('maximized'));
        }
      });

      // ── Search / filter ──────────────────────────────────────────────
      document.getElementById('albumSearch').addEventListener('input', function(){
        const q = this.value.trim().toLowerCase();
        if(!q){
          _filteredItems = _allItems;
        } else {
          _filteredItems = _allItems.filter(item => {
            if((item.name || '').toLowerCase().includes(q)) return true;
            if((item.fullPath || '').toLowerCase().includes(q)) return true;
            if((item.notes || '').toLowerCase().includes(q)) return true;
            if(item.persons && item.persons.some(n => n.toLowerCase().includes(q))) return true;
            if(item.tags && item.tags.some(t => (t.personName||'').toLowerCase().includes(q))) return true;
            return false;
          });
        }
        renderGrid(_filteredItems);
      });

      // ── Load all photos ──────────────────────────────────────────────
      async function loadAlbum(){
        const content   = document.getElementById('albumContent');
        const loaderEl  = document.getElementById('albumLoader');
        if(loaderEl) loaderEl.style.display = 'flex';

        try{
          const multimedia   = DB.getMultimedia();   // OBJE records from server
          const mediaPersons = buildMediaPersonMap(); // multimediaId → [name, …]
          const items        = [];

          // 1. Multimedia records stored on the server
          _dirHandle  = await getDirHandleFromDB();
          _dirGranted = _dirHandle ? await ensureReadPermission(_dirHandle) : false;

          for(const m of multimedia){
            let src = null;
            const fileName = mmFileName(m);

            // If the file field is already an external URL, use it directly
            if(fileName && /^https?:\/\//i.test(fileName)){
              src = fileName;
            }
            // Prefer reading from directory handle (file on disk)
            else if(fileName && _dirHandle && _dirGranted){
              try{
                const fh   = await _dirHandle.getFileHandle(fileName);
                const file = await fh.getFile();
                src = URL.createObjectURL(file);
              }catch(e){
                src = m.dataUrl || null;
              }
            } else {
              src = m.dataUrl || null;
            }

            // For display, use just the basename if fileName is a full URL
            const displayName = (fileName && /^https?:\/\//i.test(fileName))
              ? (m.title || decodeURIComponent(fileName.split('/').pop().split('?')[0]) || m.id)
              : (fileName || m.id);

            items.push({
              id:        m.id,
              name:      displayName,
              fullPath:  fileName || m.id,
              src,
              notes:     mmNotes(m),
              tags:      m.tags  || [],
              persons:   mediaPersons[m.id] || [],
              createdAt: m.createdAt || null,
              fromFs:    false
            });
          }

          // 2. If we have FS access, also list images directly from the directory
          //    (files that exist in the folder but were not registered as multimedia)
          if(_dirHandle && _dirGranted){
            const registeredNames = new Set(multimedia.map(m => mmFileName(m)).filter(Boolean));
            const fsImages = await collectImagesFromDir(_dirHandle, '');
            for(const entry of fsImages){
              if(registeredNames.has(entry.name)) continue;

              let src = null;
              try{
                const file = await entry.handle.getFile();
                src = URL.createObjectURL(file);
              }catch(e){}

              items.push({
                id:        'fs::' + entry.fullPath,
                name:      entry.name,
                fullPath:  entry.fullPath,
                src,
                notes:     '',
                tags:      [],
                persons:   [],
                createdAt: null,
                fromFs:    true
              });
            }
          }

          _allItems      = items;
          _filteredItems = items;
          renderGrid(items);
        }catch(e){
          console.error(e);
          content.innerHTML = `<div class="album-empty"><i class="mdi mdi-alert-outline" aria-hidden="true"></i><p>Erro ao carregar o álbum: ${escapeHtml(String(e))}</p></div>`;
        }
      }
      // ── Export to PDF ──────────────────────────────────────────────────
      async function blobSrcToDataUrl(src){
        if(!src) return { dataUrl: null, natW: 0, natH: 0 };
        return new Promise(resolve => {
          const img = new Image();
          img.crossOrigin = 'anonymous';
          img.onload = () => {
            const nw = img.naturalWidth  || 800;
            const nh = img.naturalHeight || 800;
            try{
              const c = document.createElement('canvas');
              c.width  = nw;
              c.height = nh;
              c.getContext('2d').drawImage(img, 0, 0);
              resolve({ dataUrl: c.toDataURL('image/jpeg', 0.85), natW: nw, natH: nh });
            }catch(e){
              resolve({ dataUrl: src.startsWith('data:') ? src : null, natW: nw, natH: nh });
            }
          };
          img.onerror = () => resolve({ dataUrl: null, natW: 0, natH: 0 });
          img.src = src;
        });
      }

      async function exportAlbumToPDF(){
        if(!_allItems.length){ alert('Não há fotos para exportar.'); return; }
        if(!window.jspdf){ alert('Biblioteca jsPDF não carregada. Verifique a ligação à internet.'); return; }

        const btn     = document.getElementById('btnExportPdf');
        const overlay = document.getElementById('pdfProgressOverlay');
        const msg     = document.getElementById('pdfProgressMsg');
        const bar     = document.getElementById('pdfProgressBar');
        btn.disabled  = true;
        overlay.classList.add('open');

        try{
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

          const PW = 210, PH = 297;
          const MT      = 14;
          const GAP     = 10;
          const CARD_W  = 174;
          const CARD_X  = (PW - CARD_W) / 2;
          const CARD_H  = (PH - MT * 2 - GAP) / 2;

          const F_PAD       = 6;
          const CAP_H       = 26;
          const PHOTO_MAX_W = CARD_W - F_PAD * 2;
          const PHOTO_MAX_H = CARD_H - F_PAD - CAP_H - 2;

          function cardTop(slotIdx){ return MT + slotIdx * (CARD_H + GAP); }

          function fitSize(natW, natH, maxW, maxH){
            if(!natW || !natH) return { w: maxW, h: maxH };
            const scale = Math.min(maxW / natW, maxH / natH);
            return { w: natW * scale, h: natH * scale };
          }

          function drawCard(item, dataUrl, natW, natH, slotIdx){
            const cy = cardTop(slotIdx);
            const cx = CARD_X;

            doc.setFillColor(182, 185, 196);
            doc.setDrawColor(182, 185, 196);
            doc.roundedRect(cx + 2.5, cy + 3, CARD_W, CARD_H, 2.5, 2.5, 'F');

            doc.setFillColor(255, 255, 255);
            doc.setDrawColor(208, 210, 218);
            doc.setLineWidth(0.2);
            doc.roundedRect(cx, cy, CARD_W, CARD_H, 2.5, 2.5, 'FD');

            const { w: iw, h: ih } = fitSize(natW, natH, PHOTO_MAX_W, PHOTO_MAX_H);
            const ix = cx + (CARD_W - iw) / 2;
            const iy = cy + F_PAD + (PHOTO_MAX_H - ih) / 2;

            if(dataUrl){
              try{
                const fmt = dataUrl.startsWith('data:image/png') ? 'PNG' : 'JPEG';
                doc.addImage(dataUrl, fmt, ix, iy, iw, ih, '', 'FAST');
              }catch(e){ _drawImgPlaceholder(doc, cx + F_PAD, cy + F_PAD, PHOTO_MAX_W, PHOTO_MAX_H); }
            } else {
              _drawImgPlaceholder(doc, cx + F_PAD, cy + F_PAD, PHOTO_MAX_W, PHOTO_MAX_H);
            }

            const capLineY = cy + CARD_H - CAP_H;
            doc.setDrawColor(220, 222, 230);
            doc.setLineWidth(0.2);
            doc.line(cx + 8, capLineY, cx + CARD_W - 8, capLineY);

            const capX   = cx + F_PAD + 1;
            const capW   = CARD_W - (F_PAD + 1) * 2;
            const maxCapY = cy + CARD_H - 2;
            let ty = capLineY + 5;

            doc.setFontSize(7.5);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(28, 32, 50);
            const nameL = doc.splitTextToSize(item.name, capW);
            doc.text(nameL.slice(0, 1), capX, ty);
            ty += 4.2;

            const allPersons = [];
            if(item.persons && item.persons.length) allPersons.push(...item.persons);
            if(item.tags && item.tags.length){
              item.tags.forEach(t => { if(t.personName && !allPersons.includes(t.personName)) allPersons.push(t.personName); });
            }
            if(allPersons.length && ty < maxCapY){
              doc.setFontSize(6.5);
              doc.setFont('helvetica', 'normal');
              doc.setTextColor(55, 75, 165);
              const pplTxt = allPersons.join('  ·  ');
              const pplL = doc.splitTextToSize(pplTxt, capW);
              const maxP = Math.min(pplL.length, Math.max(1, Math.floor((maxCapY - ty - 4) / 3.6)));
              doc.text(pplL.slice(0, maxP), capX, ty);
              ty += maxP * 3.6 + 1;
            }

            if(item.notes && item.notes.trim() && ty + 3 < maxCapY){
              doc.setFontSize(6);
              doc.setFont('helvetica', 'italic');
              doc.setTextColor(105, 108, 122);
              const noteTxt = item.notes.trim().replace(/\n+/g, ' ');
              const noteL = doc.splitTextToSize(noteTxt, capW);
              const maxN = Math.max(1, Math.floor((maxCapY - ty) / 3.2));
              doc.text(noteL.slice(0, maxN), capX, ty);
            }
          }

          function _drawImgPlaceholder(doc, x, y, w, h){
            doc.setFillColor(236, 237, 243);
            doc.rect(x, y, w, h, 'F');
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(168, 172, 188);
            doc.text('Sem imagem', x + w / 2, y + h / 2, { align: 'center', baseline: 'middle' });
          }

          const total = _allItems.length;
          for(let i = 0; i < total; i++){
            msg.textContent = `A processar foto ${i + 1} de ${total}…`;
            bar.style.width  = Math.round((i / total) * 100) + '%';

            const slotIdx = i % 2;
            if(slotIdx === 0 && i > 0) doc.addPage();

            const item = _allItems[i];
            const { dataUrl, natW, natH } = await blobSrcToDataUrl(item.src);
            drawCard(item, dataUrl, natW, natH, slotIdx);

            if(i % 3 === 2) await new Promise(r => setTimeout(r, 0));
          }

          const totalPages = doc.getNumberOfPages();
          for(let p = 1; p <= totalPages; p++){
            doc.setPage(p);
            doc.setFontSize(7);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(175, 178, 192);
            doc.setDrawColor(212, 215, 224);
            doc.setLineWidth(0.25);
            doc.line(18, PH - 8, PW - 18, PH - 8);
            doc.text('myLineage – Álbum de Fotos', 18, PH - 4.5);
            doc.text('Pág. ' + p + ' / ' + totalPages, PW - 18, PH - 4.5, { align: 'right' });
          }

          bar.style.width = '100%';
          msg.textContent = 'A guardar ficheiro…';
          await new Promise(r => setTimeout(r, 80));

          const dateStr = new Date().toISOString().slice(0, 10);
          doc.save('album-myLineage-' + dateStr + '.pdf');

        }catch(e){
          console.error(e);
          alert('Erro ao gerar PDF: ' + e.message);
        }finally{
          overlay.classList.remove('open');
          bar.style.width = '0%';
          btn.disabled = false;
        }
      }
      document.getElementById('btnExportPdf').addEventListener('click', exportAlbumToPDF);
      // ── Init ─────────────────────────────────────────────────────────
      document.addEventListener('DOMContentLoaded', loadAlbum);
    </script>
    <script src="history-logger.js"></script>
  </body>
</html>
