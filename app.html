<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cadastro de Pessoas</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css">
    <style>
      .photo-area{position:relative;display:inline-block;}
      .tag-overlay{position:absolute;left:0;top:0;right:0;bottom:0;pointer-events:none}
      .tag-rect{position:absolute;border:2px solid rgba(59,130,246,0.9);background:rgba(59,130,246,0.12);pointer-events:auto;cursor:pointer;border-radius:6px;box-sizing:border-box}
      .tag-label{position:absolute;background:rgba(0,0,0,0.6);color:#fff;padding:2px 6px;border-radius:6px;font-size:12px;transform:translateY(-120%);white-space:nowrap}
      .tag-form{position:absolute;background:var(--bg-card);padding:8px;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,0.4);z-index:620}
      .tag-form input{margin-bottom:6px;}
    </style>
    <script src="remote-storage.js"></script>
  </head>
  <body>
    <div class="app-shell">
      <aside class="sidebar">
        <a href="index.html" class="logo"><i class="mdi mdi-tree" aria-hidden="true"></i><span>myLineage</span></a>
        <nav>
          <a href="app.html" class="active"><i class="mdi mdi-account-multiple" aria-hidden="true"></i>Cadastro</a>
          <a href="indicadores.html"><i class="mdi mdi-chart-bar" aria-hidden="true"></i>Indicadores</a>
          <a href="arvore.html"><i class="mdi mdi-sitemap" aria-hidden="true"></i>Árvore</a>
          <a href="gedcom.html"><i class="mdi mdi-dna" aria-hidden="true"></i>GEDCOM</a>
          <a href="album.html"><i class="mdi mdi-image-multiple" aria-hidden="true"></i>Álbum</a>
          <a href="documentos.html"><i class="mdi mdi-folder-open" aria-hidden="true"></i>Documentos</a>
          <a href="validacao.html"><i class="mdi mdi-shield-check" aria-hidden="true"></i>Validação</a>
          <a href="historico.html"><i class="mdi mdi-history" aria-hidden="true"></i>Histórico</a>
        </nav>
        <div class="sidebar-footer">
          <a href="apis.html"><i class="mdi mdi-api" aria-hidden="true"></i>APIs</a>
          <a href="configuracao.html"><i class="mdi mdi-cog" aria-hidden="true"></i>Definições</a>
        </div>
      </aside>
      <main class="content">
        <div class="topbar">
          <div style="display:flex;align-items:center;gap:12px"><h1>Cadastro de Pessoas</h1></div>
        </div>
        <div class="main-grid">
          <div class="table-panel card">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0;">
                <div style="display:flex;gap:12px;align-items:center;">
                    <div style="display:flex;align-items:center;gap:6px;">
                      <input type="text" id="nameFilter" placeholder="Filtrar por nome..." style="padding:8px 10px;border-radius:8px;border:1px solid rgba(163,163,255,0.06);background:transparent;color:var(--text-main);" />
                      <button id="nameSearchBtn" class="icon-btn" type="button" title="Pesquisar"><i class="mdi mdi-magnify" aria-hidden="true"></i></button>
                    </div>
                  </div>
              </div>
          <div>
            <label><input type="checkbox" id="hideDeleted" checked /> Ocultar registros excluídos</label>
          </div>
          <table id="peopleTable">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="paginationControls" style="color:var(--text-secondary);margin-top:12px;"></div>
      </div>
      <div class="form-panel card" id="formPanel" style="display:none;">
        <div class="accordion">
          <div class="accordion-card" id="cardDados">
            <button type="button" class="accordion-header" data-target="contentDados"><span>Dados Pessoais</span><span class="accordion-arrow"><i class="mdi mdi-chevron-down" aria-hidden="true"></i></span></button>
            <div class="accordion-content" id="contentDados">
              <form id="personForm">
                <input type="hidden" id="indiId" />
                <div>
                  <label for="firstName">First Name</label>
                  <input type="text" id="firstName" name="firstName" required />
                </div>
                <div>
                  <label for="lastName">Last Name</label>
                  <input type="text" id="lastName" name="lastName" required />
                </div>
                <div>
                  <label for="gender">Gender</label>
                  <select id="gender" name="gender">
                    <option value="">-- selecione --</option>
                    <option value="M">Masculino</option>
                    <option value="F">Feminino</option>
                    <option value="X">Outro</option>
                  </select>
                </div>
                <div class="full">
                  <label for="notes">Notes</label>
                  <textarea id="notes" name="notes"></textarea>
                </div>
                <div id="ageInfo"></div>
                <div class="full" style="display:flex;gap:8px;flex-wrap:wrap;">
                  <button type="submit" id="saveBtn" class="btn">Salvar</button>
                  <button type="button" id="resetBtn" class="btn btn-ghost">Limpar</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div id="datesInfo" style="font-size:0.85em;color:#666;margin-top:16px;text-align:right;"></div>
      </div>
        </div>
      </main>
    </div>

    <!-- ── Right drawer overlay ── -->
    <div class="drawer-overlay" id="drawerOverlay"></div>

    <!-- ── Right drawer ── -->
    <div class="drawer" id="personDrawer" role="dialog" aria-modal="true" aria-labelledby="drawerTitle">
      <div class="drawer-header">
        <button class="btn btn-ghost btn-sm" id="drawerBackBtn" style="display:none;padding:2px 6px;margin-right:4px;" title="Voltar"><i class="mdi mdi-arrow-left"></i></button>
        <h2 id="drawerTitle" style="flex:1;">Detalhes da Pessoa</h2>
        <button class="drawer-close" id="drawerCloseBtn" aria-label="Fechar painel"><i class="mdi mdi-close"></i></button>
      </div>
      <div class="drawer-person-header" id="drawerPersonHeader">
        <div class="drawer-avatar" id="drawerAvatar"></div>
        <div>
          <div class="drawer-person-name" id="drawerPersonName">—</div>
          <div class="drawer-person-sub" id="drawerPersonSub"></div>
        </div>
      </div>
      <div class="drawer-body" id="drawerBody"></div>
      <div class="drawer-footer">
        <button class="btn btn-danger btn-sm" id="drawerDeleteBtn"><i class="mdi mdi-delete-outline"></i> Apagar</button>
        <button class="btn btn-ghost btn-sm" id="drawerCancelBtn">Cancelar</button>
        <button class="btn btn-sm" id="drawerSaveBtn"><i class="mdi mdi-content-save-outline"></i> Guardar</button>
      </div>
    </div>

    <!-- ── Drawer photo modal ── -->
    <div id="drawerPhotoModal" style="display:none;position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.88);align-items:center;justify-content:center;z-index:600;">
      <div style="background:var(--bg-card);border-radius:14px;max-width:1100px;width:97%;max-height:95vh;box-sizing:border-box;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 24px 64px rgba(0,0,0,0.7);">
        <!-- Header -->
        <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 18px 10px;border-bottom:1px solid rgba(255,255,255,0.07);flex-shrink:0;">
          <div style="display:flex;align-items:center;gap:10px;">
            <i class="mdi mdi-image-outline" style="font-size:1.2rem;color:var(--accent);"></i>
            <span id="drawerPhotoModalTitle" style="font-weight:700;font-size:1.05rem;">Foto</span>
            <span id="drawerPhotoCounter" style="font-size:0.82rem;color:#888;padding:2px 8px;background:rgba(255,255,255,0.06);border-radius:20px;"></span>
          </div>
          <button onclick="_drawerClosePhotoModal()" class="btn btn-ghost btn-sm" title="Fechar (Esc)"><i class="mdi mdi-close"></i></button>
        </div>
        <!-- Body: image + info -->
        <div style="display:flex;flex:1;min-height:0;overflow:hidden;">
          <!-- Image area with prev/next arrows -->
          <div style="flex:1;display:flex;align-items:center;justify-content:center;position:relative;padding:12px;min-width:0;background:rgba(0,0,0,0.3);">
            <!-- Prev button -->
            <button id="drawerPhotoPrev" onclick="_drawerNavPhoto(-1)" title="Anterior (←)" style="position:absolute;left:8px;top:50%;transform:translateY(-50%);z-index:10;background:rgba(40,40,60,0.85);border:1px solid rgba(255,255,255,0.12);color:#fff;border-radius:50%;width:40px;height:40px;font-size:1.3rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.15s;" onmouseover="this.style.background='rgba(90,90,180,0.9)'" onmouseout="this.style.background='rgba(40,40,60,0.85)'"><i class="mdi mdi-chevron-left"></i></button>
            <!-- Image -->
            <div id="drawerModalImageArea" style="max-width:100%;max-height:100%;overflow:visible;display:flex;align-items:center;justify-content:center;"></div>
            <!-- Next button -->
            <button id="drawerPhotoNext" onclick="_drawerNavPhoto(1)" title="Seguinte (→)" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);z-index:10;background:rgba(40,40,60,0.85);border:1px solid rgba(255,255,255,0.12);color:#fff;border-radius:50%;width:40px;height:40px;font-size:1.3rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.15s;" onmouseover="this.style.background='rgba(90,90,180,0.9)'" onmouseout="this.style.background='rgba(40,40,60,0.85)'"><i class="mdi mdi-chevron-right"></i></button>
          </div>
          <!-- Info panel -->
          <div id="drawerPhotoInfoPanel" style="width:260px;flex-shrink:0;display:flex;flex-direction:column;gap:0;border-left:1px solid rgba(255,255,255,0.07);overflow-y:auto;">
            <div style="padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.06);">
              <div style="font-size:0.72rem;text-transform:uppercase;letter-spacing:0.06em;color:#888;margin-bottom:5px;">Ficheiro</div>
              <div id="drawerPhotoFileName" style="font-size:0.88rem;word-break:break-all;color:var(--text-main);">—</div>
            </div>
            <div style="padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.06);">
              <div style="font-size:0.72rem;text-transform:uppercase;letter-spacing:0.06em;color:#888;margin-bottom:5px;">Pessoas identificadas</div>
              <div id="drawerPhotoTaggedPeople" style="font-size:0.88rem;color:var(--text-main);"></div>
            </div>
            <div style="padding:14px 16px;flex:1;display:flex;flex-direction:column;">
              <div style="font-size:0.72rem;text-transform:uppercase;letter-spacing:0.06em;color:#888;margin-bottom:5px;">Notas</div>
              <textarea id="drawerPhotoNotesArea" style="flex:1;min-height:80px;padding:8px;border-radius:8px;border:1px solid rgba(163,163,255,0.08);background:rgba(35,40,58,0.7);color:var(--text-main);box-sizing:border-box;resize:none;font-size:0.88rem;"></textarea>
              <button class="btn btn-sm" style="margin-top:8px;" onclick="_drawerSavePhotoNotes()"><i class="mdi mdi-content-save-outline"></i> Guardar Notas</button>
            </div>
            <div style="padding:10px 16px;border-top:1px solid rgba(255,255,255,0.06);">
              <div style="font-size:0.72rem;text-transform:uppercase;letter-spacing:0.06em;color:#888;margin-bottom:6px;">Identificar pessoa na foto</div>
              <div style="font-size:0.78rem;color:#888;margin-bottom:6px;">Arrasta um retângulo sobre a imagem.</div>
            </div>
          </div>
        </div>
        <!-- Thumbnail strip -->
        <div id="drawerPhotoStrip" style="display:flex;gap:6px;padding:10px 14px;border-top:1px solid rgba(255,255,255,0.07);flex-shrink:0;overflow-x:auto;background:rgba(0,0,0,0.2);"></div>
      </div>
    </div>

    <script>
    (function(){
      'use strict';
      const DB = window.GedcomDB;

      /* ── Helpers ──────────────────────────────────────────────────────── */
      const MONTHS = ['','JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
      const MONTHS_MAP = {JAN:1,FEB:2,MAR:3,APR:4,MAY:5,JUN:6,JUL:7,AUG:8,SEP:9,OCT:10,NOV:11,DEC:12};
      const QUAL_TO_GED = {'Antes de':'BEF','Depois de':'AFT','Cerca de':'ABT'};
      const GED_TO_QUAL = {BEF:'Antes de',AFT:'Depois de',ABT:'Cerca de',EST:'Cerca de'};

      function buildGedcomDate(day,month,year,qualifier){
        let p=[];
        if(qualifier && qualifier!=='Exatamente'){ p.push(QUAL_TO_GED[qualifier]||qualifier); }
        if(day) p.push(String(day));
        if(month) p.push(MONTHS[month]||'');
        if(year) p.push(String(year));
        return p.join(' ');
      }
      function parseGedcomDate(s){
        if(!s) return {};
        const tokens=s.toUpperCase().split(/\s+/);
        let q=null,d=null,m=null,y=null;
        for(const t of tokens){
          if(GED_TO_QUAL[t]) q=GED_TO_QUAL[t];
          else if(MONTHS_MAP[t]) m=MONTHS_MAP[t];
          else if(/^\d{3,4}$/.test(t)) y=parseInt(t);
          else if(/^\d{1,2}$/.test(t)&&!d) d=parseInt(t);
        }
        return {day:d,month:m,year:y,qualifier:q};
      }
      function fmtEventDate(ev){
        if(!ev||!ev.date) return '';
        const p=parseGedcomDate(ev.date);
        const qualMap={'Antes de':'ant.','Depois de':'dep.','Cerca de':'c.'};
        const q=p.qualifier?(qualMap[p.qualifier]||p.qualifier)+' ':'';
        let parts=[];
        if(p.day) parts.push(String(p.day).padStart(2,'0'));
        if(p.month) parts.push(String(p.month).padStart(2,'0'));
        if(p.year) parts.push(String(p.year));
        return q+(parts.length?parts.join('/'):ev.date);
      }

      function _esc(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

      function formatISODate(dateStr){
        if(!dateStr) return '';
        const d=new Date(dateStr);
        if(isNaN(d)) return dateStr;
        return d.getDate().toString().padStart(2,'0')+'-'+(d.getMonth()+1).toString().padStart(2,'0')+'-'+d.getFullYear();
      }

      /* ── Accordion ────────────────────────────────────────────────────── */
      const formPanel = document.getElementById('formPanel');
      function showFormPanel(show){ formPanel.style.display = show ? 'block' : 'none'; }
      function openAccordion(id){ const el=document.getElementById(id); if(!el) return; el.style.display='block'; if(el.parentElement) el.parentElement.classList.add('open'); }
      function closeAccordion(id){ const el=document.getElementById(id); if(!el) return; el.style.display='none'; if(el.parentElement) el.parentElement.classList.remove('open'); }
      function toggleAccordion(id){ const el=document.getElementById(id); if(!el) return; if(el.style.display==='block') closeAccordion(id); else openAccordion(id); }
      document.addEventListener('click',function(e){ const btn=e.target.closest&&e.target.closest('.accordion-header'); if(btn&&btn.dataset&&btn.dataset.target) toggleAccordion(btn.dataset.target); });

      showFormPanel(false);
      closeAccordion('contentDados');

      /* ── Pagination + filter ──────────────────────────────────────────── */
      let currentPage = 1;
      const PAGE_SIZE = 10;
      let currentFilter = '';

      function renderPagination(totalPages){
        const ctrl=document.getElementById('paginationControls');
        if(!ctrl) return;
        if(totalPages<=1){ ctrl.innerHTML=''; return; }
        ctrl.style.whiteSpace='nowrap'; ctrl.style.display='inline-flex'; ctrl.style.alignItems='center'; ctrl.style.gap='6px';
        ctrl.innerHTML='<button id="prevPage" '+(currentPage<=1?'disabled':'')+' class="icon-btn" aria-label="Página anterior"><i class="mdi mdi-chevron-left"></i></button><span>Página '+currentPage+' de '+totalPages+'</span><button id="nextPage" '+(currentPage>=totalPages?'disabled':'')+' class="icon-btn" aria-label="Próxima página"><i class="mdi mdi-chevron-right"></i></button>';
        const prev=document.getElementById('prevPage'), next=document.getElementById('nextPage');
        if(prev) prev.addEventListener('click',function(){ if(currentPage>1){ currentPage--; renderTable(); }});
        if(next) next.addEventListener('click',function(){ if(currentPage<totalPages){ currentPage++; renderTable(); }});
      }

      function renderTable(){
        const tbody=document.querySelector('#peopleTable tbody');
        tbody.innerHTML='';
        const hideDeleted=document.getElementById('hideDeleted').checked;
        const all=DB.getIndividuals(!hideDeleted);
        const filtered=all.filter(indi=>{
          if(hideDeleted && indi.deletedAt) return false;
          if(!currentFilter) return true;
          return DB.getDisplayName(indi).toLowerCase().indexOf(currentFilter)!==-1;
        });
        const totalPages=Math.max(1,Math.ceil(filtered.length/PAGE_SIZE));
        if(currentPage>totalPages) currentPage=totalPages;
        const start=(currentPage-1)*PAGE_SIZE;
        filtered.slice(start,start+PAGE_SIZE).forEach(indi=>{
          const tr=document.createElement('tr');
          if(indi.deletedAt) tr.classList.add('deleted');
          const name=_esc(DB.getDisplayName(indi));
          tr.innerHTML='<td><a href="#" class="person-link" data-id="'+indi.id+'">'+name+'</a></td><td class="actions"><button data-id="'+indi.id+'" class="tree-focus" title="Ver na Árvore" style="background:none;border:none;cursor:pointer;padding:0;"><i class="mdi mdi-sitemap" style="font-size:1.2em;"></i></button></td>';
          tbody.appendChild(tr);
        });
        renderPagination(totalPages);
      }

      /* ── Search ────────────────────────────────────────────────────────── */
      (function(){
        const btn=document.getElementById('nameSearchBtn'),input=document.getElementById('nameFilter');
        if(btn&&input){
          btn.addEventListener('click',function(){ currentFilter=(input.value||'').toLowerCase().trim(); currentPage=1; renderTable(); });
          input.addEventListener('keydown',function(e){ if(e.key==='Enter'){ e.preventDefault(); currentFilter=(this.value||'').toLowerCase().trim(); currentPage=1; renderTable(); }});
        }
      })();

      /* ── Form panel submit ─────────────────────────────────────────────── */
      function resetForm(){
        document.getElementById('personForm').reset();
        document.getElementById('indiId').value='';
        const a=document.getElementById('ageInfo'); if(a) a.textContent='';
      }

      function showDatesInfo(indi){
        const el=document.getElementById('datesInfo');
        if(!el) return;
        if(!indi){ el.innerHTML=''; return; }
        let h='';
        if(indi.createdAt) h+='<div>Criado em: '+formatISODate(indi.createdAt)+'</div>';
        if(indi.updatedAt) h+='<div>Atualizado em: '+formatISODate(indi.updatedAt)+'</div>';
        if(indi.deletedAt) h+='<div>Excluído em: '+formatISODate(indi.deletedAt)+'</div>';
        el.innerHTML=h;
      }

      function editPersonInForm(id){
        const indi=DB.getIndividual(id);
        if(!indi) return alert('Registro não encontrado');
        document.getElementById('indiId').value=indi.id;
        document.getElementById('firstName').value=DB.getGivenName(indi);
        document.getElementById('lastName').value=DB.getSurname(indi);
        document.getElementById('gender').value=indi.sex||'';
        document.getElementById('notes').value=indi.notes||'';
        showDatesInfo(indi);
        const birth=DB.getBirthEvent(indi), death=DB.getDeathEvent(indi);
        const ageEl=document.getElementById('ageInfo');
        if(birth&&birth.date){
          const age=DB.computeAge(birth.date, death?death.date:null);
          ageEl.textContent=age==null?'':(death?'Idade ao falecer: '+age+' anos':'Idade: '+age+' anos');
        } else if(ageEl) ageEl.textContent='';
        showFormPanel(true);
        openAccordion('contentDados');
      }

      document.getElementById('personForm').addEventListener('submit',function(e){
        e.preventDefault();
        const id=document.getElementById('indiId').value;
        const given=document.getElementById('firstName').value.trim();
        const surname=document.getElementById('lastName').value.trim();
        const sex=document.getElementById('gender').value;
        const notes=document.getElementById('notes').value;
        const existing=id?DB.getIndividual(id):null;
        const data=existing?{...existing}:{};
        data.names=[{given:given,surname:surname,type:'birth'}];
        data.sex=sex||'U';
        data.notes=notes;
        if(id) data.id=id;
        DB.saveIndividual(data);
        renderTable(); resetForm(); showDatesInfo(); showFormPanel(false); closeAccordion('contentDados');
      });

      document.getElementById('resetBtn').addEventListener('click',function(){ resetForm(); showDatesInfo(); showFormPanel(false); closeAccordion('contentDados'); });

      /* ── Table click handlers ──────────────────────────────────────────── */
      document.getElementById('peopleTable').addEventListener('click',function(e){
        if(e.target&&e.target.tagName==='A') e.preventDefault();
        const el=e.target.closest&&e.target.closest('[data-id]');
        if(!el) return;
        const id=el.getAttribute('data-id');
        if(el.classList.contains('person-link')) openDrawer('edit',id);
        else if(el.classList.contains('tree-focus')){
          DB.setSetting('tempFocusPerson',id);
          window.location.href='arvore.html';
        }
      });

      document.getElementById('hideDeleted').addEventListener('change', renderTable);

      /* ═══════════════════════════════════════════════════════════════════
         DRAWER
         ═══════════════════════════════════════════════════════════════════ */
      let _drawerPersonId = null, _drawerMode = 'edit';

      function openDrawer(mode, personId){
        const footer=document.querySelector('.drawer-footer'); if(footer) footer.style.display='';
        const backBtn=document.getElementById('drawerBackBtn'); if(backBtn){ backBtn.style.display='none'; backBtn._personId=null; }
        const phdr=document.getElementById('drawerPersonHeader'); if(phdr) phdr.style.display='';
        _drawerMode=mode; _drawerPersonId=personId||null;
        const indi=personId?DB.getIndividual(personId):null;
        document.getElementById('drawerTitle').textContent=mode==='create'?'Nova Pessoa':'Editar Pessoa';
        const nameEl=document.getElementById('drawerPersonName'), subEl=document.getElementById('drawerPersonSub'), avatarEl=document.getElementById('drawerAvatar');
        if(indi){
          nameEl.textContent=DB.getDisplayName(indi);
          let sub=[];
          const birth=DB.getBirthEvent(indi); if(birth&&birth.date) sub.push('\u2605 '+fmtEventDate(birth));
          const death=DB.getDeathEvent(indi); if(death&&death.date) sub.push('\u271D '+fmtEventDate(death));
          subEl.textContent=sub.join('  ·  ');
          const thumb=DB.getThumbnailForPerson(indi.id);
          if(thumb){ avatarEl.style.backgroundImage='url('+thumb+')'; avatarEl.style.backgroundSize='cover'; avatarEl.style.backgroundPosition='center'; }
          else{ avatarEl.style.backgroundImage=''; const s=indi.sex; avatarEl.style.background=s==='F'?'#e26aa6':s==='M'?'#4493f8':'#9aa0a6'; }
        } else {
          nameEl.textContent='Nova Pessoa'; subEl.textContent='';
          avatarEl.style.backgroundImage=''; avatarEl.style.background='var(--bg-surface-2)';
        }
        const body=document.getElementById('drawerBody');
        const given=indi?DB.getGivenName(indi):'';
        const surname=indi?DB.getSurname(indi):'';
        const sex=indi?(indi.sex||''):'';
        const notes=indi?(indi.notes||''):'';
        body.innerHTML=[
          '<div class="drawer-section-label">Identidade</div>',
          '<div class="form-row"><div><label>Primeiro nome</label><input type="text" id="df_firstName" value="'+_esc(given)+'" placeholder="Nome" /></div><div><label>Apelido</label><input type="text" id="df_lastName" value="'+_esc(surname)+'" placeholder="Apelido" /></div></div>',
          '<div><label>Género</label><select id="df_gender"><option value=""'+(!sex?' selected':'')+'>​(n/a)</option><option value="M"'+(sex==='M'?' selected':'')+'>Masculino</option><option value="F"'+(sex==='F'?' selected':'')+'>Feminino</option><option value="X"'+(sex==='X'?' selected':'')+'>Outro</option></select></div>',
          '<div class="drawer-section-label" style="margin-top:8px;">Notas</div>',
          '<div><textarea id="df_notes" rows="3" placeholder="Notas...">'+_esc(notes)+'</textarea></div>',
          indi?'<div style="margin-top:6px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;"><button class="btn btn-ghost btn-sm" style="font-size:0.82rem;" onclick="openDrawerSection(\''+indi.id+'\',\'relacoes\')"><i class="mdi mdi-account-multiple-outline"></i> Relações</button><button class="btn btn-ghost btn-sm" style="font-size:0.82rem;" onclick="openDrawerSection(\''+indi.id+'\',\'eventos\')"><i class="mdi mdi-calendar-check-outline"></i> Eventos</button><button class="btn btn-ghost btn-sm" style="font-size:0.82rem;" onclick="openDrawerSection(\''+indi.id+'\',\'fotos\')"><i class="mdi mdi-image-multiple-outline"></i> Fotos</button><button class="btn btn-ghost btn-sm" style="font-size:0.82rem;" onclick="_drawerShowAddPerson(\''+indi.id+'\')"><i class="mdi mdi-account-plus-outline"></i> Adicionar</button><button class="btn btn-ghost btn-sm" style="font-size:0.82rem;" onclick="_drawerShowLinkPerson(\''+indi.id+'\')"><i class="mdi mdi-link-variant"></i> Ligar</button></div>':''
        ].join('');
        document.getElementById('personDrawer').classList.add('open');
        document.getElementById('drawerOverlay').classList.add('open');
        setTimeout(()=>{ const fi=document.getElementById('df_firstName'); if(fi) fi.focus(); },50);
      }
      window.openDrawer = openDrawer;

      function closeDrawer(){
        document.getElementById('personDrawer').classList.remove('open');
        document.getElementById('drawerOverlay').classList.remove('open');
      }

      /* ── Drawer sections ───────────────────────────────────────────────── */
      window.openDrawerSection = function(personId, section){
        const indi=DB.getIndividual(personId);
        if(!indi) return;
        const footer=document.querySelector('.drawer-footer'); if(footer) footer.style.display='none';
        const phdr=document.getElementById('drawerPersonHeader'); if(phdr) phdr.style.display='none';
        const backBtn=document.getElementById('drawerBackBtn'); if(backBtn){ backBtn.style.display=''; backBtn._personId=personId; }
        document.getElementById('drawerTitle').textContent=(section==='relacoes'?'Relações':section==='fotos'?'Fotos':'Eventos')+' — '+DB.getDisplayName(indi);
        const body=document.getElementById('drawerBody');
        body.innerHTML=section==='relacoes'?_renderRelations(personId):section==='fotos'?_renderPhotos(personId):_renderEvents(personId);
        if(section==='fotos') _buildPhotoGrid(personId);
      };

      /* ── Events section ────────────────────────────────────────────────── */
      const EVENT_TYPES = {BIRT:'Nascimento',BAPM:'Batismo',CHR:'Batizado',DEAT:'Óbito',BURI:'Sepultamento',CREM:'Cremação',ADOP:'Adoção',OCCU:'Ocupação',RESI:'Residência',EVEN:'Outro'};

      function _renderEvents(personId){
        const indi=DB.getIndividual(personId);
        const evs=(indi&&indi.events||[]);
        let html='<div style="margin-bottom:12px;"><button class="btn btn-sm" onclick="_drawerShowAddEvent(\''+_esc(personId)+'\')" style="font-size:0.83rem;"><i class="mdi mdi-plus"></i> Adicionar Evento</button></div>';
        if(!evs.length){ html+='<div style="color:#888;padding:4px 0 12px;">Nenhum evento cadastrado.</div>'; return html; }
        html+='<div class="mini-list">';
        evs.forEach((ev,i)=>{
          const label=EVENT_TYPES[ev.type]||ev.type||'';
          html+='<div class="mini-card" style="padding:10px 12px;"><div style="display:flex;justify-content:space-between;align-items:center;gap:8px;"><div style="flex:1;"><span style="font-weight:600;font-size:0.9rem;">'+_esc(label)+'</span><span style="color:#888;font-size:0.82rem;margin-left:8px;">'+_esc(fmtEventDate(ev))+'</span></div><div style="display:flex;gap:2px;flex-shrink:0;"><button onclick="_drawerEditEvent('+i+',\''+_esc(personId)+'\')" title="Editar" style="background:none;border:none;cursor:pointer;color:#4493f8;padding:2px 4px;font-size:1rem;"><i class="mdi mdi-pencil-outline"></i></button><button onclick="_drawerDeleteEvent('+i+',\''+_esc(personId)+'\')" title="Apagar" style="background:none;border:none;cursor:pointer;color:#e06060;padding:2px 4px;font-size:1rem;"><i class="mdi mdi-trash-can-outline"></i></button></div></div>'+(ev.place?'<div style="color:#aaa;font-size:0.82rem;margin-top:3px;">&#128205; '+_esc(ev.place)+'</div>':'')+(ev.notes?'<div style="color:#bbb;font-size:0.82rem;margin-top:3px;">'+_esc(ev.notes)+'</div>':'')+'</div>';
        });
        html+='</div>';
        return html;
      }

      window._drawerDeleteEvent = function(idx,personId){
        if(!confirm('Apagar este evento?')) return;
        const indi=DB.getIndividual(personId); if(!indi) return;
        indi.events.splice(idx,1);
        DB.saveIndividual(indi);
        document.getElementById('drawerBody').innerHTML=_renderEvents(personId);
      };

      window._drawerEditEvent = function(idx,personId){
        const indi=DB.getIndividual(personId); if(!indi) return;
        const ev=indi.events[idx]; if(!ev) return;
        const p=parseGedcomDate(ev.date);
        const body=document.getElementById('drawerBody');
        const opts=Object.entries(EVENT_TYPES).map(([k,v])=>'<option value="'+k+'"'+(ev.type===k?' selected':'')+'>'+v+'</option>').join('');
        body.innerHTML='<div style="padding:4px 0 8px;"><h3 style="font-size:0.95rem;margin:0 0 14px;">Editar Evento</h3><div style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Tipo</label><select id="editEvType" style="width:100%;">'+opts+'</select></div><div style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Data</label><select id="editEvQual" style="width:100%;margin-bottom:6px;"><option value="Exatamente"'+((!p.qualifier||p.qualifier==='Exatamente')?' selected':'')+'>Exatamente</option><option value="Antes de"'+(p.qualifier==='Antes de'?' selected':'')+'>Antes de</option><option value="Depois de"'+(p.qualifier==='Depois de'?' selected':'')+'>Depois de</option><option value="Cerca de"'+(p.qualifier==='Cerca de'?' selected':'')+'>Cerca de</option></select><div style="display:flex;gap:6px;"><input id="editEvDay" type="number" min="1" max="31" placeholder="Dia" value="'+(p.day||'')+'" style="flex:1;min-width:0;text-align:center;"/><input id="editEvMonth" type="number" min="1" max="12" placeholder="Mês" value="'+(p.month||'')+'" style="flex:1;min-width:0;text-align:center;"/><input id="editEvYear" type="number" min="1" max="9999" placeholder="Ano" value="'+(p.year||'')+'" style="flex:2;min-width:0;text-align:center;"/></div></div><div style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Local</label><input id="editEvPlace" type="text" value="'+_esc(ev.place||'')+'" style="width:100%;"/></div><div style="margin-bottom:14px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Notas</label><textarea id="editEvNotes" rows="3" style="width:100%;resize:vertical;">'+_esc(ev.notes||'')+'</textarea></div><div style="display:flex;gap:8px;justify-content:flex-end;"><button class="btn btn-ghost btn-sm" onclick="openDrawerSection(\''+_esc(personId)+'\',\'eventos\')">Cancelar</button><button class="btn btn-sm" onclick="_drawerSaveEditEvent('+idx+',\''+_esc(personId)+'\')"><i class="mdi mdi-content-save-outline"></i> Guardar</button></div></div>';
      };

      window._drawerSaveEditEvent = function(idx,personId){
        const indi=DB.getIndividual(personId); if(!indi) return;
        const type=(document.getElementById('editEvType')||{}).value||'EVEN';
        const qual=(document.getElementById('editEvQual')||{}).value;
        const day=parseInt((document.getElementById('editEvDay')||{}).value)||null;
        const month=parseInt((document.getElementById('editEvMonth')||{}).value)||null;
        const year=parseInt((document.getElementById('editEvYear')||{}).value)||null;
        if(!day&&!month&&!year){ alert('Preencha pelo menos um campo de data.'); return; }
        const place=((document.getElementById('editEvPlace')||{}).value||'').trim();
        const notes=((document.getElementById('editEvNotes')||{}).value||'').trim();
        indi.events[idx]={type,date:buildGedcomDate(day,month,year,qual),place:place||undefined,notes:notes||undefined};
        DB.saveIndividual(indi);
        openDrawerSection(personId,'eventos');
      };

      window._drawerShowAddEvent = function(personId){
        const opts=Object.entries(EVENT_TYPES).map(([k,v])=>'<option value="'+k+'">'+v+'</option>').join('');
        document.getElementById('drawerBody').innerHTML='<div style="padding:4px 0 8px;"><h3 style="font-size:0.95rem;margin:0 0 14px;">Novo Evento</h3><div style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Tipo</label><select id="addEvType" style="width:100%;">'+opts+'</select></div><div style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Data</label><select id="addEvQual" style="width:100%;margin-bottom:6px;"><option value="Exatamente" selected>Exatamente</option><option value="Antes de">Antes de</option><option value="Depois de">Depois de</option><option value="Cerca de">Cerca de</option></select><div style="display:flex;gap:6px;"><input id="addEvDay" type="number" min="1" max="31" placeholder="Dia" style="flex:1;min-width:0;text-align:center;"/><input id="addEvMonth" type="number" min="1" max="12" placeholder="Mês" style="flex:1;min-width:0;text-align:center;"/><input id="addEvYear" type="number" min="1" max="9999" placeholder="Ano" style="flex:2;min-width:0;text-align:center;"/></div></div><div style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Local</label><input id="addEvPlace" type="text" placeholder="Local do evento" style="width:100%;"/></div><div style="margin-bottom:14px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Notas</label><textarea id="addEvNotes" rows="3" placeholder="Notas..." style="width:100%;resize:vertical;"></textarea></div><div style="display:flex;gap:8px;justify-content:flex-end;"><button class="btn btn-ghost btn-sm" onclick="openDrawerSection(\''+_esc(personId)+'\',\'eventos\')">Cancelar</button><button class="btn btn-sm" onclick="_drawerSaveNewEvent(\''+_esc(personId)+'\')"><i class="mdi mdi-content-save-outline"></i> Guardar</button></div></div>';
      };

      window._drawerSaveNewEvent = function(personId){
        const indi=DB.getIndividual(personId); if(!indi) return;
        const type=(document.getElementById('addEvType')||{}).value||'EVEN';
        const qual=(document.getElementById('addEvQual')||{}).value;
        const day=parseInt((document.getElementById('addEvDay')||{}).value)||null;
        const month=parseInt((document.getElementById('addEvMonth')||{}).value)||null;
        const year=parseInt((document.getElementById('addEvYear')||{}).value)||null;
        if(!day&&!month&&!year){ alert('Preencha pelo menos um campo de data.'); return; }
        const place=((document.getElementById('addEvPlace')||{}).value||'').trim();
        const notes=((document.getElementById('addEvNotes')||{}).value||'').trim();
        if(!indi.events) indi.events=[];
        indi.events.push({type,date:buildGedcomDate(day,month,year,qual),place:place||undefined,notes:notes||undefined});
        DB.saveIndividual(indi);
        openDrawerSection(personId,'eventos');
      };

      /* ── Relations section ─────────────────────────────────────────────── */
      function _getRelationsForPerson(personId){
        const rels=[];
        const parents=DB.getParents(personId);
        parents.forEach(p=>rels.push({type:'ancestor',targetId:p.id,name:DB.getDisplayName(p),sex:p.sex}));
        const children=DB.getChildren(personId);
        children.forEach(c=>rels.push({type:'child',targetId:c.id,name:DB.getDisplayName(c),sex:c.sex}));
        const spouses=DB.getSpouses(personId);
        spouses.forEach(s=>rels.push({type:'mate',targetId:s.id,name:DB.getDisplayName(s),sex:s.sex}));
        const siblings=DB.getSiblings(personId);
        siblings.forEach(s=>rels.push({type:'siblin',targetId:s.id,name:DB.getDisplayName(s),sex:s.sex}));
        return rels;
      }

      function _renderRelations(personId){
        const rels=_getRelationsForPerson(personId);
        const typeDesc={siblin:'Irmão / Irmã',ancestor:'Pai / Mãe',child:'Filho(a)',mate:'Companheiro(a)'};
        let html='<div style="margin-bottom:12px;"><button class="btn btn-sm" onclick="_drawerShowAddRelation(\''+_esc(personId)+'\')" style="font-size:0.83rem;"><i class="mdi mdi-plus"></i> Adicionar Relação</button></div>';
        if(!rels.length){ html+='<div style="color:#888;padding:4px 0 12px;">Nenhuma relação cadastrada.</div>'; return html; }
        html+='<div class="mini-list">';
        rels.forEach(r=>{
          let desc=typeDesc[r.type]||r.type;
          if(r.sex==='F'){ if(desc.includes('Filho')) desc='Filha'; if(desc.includes('Pai')) desc='Mãe'; if(desc.includes('Compan')) desc='Companheira'; if(desc.includes('Irm')) desc='Irmã'; }
          else if(r.sex==='M'){ if(desc.includes('Filho')) desc='Filho'; if(desc.includes('Mãe')||desc.includes('Pai')) desc='Pai'; if(desc.includes('Compan')) desc='Companheiro'; if(desc.includes('Irm')) desc='Irmão'; }
          html+='<div class="mini-card" style="padding:10px 12px;"><div style="display:flex;justify-content:space-between;align-items:center;gap:8px;"><div style="flex:1;"><span style="font-weight:600;font-size:0.9rem;">'+_esc(r.name)+'</span><span style="color:#aaa;font-size:0.82rem;margin-left:8px;">'+_esc(desc)+'</span></div><button onclick="_drawerDeleteRelation(\''+_esc(personId)+'\',\''+_esc(r.targetId)+'\',\''+_esc(r.type)+'\')" title="Apagar" style="background:none;border:none;cursor:pointer;color:#e06060;padding:2px 4px;font-size:1rem;flex-shrink:0;"><i class="mdi mdi-trash-can-outline"></i></button></div></div>';
        });
        html+='</div>';
        return html;
      }

      window._drawerDeleteRelation = function(personId,targetId,relType){
        if(!confirm('Apagar esta relação?')) return;
        if(relType==='ancestor'){
          // Remove parent from famc family
          const indi=DB.getIndividual(personId);
          if(indi&&indi.famc){
            const fam=DB.getFamily(indi.famc);
            if(fam){
              if(fam.husb===targetId) fam.husb=null;
              if(fam.wife===targetId) fam.wife=null;
              DB.saveFamily(fam);
              // Remove fams link from the parent
              const parent=DB.getIndividual(targetId);
              if(parent&&parent.fams){ parent.fams=parent.fams.filter(f=>f!==fam.id); DB.saveIndividual(parent); }
            }
          }
        } else if(relType==='child'){
          // Remove child from this person's fams families
          DB.getFamiliesAsSpouse(personId).forEach(fam=>{
            if(fam.children&&fam.children.includes(targetId)){
              fam.children=fam.children.filter(c=>c!==targetId);
              DB.saveFamily(fam);
              const child=DB.getIndividual(targetId);
              if(child&&child.famc===fam.id){ child.famc=null; DB.saveIndividual(child); }
            }
          });
        } else if(relType==='mate'){
          // Find shared family and remove spouse link
          DB.getFamiliesAsSpouse(personId).forEach(fam=>{
            if(fam.husb===targetId||fam.wife===targetId){
              if(fam.husb===targetId) fam.husb=null;
              if(fam.wife===targetId) fam.wife=null;
              DB.saveFamily(fam);
              const sp=DB.getIndividual(targetId);
              if(sp&&sp.fams){ sp.fams=sp.fams.filter(f=>f!==fam.id); DB.saveIndividual(sp); }
            }
          });
        } else if(relType==='siblin'){
          // Remove sibling from shared family
          const indi=DB.getIndividual(personId);
          if(indi&&indi.famc){
            const fam=DB.getFamily(indi.famc);
            if(fam&&fam.children&&fam.children.includes(targetId)){
              fam.children=fam.children.filter(c=>c!==targetId);
              DB.saveFamily(fam);
              const sib=DB.getIndividual(targetId);
              if(sib&&sib.famc===fam.id){ sib.famc=null; DB.saveIndividual(sib); }
            }
          }
        }
        document.getElementById('drawerBody').innerHTML=_renderRelations(personId);
      };

      window._drawerShowAddRelation = function(personId){
        const others=DB.getIndividuals().filter(i=>i.id!==personId);
        const parents=DB.getParents(personId);
        let kinOpts='<option value="ancestor">Pai / Mãe</option><option value="child">Filho(a)</option><option value="mate">Companheiro(a)</option><option value="siblin">Irmão / Irmã</option>';
        if(parents.length>=2) kinOpts='<option value="child">Filho(a)</option><option value="mate">Companheiro(a)</option><option value="siblin">Irmão / Irmã</option>';
        const opts=others.map(i=>'<option value="'+i.id+'">'+_esc(DB.getDisplayName(i))+'</option>').join('');
        document.getElementById('drawerBody').innerHTML='<div style="padding:4px 0 8px;"><h3 style="font-size:0.95rem;margin:0 0 14px;">Nova Relação</h3><div style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Tipo</label><select id="addRelType" style="width:100%;">'+kinOpts+'</select></div><div style="margin-bottom:14px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Pessoa</label><select id="addRelTarget" style="width:100%;">'+opts+'</select></div><div style="display:flex;gap:8px;justify-content:flex-end;"><button class="btn btn-ghost btn-sm" onclick="openDrawerSection(\''+_esc(personId)+'\',\'relacoes\')">Cancelar</button><button class="btn btn-sm" onclick="_drawerSaveLinkRelation(\''+_esc(personId)+'\')"><i class="mdi mdi-content-save-outline"></i> Guardar</button></div></div>';
      };

      window._drawerSaveLinkRelation = function(personId){
        const relType=(document.getElementById('addRelType')||{}).value;
        const targetId=(document.getElementById('addRelTarget')||{}).value;
        if(!relType||!targetId) return alert('Selecione tipo e pessoa.');
        _linkRelation(personId,targetId,relType);
        openDrawerSection(personId,'relacoes');
      };

      function _linkRelation(personId,targetId,relType){
        const indi=DB.getIndividual(personId);
        const target=DB.getIndividual(targetId);
        if(!indi||!target) return;

        if(relType==='mate'){
          DB.ensureFamily(personId,targetId);
        } else if(relType==='ancestor'){
          // target is parent of indi
          if(!indi.famc){
            // Create family for parents
            const fam=DB.saveFamily({husb:target.sex==='M'?targetId:null,wife:target.sex==='F'?targetId:null,children:[personId],events:[]});
            indi.famc=fam.id; DB.saveIndividual(indi);
            if(!target.fams) target.fams=[];
            if(!target.fams.includes(fam.id)){ target.fams.push(fam.id); DB.saveIndividual(target); }
          } else {
            const fam=DB.getFamily(indi.famc);
            if(fam){
              if(!fam.husb&&target.sex!=='F'){ fam.husb=targetId; }
              else if(!fam.wife){ fam.wife=targetId; }
              else { fam.husb=targetId; } // overwrite
              DB.saveFamily(fam);
              if(!target.fams) target.fams=[];
              if(!target.fams.includes(fam.id)){ target.fams.push(fam.id); DB.saveIndividual(target); }
            }
          }
        } else if(relType==='child'){
          // target is child of indi
          const fams=DB.getFamiliesAsSpouse(personId);
          let fam=fams.length?fams[0]:null;
          if(!fam){
            fam=DB.saveFamily({husb:indi.sex==='M'?personId:null,wife:indi.sex==='F'?personId:null,children:[],events:[]});
            if(!indi.fams) indi.fams=[];
            indi.fams.push(fam.id); DB.saveIndividual(indi);
          }
          if(!fam.children) fam.children=[];
          if(!fam.children.includes(targetId)){ fam.children.push(targetId); DB.saveFamily(fam); }
          target.famc=fam.id; DB.saveIndividual(target);
        } else if(relType==='siblin'){
          // target is sibling of indi — share famc family
          if(indi.famc){
            const fam=DB.getFamily(indi.famc);
            if(fam){
              if(!fam.children) fam.children=[];
              if(!fam.children.includes(targetId)){ fam.children.push(targetId); DB.saveFamily(fam); }
              target.famc=fam.id; DB.saveIndividual(target);
            }
          } else {
            // Create family for both
            const fam=DB.saveFamily({children:[personId,targetId],events:[]});
            indi.famc=fam.id; DB.saveIndividual(indi);
            target.famc=fam.id; DB.saveIndividual(target);
          }
        }
      }

      /* ── Add person workflow ───────────────────────────────────────────── */
      window._drawerShowAddPerson = function(personId){
        const indi=DB.getIndividual(personId); if(!indi) return;
        const parents=DB.getParents(personId);
        const footer=document.querySelector('.drawer-footer'); if(footer) footer.style.display='none';
        const phdr=document.getElementById('drawerPersonHeader'); if(phdr) phdr.style.display='none';
        const backBtn=document.getElementById('drawerBackBtn'); if(backBtn){ backBtn.style.display=''; backBtn._personId=personId; }
        document.getElementById('drawerTitle').textContent='Adicionar — '+DB.getDisplayName(indi);
        let kinOpts='<option value="sibling_male">Irmão</option><option value="sibling_female">Irmã</option><option value="child_male">Filho</option><option value="child_female">Filha</option>';
        if(parents.length<2) kinOpts+='<option value="ancestor_male">Pai</option><option value="ancestor_female">Mãe</option>';
        kinOpts+='<option value="mate_male">Companheiro</option><option value="mate_female">Companheira</option>';
        document.getElementById('drawerBody').innerHTML='<div style="padding:4px 0 8px;"><h3 style="font-size:0.95rem;margin:0 0 14px;">Nova Pessoa</h3><div style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Grau de parentesco</label><select id="addPersKinship" style="width:100%;">'+kinOpts+'</select></div><div style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Primeiro nome</label><input id="addPersFirstName" type="text" placeholder="Nome" style="width:100%;"/></div><div style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Apelido</label><input id="addPersLastName" type="text" placeholder="Apelido" style="width:100%;"/></div><div style="margin-bottom:14px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Notas</label><textarea id="addPersNotes" rows="2" placeholder="Notas..." style="width:100%;resize:vertical;"></textarea></div><div style="display:flex;gap:8px;justify-content:flex-end;"><button class="btn btn-ghost btn-sm" onclick="openDrawer(\'edit\',\''+_esc(personId)+'\')">Cancelar</button><button class="btn btn-sm" onclick="_drawerSaveNewPerson(\''+_esc(personId)+'\')"><i class="mdi mdi-content-save-outline"></i> Guardar</button></div></div>';
        setTimeout(()=>{ const fi=document.getElementById('addPersFirstName'); if(fi) fi.focus(); },50);
      };

      window._drawerSaveNewPerson = function(personId){
        const kinship=(document.getElementById('addPersKinship')||{}).value||'';
        const firstName=((document.getElementById('addPersFirstName')||{}).value||'').trim();
        const lastName=((document.getElementById('addPersLastName')||{}).value||'').trim();
        const notes=((document.getElementById('addPersNotes')||{}).value||'').trim();
        if(!firstName&&!lastName){ alert('Introduza pelo menos um nome.'); return; }
        const sexMap={sibling_male:'M',sibling_female:'F',child_male:'M',child_female:'F',ancestor_male:'M',ancestor_female:'F',mate_male:'M',mate_female:'F'};
        const relMap={sibling_male:'siblin',sibling_female:'siblin',child_male:'child',child_female:'child',ancestor_male:'ancestor',ancestor_female:'ancestor',mate_male:'mate',mate_female:'mate'};
        const sex=sexMap[kinship]||'U';
        const relType=relMap[kinship]||'';
        // Create the new individual
        const newIndi=DB.saveIndividual({names:[{given:firstName,surname:lastName,type:'birth'}],sex,notes:notes||undefined,events:[]});
        if(relType) _linkRelation(personId,newIndi.id,relType);
        openDrawer('edit',personId);
        renderTable();
      };

      /* ── Link existing person ──────────────────────────────────────────── */
      window._drawerShowLinkPerson = function(personId){
        const indi=DB.getIndividual(personId); if(!indi) return;
        const parents=DB.getParents(personId);
        const footer=document.querySelector('.drawer-footer'); if(footer) footer.style.display='none';
        const phdr=document.getElementById('drawerPersonHeader'); if(phdr) phdr.style.display='none';
        const backBtn=document.getElementById('drawerBackBtn'); if(backBtn){ backBtn.style.display=''; backBtn._personId=personId; }
        document.getElementById('drawerTitle').textContent='Ligar — '+DB.getDisplayName(indi);
        let kinOpts='<option value="siblin">Irmão / Irmã</option><option value="child">Filho(a)</option>';
        if(parents.length<2) kinOpts='<option value="ancestor">Pai / Mãe</option>'+kinOpts;
        kinOpts+='<option value="mate">Companheiro(a)</option>';
        const others=DB.getIndividuals().filter(i=>i.id!==personId);
        const opts=others.map(i=>'<option value="'+i.id+'">'+_esc(DB.getDisplayName(i))+'</option>').join('');
        document.getElementById('drawerBody').innerHTML='<div style="padding:4px 0 8px;"><h3 style="font-size:0.95rem;margin:0 0 14px;">Ligar Pessoa Existente</h3><div style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Grau de parentesco</label><select id="linkPersKinship" style="width:100%;">'+kinOpts+'</select></div><div style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Pesquisar pessoa</label><input id="linkPersSearch" type="text" placeholder="Pesquisar por nome..." style="width:100%;margin-bottom:6px;" /><select id="linkPersTarget" size="6" style="width:100%;min-height:110px;">'+opts+'</select></div><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;"><button class="btn btn-ghost btn-sm" onclick="openDrawer(\'edit\',\''+_esc(personId)+'\')">Cancelar</button><button class="btn btn-sm" onclick="_drawerSaveLinkPerson(\''+_esc(personId)+'\')"><i class="mdi mdi-content-save-outline"></i> Guardar</button></div></div>';
        const sel=document.getElementById('linkPersTarget');
        if(sel) sel._allOpts=others.map(i=>({value:i.id,text:DB.getDisplayName(i)}));
        const si=document.getElementById('linkPersSearch');
        if(si){ si.addEventListener('input',function(){ const q=this.value.toLowerCase(); const all=sel._allOpts||[]; sel.innerHTML=all.filter(o=>o.text.toLowerCase().includes(q)).map(o=>'<option value="'+o.value+'">'+_esc(o.text)+'</option>').join(''); }); si.focus(); }
      };

      window._drawerSaveLinkPerson = function(personId){
        const relType=(document.getElementById('linkPersKinship')||{}).value;
        const targetId=(document.getElementById('linkPersTarget')||{}).value;
        if(!relType||!targetId){ alert('Selecione tipo e pessoa.'); return; }
        if(targetId===personId){ alert('Não pode ligar uma pessoa a si própria.'); return; }
        _linkRelation(personId,targetId,relType);
        openDrawer('edit',personId);
        renderTable();
      };

      /* ── Photos section ───────────────────────────────────────────────── */
      // _renderPhotos returns the static upload-bar + empty grid container.
      // _buildPhotoGrid then fills the grid using real DOM nodes + addEventListener.
      function _renderPhotos(personId){
        return '<div style="margin-bottom:14px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">'
          + '<label for="drawerPhotoInput" class="btn btn-sm" style="cursor:pointer;font-size:0.83rem;"><i class="mdi mdi-image-plus"></i> Escolher Ficheiro</label>'
          + '<span id="drawerPhotoName" style="color:#aaa;font-size:0.82rem;max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">Nenhum ficheiro</span>'
          + '<button class="btn btn-sm" id="drawerUploadBtn" style="font-size:0.83rem;"><i class="mdi mdi-upload"></i> Upload</button>'
          + '</div>'
          + '<input type="file" id="drawerPhotoInput" accept="image/*" style="display:none;"/>'
          + '<div id="_photoGrid" style="display:flex;flex-wrap:wrap;gap:10px;"></div>';
      }

      function _buildPhotoGrid(personId){
        // Wire upload button
        var uploadBtn = document.getElementById('drawerUploadBtn');
        if(uploadBtn) uploadBtn.addEventListener('click', function(){ window._drawerUploadPhoto(personId); });
        var fileInput = document.getElementById('drawerPhotoInput');
        if(fileInput) fileInput.addEventListener('change', function(){
          var nameEl = document.getElementById('drawerPhotoName');
          if(nameEl) nameEl.textContent = fileInput.files&&fileInput.files.length ? fileInput.files[0].name : 'Nenhum ficheiro';
        });

        var grid = document.getElementById('_photoGrid');
        if(!grid) return;
        var media = DB.getMultimediaForIndividual(personId);
        if(!media.length){
          grid.innerHTML = '<div style="color:#888;padding:4px 0 12px;">Nenhuma foto associada.</div>';
          return;
        }

        media.forEach(function(m){
          var src = m.dataUrl || (m.files && m.files[0] ? m.files[0].file : '') || '';
          var hasImage = src.startsWith('data:') || src.startsWith('http') || src.startsWith('/');
          var wrap = document.createElement('div');
          wrap.style.cssText = 'position:relative;display:inline-block;';

          if(hasImage){
            var img = document.createElement('img');
            img.src = src;
            img.title = m.title || '';
            img.style.cssText = 'width:72px;height:72px;object-fit:cover;border-radius:6px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.3);display:block;';
            img.addEventListener('click', (function(mid, pid){ return function(){ window._drawerViewPhoto(mid, pid); }; })(m.id, personId));
            wrap.appendChild(img);
          } else {
            var placeholder = document.createElement('div');
            placeholder.style.cssText = 'width:72px;height:72px;border-radius:6px;background:#2a2a3a;border:1px dashed #555;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;cursor:pointer;';
            var iconEl = document.createElement('i');
            iconEl.className = 'mdi mdi-image-off';
            iconEl.style.cssText = 'font-size:1.4rem;color:#888;pointer-events:none;';
            var label = document.createElement('span');
            label.style.cssText = 'font-size:0.55rem;color:#888;text-align:center;word-break:break-all;padding:0 3px;max-height:28px;overflow:hidden;pointer-events:none;';
            label.textContent = src || '(sem nome)';
            placeholder.appendChild(iconEl);
            placeholder.appendChild(label);
            placeholder.title = 'Clique para carregar: ' + (src || '(sem nome)');
            placeholder.addEventListener('click', (function(mid, pid){ return function(){ window._drawerLinkGedcomPhoto(mid, pid); }; })(m.id, personId));
            wrap.appendChild(placeholder);
          }

          // Remove/unlink button
          var removeBtn = document.createElement('button');
          removeBtn.title = 'Remover vínculo';
          removeBtn.innerHTML = '<i class="mdi mdi-close" style="pointer-events:none;"></i>';
          removeBtn.style.cssText = 'position:absolute;top:-6px;right:-6px;background:#e06060;border:none;color:#fff;border-radius:50%;width:18px;height:18px;font-size:0.65rem;cursor:pointer;padding:0;display:flex;align-items:center;justify-content:center;';
          removeBtn.addEventListener('click', (function(mid, pid){ return function(ev){ ev.stopPropagation(); window._drawerUnlinkPhoto(mid, pid); }; })(m.id, personId));
          wrap.appendChild(removeBtn);

          grid.appendChild(wrap);
        });
      }

      window._drawerUploadPhoto = async function(personId){
        const input=document.getElementById('drawerPhotoInput');
        if(!input||!input.files||!input.files.length) return alert('Selecione uma imagem.');
        const f=input.files[0];
        try{
          const dataUrl=await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); });
          const media=DB.saveMultimedia({title:f.name,dataUrl,files:[{file:dataUrl,format:f.type}]});
          const indi=DB.getIndividual(personId);
          if(indi){ if(!indi.multimediaRefs) indi.multimediaRefs=[]; indi.multimediaRefs.push(media.id); DB.saveIndividual(indi); }
          input.value=''; openDrawerSection(personId,'fotos');
        }catch(err){ alert('Erro: '+err); }
      };

      window._drawerLinkGedcomPhoto = function(mediaId, personId){
        // For GEDCOM-imported photos that have a filename but no image data,
        // let the user pick the actual file to associate with this multimedia record
        const input=document.createElement('input');
        input.type='file'; input.accept='image/*';
        input.onchange=async function(){
          if(!input.files||!input.files.length) return;
          const f=input.files[0];
          try{
            const dataUrl=await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); });
            const m=DB.getMultimediaItem(mediaId);
            if(!m) return;
            m.dataUrl=dataUrl;
            m.files=[{file:dataUrl,format:f.type}];
            if(!m.title) m.title=f.name;
            DB.saveMultimedia(m);
            openDrawerSection(personId,'fotos');
          }catch(err){ alert('Erro ao carregar imagem: '+err); }
        };
        input.click();
      };

      window._drawerUnlinkPhoto = function(mediaId,personId){
        if(!confirm('Remover vínculo desta foto?')) return;
        const indi=DB.getIndividual(personId);
        if(indi&&indi.multimediaRefs){ indi.multimediaRefs=indi.multimediaRefs.filter(id=>id!==mediaId); DB.saveIndividual(indi); }
        openDrawerSection(personId,'fotos');
      };

      /* ── Photo modal ───────────────────────────────────────────────────── */
      let _drawerCurrentPhotoId=null, _drawerPhotoList=[], _drawerPhotoPersonId=null;
      let _drawerIsDrawing=false, _drawerDrawStart=null, _drawerCurrentDrawEl=null;

      function _buildPhotoSrc(m){ return m.dataUrl||(m.files&&m.files[0]?m.files[0].file:'')||''; }

      function _loadPhotoIntoModal(mediaId){
        const m=DB.getMultimediaItem(mediaId); if(!m) return;
        _drawerCurrentPhotoId=mediaId;
        const idx=_drawerPhotoList.indexOf(mediaId);
        const total=_drawerPhotoList.length;
        // counter
        const counter=document.getElementById('drawerPhotoCounter');
        if(counter) counter.textContent=total>1?(idx+1)+' / '+total:'';
        // title
        const titleEl=document.getElementById('drawerPhotoModalTitle');
        if(titleEl) titleEl.textContent=m.title||(m.files&&m.files[0]?m.files[0].file:'')||'Foto';
        // filename
        const fnEl=document.getElementById('drawerPhotoFileName');
        if(fnEl) fnEl.textContent=(m.files&&m.files[0]?m.files[0].file:'')||m.title||'—';
        // nav buttons opacity
        const prevBtn=document.getElementById('drawerPhotoPrev');
        const nextBtn=document.getElementById('drawerPhotoNext');
        if(prevBtn) prevBtn.style.opacity=total>1?'1':'0.2';
        if(nextBtn) nextBtn.style.opacity=total>1?'1':'0.2';
        // image
        const area=document.getElementById('drawerModalImageArea');
        area.innerHTML='';
        const src=_buildPhotoSrc(m);
        const container=document.createElement('div'); container.style.position='relative';
        const img=document.createElement('img'); img.id='drawerModalImage';
        img.style.cssText='display:block;max-width:100%;max-height:calc(95vh - 200px);border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.5);';
        img.src=src;
        const overlay=document.createElement('div'); overlay.className='tag-overlay';
        overlay.style.cssText='position:absolute;left:0;top:0;right:0;bottom:0;pointer-events:auto;';
        container.appendChild(img); container.appendChild(overlay); area.appendChild(container);
        overlay.addEventListener('pointerdown',function(ev){ ev.preventDefault(); _startDraw(ev,img,overlay); });
        overlay.addEventListener('pointermove',function(ev){ if(_drawerIsDrawing) _updateDraw(ev,img); });
        overlay.addEventListener('pointerup',function(ev){ if(_drawerIsDrawing) _finishDraw(ev,img,overlay); });
        // notes
        const notesEl=document.getElementById('drawerPhotoNotesArea');
        if(notesEl) notesEl.value=typeof m.notes==='string'?m.notes:(Array.isArray(m.notes)?m.notes.join('\n'):'');
        _drawerRenderPhotoTags(m);
        // thumbnail strip
        const strip=document.getElementById('drawerPhotoStrip');
        if(strip){
          strip.innerHTML='';
          strip.style.display=total>1?'flex':'none';
          _drawerPhotoList.forEach(function(mid,i){
            const mi=DB.getMultimediaItem(mid); if(!mi) return;
            const s=_buildPhotoSrc(mi);
            const thumb=document.createElement('div');
            thumb.style.cssText='flex-shrink:0;width:54px;height:54px;border-radius:6px;overflow:hidden;cursor:pointer;border:2px solid '+(mid===mediaId?'var(--accent)':'transparent')+';transition:border 0.15s;';
            if(s.startsWith('data:')||s.startsWith('http')||s.startsWith('/')){
              const ti=document.createElement('img'); ti.style.cssText='width:100%;height:100%;object-fit:cover;'; ti.src=s;
              thumb.appendChild(ti);
            } else {
              thumb.style.background='#2a2a3a'; thumb.style.display='flex'; thumb.style.alignItems='center'; thumb.style.justifyContent='center';
              thumb.innerHTML='<i class="mdi mdi-image-off" style="color:#666;font-size:1.1rem;"></i>';
            }
            thumb.addEventListener('click',function(){ _loadPhotoIntoModal(mid); });
            strip.appendChild(thumb);
          });
          const activeThumb=strip.children[idx]; if(activeThumb) activeThumb.scrollIntoView({block:'nearest',inline:'center'});
        }
      }

      window._drawerViewPhoto = function(mediaId, personId){
        _drawerPhotoPersonId=personId||null;
        if(personId){
          const media=DB.getMultimediaForIndividual(personId);
          _drawerPhotoList=media.map(function(m){ return m.id; });
        } else {
          _drawerPhotoList=[mediaId];
        }
        if(!_drawerPhotoList.includes(mediaId)) _drawerPhotoList=[mediaId];
        _loadPhotoIntoModal(mediaId);
        document.getElementById('drawerPhotoModal').style.display='flex';
      };

      window._drawerNavPhoto = function(dir){
        if(!_drawerPhotoList.length) return;
        const idx=_drawerPhotoList.indexOf(_drawerCurrentPhotoId);
        const next=(_drawerPhotoList.length+idx+dir)%_drawerPhotoList.length;
        _loadPhotoIntoModal(_drawerPhotoList[next]);
      };

      window._drawerClosePhotoModal = function(){
        _drawerCurrentPhotoId=null; _drawerIsDrawing=false;
        document.getElementById('drawerPhotoModal').style.display='none';
        document.getElementById('drawerModalImageArea').innerHTML='';
      };

      window._drawerSavePhotoNotes = function(){
        if(!_drawerCurrentPhotoId) return;
        const m=DB.getMultimediaItem(_drawerCurrentPhotoId); if(!m) return;
        m.notes=((document.getElementById('drawerPhotoNotesArea')||{}).value||'');
        DB.saveMultimedia(m);
        const btn=document.querySelector('#drawerPhotoInfoPanel .btn-sm');
        if(btn){const orig=btn.innerHTML; btn.innerHTML='<i class="mdi mdi-check"></i> Guardado'; setTimeout(function(){btn.innerHTML=orig;},1500);}
      };

      // keyboard navigation
      document.addEventListener('keydown',function(ev){
        if(document.getElementById('drawerPhotoModal').style.display==='none') return;
        if(ev.key==='ArrowRight') _drawerNavPhoto(1);
        else if(ev.key==='ArrowLeft') _drawerNavPhoto(-1);
        else if(ev.key==='Escape') _drawerClosePhotoModal();
      });
      // click backdrop to close
      document.getElementById('drawerPhotoModal').addEventListener('click',function(ev){ if(ev.target===this) _drawerClosePhotoModal(); });

      function _drawerRenderPhotoTags(media){
        const overlay=document.querySelector('#drawerModalImageArea .tag-overlay'); if(!overlay) return;
        overlay.querySelectorAll('.tag-rect,.tag-form').forEach(e=>e.remove());
        const tags=media.tags||[];
        tags.forEach(t=>{
          const el=document.createElement('div'); el.className='tag-rect';
          el.style.left=(t.bbox.x*100)+'%'; el.style.top=(t.bbox.y*100)+'%';
          el.style.width=(t.bbox.w*100)+'%'; el.style.height=(t.bbox.h*100)+'%';
          el.title=t.personName||'';
          el.addEventListener('click',function(ev){ ev.stopPropagation(); });
          const lbl=document.createElement('div'); lbl.className='tag-label'; lbl.textContent=t.personName||'Pessoa'; el.appendChild(lbl);
          overlay.appendChild(el);
        });
        const ppl=document.getElementById('drawerPhotoTaggedPeople'); if(!ppl) return;
        const unique=Array.from(new Map(tags.map(t=>[t.personId||t.personName,t])).values());
        ppl.innerHTML=unique.length===0?'<span style="color:#888">Nenhuma pessoa identificada.</span>':'<strong>Pessoas identificadas:</strong> '+unique.map(t=>_esc(t.personName||'')).join(', ');
      }

      function _startDraw(ev,img,overlay){ _drawerIsDrawing=true; _drawerDrawStart={x:ev.clientX,y:ev.clientY}; _drawerCurrentDrawEl=document.createElement('div'); _drawerCurrentDrawEl.className='tag-rect'; _drawerCurrentDrawEl.style.cssText='left:0;top:0;width:0;height:0;'; overlay.appendChild(_drawerCurrentDrawEl); }
      function _updateDraw(ev,img){ if(!_drawerCurrentDrawEl||!_drawerDrawStart) return; const r=img.getBoundingClientRect(); _drawerCurrentDrawEl.style.left=(Math.min(_drawerDrawStart.x,ev.clientX)-r.left)/r.width*100+'%'; _drawerCurrentDrawEl.style.top=(Math.min(_drawerDrawStart.y,ev.clientY)-r.top)/r.height*100+'%'; _drawerCurrentDrawEl.style.width=Math.abs(ev.clientX-_drawerDrawStart.x)/r.width*100+'%'; _drawerCurrentDrawEl.style.height=Math.abs(ev.clientY-_drawerDrawStart.y)/r.height*100+'%'; }
      function _finishDraw(ev,img,overlay){ _drawerIsDrawing=false; const r=img.getBoundingClientRect(); const bbox={x:Math.max(0,(Math.min(_drawerDrawStart.x,ev.clientX)-r.left)/r.width),y:Math.max(0,(Math.min(_drawerDrawStart.y,ev.clientY)-r.top)/r.height),w:Math.abs(ev.clientX-_drawerDrawStart.x)/r.width,h:Math.abs(ev.clientY-_drawerDrawStart.y)/r.height}; if(_drawerCurrentDrawEl&&_drawerCurrentDrawEl.parentElement) _drawerCurrentDrawEl.remove(); _drawerCurrentDrawEl=null; _drawerDrawStart=null; if(bbox.w>0.01&&bbox.h>0.01) _showTagForm(bbox,img,overlay); }

      function _showTagForm(bbox,img,overlay){
        const form=document.createElement('div'); form.className='tag-form'; form.style.left=(bbox.x*100)+'%'; form.style.top=(bbox.y*100)+'%';
        form.innerHTML='<div style="font-weight:600;margin-bottom:6px;">Identificar pessoa</div>';
        const indis=DB.getIndividuals();
        const input=document.createElement('input'); input.placeholder='Nome'; input.style.width='220px';
        const sugg=document.createElement('div'); sugg.style.cssText='position:absolute;left:8px;top:38px;background:var(--bg-card);border:1px solid rgba(255,255,255,0.1);max-height:160px;overflow:auto;width:220px;z-index:630;display:none;border-radius:6px;';
        const saveBtn=document.createElement('button'); saveBtn.textContent='Salvar'; saveBtn.className='btn';
        const cancelBtn=document.createElement('button'); cancelBtn.textContent='Cancelar'; cancelBtn.className='btn';
        form.appendChild(input); form.appendChild(sugg); form.appendChild(document.createElement('div')); form.lastChild.style.marginTop='6px'; form.appendChild(saveBtn); form.appendChild(cancelBtn);
        form.addEventListener('pointerdown',ev=>ev.stopPropagation());
        let selectedId=null;
        input.addEventListener('input',function(){ selectedId=null; const q=this.value.toLowerCase(); const list=indis.filter(i=>DB.getDisplayName(i).toLowerCase().includes(q)).slice(0,30); sugg.innerHTML=''; if(!list.length){sugg.style.display='none';return;} list.forEach(i=>{ const row=document.createElement('div'); row.style.cssText='padding:6px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.04);'; row.textContent=DB.getDisplayName(i); row.addEventListener('click',()=>{input.value=row.textContent;selectedId=i.id;sugg.style.display='none';}); sugg.appendChild(row); }); sugg.style.display='block'; });
        cancelBtn.addEventListener('click',()=>form.remove());
        saveBtn.addEventListener('click',()=>{ const name=input.value.trim(); if(!name)return alert('Nome obrigatório.'); const m=DB.getMultimediaItem(_drawerCurrentPhotoId); if(!m) return; if(!m.tags) m.tags=[]; m.tags.push({id:'tag_'+Date.now(),personId:selectedId,personName:name,bbox}); DB.saveMultimedia(m); if(selectedId){ const indi=DB.getIndividual(selectedId); if(indi){ if(!indi.multimediaRefs) indi.multimediaRefs=[]; if(!indi.multimediaRefs.includes(m.id)) indi.multimediaRefs.push(m.id); DB.saveIndividual(indi); }} _drawerRenderPhotoTags(m); form.remove(); });
        setTimeout(()=>input.focus(),50);
        overlay.appendChild(form);
      }

      /* ── Drawer save / delete / close ──────────────────────────────────── */
      function drawerSave(){
        const given=(document.getElementById('df_firstName')||{}).value||'';
        const surname=(document.getElementById('df_lastName')||{}).value||'';
        const sex=(document.getElementById('df_gender')||{}).value||'U';
        const notes=(document.getElementById('df_notes')||{}).value||'';
        if(_drawerMode==='create'){
          DB.saveIndividual({names:[{given:given.trim(),surname:surname.trim(),type:'birth'}],sex,notes,events:[]});
        } else if(_drawerPersonId){
          const indi=DB.getIndividual(_drawerPersonId);
          if(indi){ indi.names=[{given:given.trim(),surname:surname.trim(),type:'birth'}]; indi.sex=sex; indi.notes=notes; DB.saveIndividual(indi); }
        }
        closeDrawer(); renderTable();
      }

      function drawerDeletePerson(){
        if(!_drawerPersonId||!confirm('Apagar esta pessoa?')) return;
        DB.deleteIndividual(_drawerPersonId);
        closeDrawer(); renderTable();
      }

      document.getElementById('drawerCloseBtn').addEventListener('click', closeDrawer);
      document.getElementById('drawerCancelBtn').addEventListener('click', closeDrawer);
      document.getElementById('drawerOverlay').addEventListener('click', closeDrawer);
      document.getElementById('drawerSaveBtn').addEventListener('click', drawerSave);
      document.getElementById('drawerDeleteBtn').addEventListener('click', drawerDeletePerson);
      document.getElementById('drawerBackBtn').addEventListener('click', function(){ const pid=this._personId; if(pid) openDrawer('edit',pid); });

      /* ── Init ──────────────────────────────────────────────────────────── */
      renderTable();

      // Auto-open from URL param (?edit=id)
      (function(){
        const p=new URLSearchParams(window.location.search);
        const editId=p.get('edit');
        if(editId) openDrawer('edit',editId);
      })();

    })();
    </script>
    <script src="history-logger.js"></script>
  </body>
</html>
