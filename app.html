<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cadastro de Pessoas</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css">
    <script src="remote-storage.js"></script>
  </head>
  <body>
    <div class="app-shell">
      <aside class="sidebar">
        <a href="index.html" class="logo"><i class="mdi mdi-tree" aria-hidden="true"></i><span>myLineage</span></a>
        <nav>
          <a href="app.html" class="active"><i class="mdi mdi-account-multiple" aria-hidden="true"></i>Cadastro</a>
          <a href="indicadores.html"><i class="mdi mdi-chart-bar" aria-hidden="true"></i>Indicadores</a>
          <a href="arvore.html"><i class="mdi mdi-sitemap" aria-hidden="true"></i>Árvore</a>
          <a href="gedcom.html"><i class="mdi mdi-dna" aria-hidden="true"></i>GEDCOM</a>
          <a href="album.html"><i class="mdi mdi-image-multiple" aria-hidden="true"></i>Álbum</a>
        </nav>
        <div class="sidebar-footer">
          <a href="apis.html"><i class="mdi mdi-api" aria-hidden="true"></i>APIs</a>
          <a href="configuracao.html"><i class="mdi mdi-cog" aria-hidden="true"></i>Definições</a>
        </div>
      </aside>
      <main class="content">
        <div class="topbar">
          <div style="display:flex;align-items:center;gap:12px"><h1>Cadastro de Pessoas</h1></div>
          <div><button class="btn" id="addPersonBtn">Adicionar Pessoa</button></div>
        </div>
        <div class="main-grid">
          <div class="table-panel card">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0;">
                <div style="display:flex;gap:12px;align-items:center;">
                    <div style="display:flex;align-items:center;gap:6px;">
                      <input type="text" id="nameFilter" placeholder="Filtrar por nome..." style="padding:8px 10px;border-radius:8px;border:1px solid rgba(163,163,255,0.06);background:transparent;color:var(--text-main);" />
                      <button id="nameSearchBtn" class="icon-btn" type="button" title="Pesquisar"><i class="mdi mdi-magnify" aria-hidden="true"></i></button>
                    </div>
                  </div>
              </div>
          <div>
            <label><input type="checkbox" id="hideDeleted" checked /> Ocultar registros excluídos</label>
          </div>
          <table id="peopleTable">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Data Nascimento</th>
              <th>Data Óbito</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="paginationControls" style="color:var(--text-secondary);margin-top:12px;"></div>
      </div>
      <div class="form-panel card" id="formPanel" style="display:none;">
        <div class="accordion">
          <div class="accordion-card" id="cardDados">
            <button type="button" class="accordion-header" data-target="contentDados"><span>Dados Pessoais</span><span class="accordion-arrow"><i class="mdi mdi-chevron-down" aria-hidden="true"></i></span></button>
            <div class="accordion-content" id="contentDados">
              <form id="personForm">
                <input type="hidden" id="id" name="id" />
                <input type="hidden" id="createdAt" name="createdAt" />
                <input type="hidden" id="updatedAt" name="updatedAt" />
                <input type="hidden" id="deletedAt" name="deletedAt" />
                <div>
                  <label for="firstName">First Name</label>
                  <input type="text" id="firstName" name="firstName" required />
                </div>
                <div>
                  <label for="lastName">Last Name</label>
                  <input type="text" id="lastName" name="lastName" required />
                </div>
                <div>
                  <label for="gender">Gender</label>
                  <select id="gender" name="gender">
                    <option value="">-- selecione --</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div class="full">
                  <label for="notes">Notes</label>
                  <textarea id="notes" name="notes"></textarea>
                </div>
                <div id="ageInfo"></div>
                <div class="full">
                  <button type="submit" id="saveBtn">Salvar</button>
                  <button type="button" id="resetBtn">Limpar</button>
                  <button type="button" id="detailBtn">Detalhe</button>
                </div>
              </form>
            </div>
          </div>

          <!-- Apenas Dados Pessoais visíveis na página de Cadastro. Eventos/ Relações mudaram para página de detalhe. -->
        </div>
        <div id="datesInfo" style="font-size:0.85em;color:#666;margin-top:16px;text-align:right;"></div>
      </div>
        </div>
      </main>
    </div>

    <script>
            // Novo controle de exibição da ficha
            const formPanel = document.getElementById('formPanel');
            const addPersonBtn = document.getElementById('addPersonBtn');
            function showFormPanel(show = true) {
              formPanel.style.display = show ? 'block' : 'none';
            }
            // Accordion helpers
            function openAccordion(id) {
              const el = document.getElementById(id);
              if (!el) return;
              el.style.display = 'block';
              if (el.parentElement) el.parentElement.classList.add('open');
            }
            function closeAccordion(id) {
              const el = document.getElementById(id);
              if (!el) return;
              el.style.display = 'none';
              if (el.parentElement) el.parentElement.classList.remove('open');
            }
            function toggleAccordion(id) {
              const el = document.getElementById(id);
              if (!el) return;
              if (el.style.display === 'block') closeAccordion(id); else openAccordion(id);
            }
            // Wire accordion headers
            document.addEventListener('click', function(e){
              const btn = e.target.closest && e.target.closest('.accordion-header');
              if (btn && btn.dataset && btn.dataset.target) {
                toggleAccordion(btn.dataset.target);
              }
            });
            addPersonBtn.addEventListener('click', function() {
              resetForm();
              showFormPanel(true);
              // Fecha Events/Relations e abre Dados ao criar nova pessoa
              closeAccordion('contentEventos');
              closeAccordion('contentRelacoes');
              openAccordion('contentDados');
              // Limpa listas de eventos e relações para nova ficha
              if (typeof renderEventsList === 'function' && document.getElementById('eventsList')) renderEventsList('');
              if (typeof renderRelationsList === 'function' && document.getElementById('relationsList')) renderRelationsList('');
              // Limpa a área de datas (não mostrar datas para novo registro)
              if (typeof showDatesInfo === 'function') showDatesInfo();
            });
            // Modifica editPerson para mostrar ficha e folders
            const originalEditPerson = editPerson;
            editPerson = function(id) {
              const people = loadPeople();
              const p = people.find(x => x.id === id);
              if (!p) return alert('Registro não encontrado');
              document.getElementById('id').value = p.id;
              document.getElementById('firstName').value = p.firstName || '';
              document.getElementById('lastName').value = p.lastName || '';
              document.getElementById('gender').value = p.gender || '';
              document.getElementById('notes').value = p.notes || '';
              // Exibe datas no rodapé
              showDatesInfo(p);
              // Calcula e exibe idade (ou idade ao falecer)
              try {
                const evs = getEvents();
                const birth = evs.find(e => e.personId === p.id && e.type === 'BIRTH' && !e.deletedAt);
                const death = evs.find(e => e.personId === p.id && e.type === 'DEATH' && !e.deletedAt);
                const ageEl = document.getElementById('ageInfo');
                if (birth && birth.date) {
                  const ref = death && death.date ? death.date : new Date().toISOString();
                  const age = computeAge(birth.date, ref);
                  ageEl.textContent = age == null ? '' : (death ? 'Idade ao falecer: ' + age + ' anos' : 'Idade: ' + age + ' anos');
                } else if (ageEl) {
                  ageEl.textContent = '';
                }
              } catch (e) { /* ignore */ }
              showFormPanel(true);
              // Abre panel de Dados e, se existirem, relações/eventos
              if (document.getElementById('contentRelacoes')) openAccordion('contentRelacoes');
              if (document.getElementById('contentEventos')) openAccordion('contentEventos');
              openAccordion('contentDados');
              // Preenche pessoas para relação (se select presente)
              if (document.getElementById('relationPerson')) fillRelationPersonSelect(id);
              // Renderiza listas apenas se os containers existirem
              if (document.getElementById('relationsList')) renderRelationsList(id);
              if (document.getElementById('eventsList')) renderEventsList(id);
            }
            // Oculta ficha ao salvar ou limpar
            document.getElementById('personForm').addEventListener('submit', function(e){
              e.preventDefault();
              const id = document.getElementById('id').value || generateUUID();
              const firstName = document.getElementById('firstName').value.trim();
              const lastName = document.getElementById('lastName').value.trim();
              const gender = document.getElementById('gender').value;
              const notes = document.getElementById('notes').value;
              const people = loadPeople();
              const existingIndex = people.findIndex(x => x.id === id);
              const now = nowISO();
              let createdAt = now;
              let deletedAt = null;
              if (existingIndex >= 0) {
                createdAt = people[existingIndex].createdAt || now;
                deletedAt = people[existingIndex].deletedAt || null;
                people[existingIndex] = {
                  ...people[existingIndex],
                  firstName, lastName, gender, notes,
                  updatedAt: now
                };
              } else {
                people.push({
                  id,
                  firstName,
                  lastName,
                  gender,
                  notes,
                  createdAt: now,
                  updatedAt: now,
                  deletedAt: null
                });
              }
              savePeople(people);
              renderTable();
              resetForm();
              showDatesInfo();
              showFormPanel(false);
              closeAccordion('contentRelacoes');
              closeAccordion('contentEventos');
              closeAccordion('contentDados');
            });
            document.getElementById('resetBtn').addEventListener('click', function(){
              resetForm();
              showDatesInfo();
              showFormPanel(false);
              closeAccordion('contentRelacoes');
              closeAccordion('contentEventos');
              closeAccordion('contentDados');
            });
            // Botão Detalhe: abre página de detalhe com todas as secções
            const detailBtn = document.getElementById('detailBtn');
            if (detailBtn) detailBtn.addEventListener('click', function(){
              const id = document.getElementById('id').value;
              if (!id) return alert('Nenhuma pessoa selecionada');
              window.location.href = 'pessoa-detalhe.html?id=' + encodeURIComponent(id);
            });
            // Oculta ficha ao iniciar
            showFormPanel(false);
            closeAccordion('contentRelacoes');
            closeAccordion('contentEventos');
            closeAccordion('contentDados');
            // Helpers to toggle small forms: show lists by default
            function showEventForm(show) {
              const w = document.getElementById('eventFormWrapper');
              const list = document.getElementById('eventsList');
              if (!w || !list) return;
              w.style.display = show ? 'block' : 'none';
              list.style.display = show ? 'none' : 'block';
            }
            function showRelationForm(show) {
              const w = document.getElementById('relationFormWrapper');
              const list = document.getElementById('relationsList');
              if (!w || !list) return;
              w.style.display = show ? 'block' : 'none';
              list.style.display = show ? 'none' : 'block';
            }
            // Wire open / cancel buttons for events/relations (if present)
            (function(){
              const openEventBtn = document.getElementById('openEventFormBtn');
              if (openEventBtn) openEventBtn.addEventListener('click', function(){ showEventForm(true); openAccordion('contentEventos'); });
              const cancelEventBtn = document.getElementById('cancelEventBtn');
              if (cancelEventBtn) cancelEventBtn.addEventListener('click', function(){ const f = document.getElementById('eventForm'); if(f) f.reset(); showEventForm(false); });
              const openRelationBtn = document.getElementById('openRelationFormBtn');
              if (openRelationBtn) openRelationBtn.addEventListener('click', function(){ showRelationForm(true); openAccordion('contentRelacoes'); });
              const cancelRelationBtn = document.getElementById('cancelRelationBtn');
              if (cancelRelationBtn) cancelRelationBtn.addEventListener('click', function(){ const f = document.getElementById('relationForm'); if(f) f.reset(); showRelationForm(false); });
            })();
            // Eventos
            function getEvents() {
              try {
                const raw = localStorage.getItem('events:myLineage');
                return raw ? JSON.parse(raw) : [];
              } catch (e) { return []; }
            }
            function saveEvents(events) {
              localStorage.setItem('events:myLineage', JSON.stringify(events));
            }
            function renderEventsList(personId) {
              // Always show the list view by default when rendering
              try { showEventForm(false); } catch (e) {}
              const events = getEvents();
              const list = document.getElementById('eventsList');
              const evs = events.filter(ev => ev.personId === personId && !ev.deletedAt);
              if (evs.length === 0) {
                list.innerHTML = '<div style="color:#888">Nenhum evento cadastrado.</div>';
                return;
              }
              let html = '<ul>';
              evs.forEach((ev, idx) => {
                html += `<li><b>${ev.type}</b> - ${ev.date || 'Sem data'}${ev.location ? ', ' + ev.location : ''} <br><small>${ev.notes || ''}</small> <button class="remove-event" data-index="${idx}" title="Remover evento" style="background:none;border:none;cursor:pointer;padding:0;margin-left:8px;"><i class="mdi mdi-trash-can" style="font-size:1.2em;" aria-hidden="true"></i></button></li>`;
              });
              html += '</ul>';
              list.innerHTML = html;
              // Adiciona handler para remover evento
              document.querySelectorAll('.remove-event').forEach(btn => {
                btn.addEventListener('click', function(){
                  const idx = parseInt(this.getAttribute('data-index'));
                  let events = getEvents();
                  const evs = events.filter(ev => ev.personId === personId && !ev.deletedAt);
                  const eventToRemove = evs[idx];
                  events = events.map(ev => {
                    if (ev.id === eventToRemove.id) {
                      return { ...ev, deletedAt: nowISO(), updatedAt: nowISO() };
                    }
                    return ev;
                  });
                  saveEvents(events);
                  renderEventsList(personId);
                  renderTable(); // Atualiza tabela
                });
              });
            }
            const addEventBtnEl = document.getElementById('addEventBtn');
            if (addEventBtnEl) addEventBtnEl.addEventListener('click', function(){
              const personId = document.getElementById('id').value;
              if (!personId) return alert('Pessoa não selecionada');
              const type = document.getElementById('eventType').value;
              const date = document.getElementById('eventDate').value || null;
              const location = document.getElementById('eventLocation').value || null;
              const notes = document.getElementById('eventNotes').value || '';
              if (!type) return alert('Tipo de evento obrigatório');
              const events = getEvents();
              const now = nowISO();
              events.push({
                id: generateUUID(),
                personId,
                type,
                date,
                location,
                notes,
                createdAt: now,
                updatedAt: now,
                deletedAt: null
              });
              saveEvents(events);
              renderEventsList(personId);
              renderTable(); // Atualiza tabela
              const evForm = document.getElementById('eventForm'); if (evForm) evForm.reset();
              showEventForm(false);
            });

            // Relações
            function fillRelationPersonSelect(currentId) {
              const people = loadPeople();
              const select = document.getElementById('relationPerson');
              select.innerHTML = '<option value="">-- selecione --</option>';
              people.forEach(p => {
                if (p.id !== currentId && !p.deletedAt) {
                  select.innerHTML += `<option value="${p.id}">${escapeHtml(p.firstName)} ${escapeHtml(p.lastName)}</option>`;
                }
              });
            }

            // Abre a ficha de uma pessoa (usado para navegação por relações)
            function showPersonDetail(id) {
              const people = loadPeople();
              const p = people.find(x => x.id === id);
              if (!p) return alert('Registro não encontrado');
              document.getElementById('id').value = p.id;
              document.getElementById('firstName').value = p.firstName || '';
              document.getElementById('lastName').value = p.lastName || '';
              document.getElementById('gender').value = p.gender || '';
              document.getElementById('notes').value = p.notes || '';
              if (document.getElementById('createdAt')) document.getElementById('createdAt').value = p.createdAt || '';
              if (document.getElementById('updatedAt')) document.getElementById('updatedAt').value = p.updatedAt || '';
              if (document.getElementById('deletedAt')) document.getElementById('deletedAt').value = p.deletedAt || '';
              showDatesInfo(p);
              // Calcula e exibe idade (ou idade ao falecer)
              try {
                const evs = getEvents();
                const birth = evs.find(e => e.personId === p.id && e.type === 'BIRTH' && !e.deletedAt);
                const death = evs.find(e => e.personId === p.id && e.type === 'DEATH' && !e.deletedAt);
                const ageEl = document.getElementById('ageInfo');
                if (birth && birth.date) {
                  const ref = death && death.date ? death.date : new Date().toISOString();
                  const age = computeAge(birth.date, ref);
                  ageEl.textContent = age == null ? '' : (death ? 'Idade ao falecer: ' + age + ' anos' : 'Idade: ' + age + ' anos');
                } else if (ageEl) {
                  ageEl.textContent = '';
                }
              } catch (e) { /* ignore */ }
              showFormPanel(true);
              if (document.getElementById('contentRelacoes')) openAccordion('contentRelacoes');
              if (document.getElementById('contentEventos')) openAccordion('contentEventos');
              openAccordion('contentDados');
              if (document.getElementById('relationPerson')) fillRelationPersonSelect(id);
              if (document.getElementById('relationsList')) renderRelationsList(id);
              if (document.getElementById('eventsList')) renderEventsList(id);
              window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            function getRelations() {
              try {
                const raw = localStorage.getItem('relations:myLineage');
                return raw ? JSON.parse(raw) : [];
              } catch (e) { return []; }
            }
            function saveRelations(relations) {
              localStorage.setItem('relations:myLineage', JSON.stringify(relations));
            }
            function renderRelationsList(personId) {
              // Ensure relation form is closed and the list is visible
              try { showRelationForm(false); } catch(e) {}
              const relations = getRelations();
              const people = loadPeople();
              const list = document.getElementById('relationsList');
              const rels = relations.filter(r => r.from === personId);
              if (rels.length === 0) {
                list.innerHTML = '<div style="color:#888">Nenhuma relação cadastrada.</div>';
                return;
              }
              const typeDesc = {
                siblin: 'Irmão / Irmã',
                ancestor: 'Pai / Mãe',
                child: 'Filho(a)',
                mate: 'Companheiro(a)'
              };
              let html = '<ul>';
              rels.forEach((r, idx) => {
                const p = people.find(x => x.id === r.to);
                const desc = typeDesc[r.type] || r.type;
                  const nameHtml = p ? `<a href="#" class="relation-link" data-id="${p.id}">${escapeHtml(p.firstName + ' ' + p.lastName)}</a>` : escapeHtml(r.to);
                  html += `<li>${desc}: ${nameHtml} <button class="remove-relation" data-index="${idx}" title="Remover relação" style="background:none;border:none;cursor:pointer;padding:0;margin-left:8px;"><i class="mdi mdi-trash-can" style="font-size:1.2em;" aria-hidden="true"></i></button></li>`;
              });
              html += '</ul>';
              list.innerHTML = html;
                // add click handlers for relation links (navigate to related person's detail)
                document.querySelectorAll('.relation-link').forEach(a => {
                  a.addEventListener('click', function(ev){ ev.preventDefault(); const id = this.getAttribute('data-id'); if(id) showPersonDetail(id); });
                });
              // Adiciona handler para remover relação
              document.querySelectorAll('.remove-relation').forEach(btn => {
                btn.addEventListener('click', function(){
                  const idx = parseInt(this.getAttribute('data-index'));
                  let relations = getRelations();
                  const rels = relations.filter(r => r.from === personId);
                  const relToRemove = rels[idx];
                  relations = relations.filter(r => !(r.from === personId && r.to === relToRemove.to && r.type === relToRemove.type));
                  saveRelations(relations);
                  renderRelationsList(personId);
                });
              });
            }
            const addRelationBtnEl = document.getElementById('addRelationBtn');
            if (addRelationBtnEl) addRelationBtnEl.addEventListener('click', function(){
              const type = document.getElementById('relationType').value;
              const to = document.getElementById('relationPerson').value;
              const from = document.getElementById('id').value;
              if (!type || !to || !from) return alert('Selecione tipo e pessoa relacionada.');
              const relations = getRelations();
              relations.push({ from, to, type });
              saveRelations(relations);
              renderRelationsList(from);
              const relTypeEl = document.getElementById('relationType'); if (relTypeEl) relTypeEl.value = '';
              const relPersonEl = document.getElementById('relationPerson'); if (relPersonEl) relPersonEl.value = '';
              showRelationForm(false);
            });
      const STORAGE_KEY = 'people:myLineage';

      function nowISO() { return new Date().toISOString(); }

      function generateUUID() {
        if (crypto && crypto.randomUUID) return crypto.randomUUID();
        const bytes = crypto.getRandomValues(new Uint8Array(16));
        bytes[6] = (bytes[6] & 0x0f) | 0x40;
        bytes[8] = (bytes[8] & 0x3f) | 0x80;
        const b2h = b => Array.from(b).map(x => x.toString(16).padStart(2,'0')).join('');
        const s = b2h(bytes);
        return s.slice(0,8)+'-'+s.slice(8,12)+'-'+s.slice(12,16)+'-'+s.slice(16,20)+'-'+s.slice(20);
      }

      function loadPeople() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : [];
        } catch (e) {
          console.error('Erro ao ler storage', e);
          return [];
        }
      }

      function savePeople(people) { localStorage.setItem(STORAGE_KEY, JSON.stringify(people)); }

      // Pagination + filter state
      let currentPage = 1;
      const PAGE_SIZE = 10;
      // currentFilter is applied when the user clicks the search button or presses Enter
      let currentFilter = '';

      function renderPagination(totalPages) {
        const ctrl = document.getElementById('paginationControls');
        if (!ctrl) return;
        if (totalPages <= 1) { ctrl.innerHTML = ''; return; }
        const prevDisabled = currentPage <= 1 ? 'disabled' : '';
        const nextDisabled = currentPage >= totalPages ? 'disabled' : '';
        // force no line-breaks and keep controls inline
        ctrl.style.whiteSpace = 'nowrap';
        ctrl.style.display = 'inline-flex';
        ctrl.style.alignItems = 'center';
        ctrl.style.gap = '6px';
        ctrl.innerHTML = `<button id="prevPage" ${prevDisabled} class="icon-btn" aria-label="Página anterior"><i class="mdi mdi-chevron-left" aria-hidden="true"></i></button><span style="margin-right:0;">Página ${currentPage} de ${totalPages}</span><button id="nextPage" ${nextDisabled} class="icon-btn" aria-label="Próxima página"><i class="mdi mdi-chevron-right" aria-hidden="true"></i></button>`;
        const prev = document.getElementById('prevPage');
        const next = document.getElementById('nextPage');
        if (prev) prev.addEventListener('click', function(){ if (currentPage>1) { currentPage--; renderTable(); } });
        if (next) next.addEventListener('click', function(){ if (currentPage<totalPages) { currentPage++; renderTable(); } });
      }

      function renderTable() {
        const tbody = document.querySelector('#peopleTable tbody');
        tbody.innerHTML = '';
        const all = loadPeople();
        const hideDeleted = document.getElementById('hideDeleted').checked;
        const events = getEvents();
        const filter = currentFilter;

        // Apply hidden and filter
        const filtered = all.filter(p => {
          if (hideDeleted && p.deletedAt) return false;
          if (!filter) return true;
          const full = ((p.firstName||'') + ' ' + (p.lastName||'')).toLowerCase();
          return full.indexOf(filter) !== -1;
        });

        const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
        if (currentPage > totalPages) currentPage = totalPages;
        const start = (currentPage - 1) * PAGE_SIZE;
        const pageItems = filtered.slice(start, start + PAGE_SIZE);

        pageItems.forEach(p => {
          const tr = document.createElement('tr');
          if (p.deletedAt) tr.classList.add('deleted');
          const birthEv = events.find(ev => ev.personId === p.id && ev.type === 'BIRTH' && !ev.deletedAt);
          const deathEv = events.find(ev => ev.personId === p.id && ev.type === 'DEATH' && !ev.deletedAt);
          const birthDate = birthEv && birthEv.date ? formatDate(birthEv.date) : '';
          const deathDate = deathEv && deathEv.date ? formatDate(deathEv.date) : '';
          const fullName = ((p.firstName||'') + ' ' + (p.lastName||'')).replace(/\s+/g,' ').trim();
          const fullNameEsc = escapeHtml(fullName);
          tr.innerHTML = `
            <td><a href="#" class="person-link" data-id="${p.id}">${fullNameEsc}</a></td>
            <td>${birthDate}</td>
            <td>${deathDate}</td>
            <td class="actions">
              <button data-id="${p.id}" class="detail" title="Detalhe" style="background:none;border:none;cursor:pointer;padding:0;margin-right:8px;"><i class="mdi mdi-eye" style="font-size:1.2em;" aria-hidden="true"></i></button>
              <button data-id="${p.id}" class="del" title="Excluir" style="background:none;border:none;cursor:pointer;padding:0;"><i class="mdi mdi-trash-can" style="font-size:1.2em;" aria-hidden="true"></i></button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        renderPagination(totalPages);
      }

      // Search button / Enter key behavior: apply filter independently and reset to page 1
      (function(){
        const btn = document.getElementById('nameSearchBtn');
        const input = document.getElementById('nameFilter');
        if (btn && input) {
          btn.addEventListener('click', function(){
            currentFilter = (input.value || '').toLowerCase().trim();
            currentPage = 1;
            renderTable();
          });
          input.addEventListener('keydown', function(e){
            if (e.key === 'Enter'){
              e.preventDefault();
              currentFilter = (input.value || '').toLowerCase().trim();
              currentPage = 1;
              renderTable();
            }
          });
        }
      })();

      function escapeHtml(s){ return String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

      function resetForm() {
        document.getElementById('personForm').reset();
        document.getElementById('id').value = '';
        // Limpa campos de datas que só existem após salvar (criação deve deixar em branco)
        if (document.getElementById('createdAt')) document.getElementById('createdAt').value = '';
        if (document.getElementById('updatedAt')) document.getElementById('updatedAt').value = '';
        if (document.getElementById('deletedAt')) document.getElementById('deletedAt').value = '';
          const ageEl = document.getElementById('ageInfo'); if (ageEl) ageEl.textContent = '';
      }

      function formatDate(dateStr) {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        if (isNaN(d)) return escapeHtml(dateStr);
        const pad = n => n.toString().padStart(2, '0');
        const day = pad(d.getDate());
        const month = pad(d.getMonth() + 1);
        const year = d.getFullYear();
        return `${day}-${month}-${year}`;
      }

      function computeAge(birthStr, refStr) {
        if (!birthStr) return null;
        const b = new Date(birthStr);
        const r = refStr ? new Date(refStr) : new Date();
        if (isNaN(b) || isNaN(r)) return null;
        let years = r.getFullYear() - b.getFullYear();
        const m = r.getMonth() - b.getMonth();
        if (m < 0 || (m === 0 && r.getDate() < b.getDate())) years--;
        return years;
      }

      function showDatesInfo(person) {
        const el = document.getElementById('datesInfo');
        if (!el) return;
        if (!person) {
          el.innerHTML = '';
          return;
        }
        let html = '';
        if (person.createdAt) html += `<div>Criado em: <span>${formatDate(person.createdAt)}</span></div>`;
        if (person.updatedAt) html += `<div>Atualizado em: <span>${formatDate(person.updatedAt)}</span></div>`;
        if (person.deletedAt) html += `<div>Excluído em: <span>${formatDate(person.deletedAt)}</span></div>`;
        el.innerHTML = html;
      }

      document.getElementById('personForm').addEventListener('submit', function(e){
        e.preventDefault();
        const id = document.getElementById('id').value || generateUUID();
        const firstName = document.getElementById('firstName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        const gender = document.getElementById('gender').value;
        const notes = document.getElementById('notes').value;
        const createdAtField = document.getElementById('createdAt').value;
        const deletedAtField = document.getElementById('deletedAt').value || null;

        const people = loadPeople();
        const existingIndex = people.findIndex(x => x.id === id);
        const now = nowISO();

        if (existingIndex >= 0) {
          people[existingIndex] = {
            ...people[existingIndex],
            firstName, lastName, gender, notes,
            updatedAt: now,
            deletedAt: deletedAtField || null
          };
        } else {
          people.push({
            id,
            firstName,
            lastName,
            gender,
            notes,
            createdAt: createdAtField || now,
            updatedAt: now,
            deletedAt: deletedAtField || null
          });
        }

        savePeople(people);
        renderTable();
        resetForm();
      });

      document.getElementById('resetBtn').addEventListener('click', function(){ resetForm(); });

      document.getElementById('peopleTable').addEventListener('click', function(e){
        // Prevent default navigation for links
        if (e.target && e.target.tagName === 'A') e.preventDefault();
        // Find the closest element that carries a data-id
        const el = e.target.closest && e.target.closest('[data-id]');
        if (!el) return;
        const id = el.getAttribute('data-id');
        if (!id) return;
        // If it's the person link or edit: open edit; detail: open detail page; del: soft delete
        if (el.classList.contains('edit') || el.classList.contains('person-link')) {
          editPerson(id);
        } else if (el.classList.contains('detail')) {
          window.location.href = 'pessoa-detalhe.html?id=' + encodeURIComponent(id);
        } else if (el.classList.contains('del')) {
          softDeletePerson(id);
        }
      });

      document.getElementById('hideDeleted').addEventListener('change', renderTable);

      function editPerson(id) {
        const people = loadPeople();
        const p = people.find(x => x.id === id);
        if (!p) return alert('Registro não encontrado');
        document.getElementById('id').value = p.id;
        document.getElementById('firstName').value = p.firstName || '';
        document.getElementById('lastName').value = p.lastName || '';
        document.getElementById('gender').value = p.gender || '';
        document.getElementById('notes').value = p.notes || '';
        document.getElementById('createdAt').value = p.createdAt || '';
        document.getElementById('updatedAt').value = p.updatedAt || '';
        document.getElementById('deletedAt').value = p.deletedAt || '';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function softDeletePerson(id) {
        if (!confirm('Confirmar exclusão (soft delete)?')) return;
        const people = loadPeople();
        const i = people.findIndex(x => x.id === id);
        if (i < 0) return alert('Registro não encontrado');
        people[i].deletedAt = nowISO();
        people[i].updatedAt = nowISO();
        savePeople(people);
        renderTable();
      }

      renderTable();
    </script>
  </body>
</html>
