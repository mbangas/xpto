<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Definições</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css">
    <script src="remote-storage.js"></script>
  </head>
  <body>
    <div class="app-shell">
      <aside class="sidebar">
        <a href="index.html" class="logo"><i class="mdi mdi-tree" aria-hidden="true"></i><span>myLineage</span></a>
        <nav>
          <a href="app.html"><i class="mdi mdi-account-multiple" aria-hidden="true"></i>Cadastro</a>
          <a href="indicadores.html"><i class="mdi mdi-chart-bar" aria-hidden="true"></i>Indicadores</a>
          <a href="arvore.html"><i class="mdi mdi-sitemap" aria-hidden="true"></i>Árvore</a>
          <a href="gedcom.html"><i class="mdi mdi-dna" aria-hidden="true"></i>GEDCOM</a>
          <a href="album.html"><i class="mdi mdi-image-multiple" aria-hidden="true"></i>Álbum</a>
          <a href="documentos.html"><i class="mdi mdi-folder-open" aria-hidden="true"></i>Documentos</a>
          <a href="validacao.html"><i class="mdi mdi-shield-check" aria-hidden="true"></i>Validação</a>
          <a href="historico.html"><i class="mdi mdi-history" aria-hidden="true"></i>Histórico</a>
        </nav>
        <div class="sidebar-footer">
          <a href="apis.html"><i class="mdi mdi-api" aria-hidden="true"></i>APIs</a>
          <a href="configuracao.html" class="active"><i class="mdi mdi-cog" aria-hidden="true"></i>Definições</a>
        </div>
      </aside>
      <main class="content">
        <div class="topbar">
          <div><h1>Definições</h1></div>
          <div></div>
        </div>

        <div class="card centered-panel" style="max-width:760px;width:100%;">
          <h2 style="margin:0 0 8px 0;">Biblioteca de Documentos</h2>
          <p style="color:var(--text-secondary);margin-top:6px;">Defina a pasta base que contém o repositório de documentos. Use o botão para abrir o seletor de pastas (File System Access API) quando disponível, ou selecione uma pasta via o seletor de ficheiros com <em>webkitdirectory</em> como fallback (navegadores Chromium).</p>

          <div style="display:flex;gap:12px;align-items:center;margin-top:12px;flex-direction:column;align-items:flex-start;">
            <label style="font-weight:600;color:var(--text-secondary);">Selecionar pasta de documentos</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <button class="btn" id="openDocDirBtn">Selecionar pasta...</button>
              <input type="file" id="docDirPicker" webkitdirectory directory multiple style="display:none;" />
            </div>
            <div id="docSelectionInfo" style="color:var(--text-secondary);font-size:0.95rem;min-height:36px;"></div>
            <div style="display:flex;gap:8px;margin-top:6px;">
              <button class="btn" id="clearDocBaseBtn">Remover configuração</button>
            </div>
            <div id="currentDocBase" style="margin-top:10px;color:var(--text-secondary);font-size:0.95rem;"></div>
          </div>
        </div>

        <div class="card centered-panel" style="max-width:760px;width:100%;margin-top:16px;">
          <h2 style="margin:0 0 8px 0;">Biblioteca de Fotos</h2>
          <p style="color:var(--text-secondary);margin-top:6px;">Defina a pasta base que contém o repositório de fotografias. Use o botão para abrir o seletor de pastas (File System Access API) quando disponível, ou selecione uma pasta via o seletor de ficheiros com <em>webkitdirectory</em> como fallback (navegadores Chromium).</p>

          <div style="display:flex;gap:12px;align-items:center;margin-top:12px;flex-direction:column;align-items:flex-start;">
            <label style="font-weight:600;color:var(--text-secondary);">Selecionar pasta de fotografias</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <button class="btn" id="openDirBtn">Selecionar pasta...</button>
              <input type="file" id="dirPicker" webkitdirectory directory multiple accept="image/*" style="display:none;" />
            </div>
            <div id="selectionInfo" style="color:var(--text-secondary);font-size:0.95rem;min-height:36px;"></div>
            <div style="display:flex;gap:8px;margin-top:6px;">
              <button class="btn" id="clearBaseBtn">Remover configuração</button>
            </div>
            <div id="currentBase" style="margin-top:10px;color:var(--text-secondary);font-size:0.95rem;"></div>
          </div>
        </div>

        <div class="card centered-panel" style="max-width:760px;width:100%;margin-top:16px;">
          <h2 style="margin:0 0 8px 0;">Pessoa em Foco</h2>
          <p style="color:var(--text-secondary);margin-top:6px;">Pesquise pessoas e defina uma como foco principal. A seleção será salva nas configurações locais.</p>

          <div style="display:flex;gap:12px;align-items:center;margin-top:12px;flex-direction:column;align-items:flex-start;">
            <label style="font-weight:600;color:var(--text-secondary);">Pesquisar pessoa</label>
            <div style="position:relative;width:100%;max-width:420px;">
              <input type="search" id="personSearch" placeholder="Pesquisar pessoa (nome)" style="width:220px;padding:8px;border:1px solid var(--border);border-radius:4px;" />
              <div id="peopleSuggestions" style="position:absolute;left:8px;top:38px;background:var(--bg-card);border:1px solid rgba(0,0,0,0.06);max-height:160px;overflow:auto;width:220px;z-index:230;display:none;"></div>
            </div>
            <div style="display:flex;gap:8px;margin-top:8px;align-items:center;">
              <button class="btn" id="setFocusBtn">Definir Pessoa</button>
            </div>

            <div style="margin-top:8px;color:var(--text-secondary);font-size:0.95rem;">Pessoa em foco atual: <span id="currentFocus" style="font-weight:600"></span></div>
            <div style="display:flex;gap:8px;margin-top:6px;">
              <button class="btn" id="clearFocusBtn">Remover foco</button>
            </div>
          </div>
        </div>

      </main>
    </div>

    <script>
      const DB = window.GedcomDB;
      function nowISO(){ return new Date().toISOString(); }

      // ── IndexedDB helpers for directory handles (unchanged) ──
      function saveDocDirHandleToDB(handle){
        try{
          const req = indexedDB.open('myLineage-db', 1);
          req.onupgradeneeded = function(e){ const db = e.target.result; if(!db.objectStoreNames.contains('handles')) db.createObjectStore('handles'); };
          return new Promise((resolve, reject)=>{
            req.onsuccess = function(e){
              const db = e.target.result;
              const tx = db.transaction('handles', 'readwrite');
              const store = tx.objectStore('handles');
              store.put(handle, 'docBaseHandle');
              tx.oncomplete = function(){ db.close(); resolve(true); };
              tx.onerror = function(ev){ db.close(); reject(ev); };
            };
            req.onerror = function(){ reject(req.error); };
          });
        }catch(e){ return Promise.reject(e); }
      }

      function saveDirHandleToDB(handle){
        try{
          const req = indexedDB.open('myLineage-db', 1);
          req.onupgradeneeded = function(e){ const db = e.target.result; if(!db.objectStoreNames.contains('handles')) db.createObjectStore('handles'); };
          return new Promise((resolve, reject)=>{
            req.onsuccess = function(e){
              const db = e.target.result;
              const tx = db.transaction('handles', 'readwrite');
              const store = tx.objectStore('handles');
              store.put(handle, 'photoBaseHandle');
              tx.oncomplete = function(){ db.close(); resolve(true); };
              tx.onerror = function(ev){ db.close(); reject(ev); };
            };
            req.onerror = function(){ reject(req.error); };
          });
        }catch(e){ return Promise.reject(e); }
      }

      function getDirHandleFromDB(){
        try{
          const req = indexedDB.open('myLineage-db', 1);
          return new Promise((resolve, reject)=>{
            req.onupgradeneeded = function(e){ const db = e.target.result; if(!db.objectStoreNames.contains('handles')) db.createObjectStore('handles'); };
            req.onsuccess = function(e){ const db = e.target.result; const tx = db.transaction('handles','readonly'); const store = tx.objectStore('handles'); const g = store.get('photoBaseHandle'); g.onsuccess = function(){ resolve(g.result || null); db.close(); }; g.onerror = function(){ resolve(null); db.close(); }; };
            req.onerror = function(){ resolve(null); };
          });
        }catch(e){ return Promise.resolve(null); }
      }

      // ── Settings helpers via GedcomDB ──
      function readSaved(){ return DB.getSetting('photoBase') || null; }
      function saveBase(obj){ DB.setSetting('photoBase', obj); }
      function clearBase(){ DB.setSetting('photoBase', null); }

      function readDocSaved(){ return DB.getSetting('docBase') || null; }
      function saveDocBase(obj){ DB.setSetting('docBase', obj); }
      function clearDocBase(){ DB.setSetting('docBase', null); }

      function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
      function commonPrefix(paths){ if(!paths || paths.length===0) return ''; const split = paths.map(p => (p || '').split('/')); const first = split[0] || []; let prefix = []; for(let i=0;i<first.length;i++){ const seg = first[i]; if(split.every(s => s[i] === seg)) prefix.push(seg); else break; } return prefix.join('/'); }

      function showCurrent(){ const cur = readSaved(); const el = document.getElementById('currentBase'); if(!cur){ el.innerHTML = '<div style="font-style:italic;color:var(--text-secondary);">Nenhuma pasta base configurada.</div>'; return; } el.innerHTML = `<div>Base configurada: <b>${escapeHtml(cur.folder)}</b> — ${cur.files || 0} ficheiros<br><small style="color:var(--text-secondary);">Salvo em: ${cur.when || ''}</small></div>`; }

      function showCurrentDoc(){ const cur = readDocSaved(); const el = document.getElementById('currentDocBase'); if(!cur){ el.innerHTML = '<div style="font-style:italic;color:var(--text-secondary);">Nenhuma pasta base configurada.</div>'; return; } el.innerHTML = `<div>Base configurada: <b>${escapeHtml(cur.folder)}</b> — ${cur.files || 0} ficheiros<br><small style="color:var(--text-secondary);">Salvo em: ${cur.when || ''}</small></div>`; }

      document.addEventListener('DOMContentLoaded', function(){
        const fileInput = document.getElementById('dirPicker');
        const openBtn = document.getElementById('openDirBtn');
        const info = document.getElementById('selectionInfo');
        const clearBtn = document.getElementById('clearBaseBtn');
        let lastFolder = null; let lastCount = 0;

        showCurrent();
        showCurrentDoc();

        // --- Biblioteca de Documentos ---
        const docFileInput = document.getElementById('docDirPicker');
        const openDocBtn = document.getElementById('openDocDirBtn');
        const docInfo = document.getElementById('docSelectionInfo');
        const clearDocBtn = document.getElementById('clearDocBaseBtn');

        function handleDocFilesArray(files){
          if(!files || files.length===0){ docInfo.textContent = 'Nenhum ficheiro selecionado.'; return; }
          const paths = files.map(f => f.webkitRelativePath || f.name);
          const root = commonPrefix(paths) || (paths[0] ? paths[0].split('/')[0] : '');
          docInfo.innerHTML = `<div>Detectado: <b>${escapeHtml(root)}</b> — ${files.length} ficheiros</div>`;
          saveDocBase({ folder: root, files: files.length, when: nowISO() });
          showCurrentDoc();
          alert('Pasta base de documentos salva.');
        }

        async function countFilesInDir(dirHandle){
          let count = 0;
          for await (const [name, handle] of dirHandle.entries()){
            if(handle.kind === 'file') count++;
            else if(handle.kind === 'directory') count += await countFilesInDir(handle);
          }
          return count;
        }

        if(window.showDirectoryPicker){
          docFileInput.style.display = 'none';
          openDocBtn.addEventListener('click', async function(){
            try{
              const dir = await window.showDirectoryPicker();
              const count = await countFilesInDir(dir);
              docInfo.innerHTML = `<div>Detectado: <b>${escapeHtml(dir.name)}</b> — ${count} ficheiros</div>`;
              saveDocBase({ folder: dir.name, files: count, when: nowISO() });
              try{ await saveDocDirHandleToDB(dir); }catch(err){ console.warn('Não foi possível salvar handle do diretório de documentos:', err); }
              showCurrentDoc();
              alert('Pasta base de documentos salva.');
            }catch(err){
              console.error(err);
              alert('Não foi possível abrir o seletor de pastas.');
            }
          });
        } else {
          openDocBtn.style.display = 'none';
          docFileInput.addEventListener('change', function(e){
            handleDocFilesArray(Array.from(this.files || []));
          });
        }

        clearDocBtn.addEventListener('click', function(){ if(!confirm('Remover a configuração da pasta base de documentos?')) return; clearDocBase(); showCurrentDoc(); alert('Configuração removida.'); });

        // --- Biblioteca de Fotos ---
        function handleFilesArray(files){
          if(!files || files.length===0){ info.textContent = 'Nenhum ficheiro selecionado.'; return; }
          const paths = files.map(f => f.webkitRelativePath || f.name);
          const root = commonPrefix(paths) || (paths[0] ? paths[0].split('/')[0] : '');
          lastFolder = root; lastCount = files.length;
          info.innerHTML = `<div>Detectado: <b>${escapeHtml(root)}</b> — ${files.length} ficheiros</div>`;
          saveBase({ folder: lastFolder, files: lastCount, when: nowISO() });
          showCurrent();
          alert('Pasta base salva.');
        }

        if(window.showDirectoryPicker){
          fileInput.style.display = 'none';
          openBtn.addEventListener('click', async function(){
            try{
              const dir = await window.showDirectoryPicker();
              const count = await countFilesInDir(dir);
              lastFolder = dir.name; lastCount = count;
              info.innerHTML = `<div>Detectado: <b>${escapeHtml(dir.name)}</b> — ${count} ficheiros</div>`;
              saveBase({ folder: lastFolder, files: lastCount, when: nowISO() });
              try{ await saveDirHandleToDB(dir); }catch(err){ console.warn('Não foi possível salvar handle do diretório:', err); }
              showCurrent();
              alert('Pasta base salva.');
            }catch(err){
              console.error(err);
              alert('Não foi possível abrir o seletor de pastas.');
            }
          });
        } else {
          openBtn.style.display = 'none';
          fileInput.addEventListener('change', function(e){
            handleFilesArray(Array.from(this.files || []));
          });
        }

        clearBtn.addEventListener('click', function(){ if(!confirm('Remover a configuração da pasta base?')) return; clearBase(); showCurrent(); alert('Configuração removida.'); });

        // --- Pessoa em Foco ---
        const search = document.getElementById('personSearch');
        const setFocusBtn = document.getElementById('setFocusBtn');
        const currentFocusEl = document.getElementById('currentFocus');
        const clearFocusBtn = document.getElementById('clearFocusBtn');
        const suggestions = document.getElementById('peopleSuggestions');
        let selectedPersonId = null;

        function saveFocus(name, id){ const obj = { name, when: nowISO() }; if(id) obj.id = id; DB.setSetting('focusedPerson', obj); showCurrentFocus(); }
        function clearFocus(){ DB.setSetting('focusedPerson', null); showCurrentFocus(); }
        function showCurrentFocus(){ const v = DB.getSetting('focusedPerson'); currentFocusEl.textContent = v ? v.name : '—'; }

        function renderSuggestions(filter){
          const q = (filter||'').toLowerCase().trim();
          if(!q){ suggestions.innerHTML = ''; suggestions.style.display = 'none'; return; }
          const people = DB.getIndividuals();
          const list = people.filter(p => DB.getDisplayName(p).toLowerCase().includes(q)).slice(0, 30);
          suggestions.innerHTML = '';
          if(list.length===0){ suggestions.style.display='none'; return; }
          list.forEach(p => {
            const label = DB.getDisplayName(p);
            const row = document.createElement('div');
            row.style.padding='6px'; row.style.cursor='pointer'; row.style.borderBottom='1px solid rgba(255,255,255,0.03)';
            row.textContent = label;
            row.addEventListener('click', function(){ search.value = label; selectedPersonId = p.id; suggestions.style.display='none'; search.focus(); });
            suggestions.appendChild(row);
          });
          suggestions.style.display='block';
        }

        function setFromInput(){
          const val = (search.value||'').trim();
          if(!val) return alert('Escreva ou selecione uma pessoa.');
          const people = DB.getIndividuals();
          let found = null;
          if(selectedPersonId) found = people.find(p => p.id === selectedPersonId);
          if(!found) found = people.find(p => DB.getDisplayName(p).toLowerCase() === val.toLowerCase());
          if(!found) return alert('Pessoa não encontrada. Verifique se o nome corresponde a uma pessoa existente.');
          saveFocus(DB.getDisplayName(found), found.id || null);
          alert('Pessoa definida como foco principal.');
        }

        search.addEventListener('input', function(){ selectedPersonId = null; renderSuggestions(this.value); });
        search.addEventListener('keydown', function(e){ if(e.key === 'Enter'){ e.preventDefault(); setFocusBtn.click(); } });
        setFocusBtn.addEventListener('click', setFromInput);
        clearFocusBtn.addEventListener('click', function(){ if(!confirm('Remover pessoa em foco?')) return; clearFocus(); alert('Foco removido.'); });

        showCurrentFocus();
      });
    </script>
    <script src="history-logger.js"></script>
  </body>
</html>
