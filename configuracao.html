<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Configuração</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css">
  </head>
  <body>
    <div class="app-shell">
      <aside class="sidebar">
        <div class="logo">XPTO</div>
        <nav>
          <a href="index.html">Cadastro</a>
          <a href="indicadores.html">Indicadores</a>
          <a href="pessoas.html">Pessoas</a>
          <a href="import.html">Importar</a>
          <a href="export.html">Exportar</a>
        </nav>
        <div class="sidebar-footer">
          <a href="configuracao.html" class="active">Configuração</a>
        </div>
      </aside>
      <main class="content">
        <div class="topbar">
          <div><h1 style="margin:0;font-size:1.25rem;">Configuração</h1></div>
          <div></div>
        </div>

        <div class="card" style="max-width:760px;">
          <h2 style="margin:0 0 8px 0;">Biblioteca de Fotos</h2>
          <p style="color:var(--text-secondary);margin-top:6px;">Defina a pasta base que contém o repositório de fotografias. Use o botão para abrir o seletor de pastas (File System Access API) quando disponível, ou selecione uma pasta via o seletor de ficheiros com <em>webkitdirectory</em> como fallback (navegadores Chromium).</p>

          <div style="display:flex;gap:12px;align-items:center;margin-top:12px;flex-direction:column;align-items:flex-start;">
            <label style="font-weight:600;color:var(--text-secondary);">Selecionar pasta de fotografias</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <button class="btn" id="openDirBtn">Selecionar pasta...</button>
              <input type="file" id="dirPicker" webkitdirectory directory multiple accept="image/*" style="display:none;" />
            </div>
            <div id="selectionInfo" style="color:var(--text-secondary);font-size:0.95rem;min-height:36px;"></div>
            <div style="display:flex;gap:8px;margin-top:6px;">
              <button class="btn" id="clearBaseBtn">Remover configuração</button>
            </div>
            <div id="currentBase" style="margin-top:10px;color:var(--text-secondary);font-size:0.95rem;"></div>
          </div>
        </div>

        <div class="card" style="max-width:760px; margin-top:16px;">
          <h2 style="margin:0 0 8px 0;">Pessoa em Foco</h2>
          <p style="color:var(--text-secondary);margin-top:6px;">Pesquise pessoas e defina uma como foco principal. A seleção será salva nas configurações locais.</p>

          <div style="display:flex;gap:12px;align-items:center;margin-top:12px;flex-direction:column;align-items:flex-start;">
            <label style="font-weight:600;color:var(--text-secondary);">Pesquisar pessoa</label>
            <input list="peopleList" type="search" id="personSearch" placeholder="Pesquisar pessoa..." style="width:100%;max-width:420px;padding:8px;border:1px solid var(--border);border-radius:4px;" />
            <datalist id="peopleList"></datalist>
            <div style="display:flex;gap:8px;margin-top:8px;align-items:center;">
              <button class="btn" id="setFocusBtn">Definir como foco</button>
            </div>

            <div style="margin-top:8px;color:var(--text-secondary);font-size:0.95rem;">Pessoa em foco atual: <span id="currentFocus" style="font-weight:600"></span></div>
            <div style="display:flex;gap:8px;margin-top:6px;">
              <button class="btn" id="clearFocusBtn">Remover foco</button>
            </div>
          </div>
        </div>

      </main>
    </div>

    <script>
      function nowISO(){ return new Date().toISOString(); }
      const KEY = 'photoBase:xpto';

      // Persist directory handle in IndexedDB so other pages can write into it
      function saveDirHandleToDB(handle){
        try{
          const req = indexedDB.open('xpto-db', 1);
          req.onupgradeneeded = function(e){ const db = e.target.result; if(!db.objectStoreNames.contains('handles')) db.createObjectStore('handles'); };
          return new Promise((resolve, reject)=>{
            req.onsuccess = function(e){
              const db = e.target.result;
              const tx = db.transaction('handles', 'readwrite');
              const store = tx.objectStore('handles');
              store.put(handle, 'photoBaseHandle');
              tx.oncomplete = function(){ db.close(); resolve(true); };
              tx.onerror = function(ev){ db.close(); reject(ev); };
            };
            req.onerror = function(){ reject(req.error); };
          });
        }catch(e){ return Promise.reject(e); }
      }

      function getDirHandleFromDB(){
        try{
          const req = indexedDB.open('xpto-db', 1);
          return new Promise((resolve, reject)=>{
            req.onupgradeneeded = function(e){ const db = e.target.result; if(!db.objectStoreNames.contains('handles')) db.createObjectStore('handles'); };
            req.onsuccess = function(e){ const db = e.target.result; const tx = db.transaction('handles','readonly'); const store = tx.objectStore('handles'); const g = store.get('photoBaseHandle'); g.onsuccess = function(){ resolve(g.result || null); db.close(); }; g.onerror = function(){ resolve(null); db.close(); }; };
            req.onerror = function(){ resolve(null); };
          });
        }catch(e){ return Promise.resolve(null); }
      }

      function readSaved(){ try{ return JSON.parse(localStorage.getItem(KEY)||'null'); }catch(e){ return null; } }
      function saveBase(obj){ localStorage.setItem(KEY, JSON.stringify(obj)); }
      function clearBase(){ localStorage.removeItem(KEY); }

      function showCurrent(){ const cur = readSaved(); const el = document.getElementById('currentBase'); if(!cur){ el.innerHTML = '<div style="font-style:italic;color:var(--text-secondary);">Nenhuma pasta base configurada.</div>'; return; } el.innerHTML = `<div>Base configurada: <b>${escapeHtml(cur.folder)}</b> — ${cur.files || 0} ficheiros<br><small style="color:var(--text-secondary);">Salvo em: ${cur.when || ''}</small></div>`; }

      function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

      function commonPrefix(paths){ if(!paths || paths.length===0) return ''; const split = paths.map(p => (p || '').split('/')); const first = split[0] || []; let prefix = []; for(let i=0;i<first.length;i++){ const seg = first[i]; if(split.every(s => s[i] === seg)) prefix.push(seg); else break; } return prefix.join('/'); }

      document.addEventListener('DOMContentLoaded', function(){
        const fileInput = document.getElementById('dirPicker');
        const openBtn = document.getElementById('openDirBtn');
        const info = document.getElementById('selectionInfo');
        const clearBtn = document.getElementById('clearBaseBtn');
        let lastFolder = null; let lastCount = 0;

        showCurrent();

        async function countFilesInDir(dirHandle){
          let count = 0;
          for await (const [name, handle] of dirHandle.entries()){
            if(handle.kind === 'file') count++;
            else if(handle.kind === 'directory') count += await countFilesInDir(handle);
          }
          return count;
        }

        function handleFilesArray(files){
          if(!files || files.length===0){ info.textContent = 'Nenhum ficheiro selecionado.'; return; }
          const paths = files.map(f => f.webkitRelativePath || f.name);
          const root = commonPrefix(paths) || (paths[0] ? paths[0].split('/')[0] : '');
          lastFolder = root;
          lastCount = files.length;
          info.innerHTML = `<div>Detectado: <b>${escapeHtml(root)}</b> — ${files.length} ficheiros</div>`;
          // salvar automaticamente
          saveBase({ folder: lastFolder, files: lastCount, when: nowISO() });
          showCurrent();
          alert('Pasta base salva.');
        }

        if(window.showDirectoryPicker){
          fileInput.style.display = 'none';
          openBtn.addEventListener('click', async function(){
            try{
              const dir = await window.showDirectoryPicker();
              const count = await countFilesInDir(dir);
              lastFolder = dir.name;
              lastCount = count;
              info.innerHTML = `<div>Detectado: <b>${escapeHtml(dir.name)}</b> — ${count} ficheiros</div>`;
              // salvar automaticamente
              saveBase({ folder: lastFolder, files: lastCount, when: nowISO() });
              // persist directory handle so other pages can write into it
              try{ await saveDirHandleToDB(dir); }catch(err){ console.warn('Não foi possível salvar handle do diretório:', err); }
              showCurrent();
              alert('Pasta base salva.');
            }catch(err){
              console.error(err);
              alert('Não foi possível abrir o seletor de pastas.');
            }
          });
        } else {
          openBtn.style.display = 'none';
          fileInput.addEventListener('change', function(e){
            const files = Array.from(this.files || []);
            handleFilesArray(files);
          });
        }

        saveBtn.addEventListener('click', function(){ if(!lastFolder) return alert('Nenhuma pasta detectada.'); saveBase({ folder: lastFolder, files: lastCount, when: nowISO() }); showCurrent(); alert('Pasta base salva.'); });
        clearBtn.addEventListener('click', function(){ if(!confirm('Remover a configuração da pasta base?')) return; clearBase(); showCurrent(); alert('Configuração removida.'); });

        // --- Pessoa em Foco: pesquisa e foco principal (combobox/datalist) ---
        const PERSON_KEY = 'people:xpto';
        const FOCUS_KEY = 'focusedPerson:xpto';
        const search = document.getElementById('personSearch');
        const peopleList = document.getElementById('peopleList');
        const setFocusBtn = document.getElementById('setFocusBtn');
        const currentFocusEl = document.getElementById('currentFocus');
        const clearFocusBtn = document.getElementById('clearFocusBtn');

        function loadPeople(){ try{ return JSON.parse(localStorage.getItem(PERSON_KEY)||'[]'); }catch(e){ return []; } }
        function personName(p){ if(!p) return ''; if(typeof p === 'string') return p; // prefer explicit first/last name fields as "nome completo"
          if((p.firstName || p.lastName)) return ((p.firstName||'') + ' ' + (p.lastName||'')).replace(/\s+/g,' ').trim();
          if(p.fullName) return p.fullName;
          if(p.name) return p.name;
          if(p.nome) return p.nome;
          if(p.displayName) return p.displayName;
          // fallback: find first string prop
          for(const k in p){ if(typeof p[k] === 'string' && p[k].trim()) return p[k]; } return JSON.stringify(p); }
        function saveFocus(name){ localStorage.setItem(FOCUS_KEY, JSON.stringify({ name: name, when: nowISO() })); showCurrentFocus(); }
        function clearFocus(){ localStorage.removeItem(FOCUS_KEY); showCurrentFocus(); }
        function showCurrentFocus(){ const v = JSON.parse(localStorage.getItem(FOCUS_KEY)||'null'); currentFocusEl.textContent = v ? v.name : '—'; }

        function renderMatches(q){ const people = loadPeople(); const ql = (q||'').trim().toLowerCase(); const matches = ql ? people.filter(p => personName(p).toLowerCase().includes(ql)) : people.slice(0,200); peopleList.innerHTML = matches.map(p => `<option value="${escapeHtml(personName(p))}"></option>`).join(''); }

        function setFromInput(){ const val = (search.value||'').trim(); if(!val){ return alert('Escreva ou selecione uma pessoa.'); } const people = loadPeople(); const found = people.find(p => personName(p).toLowerCase() === val.toLowerCase()); if(!found){ return alert('Pessoa não encontrada. Verifique se o nome corresponde a uma pessoa existente.'); } saveFocus(personName(found)); alert('Pessoa definida como foco principal.'); }

        search.addEventListener('input', function(){ renderMatches(this.value); });
        search.addEventListener('keydown', function(e){ if(e.key === 'Enter'){ e.preventDefault(); setFromInput(); } });
        setFocusBtn.addEventListener('click', setFromInput);
        clearFocusBtn.addEventListener('click', function(){ if(!confirm('Remover pessoa em foco?')) return; clearFocus(); alert('Foco removido.'); });

        showCurrentFocus();
        renderMatches('');
      });
    </script>
  </body>
</html>
