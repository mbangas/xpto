var F3Lib=(()=>{var Pt=Object.defineProperty;var Ms=Object.getOwnPropertyDescriptor;var As=Object.getOwnPropertyNames;var Ts=Object.prototype.hasOwnProperty;var Rs=(e,t)=>{for(var n in t)Pt(e,n,{get:t[n],enumerable:!0})},Ds=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of As(t))!Ts.call(e,i)&&i!==n&&Pt(e,i,{get:()=>t[i],enumerable:!(r=Ms(t,i))||r.enumerable});return e};var Os=e=>Ds(Pt({},"__esModule",{value:!0}),e);var yu={};Rs(yu,{CalculateTree:()=>fo,Card:()=>Bn,calculateTree:()=>An,cardHtml:()=>Dt,cardSvg:()=>Ot,createChart:()=>Vn,createStore:()=>Tn,createSvg:()=>Lt,elements:()=>ks,formatData:()=>et,formatDataForExport:()=>Mn,handlers:()=>hs,icons:()=>rs,view:()=>On});function Ee(e,t){let n,r;if(t===void 0)for(let i of e)i!=null&&(n===void 0?i>=i&&(n=r=i):(n>i&&(n=i),r<i&&(r=i)));else{let i=-1;for(let o of e)(o=t(o,++i,e))!=null&&(n===void 0?o>=o&&(n=r=o):(n>o&&(n=o),r<o&&(r=o)))}return[n,r]}var Hs={value:()=>{}};function Xn(){for(var e=0,t=arguments.length,n={},r;e<t;++e){if(!(r=arguments[e]+"")||r in n||/[\s.]/.test(r))throw new Error("illegal type: "+r);n[r]=[]}return new tt(n)}function tt(e){this._=e}function Ls(e,t){return e.trim().split(/^|\s+/).map(function(n){var r="",i=n.indexOf(".");if(i>=0&&(r=n.slice(i+1),n=n.slice(0,i)),n&&!t.hasOwnProperty(n))throw new Error("unknown type: "+n);return{type:n,name:r}})}tt.prototype=Xn.prototype={constructor:tt,on:function(e,t){var n=this._,r=Ls(e+"",n),i,o=-1,s=r.length;if(arguments.length<2){for(;++o<s;)if((i=(e=r[o]).type)&&(i=Ns(n[i],e.name)))return i;return}if(t!=null&&typeof t!="function")throw new Error("invalid callback: "+t);for(;++o<s;)if(i=(e=r[o]).type)n[i]=Un(n[i],e.name,t);else if(t==null)for(i in n)n[i]=Un(n[i],e.name,null);return this},copy:function(){var e={},t=this._;for(var n in t)e[n]=t[n].slice();return new tt(e)},call:function(e,t){if((i=arguments.length-2)>0)for(var n=new Array(i),r=0,i,o;r<i;++r)n[r]=arguments[r+2];if(!this._.hasOwnProperty(e))throw new Error("unknown type: "+e);for(o=this._[e],r=0,i=o.length;r<i;++r)o[r].value.apply(t,n)},apply:function(e,t,n){if(!this._.hasOwnProperty(e))throw new Error("unknown type: "+e);for(var r=this._[e],i=0,o=r.length;i<o;++i)r[i].value.apply(t,n)}};function Ns(e,t){for(var n=0,r=e.length,i;n<r;++n)if((i=e[n]).name===t)return i.value}function Un(e,t,n){for(var r=0,i=e.length;r<i;++r)if(e[r].name===t){e[r]=Hs,e=e.slice(0,r).concat(e.slice(r+1));break}return n!=null&&e.push({name:t,value:n}),e}var Fe=Xn;var nt="http://www.w3.org/1999/xhtml",zt={svg:"http://www.w3.org/2000/svg",xhtml:nt,xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};function ce(e){var t=e+="",n=t.indexOf(":");return n>=0&&(t=e.slice(0,n))!=="xmlns"&&(e=e.slice(n+1)),zt.hasOwnProperty(t)?{space:zt[t],local:e}:e}function Fs(e){return function(){var t=this.ownerDocument,n=this.namespaceURI;return n===nt&&t.documentElement.namespaceURI===nt?t.createElement(e):t.createElementNS(n,e)}}function Ps(e){return function(){return this.ownerDocument.createElementNS(e.space,e.local)}}function Ie(e){var t=ce(e);return(t.local?Ps:Fs)(t)}function zs(){}function ye(e){return e==null?zs:function(){return this.querySelector(e)}}function Yn(e){typeof e!="function"&&(e=ye(e));for(var t=this._groups,n=t.length,r=new Array(n),i=0;i<n;++i)for(var o=t[i],s=o.length,l=r[i]=new Array(s),f,u,p=0;p<s;++p)(f=o[p])&&(u=e.call(f,f.__data__,p,o))&&("__data__"in f&&(u.__data__=f.__data__),l[p]=u);return new U(r,this._parents)}function qt(e){return e==null?[]:Array.isArray(e)?e:Array.from(e)}function qs(){return[]}function Pe(e){return e==null?qs:function(){return this.querySelectorAll(e)}}function Bs(e){return function(){return qt(e.apply(this,arguments))}}function Zn(e){typeof e=="function"?e=Bs(e):e=Pe(e);for(var t=this._groups,n=t.length,r=[],i=[],o=0;o<n;++o)for(var s=t[o],l=s.length,f,u=0;u<l;++u)(f=s[u])&&(r.push(e.call(f,f.__data__,u,s)),i.push(f));return new U(r,i)}function ze(e){return function(){return this.matches(e)}}function rt(e){return function(t){return t.matches(e)}}var Vs=Array.prototype.find;function Us(e){return function(){return Vs.call(this.children,e)}}function Xs(){return this.firstElementChild}function Gn(e){return this.select(e==null?Xs:Us(typeof e=="function"?e:rt(e)))}var Ys=Array.prototype.filter;function Zs(){return Array.from(this.children)}function Gs(e){return function(){return Ys.call(this.children,e)}}function Wn(e){return this.selectAll(e==null?Zs:Gs(typeof e=="function"?e:rt(e)))}function Kn(e){typeof e!="function"&&(e=ze(e));for(var t=this._groups,n=t.length,r=new Array(n),i=0;i<n;++i)for(var o=t[i],s=o.length,l=r[i]=[],f,u=0;u<s;++u)(f=o[u])&&e.call(f,f.__data__,u,o)&&l.push(f);return new U(r,this._parents)}function it(e){return new Array(e.length)}function Jn(){return new U(this._enter||this._groups.map(it),this._parents)}function qe(e,t){this.ownerDocument=e.ownerDocument,this.namespaceURI=e.namespaceURI,this._next=null,this._parent=e,this.__data__=t}qe.prototype={constructor:qe,appendChild:function(e){return this._parent.insertBefore(e,this._next)},insertBefore:function(e,t){return this._parent.insertBefore(e,t)},querySelector:function(e){return this._parent.querySelector(e)},querySelectorAll:function(e){return this._parent.querySelectorAll(e)}};function jn(e){return function(){return e}}function Ws(e,t,n,r,i,o){for(var s=0,l,f=t.length,u=o.length;s<u;++s)(l=t[s])?(l.__data__=o[s],r[s]=l):n[s]=new qe(e,o[s]);for(;s<f;++s)(l=t[s])&&(i[s]=l)}function Ks(e,t,n,r,i,o,s){var l,f,u=new Map,p=t.length,d=o.length,c=new Array(p),a;for(l=0;l<p;++l)(f=t[l])&&(c[l]=a=s.call(f,f.__data__,l,t)+"",u.has(a)?i[l]=f:u.set(a,f));for(l=0;l<d;++l)a=s.call(e,o[l],l,o)+"",(f=u.get(a))?(r[l]=f,f.__data__=o[l],u.delete(a)):n[l]=new qe(e,o[l]);for(l=0;l<p;++l)(f=t[l])&&u.get(c[l])===f&&(i[l]=f)}function Js(e){return e.__data__}function Qn(e,t){if(!arguments.length)return Array.from(this,Js);var n=t?Ks:Ws,r=this._parents,i=this._groups;typeof e!="function"&&(e=jn(e));for(var o=i.length,s=new Array(o),l=new Array(o),f=new Array(o),u=0;u<o;++u){var p=r[u],d=i[u],c=d.length,a=js(e.call(p,p&&p.__data__,u,r)),h=a.length,m=l[u]=new Array(h),g=s[u]=new Array(h),y=f[u]=new Array(c);n(p,d,m,g,y,a,t);for(var x=0,_=0,S,O;x<h;++x)if(S=m[x]){for(x>=_&&(_=x+1);!(O=g[_])&&++_<h;);S._next=O||null}}return s=new U(s,r),s._enter=l,s._exit=f,s}function js(e){return typeof e=="object"&&"length"in e?e:Array.from(e)}function er(){return new U(this._exit||this._groups.map(it),this._parents)}function tr(e,t,n){var r=this.enter(),i=this,o=this.exit();return typeof e=="function"?(r=e(r),r&&(r=r.selection())):r=r.append(e+""),t!=null&&(i=t(i),i&&(i=i.selection())),n==null?o.remove():n(o),r&&i?r.merge(i).order():i}function nr(e){for(var t=e.selection?e.selection():e,n=this._groups,r=t._groups,i=n.length,o=r.length,s=Math.min(i,o),l=new Array(i),f=0;f<s;++f)for(var u=n[f],p=r[f],d=u.length,c=l[f]=new Array(d),a,h=0;h<d;++h)(a=u[h]||p[h])&&(c[h]=a);for(;f<i;++f)l[f]=n[f];return new U(l,this._parents)}function rr(){for(var e=this._groups,t=-1,n=e.length;++t<n;)for(var r=e[t],i=r.length-1,o=r[i],s;--i>=0;)(s=r[i])&&(o&&s.compareDocumentPosition(o)^4&&o.parentNode.insertBefore(s,o),o=s);return this}function ir(e){e||(e=Qs);function t(d,c){return d&&c?e(d.__data__,c.__data__):!d-!c}for(var n=this._groups,r=n.length,i=new Array(r),o=0;o<r;++o){for(var s=n[o],l=s.length,f=i[o]=new Array(l),u,p=0;p<l;++p)(u=s[p])&&(f[p]=u);f.sort(t)}return new U(i,this._parents).order()}function Qs(e,t){return e<t?-1:e>t?1:e>=t?0:NaN}function or(){var e=arguments[0];return arguments[0]=this,e.apply(null,arguments),this}function sr(){return Array.from(this)}function ar(){for(var e=this._groups,t=0,n=e.length;t<n;++t)for(var r=e[t],i=0,o=r.length;i<o;++i){var s=r[i];if(s)return s}return null}function lr(){let e=0;for(let t of this)++e;return e}function cr(){return!this.node()}function ur(e){for(var t=this._groups,n=0,r=t.length;n<r;++n)for(var i=t[n],o=0,s=i.length,l;o<s;++o)(l=i[o])&&e.call(l,l.__data__,o,i);return this}function ea(e){return function(){this.removeAttribute(e)}}function ta(e){return function(){this.removeAttributeNS(e.space,e.local)}}function na(e,t){return function(){this.setAttribute(e,t)}}function ra(e,t){return function(){this.setAttributeNS(e.space,e.local,t)}}function ia(e,t){return function(){var n=t.apply(this,arguments);n==null?this.removeAttribute(e):this.setAttribute(e,n)}}function oa(e,t){return function(){var n=t.apply(this,arguments);n==null?this.removeAttributeNS(e.space,e.local):this.setAttributeNS(e.space,e.local,n)}}function fr(e,t){var n=ce(e);if(arguments.length<2){var r=this.node();return n.local?r.getAttributeNS(n.space,n.local):r.getAttribute(n)}return this.each((t==null?n.local?ta:ea:typeof t=="function"?n.local?oa:ia:n.local?ra:na)(n,t))}function ot(e){return e.ownerDocument&&e.ownerDocument.defaultView||e.document&&e||e.defaultView}function sa(e){return function(){this.style.removeProperty(e)}}function aa(e,t,n){return function(){this.style.setProperty(e,t,n)}}function la(e,t,n){return function(){var r=t.apply(this,arguments);r==null?this.style.removeProperty(e):this.style.setProperty(e,r,n)}}function dr(e,t,n){return arguments.length>1?this.each((t==null?sa:typeof t=="function"?la:aa)(e,t,n??"")):pe(this.node(),e)}function pe(e,t){return e.style.getPropertyValue(t)||ot(e).getComputedStyle(e,null).getPropertyValue(t)}function ca(e){return function(){delete this[e]}}function ua(e,t){return function(){this[e]=t}}function fa(e,t){return function(){var n=t.apply(this,arguments);n==null?delete this[e]:this[e]=n}}function hr(e,t){return arguments.length>1?this.each((t==null?ca:typeof t=="function"?fa:ua)(e,t)):this.node()[e]}function pr(e){return e.trim().split(/^|\s+/)}function Bt(e){return e.classList||new mr(e)}function mr(e){this._node=e,this._names=pr(e.getAttribute("class")||"")}mr.prototype={add:function(e){var t=this._names.indexOf(e);t<0&&(this._names.push(e),this._node.setAttribute("class",this._names.join(" ")))},remove:function(e){var t=this._names.indexOf(e);t>=0&&(this._names.splice(t,1),this._node.setAttribute("class",this._names.join(" ")))},contains:function(e){return this._names.indexOf(e)>=0}};function gr(e,t){for(var n=Bt(e),r=-1,i=t.length;++r<i;)n.add(t[r])}function _r(e,t){for(var n=Bt(e),r=-1,i=t.length;++r<i;)n.remove(t[r])}function da(e){return function(){gr(this,e)}}function ha(e){return function(){_r(this,e)}}function pa(e,t){return function(){(t.apply(this,arguments)?gr:_r)(this,e)}}function yr(e,t){var n=pr(e+"");if(arguments.length<2){for(var r=Bt(this.node()),i=-1,o=n.length;++i<o;)if(!r.contains(n[i]))return!1;return!0}return this.each((typeof t=="function"?pa:t?da:ha)(n,t))}function ma(){this.textContent=""}function ga(e){return function(){this.textContent=e}}function _a(e){return function(){var t=e.apply(this,arguments);this.textContent=t??""}}function xr(e){return arguments.length?this.each(e==null?ma:(typeof e=="function"?_a:ga)(e)):this.node().textContent}function ya(){this.innerHTML=""}function xa(e){return function(){this.innerHTML=e}}function va(e){return function(){var t=e.apply(this,arguments);this.innerHTML=t??""}}function vr(e){return arguments.length?this.each(e==null?ya:(typeof e=="function"?va:xa)(e)):this.node().innerHTML}function wa(){this.nextSibling&&this.parentNode.appendChild(this)}function wr(){return this.each(wa)}function ba(){this.previousSibling&&this.parentNode.insertBefore(this,this.parentNode.firstChild)}function br(){return this.each(ba)}function Cr(e){var t=typeof e=="function"?e:Ie(e);return this.select(function(){return this.appendChild(t.apply(this,arguments))})}function Ca(){return null}function Sr(e,t){var n=typeof e=="function"?e:Ie(e),r=t==null?Ca:typeof t=="function"?t:ye(t);return this.select(function(){return this.insertBefore(n.apply(this,arguments),r.apply(this,arguments)||null)})}function Sa(){var e=this.parentNode;e&&e.removeChild(this)}function kr(){return this.each(Sa)}function ka(){var e=this.cloneNode(!1),t=this.parentNode;return t?t.insertBefore(e,this.nextSibling):e}function $a(){var e=this.cloneNode(!0),t=this.parentNode;return t?t.insertBefore(e,this.nextSibling):e}function $r(e){return this.select(e?$a:ka)}function Er(e){return arguments.length?this.property("__data__",e):this.node().__data__}function Ea(e){return function(t){e.call(this,t,this.__data__)}}function Ia(e){return e.trim().split(/^|\s+/).map(function(t){var n="",r=t.indexOf(".");return r>=0&&(n=t.slice(r+1),t=t.slice(0,r)),{type:t,name:n}})}function Ma(e){return function(){var t=this.__on;if(t){for(var n=0,r=-1,i=t.length,o;n<i;++n)o=t[n],(!e.type||o.type===e.type)&&o.name===e.name?this.removeEventListener(o.type,o.listener,o.options):t[++r]=o;++r?t.length=r:delete this.__on}}}function Aa(e,t,n){return function(){var r=this.__on,i,o=Ea(t);if(r){for(var s=0,l=r.length;s<l;++s)if((i=r[s]).type===e.type&&i.name===e.name){this.removeEventListener(i.type,i.listener,i.options),this.addEventListener(i.type,i.listener=o,i.options=n),i.value=t;return}}this.addEventListener(e.type,o,n),i={type:e.type,name:e.name,value:t,listener:o,options:n},r?r.push(i):this.__on=[i]}}function Ir(e,t,n){var r=Ia(e+""),i,o=r.length,s;if(arguments.length<2){var l=this.node().__on;if(l){for(var f=0,u=l.length,p;f<u;++f)for(i=0,p=l[f];i<o;++i)if((s=r[i]).type===p.type&&s.name===p.name)return p.value}return}for(l=t?Aa:Ma,i=0;i<o;++i)this.each(l(r[i],t,n));return this}function Mr(e,t,n){var r=ot(e),i=r.CustomEvent;typeof i=="function"?i=new i(t,n):(i=r.document.createEvent("Event"),n?(i.initEvent(t,n.bubbles,n.cancelable),i.detail=n.detail):i.initEvent(t,!1,!1)),e.dispatchEvent(i)}function Ta(e,t){return function(){return Mr(this,e,t)}}function Ra(e,t){return function(){return Mr(this,e,t.apply(this,arguments))}}function Ar(e,t){return this.each((typeof t=="function"?Ra:Ta)(e,t))}function*Tr(){for(var e=this._groups,t=0,n=e.length;t<n;++t)for(var r=e[t],i=0,o=r.length,s;i<o;++i)(s=r[i])&&(yield s)}var Vt=[null];function U(e,t){this._groups=e,this._parents=t}function Rr(){return new U([[document.documentElement]],Vt)}function Da(){return this}U.prototype=Rr.prototype={constructor:U,select:Yn,selectAll:Zn,selectChild:Gn,selectChildren:Wn,filter:Kn,data:Qn,enter:Jn,exit:er,join:tr,merge:nr,selection:Da,order:rr,sort:ir,call:or,nodes:sr,node:ar,size:lr,empty:cr,each:ur,attr:fr,style:dr,property:hr,classed:yr,text:xr,html:vr,raise:wr,lower:br,append:Cr,insert:Sr,remove:kr,clone:$r,datum:Er,on:Ir,dispatch:Ar,[Symbol.iterator]:Tr};var ue=Rr;function w(e){return typeof e=="string"?new U([[document.querySelector(e)]],[document.documentElement]):new U([[e]],Vt)}function se(e){return w(Ie(e).call(document.documentElement))}function Dr(e){let t;for(;t=e.sourceEvent;)e=t;return e}function fe(e,t){if(e=Dr(e),t===void 0&&(t=e.currentTarget),t){var n=t.ownerSVGElement||t;if(n.createSVGPoint){var r=n.createSVGPoint();return r.x=e.clientX,r.y=e.clientY,r=r.matrixTransform(t.getScreenCTM().inverse()),[r.x,r.y]}if(t.getBoundingClientRect){var i=t.getBoundingClientRect();return[e.clientX-i.left-t.clientLeft,e.clientY-i.top-t.clientTop]}}return[e.pageX,e.pageY]}var st={capture:!0,passive:!1};function at(e){e.preventDefault(),e.stopImmediatePropagation()}function Ut(e){var t=e.document.documentElement,n=w(e).on("dragstart.drag",at,st);"onselectstart"in t?n.on("selectstart.drag",at,st):(t.__noselect=t.style.MozUserSelect,t.style.MozUserSelect="none")}function Xt(e,t){var n=e.document.documentElement,r=w(e).on("dragstart.drag",null);t&&(r.on("click.drag",at,st),setTimeout(function(){r.on("click.drag",null)},0)),"onselectstart"in n?r.on("selectstart.drag",null):(n.style.MozUserSelect=n.__noselect,delete n.__noselect)}function lt(e,t,n){e.prototype=t.prototype=n,n.constructor=e}function Yt(e,t){var n=Object.create(e.prototype);for(var r in t)n[r]=t[r];return n}function Ue(){}var Be=.7,ft=1/Be,Me="\\s*([+-]?\\d+)\\s*",Ve="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)\\s*",ae="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)%\\s*",Oa=/^#([0-9a-f]{3,8})$/,Ha=new RegExp(`^rgb\\(${Me},${Me},${Me}\\)$`),La=new RegExp(`^rgb\\(${ae},${ae},${ae}\\)$`),Na=new RegExp(`^rgba\\(${Me},${Me},${Me},${Ve}\\)$`),Fa=new RegExp(`^rgba\\(${ae},${ae},${ae},${Ve}\\)$`),Pa=new RegExp(`^hsl\\(${Ve},${ae},${ae}\\)$`),za=new RegExp(`^hsla\\(${Ve},${ae},${ae},${Ve}\\)$`),Or={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};lt(Ue,me,{copy(e){return Object.assign(new this.constructor,this,e)},displayable(){return this.rgb().displayable()},hex:Hr,formatHex:Hr,formatHex8:qa,formatHsl:Ba,formatRgb:Lr,toString:Lr});function Hr(){return this.rgb().formatHex()}function qa(){return this.rgb().formatHex8()}function Ba(){return Br(this).formatHsl()}function Lr(){return this.rgb().formatRgb()}function me(e){var t,n;return e=(e+"").trim().toLowerCase(),(t=Oa.exec(e))?(n=t[1].length,t=parseInt(t[1],16),n===6?Nr(t):n===3?new ee(t>>8&15|t>>4&240,t>>4&15|t&240,(t&15)<<4|t&15,1):n===8?ct(t>>24&255,t>>16&255,t>>8&255,(t&255)/255):n===4?ct(t>>12&15|t>>8&240,t>>8&15|t>>4&240,t>>4&15|t&240,((t&15)<<4|t&15)/255):null):(t=Ha.exec(e))?new ee(t[1],t[2],t[3],1):(t=La.exec(e))?new ee(t[1]*255/100,t[2]*255/100,t[3]*255/100,1):(t=Na.exec(e))?ct(t[1],t[2],t[3],t[4]):(t=Fa.exec(e))?ct(t[1]*255/100,t[2]*255/100,t[3]*255/100,t[4]):(t=Pa.exec(e))?zr(t[1],t[2]/100,t[3]/100,1):(t=za.exec(e))?zr(t[1],t[2]/100,t[3]/100,t[4]):Or.hasOwnProperty(e)?Nr(Or[e]):e==="transparent"?new ee(NaN,NaN,NaN,0):null}function Nr(e){return new ee(e>>16&255,e>>8&255,e&255,1)}function ct(e,t,n,r){return r<=0&&(e=t=n=NaN),new ee(e,t,n,r)}function Va(e){return e instanceof Ue||(e=me(e)),e?(e=e.rgb(),new ee(e.r,e.g,e.b,e.opacity)):new ee}function Ae(e,t,n,r){return arguments.length===1?Va(e):new ee(e,t,n,r??1)}function ee(e,t,n,r){this.r=+e,this.g=+t,this.b=+n,this.opacity=+r}lt(ee,Ae,Yt(Ue,{brighter(e){return e=e==null?ft:Math.pow(ft,e),new ee(this.r*e,this.g*e,this.b*e,this.opacity)},darker(e){return e=e==null?Be:Math.pow(Be,e),new ee(this.r*e,this.g*e,this.b*e,this.opacity)},rgb(){return this},clamp(){return new ee(ve(this.r),ve(this.g),ve(this.b),dt(this.opacity))},displayable(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:Fr,formatHex:Fr,formatHex8:Ua,formatRgb:Pr,toString:Pr}));function Fr(){return`#${xe(this.r)}${xe(this.g)}${xe(this.b)}`}function Ua(){return`#${xe(this.r)}${xe(this.g)}${xe(this.b)}${xe((isNaN(this.opacity)?1:this.opacity)*255)}`}function Pr(){let e=dt(this.opacity);return`${e===1?"rgb(":"rgba("}${ve(this.r)}, ${ve(this.g)}, ${ve(this.b)}${e===1?")":`, ${e})`}`}function dt(e){return isNaN(e)?1:Math.max(0,Math.min(1,e))}function ve(e){return Math.max(0,Math.min(255,Math.round(e)||0))}function xe(e){return e=ve(e),(e<16?"0":"")+e.toString(16)}function zr(e,t,n,r){return r<=0?e=t=n=NaN:n<=0||n>=1?e=t=NaN:t<=0&&(e=NaN),new ie(e,t,n,r)}function Br(e){if(e instanceof ie)return new ie(e.h,e.s,e.l,e.opacity);if(e instanceof Ue||(e=me(e)),!e)return new ie;if(e instanceof ie)return e;e=e.rgb();var t=e.r/255,n=e.g/255,r=e.b/255,i=Math.min(t,n,r),o=Math.max(t,n,r),s=NaN,l=o-i,f=(o+i)/2;return l?(t===o?s=(n-r)/l+(n<r)*6:n===o?s=(r-t)/l+2:s=(t-n)/l+4,l/=f<.5?o+i:2-o-i,s*=60):l=f>0&&f<1?0:s,new ie(s,l,f,e.opacity)}function Vr(e,t,n,r){return arguments.length===1?Br(e):new ie(e,t,n,r??1)}function ie(e,t,n,r){this.h=+e,this.s=+t,this.l=+n,this.opacity=+r}lt(ie,Vr,Yt(Ue,{brighter(e){return e=e==null?ft:Math.pow(ft,e),new ie(this.h,this.s,this.l*e,this.opacity)},darker(e){return e=e==null?Be:Math.pow(Be,e),new ie(this.h,this.s,this.l*e,this.opacity)},rgb(){var e=this.h%360+(this.h<0)*360,t=isNaN(e)||isNaN(this.s)?0:this.s,n=this.l,r=n+(n<.5?n:1-n)*t,i=2*n-r;return new ee(Zt(e>=240?e-240:e+120,i,r),Zt(e,i,r),Zt(e<120?e+240:e-120,i,r),this.opacity)},clamp(){return new ie(qr(this.h),ut(this.s),ut(this.l),dt(this.opacity))},displayable(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl(){let e=dt(this.opacity);return`${e===1?"hsl(":"hsla("}${qr(this.h)}, ${ut(this.s)*100}%, ${ut(this.l)*100}%${e===1?")":`, ${e})`}`}}));function qr(e){return e=(e||0)%360,e<0?e+360:e}function ut(e){return Math.max(0,Math.min(1,e||0))}function Zt(e,t,n){return(e<60?t+(n-t)*e/60:e<180?n:e<240?t+(n-t)*(240-e)/60:t)*255}function Gt(e,t,n,r,i){var o=e*e,s=o*e;return((1-3*e+3*o-s)*t+(4-6*o+3*s)*n+(1+3*e+3*o-3*s)*r+s*i)/6}function Ur(e){var t=e.length-1;return function(n){var r=n<=0?n=0:n>=1?(n=1,t-1):Math.floor(n*t),i=e[r],o=e[r+1],s=r>0?e[r-1]:2*i-o,l=r<t-1?e[r+2]:2*o-i;return Gt((n-r/t)*t,s,i,o,l)}}function Xr(e){var t=e.length;return function(n){var r=Math.floor(((n%=1)<0?++n:n)*t),i=e[(r+t-1)%t],o=e[r%t],s=e[(r+1)%t],l=e[(r+2)%t];return Gt((n-r/t)*t,i,o,s,l)}}var Wt=e=>()=>e;function Xa(e,t){return function(n){return e+n*t}}function Ya(e,t,n){return e=Math.pow(e,n),t=Math.pow(t,n)-e,n=1/n,function(r){return Math.pow(e+r*t,n)}}function Yr(e){return(e=+e)==1?ht:function(t,n){return n-t?Ya(t,n,e):Wt(isNaN(t)?n:t)}}function ht(e,t){var n=t-e;return n?Xa(e,n):Wt(isNaN(e)?t:e)}var pt=function e(t){var n=Yr(t);function r(i,o){var s=n((i=Ae(i)).r,(o=Ae(o)).r),l=n(i.g,o.g),f=n(i.b,o.b),u=ht(i.opacity,o.opacity);return function(p){return i.r=s(p),i.g=l(p),i.b=f(p),i.opacity=u(p),i+""}}return r.gamma=e,r}(1);function Zr(e){return function(t){var n=t.length,r=new Array(n),i=new Array(n),o=new Array(n),s,l;for(s=0;s<n;++s)l=Ae(t[s]),r[s]=l.r||0,i[s]=l.g||0,o[s]=l.b||0;return r=e(r),i=e(i),o=e(o),l.opacity=1,function(f){return l.r=r(f),l.g=i(f),l.b=o(f),l+""}}}var Za=Zr(Ur),Ga=Zr(Xr);function ne(e,t){return e=+e,t=+t,function(n){return e*(1-n)+t*n}}var Jt=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,Kt=new RegExp(Jt.source,"g");function Wa(e){return function(){return e}}function Ka(e){return function(t){return e(t)+""}}function jt(e,t){var n=Jt.lastIndex=Kt.lastIndex=0,r,i,o,s=-1,l=[],f=[];for(e=e+"",t=t+"";(r=Jt.exec(e))&&(i=Kt.exec(t));)(o=i.index)>n&&(o=t.slice(n,o),l[s]?l[s]+=o:l[++s]=o),(r=r[0])===(i=i[0])?l[s]?l[s]+=i:l[++s]=i:(l[++s]=null,f.push({i:s,x:ne(r,i)})),n=Kt.lastIndex;return n<t.length&&(o=t.slice(n),l[s]?l[s]+=o:l[++s]=o),l.length<2?f[0]?Ka(f[0].x):Wa(t):(t=f.length,function(u){for(var p=0,d;p<t;++p)l[(d=f[p]).i]=d.x(u);return l.join("")})}var Gr=180/Math.PI,mt={translateX:0,translateY:0,rotate:0,skewX:0,scaleX:1,scaleY:1};function Qt(e,t,n,r,i,o){var s,l,f;return(s=Math.sqrt(e*e+t*t))&&(e/=s,t/=s),(f=e*n+t*r)&&(n-=e*f,r-=t*f),(l=Math.sqrt(n*n+r*r))&&(n/=l,r/=l,f/=l),e*r<t*n&&(e=-e,t=-t,f=-f,s=-s),{translateX:i,translateY:o,rotate:Math.atan2(t,e)*Gr,skewX:Math.atan(f)*Gr,scaleX:s,scaleY:l}}var gt;function Wr(e){let t=new(typeof DOMMatrix=="function"?DOMMatrix:WebKitCSSMatrix)(e+"");return t.isIdentity?mt:Qt(t.a,t.b,t.c,t.d,t.e,t.f)}function Kr(e){return e==null?mt:(gt||(gt=document.createElementNS("http://www.w3.org/2000/svg","g")),gt.setAttribute("transform",e),(e=gt.transform.baseVal.consolidate())?(e=e.matrix,Qt(e.a,e.b,e.c,e.d,e.e,e.f)):mt)}function Jr(e,t,n,r){function i(u){return u.length?u.pop()+" ":""}function o(u,p,d,c,a,h){if(u!==d||p!==c){var m=a.push("translate(",null,t,null,n);h.push({i:m-4,x:ne(u,d)},{i:m-2,x:ne(p,c)})}else(d||c)&&a.push("translate("+d+t+c+n)}function s(u,p,d,c){u!==p?(u-p>180?p+=360:p-u>180&&(u+=360),c.push({i:d.push(i(d)+"rotate(",null,r)-2,x:ne(u,p)})):p&&d.push(i(d)+"rotate("+p+r)}function l(u,p,d,c){u!==p?c.push({i:d.push(i(d)+"skewX(",null,r)-2,x:ne(u,p)}):p&&d.push(i(d)+"skewX("+p+r)}function f(u,p,d,c,a,h){if(u!==d||p!==c){var m=a.push(i(a)+"scale(",null,",",null,")");h.push({i:m-4,x:ne(u,d)},{i:m-2,x:ne(p,c)})}else(d!==1||c!==1)&&a.push(i(a)+"scale("+d+","+c+")")}return function(u,p){var d=[],c=[];return u=e(u),p=e(p),o(u.translateX,u.translateY,p.translateX,p.translateY,d,c),s(u.rotate,p.rotate,d,c),l(u.skewX,p.skewX,d,c),f(u.scaleX,u.scaleY,p.scaleX,p.scaleY,d,c),u=p=null,function(a){for(var h=-1,m=c.length,g;++h<m;)d[(g=c[h]).i]=g.x(a);return d.join("")}}}var en=Jr(Wr,"px, ","px)","deg)"),tn=Jr(Kr,", ",")",")");var Ja=1e-12;function jr(e){return((e=Math.exp(e))+1/e)/2}function ja(e){return((e=Math.exp(e))-1/e)/2}function Qa(e){return((e=Math.exp(2*e))-1)/(e+1)}var nn=function e(t,n,r){function i(o,s){var l=o[0],f=o[1],u=o[2],p=s[0],d=s[1],c=s[2],a=p-l,h=d-f,m=a*a+h*h,g,y;if(m<Ja)y=Math.log(c/u)/t,g=function(T){return[l+T*a,f+T*h,u*Math.exp(t*T*y)]};else{var x=Math.sqrt(m),_=(c*c-u*u+r*m)/(2*u*n*x),S=(c*c-u*u-r*m)/(2*c*n*x),O=Math.log(Math.sqrt(_*_+1)-_),L=Math.log(Math.sqrt(S*S+1)-S);y=(L-O)/t,g=function(T){var D=T*y,q=jr(O),N=u/(n*x)*(q*Qa(t*D+O)-ja(O));return[l+N*a,f+N*h,u*q/jr(t*D+O)]}}return g.duration=y*1e3*t/Math.SQRT2,g}return i.rho=function(o){var s=Math.max(.001,+o),l=s*s,f=l*l;return e(s,l,f)},i}(Math.SQRT2,2,4);var Te=0,Ye=0,Xe=0,ei=1e3,_t,Ze,yt=0,we=0,xt=0,Ge=typeof performance=="object"&&performance.now?performance:Date,ti=typeof window=="object"&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):function(e){setTimeout(e,17)};function Ke(){return we||(ti(el),we=Ge.now()+xt)}function el(){we=0}function We(){this._call=this._time=this._next=null}We.prototype=vt.prototype={constructor:We,restart:function(e,t,n){if(typeof e!="function")throw new TypeError("callback is not a function");n=(n==null?Ke():+n)+(t==null?0:+t),!this._next&&Ze!==this&&(Ze?Ze._next=this:_t=this,Ze=this),this._call=e,this._time=n,rn()},stop:function(){this._call&&(this._call=null,this._time=1/0,rn())}};function vt(e,t,n){var r=new We;return r.restart(e,t,n),r}function ni(){Ke(),++Te;for(var e=_t,t;e;)(t=we-e._time)>=0&&e._call.call(void 0,t),e=e._next;--Te}function Qr(){we=(yt=Ge.now())+xt,Te=Ye=0;try{ni()}finally{Te=0,nl(),we=0}}function tl(){var e=Ge.now(),t=e-yt;t>ei&&(xt-=t,yt=e)}function nl(){for(var e,t=_t,n,r=1/0;t;)t._call?(r>t._time&&(r=t._time),e=t,t=t._next):(n=t._next,t._next=null,t=e?e._next=n:_t=n);Ze=e,rn(r)}function rn(e){if(!Te){Ye&&(Ye=clearTimeout(Ye));var t=e-we;t>24?(e<1/0&&(Ye=setTimeout(Qr,e-Ge.now()-xt)),Xe&&(Xe=clearInterval(Xe))):(Xe||(yt=Ge.now(),Xe=setInterval(tl,ei)),Te=1,ti(Qr))}}function wt(e,t,n){var r=new We;return t=t==null?0:+t,r.restart(i=>{r.stop(),e(i+t)},t,n),r}var rl=Fe("start","end","cancel","interrupt"),il=[],oi=0,ri=1,Ct=2,bt=3,ii=4,St=5,Je=6;function ge(e,t,n,r,i,o){var s=e.__transition;if(!s)e.__transition={};else if(n in s)return;ol(e,n,{name:t,index:r,group:i,on:rl,tween:il,time:o.time,delay:o.delay,duration:o.duration,ease:o.ease,timer:null,state:oi})}function je(e,t){var n=Y(e,t);if(n.state>oi)throw new Error("too late; already scheduled");return n}function W(e,t){var n=Y(e,t);if(n.state>bt)throw new Error("too late; already running");return n}function Y(e,t){var n=e.__transition;if(!n||!(n=n[t]))throw new Error("transition not found");return n}function ol(e,t,n){var r=e.__transition,i;r[t]=n,n.timer=vt(o,0,n.time);function o(u){n.state=ri,n.timer.restart(s,n.delay,n.time),n.delay<=u&&s(u-n.delay)}function s(u){var p,d,c,a;if(n.state!==ri)return f();for(p in r)if(a=r[p],a.name===n.name){if(a.state===bt)return wt(s);a.state===ii?(a.state=Je,a.timer.stop(),a.on.call("interrupt",e,e.__data__,a.index,a.group),delete r[p]):+p<t&&(a.state=Je,a.timer.stop(),a.on.call("cancel",e,e.__data__,a.index,a.group),delete r[p])}if(wt(function(){n.state===bt&&(n.state=ii,n.timer.restart(l,n.delay,n.time),l(u))}),n.state=Ct,n.on.call("start",e,e.__data__,n.index,n.group),n.state===Ct){for(n.state=bt,i=new Array(c=n.tween.length),p=0,d=-1;p<c;++p)(a=n.tween[p].value.call(e,e.__data__,n.index,n.group))&&(i[++d]=a);i.length=d+1}}function l(u){for(var p=u<n.duration?n.ease.call(null,u/n.duration):(n.timer.restart(f),n.state=St,1),d=-1,c=i.length;++d<c;)i[d].call(e,p);n.state===St&&(n.on.call("end",e,e.__data__,n.index,n.group),f())}function f(){n.state=Je,n.timer.stop(),delete r[t];for(var u in r)return;delete e.__transition}}function _e(e,t){var n=e.__transition,r,i,o=!0,s;if(n){t=t==null?null:t+"";for(s in n){if((r=n[s]).name!==t){o=!1;continue}i=r.state>Ct&&r.state<St,r.state=Je,r.timer.stop(),r.on.call(i?"interrupt":"cancel",e,e.__data__,r.index,r.group),delete n[s]}o&&delete e.__transition}}function si(e){return this.each(function(){_e(this,e)})}function sl(e,t){var n,r;return function(){var i=W(this,e),o=i.tween;if(o!==n){r=n=o;for(var s=0,l=r.length;s<l;++s)if(r[s].name===t){r=r.slice(),r.splice(s,1);break}}i.tween=r}}function al(e,t,n){var r,i;if(typeof n!="function")throw new Error;return function(){var o=W(this,e),s=o.tween;if(s!==r){i=(r=s).slice();for(var l={name:t,value:n},f=0,u=i.length;f<u;++f)if(i[f].name===t){i[f]=l;break}f===u&&i.push(l)}o.tween=i}}function ai(e,t){var n=this._id;if(e+="",arguments.length<2){for(var r=Y(this.node(),n).tween,i=0,o=r.length,s;i<o;++i)if((s=r[i]).name===e)return s.value;return null}return this.each((t==null?sl:al)(n,e,t))}function Re(e,t,n){var r=e._id;return e.each(function(){var i=W(this,r);(i.value||(i.value={}))[t]=n.apply(this,arguments)}),function(i){return Y(i,r).value[t]}}function kt(e,t){var n;return(typeof t=="number"?ne:t instanceof me?pt:(n=me(t))?(t=n,pt):jt)(e,t)}function ll(e){return function(){this.removeAttribute(e)}}function cl(e){return function(){this.removeAttributeNS(e.space,e.local)}}function ul(e,t,n){var r,i=n+"",o;return function(){var s=this.getAttribute(e);return s===i?null:s===r?o:o=t(r=s,n)}}function fl(e,t,n){var r,i=n+"",o;return function(){var s=this.getAttributeNS(e.space,e.local);return s===i?null:s===r?o:o=t(r=s,n)}}function dl(e,t,n){var r,i,o;return function(){var s,l=n(this),f;return l==null?void this.removeAttribute(e):(s=this.getAttribute(e),f=l+"",s===f?null:s===r&&f===i?o:(i=f,o=t(r=s,l)))}}function hl(e,t,n){var r,i,o;return function(){var s,l=n(this),f;return l==null?void this.removeAttributeNS(e.space,e.local):(s=this.getAttributeNS(e.space,e.local),f=l+"",s===f?null:s===r&&f===i?o:(i=f,o=t(r=s,l)))}}function li(e,t){var n=ce(e),r=n==="transform"?tn:kt;return this.attrTween(e,typeof t=="function"?(n.local?hl:dl)(n,r,Re(this,"attr."+e,t)):t==null?(n.local?cl:ll)(n):(n.local?fl:ul)(n,r,t))}function pl(e,t){return function(n){this.setAttribute(e,t.call(this,n))}}function ml(e,t){return function(n){this.setAttributeNS(e.space,e.local,t.call(this,n))}}function gl(e,t){var n,r;function i(){var o=t.apply(this,arguments);return o!==r&&(n=(r=o)&&ml(e,o)),n}return i._value=t,i}function _l(e,t){var n,r;function i(){var o=t.apply(this,arguments);return o!==r&&(n=(r=o)&&pl(e,o)),n}return i._value=t,i}function ci(e,t){var n="attr."+e;if(arguments.length<2)return(n=this.tween(n))&&n._value;if(t==null)return this.tween(n,null);if(typeof t!="function")throw new Error;var r=ce(e);return this.tween(n,(r.local?gl:_l)(r,t))}function yl(e,t){return function(){je(this,e).delay=+t.apply(this,arguments)}}function xl(e,t){return t=+t,function(){je(this,e).delay=t}}function ui(e){var t=this._id;return arguments.length?this.each((typeof e=="function"?yl:xl)(t,e)):Y(this.node(),t).delay}function vl(e,t){return function(){W(this,e).duration=+t.apply(this,arguments)}}function wl(e,t){return t=+t,function(){W(this,e).duration=t}}function fi(e){var t=this._id;return arguments.length?this.each((typeof e=="function"?vl:wl)(t,e)):Y(this.node(),t).duration}function bl(e,t){if(typeof t!="function")throw new Error;return function(){W(this,e).ease=t}}function di(e){var t=this._id;return arguments.length?this.each(bl(t,e)):Y(this.node(),t).ease}function Cl(e,t){return function(){var n=t.apply(this,arguments);if(typeof n!="function")throw new Error;W(this,e).ease=n}}function hi(e){if(typeof e!="function")throw new Error;return this.each(Cl(this._id,e))}function pi(e){typeof e!="function"&&(e=ze(e));for(var t=this._groups,n=t.length,r=new Array(n),i=0;i<n;++i)for(var o=t[i],s=o.length,l=r[i]=[],f,u=0;u<s;++u)(f=o[u])&&e.call(f,f.__data__,u,o)&&l.push(f);return new J(r,this._parents,this._name,this._id)}function mi(e){if(e._id!==this._id)throw new Error;for(var t=this._groups,n=e._groups,r=t.length,i=n.length,o=Math.min(r,i),s=new Array(r),l=0;l<o;++l)for(var f=t[l],u=n[l],p=f.length,d=s[l]=new Array(p),c,a=0;a<p;++a)(c=f[a]||u[a])&&(d[a]=c);for(;l<r;++l)s[l]=t[l];return new J(s,this._parents,this._name,this._id)}function Sl(e){return(e+"").trim().split(/^|\s+/).every(function(t){var n=t.indexOf(".");return n>=0&&(t=t.slice(0,n)),!t||t==="start"})}function kl(e,t,n){var r,i,o=Sl(t)?je:W;return function(){var s=o(this,e),l=s.on;l!==r&&(i=(r=l).copy()).on(t,n),s.on=i}}function gi(e,t){var n=this._id;return arguments.length<2?Y(this.node(),n).on.on(e):this.each(kl(n,e,t))}function $l(e){return function(){var t=this.parentNode;for(var n in this.__transition)if(+n!==e)return;t&&t.removeChild(this)}}function _i(){return this.on("end.remove",$l(this._id))}function yi(e){var t=this._name,n=this._id;typeof e!="function"&&(e=ye(e));for(var r=this._groups,i=r.length,o=new Array(i),s=0;s<i;++s)for(var l=r[s],f=l.length,u=o[s]=new Array(f),p,d,c=0;c<f;++c)(p=l[c])&&(d=e.call(p,p.__data__,c,l))&&("__data__"in p&&(d.__data__=p.__data__),u[c]=d,ge(u[c],t,n,c,u,Y(p,n)));return new J(o,this._parents,t,n)}function xi(e){var t=this._name,n=this._id;typeof e!="function"&&(e=Pe(e));for(var r=this._groups,i=r.length,o=[],s=[],l=0;l<i;++l)for(var f=r[l],u=f.length,p,d=0;d<u;++d)if(p=f[d]){for(var c=e.call(p,p.__data__,d,f),a,h=Y(p,n),m=0,g=c.length;m<g;++m)(a=c[m])&&ge(a,t,n,m,c,h);o.push(c),s.push(p)}return new J(o,s,t,n)}var El=ue.prototype.constructor;function vi(){return new El(this._groups,this._parents)}function Il(e,t){var n,r,i;return function(){var o=pe(this,e),s=(this.style.removeProperty(e),pe(this,e));return o===s?null:o===n&&s===r?i:i=t(n=o,r=s)}}function wi(e){return function(){this.style.removeProperty(e)}}function Ml(e,t,n){var r,i=n+"",o;return function(){var s=pe(this,e);return s===i?null:s===r?o:o=t(r=s,n)}}function Al(e,t,n){var r,i,o;return function(){var s=pe(this,e),l=n(this),f=l+"";return l==null&&(f=l=(this.style.removeProperty(e),pe(this,e))),s===f?null:s===r&&f===i?o:(i=f,o=t(r=s,l))}}function Tl(e,t){var n,r,i,o="style."+t,s="end."+o,l;return function(){var f=W(this,e),u=f.on,p=f.value[o]==null?l||(l=wi(t)):void 0;(u!==n||i!==p)&&(r=(n=u).copy()).on(s,i=p),f.on=r}}function bi(e,t,n){var r=(e+="")=="transform"?en:kt;return t==null?this.styleTween(e,Il(e,r)).on("end.style."+e,wi(e)):typeof t=="function"?this.styleTween(e,Al(e,r,Re(this,"style."+e,t))).each(Tl(this._id,e)):this.styleTween(e,Ml(e,r,t),n).on("end.style."+e,null)}function Rl(e,t,n){return function(r){this.style.setProperty(e,t.call(this,r),n)}}function Dl(e,t,n){var r,i;function o(){var s=t.apply(this,arguments);return s!==i&&(r=(i=s)&&Rl(e,s,n)),r}return o._value=t,o}function Ci(e,t,n){var r="style."+(e+="");if(arguments.length<2)return(r=this.tween(r))&&r._value;if(t==null)return this.tween(r,null);if(typeof t!="function")throw new Error;return this.tween(r,Dl(e,t,n??""))}function Ol(e){return function(){this.textContent=e}}function Hl(e){return function(){var t=e(this);this.textContent=t??""}}function Si(e){return this.tween("text",typeof e=="function"?Hl(Re(this,"text",e)):Ol(e==null?"":e+""))}function Ll(e){return function(t){this.textContent=e.call(this,t)}}function Nl(e){var t,n;function r(){var i=e.apply(this,arguments);return i!==n&&(t=(n=i)&&Ll(i)),t}return r._value=e,r}function ki(e){var t="text";if(arguments.length<1)return(t=this.tween(t))&&t._value;if(e==null)return this.tween(t,null);if(typeof e!="function")throw new Error;return this.tween(t,Nl(e))}function $i(){for(var e=this._name,t=this._id,n=$t(),r=this._groups,i=r.length,o=0;o<i;++o)for(var s=r[o],l=s.length,f,u=0;u<l;++u)if(f=s[u]){var p=Y(f,t);ge(f,e,n,u,s,{time:p.time+p.delay+p.duration,delay:0,duration:p.duration,ease:p.ease})}return new J(r,this._parents,e,n)}function Ei(){var e,t,n=this,r=n._id,i=n.size();return new Promise(function(o,s){var l={value:s},f={value:function(){--i===0&&o()}};n.each(function(){var u=W(this,r),p=u.on;p!==e&&(t=(e=p).copy(),t._.cancel.push(l),t._.interrupt.push(l),t._.end.push(f)),u.on=t}),i===0&&o()})}var Fl=0;function J(e,t,n,r){this._groups=e,this._parents=t,this._name=n,this._id=r}function Ii(e){return ue().transition(e)}function $t(){return++Fl}var de=ue.prototype;J.prototype=Ii.prototype={constructor:J,select:yi,selectAll:xi,selectChild:de.selectChild,selectChildren:de.selectChildren,filter:pi,merge:mi,selection:vi,transition:$i,call:de.call,nodes:de.nodes,node:de.node,size:de.size,empty:de.empty,each:de.each,on:gi,attr:li,attrTween:ci,style:bi,styleTween:Ci,text:Si,textTween:ki,remove:_i,tween:ai,delay:ui,duration:fi,ease:di,easeVarying:hi,end:Ei,[Symbol.iterator]:de[Symbol.iterator]};function Et(e){return((e*=2)<=1?e*e*e:(e-=2)*e*e+2)/2}var Pl={time:null,delay:0,duration:250,ease:Et};function zl(e,t){for(var n;!(n=e.__transition)||!(n=n[t]);)if(!(e=e.parentNode))throw new Error(`transition ${t} not found`);return n}function Mi(e){var t,n;e instanceof J?(t=e._id,e=e._name):(t=$t(),(n=Pl).time=Ke(),e=e==null?null:e+"");for(var r=this._groups,i=r.length,o=0;o<i;++o)for(var s=r[o],l=s.length,f,u=0;u<l;++u)(f=s[u])&&ge(f,e,t,u,s,n||zl(f,t));return new J(r,this._parents,e,t)}ue.prototype.interrupt=si;ue.prototype.transition=Mi;var{abs:Om,max:Hm,min:Lm}=Math;function Ai(e){return[+e[0],+e[1]]}function ql(e){return[Ai(e[0]),Ai(e[1])]}var Nm={name:"x",handles:["w","e"].map(on),input:function(e,t){return e==null?null:[[+e[0],t[0][1]],[+e[1],t[1][1]]]},output:function(e){return e&&[e[0][0],e[1][0]]}},Fm={name:"y",handles:["n","s"].map(on),input:function(e,t){return e==null?null:[[t[0][0],+e[0]],[t[1][0],+e[1]]]},output:function(e){return e&&[e[0][1],e[1][1]]}},Pm={name:"xy",handles:["n","w","e","s","nw","ne","sw","se"].map(on),input:function(e){return e==null?null:ql(e)},output:function(e){return e}};function on(e){return{type:e}}var sn=Math.PI,an=2*sn,be=1e-6,Bl=an-be;function Ti(e){this._+=e[0];for(let t=1,n=e.length;t<n;++t)this._+=arguments[t]+e[t]}function Vl(e){let t=Math.floor(e);if(!(t>=0))throw new Error(`invalid digits: ${e}`);if(t>15)return Ti;let n=10**t;return function(r){this._+=r[0];for(let i=1,o=r.length;i<o;++i)this._+=Math.round(arguments[i]*n)/n+r[i]}}var Ce=class{constructor(t){this._x0=this._y0=this._x1=this._y1=null,this._="",this._append=t==null?Ti:Vl(t)}moveTo(t,n){this._append`M${this._x0=this._x1=+t},${this._y0=this._y1=+n}`}closePath(){this._x1!==null&&(this._x1=this._x0,this._y1=this._y0,this._append`Z`)}lineTo(t,n){this._append`L${this._x1=+t},${this._y1=+n}`}quadraticCurveTo(t,n,r,i){this._append`Q${+t},${+n},${this._x1=+r},${this._y1=+i}`}bezierCurveTo(t,n,r,i,o,s){this._append`C${+t},${+n},${+r},${+i},${this._x1=+o},${this._y1=+s}`}arcTo(t,n,r,i,o){if(t=+t,n=+n,r=+r,i=+i,o=+o,o<0)throw new Error(`negative radius: ${o}`);let s=this._x1,l=this._y1,f=r-t,u=i-n,p=s-t,d=l-n,c=p*p+d*d;if(this._x1===null)this._append`M${this._x1=t},${this._y1=n}`;else if(c>be)if(!(Math.abs(d*f-u*p)>be)||!o)this._append`L${this._x1=t},${this._y1=n}`;else{let a=r-s,h=i-l,m=f*f+u*u,g=a*a+h*h,y=Math.sqrt(m),x=Math.sqrt(c),_=o*Math.tan((sn-Math.acos((m+c-g)/(2*y*x)))/2),S=_/x,O=_/y;Math.abs(S-1)>be&&this._append`L${t+S*p},${n+S*d}`,this._append`A${o},${o},0,0,${+(d*a>p*h)},${this._x1=t+O*f},${this._y1=n+O*u}`}}arc(t,n,r,i,o,s){if(t=+t,n=+n,r=+r,s=!!s,r<0)throw new Error(`negative radius: ${r}`);let l=r*Math.cos(i),f=r*Math.sin(i),u=t+l,p=n+f,d=1^s,c=s?i-o:o-i;this._x1===null?this._append`M${u},${p}`:(Math.abs(this._x1-u)>be||Math.abs(this._y1-p)>be)&&this._append`L${u},${p}`,r&&(c<0&&(c=c%an+an),c>Bl?this._append`A${r},${r},0,1,${d},${t-l},${n-f}A${r},${r},0,1,${d},${this._x1=u},${this._y1=p}`:c>be&&this._append`A${r},${r},0,${+(c>=sn)},${d},${this._x1=t+r*Math.cos(o)},${this._y1=n+r*Math.sin(o)}`)}rect(t,n,r,i){this._append`M${this._x0=this._x1=+t},${this._y0=this._y1=+n}h${r=+r}v${+i}h${-r}Z`}toString(){return this._}};function Ri(){return new Ce}Ri.prototype=Ce.prototype;function Ul(e){var t=0,n=e.children,r=n&&n.length;if(!r)t=1;else for(;--r>=0;)t+=n[r].value;e.value=t}function Di(){return this.eachAfter(Ul)}function Oi(e,t){let n=-1;for(let r of this)e.call(t,r,++n,this);return this}function Hi(e,t){for(var n=this,r=[n],i,o,s=-1;n=r.pop();)if(e.call(t,n,++s,this),i=n.children)for(o=i.length-1;o>=0;--o)r.push(i[o]);return this}function Li(e,t){for(var n=this,r=[n],i=[],o,s,l,f=-1;n=r.pop();)if(i.push(n),o=n.children)for(s=0,l=o.length;s<l;++s)r.push(o[s]);for(;n=i.pop();)e.call(t,n,++f,this);return this}function Ni(e,t){let n=-1;for(let r of this)if(e.call(t,r,++n,this))return r}function Fi(e){return this.eachAfter(function(t){for(var n=+e(t.data)||0,r=t.children,i=r&&r.length;--i>=0;)n+=r[i].value;t.value=n})}function Pi(e){return this.eachBefore(function(t){t.children&&t.children.sort(e)})}function zi(e){for(var t=this,n=Xl(t,e),r=[t];t!==n;)t=t.parent,r.push(t);for(var i=r.length;e!==n;)r.splice(i,0,e),e=e.parent;return r}function Xl(e,t){if(e===t)return e;var n=e.ancestors(),r=t.ancestors(),i=null;for(e=n.pop(),t=r.pop();e===t;)i=e,e=n.pop(),t=r.pop();return i}function qi(){for(var e=this,t=[e];e=e.parent;)t.push(e);return t}function Bi(){return Array.from(this)}function Vi(){var e=[];return this.eachBefore(function(t){t.children||e.push(t)}),e}function Ui(){var e=this,t=[];return e.each(function(n){n!==e&&t.push({source:n.parent,target:n})}),t}function*Xi(){var e=this,t,n=[e],r,i,o;do for(t=n.reverse(),n=[];e=t.pop();)if(yield e,r=e.children)for(i=0,o=r.length;i<o;++i)n.push(r[i]);while(n.length)}function he(e,t){e instanceof Map?(e=[void 0,e],t===void 0&&(t=Gl)):t===void 0&&(t=Zl);for(var n=new Se(e),r,i=[n],o,s,l,f;r=i.pop();)if((s=t(r.data))&&(f=(s=Array.from(s)).length))for(r.children=s,l=f-1;l>=0;--l)i.push(o=s[l]=new Se(s[l])),o.parent=r,o.depth=r.depth+1;return n.eachBefore(Kl)}function Yl(){return he(this).eachBefore(Wl)}function Zl(e){return e.children}function Gl(e){return Array.isArray(e)?e[1]:null}function Wl(e){e.data.value!==void 0&&(e.value=e.data.value),e.data=e.data.data}function Kl(e){var t=0;do e.height=t;while((e=e.parent)&&e.height<++t)}function Se(e){this.data=e,this.depth=this.height=0,this.parent=null}Se.prototype=he.prototype={constructor:Se,count:Di,each:Oi,eachAfter:Li,eachBefore:Hi,find:Ni,sum:Fi,sort:Pi,path:zi,ancestors:qi,descendants:Bi,leaves:Vi,links:Ui,copy:Yl,[Symbol.iterator]:Xi};function Jl(e,t){return e.parent===t.parent?1:2}function ln(e){var t=e.children;return t?t[0]:e.t}function cn(e){var t=e.children;return t?t[t.length-1]:e.t}function jl(e,t,n){var r=n/(t.i-e.i);t.c-=r,t.s+=n,e.c+=r,t.z+=n,t.m+=n}function Ql(e){for(var t=0,n=0,r=e.children,i=r.length,o;--i>=0;)o=r[i],o.z+=t,o.m+=t,t+=o.s+(n+=o.c)}function ec(e,t,n){return e.a.parent===t.parent?e.a:n}function It(e,t){this._=e,this.parent=null,this.children=null,this.A=null,this.a=this,this.z=0,this.m=0,this.c=0,this.s=0,this.t=null,this.i=t}It.prototype=Object.create(Se.prototype);function tc(e){for(var t=new It(e,0),n,r=[t],i,o,s,l;n=r.pop();)if(o=n._.children)for(n.children=new Array(l=o.length),s=l-1;s>=0;--s)r.push(i=n.children[s]=new It(o[s],s)),i.parent=n;return(t.parent=new It(null,0)).children=[t],t}function un(){var e=Jl,t=1,n=1,r=null;function i(u){var p=tc(u);if(p.eachAfter(o),p.parent.m=-p.z,p.eachBefore(s),r)u.eachBefore(f);else{var d=u,c=u,a=u;u.eachBefore(function(x){x.x<d.x&&(d=x),x.x>c.x&&(c=x),x.depth>a.depth&&(a=x)});var h=d===c?1:e(d,c)/2,m=h-d.x,g=t/(c.x+h+m),y=n/(a.depth||1);u.eachBefore(function(x){x.x=(x.x+m)*g,x.y=x.depth*y})}return u}function o(u){var p=u.children,d=u.parent.children,c=u.i?d[u.i-1]:null;if(p){Ql(u);var a=(p[0].z+p[p.length-1].z)/2;c?(u.z=c.z+e(u._,c._),u.m=u.z-a):u.z=a}else c&&(u.z=c.z+e(u._,c._));u.parent.A=l(u,c,u.parent.A||d[0])}function s(u){u._.x=u.z+u.parent.m,u.m+=u.parent.m}function l(u,p,d){if(p){for(var c=u,a=u,h=p,m=c.parent.children[0],g=c.m,y=a.m,x=h.m,_=m.m,S;h=cn(h),c=ln(c),h&&c;)m=ln(m),a=cn(a),a.a=u,S=h.z+x-c.z-g+e(h._,c._),S>0&&(jl(ec(h,u,d),u,S),g+=S,y+=S),x+=h.m,g+=c.m,_+=m.m,y+=a.m;h&&!cn(a)&&(a.t=h,a.m+=x-y),c&&!ln(m)&&(m.t=c,m.m+=g-_,d=u)}return d}function f(u){u.x*=t,u.y=u.depth*n}return i.separation=function(u){return arguments.length?(e=u,i):e},i.size=function(u){return arguments.length?(r=!1,t=+u[0],n=+u[1],i):r?null:[t,n]},i.nodeSize=function(u){return arguments.length?(r=!0,t=+u[0],n=+u[1],i):r?[t,n]:null},i}function ke(e){return function(){return e}}function Yi(e){let t=3;return e.digits=function(n){if(!arguments.length)return t;if(n==null)t=null;else{let r=Math.floor(n);if(!(r>=0))throw new RangeError(`invalid digits: ${n}`);t=r}return e},()=>new Ce(t)}var Rg=Array.prototype.slice;function Zi(e){return typeof e=="object"&&"length"in e?e:Array.from(e)}function Gi(e){this._context=e}Gi.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._point=0},lineEnd:function(){(this._line||this._line!==0&&this._point===1)&&this._context.closePath(),this._line=1-this._line},point:function(e,t){switch(e=+e,t=+t,this._point){case 0:this._point=1,this._line?this._context.lineTo(e,t):this._context.moveTo(e,t);break;case 1:this._point=2;default:this._context.lineTo(e,t);break}}};function Wi(e){return new Gi(e)}function Ki(e){return e[0]}function Ji(e){return e[1]}function Mt(e,t){var n=ke(!0),r=null,i=Wi,o=null,s=Yi(l);e=typeof e=="function"?e:e===void 0?Ki:ke(e),t=typeof t=="function"?t:t===void 0?Ji:ke(t);function l(f){var u,p=(f=Zi(f)).length,d,c=!1,a;for(r==null&&(o=i(a=s())),u=0;u<=p;++u)!(u<p&&n(d=f[u],u,f))===c&&((c=!c)?o.lineStart():o.lineEnd()),c&&o.point(+e(d,u,f),+t(d,u,f));if(a)return o=null,a+""||null}return l.x=function(f){return arguments.length?(e=typeof f=="function"?f:ke(+f),l):e},l.y=function(f){return arguments.length?(t=typeof f=="function"?f:ke(+f),l):t},l.defined=function(f){return arguments.length?(n=typeof f=="function"?f:ke(!!f),l):n},l.curve=function(f){return arguments.length?(i=f,r!=null&&(o=i(r)),l):i},l.context=function(f){return arguments.length?(f==null?r=o=null:o=i(r=f),l):r},l}function ji(e,t,n){e._context.bezierCurveTo((2*e._x0+e._x1)/3,(2*e._y0+e._y1)/3,(e._x0+2*e._x1)/3,(e._y0+2*e._y1)/3,(e._x0+4*e._x1+t)/6,(e._y0+4*e._y1+n)/6)}function Qi(e){this._context=e}Qi.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._y0=this._y1=NaN,this._point=0},lineEnd:function(){switch(this._point){case 3:ji(this,this._x1,this._y1);case 2:this._context.lineTo(this._x1,this._y1);break}(this._line||this._line!==0&&this._point===1)&&this._context.closePath(),this._line=1-this._line},point:function(e,t){switch(e=+e,t=+t,this._point){case 0:this._point=1,this._line?this._context.lineTo(e,t):this._context.moveTo(e,t);break;case 1:this._point=2;break;case 2:this._point=3,this._context.lineTo((5*this._x0+this._x1)/6,(5*this._y0+this._y1)/6);default:ji(this,e,t);break}this._x0=this._x1,this._x1=e,this._y0=this._y1,this._y1=t}};function fn(e){return new Qi(e)}function eo(e){return e<0?-1:1}function to(e,t,n){var r=e._x1-e._x0,i=t-e._x1,o=(e._y1-e._y0)/(r||i<0&&-0),s=(n-e._y1)/(i||r<0&&-0),l=(o*i+s*r)/(r+i);return(eo(o)+eo(s))*Math.min(Math.abs(o),Math.abs(s),.5*Math.abs(l))||0}function no(e,t){var n=e._x1-e._x0;return n?(3*(e._y1-e._y0)/n-t)/2:t}function dn(e,t,n){var r=e._x0,i=e._y0,o=e._x1,s=e._y1,l=(o-r)/3;e._context.bezierCurveTo(r+l,i+l*t,o-l,s-l*n,o,s)}function hn(e){this._context=e}hn.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._y0=this._y1=this._t0=NaN,this._point=0},lineEnd:function(){switch(this._point){case 2:this._context.lineTo(this._x1,this._y1);break;case 3:dn(this,this._t0,no(this,this._t0));break}(this._line||this._line!==0&&this._point===1)&&this._context.closePath(),this._line=1-this._line},point:function(e,t){var n=NaN;if(e=+e,t=+t,!(e===this._x1&&t===this._y1)){switch(this._point){case 0:this._point=1,this._line?this._context.lineTo(e,t):this._context.moveTo(e,t);break;case 1:this._point=2;break;case 2:this._point=3,dn(this,no(this,n=to(this,e,t)),n);break;default:dn(this,this._t0,n=to(this,e,t));break}this._x0=this._x1,this._x1=e,this._y0=this._y1,this._y1=t,this._t0=n}}};function ro(e){this._context=new io(e)}(ro.prototype=Object.create(hn.prototype)).point=function(e,t){hn.prototype.point.call(this,t,e)};function io(e){this._context=e}io.prototype={moveTo:function(e,t){this._context.moveTo(t,e)},closePath:function(){this._context.closePath()},lineTo:function(e,t){this._context.lineTo(t,e)},bezierCurveTo:function(e,t,n,r,i,o){this._context.bezierCurveTo(t,e,r,n,o,i)}};function pn(e){return new ro(e)}var Qe=e=>()=>e;function mn(e,{sourceEvent:t,target:n,transform:r,dispatch:i}){Object.defineProperties(this,{type:{value:e,enumerable:!0,configurable:!0},sourceEvent:{value:t,enumerable:!0,configurable:!0},target:{value:n,enumerable:!0,configurable:!0},transform:{value:r,enumerable:!0,configurable:!0},_:{value:i}})}function oe(e,t,n){this.k=e,this.x=t,this.y=n}oe.prototype={constructor:oe,scale:function(e){return e===1?this:new oe(this.k*e,this.x,this.y)},translate:function(e,t){return e===0&t===0?this:new oe(this.k,this.x+this.k*e,this.y+this.k*t)},apply:function(e){return[e[0]*this.k+this.x,e[1]*this.k+this.y]},applyX:function(e){return e*this.k+this.x},applyY:function(e){return e*this.k+this.y},invert:function(e){return[(e[0]-this.x)/this.k,(e[1]-this.y)/this.k]},invertX:function(e){return(e-this.x)/this.k},invertY:function(e){return(e-this.y)/this.k},rescaleX:function(e){return e.copy().domain(e.range().map(this.invertX,this).map(e.invert,e))},rescaleY:function(e){return e.copy().domain(e.range().map(this.invertY,this).map(e.invert,e))},toString:function(){return"translate("+this.x+","+this.y+") scale("+this.k+")"}};var $e=new oe(1,0,0);De.prototype=oe.prototype;function De(e){for(;!e.__zoom;)if(!(e=e.parentNode))return $e;return e.__zoom}function At(e){e.stopImmediatePropagation()}function Oe(e){e.preventDefault(),e.stopImmediatePropagation()}function nc(e){return(!e.ctrlKey||e.type==="wheel")&&!e.button}function rc(){var e=this;return e instanceof SVGElement?(e=e.ownerSVGElement||e,e.hasAttribute("viewBox")?(e=e.viewBox.baseVal,[[e.x,e.y],[e.x+e.width,e.y+e.height]]):[[0,0],[e.width.baseVal.value,e.height.baseVal.value]]):[[0,0],[e.clientWidth,e.clientHeight]]}function oo(){return this.__zoom||$e}function ic(e){return-e.deltaY*(e.deltaMode===1?.05:e.deltaMode?1:.002)*(e.ctrlKey?10:1)}function oc(){return navigator.maxTouchPoints||"ontouchstart"in this}function sc(e,t,n){var r=e.invertX(t[0][0])-n[0][0],i=e.invertX(t[1][0])-n[1][0],o=e.invertY(t[0][1])-n[0][1],s=e.invertY(t[1][1])-n[1][1];return e.translate(i>r?(r+i)/2:Math.min(0,r)||Math.max(0,i),s>o?(o+s)/2:Math.min(0,o)||Math.max(0,s))}function gn(){var e=nc,t=rc,n=sc,r=ic,i=oc,o=[0,1/0],s=[[-1/0,-1/0],[1/0,1/0]],l=250,f=nn,u=Fe("start","zoom","end"),p,d,c,a=500,h=150,m=0,g=10;function y(v){v.property("__zoom",oo).on("wheel.zoom",D,{passive:!1}).on("mousedown.zoom",q).on("dblclick.zoom",N).filter(i).on("touchstart.zoom",R).on("touchmove.zoom",P).on("touchend.zoom touchcancel.zoom",X).style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}y.transform=function(v,I,C,b){var k=v.selection?v.selection():v;k.property("__zoom",oo),v!==k?O(v,I,C,b):k.interrupt().each(function(){L(this,arguments).event(b).start().zoom(null,typeof I=="function"?I.apply(this,arguments):I).end()})},y.scaleBy=function(v,I,C,b){y.scaleTo(v,function(){var k=this.__zoom.k,$=typeof I=="function"?I.apply(this,arguments):I;return k*$},C,b)},y.scaleTo=function(v,I,C,b){y.transform(v,function(){var k=t.apply(this,arguments),$=this.__zoom,E=C==null?S(k):typeof C=="function"?C.apply(this,arguments):C,A=$.invert(E),M=typeof I=="function"?I.apply(this,arguments):I;return n(_(x($,M),E,A),k,s)},C,b)},y.translateBy=function(v,I,C,b){y.transform(v,function(){return n(this.__zoom.translate(typeof I=="function"?I.apply(this,arguments):I,typeof C=="function"?C.apply(this,arguments):C),t.apply(this,arguments),s)},null,b)},y.translateTo=function(v,I,C,b,k){y.transform(v,function(){var $=t.apply(this,arguments),E=this.__zoom,A=b==null?S($):typeof b=="function"?b.apply(this,arguments):b;return n($e.translate(A[0],A[1]).scale(E.k).translate(typeof I=="function"?-I.apply(this,arguments):-I,typeof C=="function"?-C.apply(this,arguments):-C),$,s)},b,k)};function x(v,I){return I=Math.max(o[0],Math.min(o[1],I)),I===v.k?v:new oe(I,v.x,v.y)}function _(v,I,C){var b=I[0]-C[0]*v.k,k=I[1]-C[1]*v.k;return b===v.x&&k===v.y?v:new oe(v.k,b,k)}function S(v){return[(+v[0][0]+ +v[1][0])/2,(+v[0][1]+ +v[1][1])/2]}function O(v,I,C,b){v.on("start.zoom",function(){L(this,arguments).event(b).start()}).on("interrupt.zoom end.zoom",function(){L(this,arguments).event(b).end()}).tween("zoom",function(){var k=this,$=arguments,E=L(k,$).event(b),A=t.apply(k,$),M=C==null?S(A):typeof C=="function"?C.apply(k,$):C,H=Math.max(A[1][0]-A[0][0],A[1][1]-A[0][1]),F=k.__zoom,z=typeof I=="function"?I.apply(k,$):I,G=f(F.invert(M).concat(H/F.k),z.invert(M).concat(H/z.k));return function(j){if(j===1)j=z;else{var re=G(j),Ne=H/re[2];j=new oe(Ne,M[0]-re[0]*Ne,M[1]-re[1]*Ne)}E.zoom(null,j)}})}function L(v,I,C){return!C&&v.__zooming||new T(v,I)}function T(v,I){this.that=v,this.args=I,this.active=0,this.sourceEvent=null,this.extent=t.apply(v,I),this.taps=0}T.prototype={event:function(v){return v&&(this.sourceEvent=v),this},start:function(){return++this.active===1&&(this.that.__zooming=this,this.emit("start")),this},zoom:function(v,I){return this.mouse&&v!=="mouse"&&(this.mouse[1]=I.invert(this.mouse[0])),this.touch0&&v!=="touch"&&(this.touch0[1]=I.invert(this.touch0[0])),this.touch1&&v!=="touch"&&(this.touch1[1]=I.invert(this.touch1[0])),this.that.__zoom=I,this.emit("zoom"),this},end:function(){return--this.active===0&&(delete this.that.__zooming,this.emit("end")),this},emit:function(v){var I=w(this.that).datum();u.call(v,this.that,new mn(v,{sourceEvent:this.sourceEvent,target:y,type:v,transform:this.that.__zoom,dispatch:u}),I)}};function D(v,...I){if(!e.apply(this,arguments))return;var C=L(this,I).event(v),b=this.__zoom,k=Math.max(o[0],Math.min(o[1],b.k*Math.pow(2,r.apply(this,arguments)))),$=fe(v);if(C.wheel)(C.mouse[0][0]!==$[0]||C.mouse[0][1]!==$[1])&&(C.mouse[1]=b.invert(C.mouse[0]=$)),clearTimeout(C.wheel);else{if(b.k===k)return;C.mouse=[$,b.invert($)],_e(this),C.start()}Oe(v),C.wheel=setTimeout(E,h),C.zoom("mouse",n(_(x(b,k),C.mouse[0],C.mouse[1]),C.extent,s));function E(){C.wheel=null,C.end()}}function q(v,...I){if(c||!e.apply(this,arguments))return;var C=v.currentTarget,b=L(this,I,!0).event(v),k=w(v.view).on("mousemove.zoom",M,!0).on("mouseup.zoom",H,!0),$=fe(v,C),E=v.clientX,A=v.clientY;Ut(v.view),At(v),b.mouse=[$,this.__zoom.invert($)],_e(this),b.start();function M(F){if(Oe(F),!b.moved){var z=F.clientX-E,G=F.clientY-A;b.moved=z*z+G*G>m}b.event(F).zoom("mouse",n(_(b.that.__zoom,b.mouse[0]=fe(F,C),b.mouse[1]),b.extent,s))}function H(F){k.on("mousemove.zoom mouseup.zoom",null),Xt(F.view,b.moved),Oe(F),b.event(F).end()}}function N(v,...I){if(e.apply(this,arguments)){var C=this.__zoom,b=fe(v.changedTouches?v.changedTouches[0]:v,this),k=C.invert(b),$=C.k*(v.shiftKey?.5:2),E=n(_(x(C,$),b,k),t.apply(this,I),s);Oe(v),l>0?w(this).transition().duration(l).call(O,E,b,v):w(this).call(y.transform,E,b,v)}}function R(v,...I){if(e.apply(this,arguments)){var C=v.touches,b=C.length,k=L(this,I,v.changedTouches.length===b).event(v),$,E,A,M;for(At(v),E=0;E<b;++E)A=C[E],M=fe(A,this),M=[M,this.__zoom.invert(M),A.identifier],k.touch0?!k.touch1&&k.touch0[2]!==M[2]&&(k.touch1=M,k.taps=0):(k.touch0=M,$=!0,k.taps=1+!!p);p&&(p=clearTimeout(p)),$&&(k.taps<2&&(d=M[0],p=setTimeout(function(){p=null},a)),_e(this),k.start())}}function P(v,...I){if(this.__zooming){var C=L(this,I).event(v),b=v.changedTouches,k=b.length,$,E,A,M;for(Oe(v),$=0;$<k;++$)E=b[$],A=fe(E,this),C.touch0&&C.touch0[2]===E.identifier?C.touch0[0]=A:C.touch1&&C.touch1[2]===E.identifier&&(C.touch1[0]=A);if(E=C.that.__zoom,C.touch1){var H=C.touch0[0],F=C.touch0[1],z=C.touch1[0],G=C.touch1[1],j=(j=z[0]-H[0])*j+(j=z[1]-H[1])*j,re=(re=G[0]-F[0])*re+(re=G[1]-F[1])*re;E=x(E,Math.sqrt(j/re)),A=[(H[0]+z[0])/2,(H[1]+z[1])/2],M=[(F[0]+G[0])/2,(F[1]+G[1])/2]}else if(C.touch0)A=C.touch0[0],M=C.touch0[1];else return;C.zoom("touch",n(_(E,A,M),C.extent,s))}}function X(v,...I){if(this.__zooming){var C=L(this,I).event(v),b=v.changedTouches,k=b.length,$,E;for(At(v),c&&clearTimeout(c),c=setTimeout(function(){c=null},a),$=0;$<k;++$)E=b[$],C.touch0&&C.touch0[2]===E.identifier?delete C.touch0:C.touch1&&C.touch1[2]===E.identifier&&delete C.touch1;if(C.touch1&&!C.touch0&&(C.touch0=C.touch1,delete C.touch1),C.touch0)C.touch0[1]=this.__zoom.invert(C.touch0[0]);else if(C.end(),C.taps===2&&(E=fe(E,this),Math.hypot(d[0]-E[0],d[1]-E[1])<g)){var A=w(this).on("dblclick.zoom");A&&A.apply(this,arguments)}}}return y.wheelDelta=function(v){return arguments.length?(r=typeof v=="function"?v:Qe(+v),y):r},y.filter=function(v){return arguments.length?(e=typeof v=="function"?v:Qe(!!v),y):e},y.touchable=function(v){return arguments.length?(i=typeof v=="function"?v:Qe(!!v),y):i},y.extent=function(v){return arguments.length?(t=typeof v=="function"?v:Qe([[+v[0][0],+v[0][1]],[+v[1][0],+v[1][1]]]),y):t},y.scaleExtent=function(v){return arguments.length?(o[0]=+v[0],o[1]=+v[1],y):[o[0],o[1]]},y.translateExtent=function(v){return arguments.length?(s[0][0]=+v[0][0],s[1][0]=+v[1][0],s[0][1]=+v[0][1],s[1][1]=+v[1][1],y):[[s[0][0],s[0][1]],[s[1][0],s[1][1]]]},y.constrain=function(v){return arguments.length?(n=v,y):n},y.duration=function(v){return arguments.length?(l=+v,y):l},y.interpolate=function(v){return arguments.length?(f=v,y):f},y.on=function(){var v=u.on.apply(u,arguments);return v===u?y:v},y.clickDistance=function(v){return arguments.length?(m=(v=+v)*v,y):Math.sqrt(m)},y.tapDistance=function(v){return arguments.length?(g=+v,y):g},y}function lc(e,t,n){if(!t.rels.children)return;let r=t.rels.spouses||[];return e.sort((i,o)=>{let s=so(i,t,n),l=so(o,t,n),f=s?r.indexOf(s.id):-1,u=l?r.indexOf(l.id):-1;return t.data.gender==="M"?f-u:u-f})}function cc(e){return e.sort((t,n)=>{let r=t._new_rel_data,i=n._new_rel_data;return r&&!i?1:!r&&i?-1:0})}function so(e,t,n){return n.find(r=>r.id!==t.id&&e.rels.parents.includes(r.id))}function He(e,t,n){if(e.exiting=n,t)if(e.depth===0&&!e.spouse)e._x=e.x,e._y=e.y;else if(e.spouse)e._x=e.spouse.x,e._y=e.spouse.y;else if(e.is_ancestry){if(!e.parent)throw new Error("no parent");e._x=e.parent.x,e._y=e.parent.y}else e._x=e.psx,e._y=e.psy;else if(n){let r=e.x>0?1:-1,i=e.y>0?1:-1;e._x=e.x+400*r,e._y=e.y+400*i}}function uc({tree:e,data_stash:t,node_separation:n,sortChildrenFunction:r}){let i=e.find(c=>c.data.main);if(!i)throw new Error("no main");let o=i.data.rels.parents[0],s=i.data.rels.parents[1],l=u(i);if(l.length>0&&!i.parents)throw new Error("no parents");let f=p(i);d(i);function u(c){return t.filter(a=>a.id===c.data.id?!1:!!(o&&a.rels.parents.includes(o)||s&&a.rels.parents.includes(s)))}function p(c){let a=[];for(let h=0;h<l.length;h++){let m={data:l[h],sibling:!0,x:0,y:c.y,depth:c.depth-1,parents:[]},g=c.parents.find(x=>x.data.id===m.data.rels.parents[0]),y=c.parents.find(x=>x.data.id===m.data.rels.parents[1]);g&&m.parents.push(g),y&&m.parents.push(y),e.push(m),a.push(m)}return a}function d(c){var a,h;let m=[c,...f];r&&m.sort((S,O)=>r(S.data,O.data)),m.sort((S,O)=>{let L=c.parents.find(N=>N.data.id===S.data.rels.parents[0]),T=c.parents.find(N=>N.data.id===S.data.rels.parents[1]),D=c.parents.find(N=>N.data.id===O.data.rels.parents[0]),q=c.parents.find(N=>N.data.id===O.data.rels.parents[1]);return!T&&q?-1:T&&!q||!L&&D?1:L&&!D?-1:0});let g=c.x,y=(c.spouses||[]).map(S=>S.x),x=Ee([g,...y]),_=m.findIndex(S=>S.data.id===c.data.id);for(let S=0;S<m.length;S++){if(S===_)continue;let O=m[S];S<_?O.x=((a=x[0])!==null&&a!==void 0?a:0)-n*(_-S):O.x=((h=x[1])!==null&&h!==void 0?h:0)+n*(S-_)}}}function fc({tree:e,data_stash:t,private_cards_config:n}){let r={},i=n.condition;if(!i)return console.error("private_cards_config.condition is not set");e.forEach(s=>{if(s.data._new_rel_data)return;let l=o(s.data.id);l&&(s.is_private=l)});function o(s){let l=[],f=!1;return u(s),r[s]=f,f;function u(p){if(f)return;if(r.hasOwnProperty(p))return f=r[p],f;let d=t.find(a=>a.id===p);if(!d)throw new Error("no d");if(d._new_rel_data)return;if(i(d))return f=!0,!0;let c=d.rels;[...c.parents,...c.spouses||[]].forEach(a=>{a&&(l.includes(a)||(l.push(a),u(a)))})}}}function dc(e,t){let n=t.find(l=>l.id===e);if(!n)throw new Error("no datum");let r=he(n,l=>s(l)),i=he(n,l=>o(l));return{ancestry:r.height,progeny:i.height};function o(l){return[...l.rels.children||[]].map(f=>t.find(u=>u.id===f)).filter(f=>f&&!f._new_rel_data&&!f.to_add)}function s(l){return l.rels.parents.filter(f=>f).map(f=>t.find(u=>u.id===f)).filter(f=>f&&!f._new_rel_data&&!f.to_add)}}function le({data:e,rels:t}){return{id:mc(),data:e||{},rels:Object.assign({parents:[],children:[],spouses:[]},t||{})}}function hc({data:e,rel_type:t,rel_datum:n}){let r=i(n,t);return e=Object.assign(e||{},{gender:r}),le({data:e});function i(o,s){return["daughter","mother"].includes(s)||s==="spouse"&&o.data.gender==="M"?"F":"M"}}function pc({data_stash:e,datum:t}){e.push(t)}function mc(){var e=new Date().getTime(),t=performance&&performance.now&&performance.now()*1e3||0;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var r=Math.random()*16;return e>0?(r=(e+r)%16|0,e=Math.floor(e/16)):(r=(t+r)%16|0,t=Math.floor(t/16)),(n==="x"?r:r&3|8).toString(16)})}function co(e,t){let n=e.data.rels;return[...n.parents,...n.spouses||[],...n.children||[]].filter(i=>i).every(i=>t.some(o=>o.data.id===i))}function Le(e,t,n){let r=n*.4,i=Math.max(...e.data.map(s=>s.is_ancestry?s.depth:0)),o=t.depth*r;return(t.depth!==0||t.spouse)&&!t.is_ancestry&&(o+=i*r,t.spouse&&(o+=r),o+=t.depth*r),o}function gc(e){e.forEach(t=>{if(!t.spouse)return;let n=t.spouse;if(t.duplicate&&n.data._tgdp_sp){let r=n.data.main?"main":n.parent.data.id;n.data._tgdp_sp[r]?.hasOwnProperty(t.data.id)&&(t._toggle=n.data._tgdp_sp[r][t.data.id])}})}function _c(e,t,n=!0){let r=[];i(e),c(r);function i(a){if(!a.children)return;let h=a.data,m=(a.data.rels.spouses||[]).map(y=>t.find(x=>x.id===y)),g=d(a);m.forEach(y=>{if(r.some(_=>_.some(S=>p([h,y],[S.p1,S.p2]))))return;let x=u(a,h,y);if(x.length>0){let _=[{d:a,p1:h,p2:y},...x];r.push(_),o(_),s(_)}else{let _=e===a?"main":a.parent.data.id;l(a,_,y),(g[y.id]||[]).forEach(S=>{i(S)})}})}function o(a){if(a.forEach(({d:h,p1:m,p2:g},y)=>{h.data._tgdp_sp||(h.data._tgdp_sp={});let x=e===h?"main":h.parent.data.id;f(h,x,g),h.data._tgdp_sp[x]||(h.data._tgdp_sp[x]={});let _=1;h.data._tgdp_sp[x].hasOwnProperty(g.id)?_=h.data._tgdp_sp[x][g.id]:h.data._tgdp_sp[x][g.id]=_,a[y].val=_}),n){if(a.every(h=>h.val<0)){let h=a.sort((_,S)=>S.val-_.val)[0],{d:m,p1:g,p2:y}=h,x=e===m?"main":m.parent.data.id;m.data._tgdp_sp[x][y.id]=1}if(a.filter(h=>h.val>0).length>1){let h=a.sort((m,g)=>g.val-m.val)[0];a.forEach(m=>{if(m===h)return;let{d:g,p1:y,p2:x}=m,_=e===g?"main":g.parent.data.id;g.data._tgdp_sp[_][x.id]=-1})}}}function s(a){a.forEach(({d:h,p1:m,p2:g})=>{let y=e===h?"main":h.parent.data.id;if(h.data._tgdp_sp[y][g.id]<0){let x=d(h);x[g.id]&&(h.children=h.children.filter(_=>!x[g.id].includes(_)),h.children.length===0&&delete h.children)}})}function l(a,h,m){a.data._tgdp_sp&&a.data._tgdp_sp[h]&&a.data._tgdp_sp[h].hasOwnProperty(m.id)&&(a.data.__tgdp_sp||(a.data.__tgdp_sp={}),a.data.__tgdp_sp[h]||(a.data.__tgdp_sp[h]={}),a.data.__tgdp_sp[h][m.id]=a.data._tgdp_sp[h][m.id],delete a.data._tgdp_sp[h][m.id])}function f(a,h,m){a.data.__tgdp_sp&&a.data.__tgdp_sp[h]&&a.data.__tgdp_sp[h].hasOwnProperty(m.id)&&(a.data._tgdp_sp[h][m.id]=a.data.__tgdp_sp[h][m.id],delete a.data.__tgdp_sp[h][m.id])}function u(a,h,m){let g=[];return y(e),g;function y(x){if(x!==a&&x.children){let _=x.data,S=(x.data.rels.spouses||[]).map(L=>t.find(T=>T.id===L)),O=d(x);S.forEach(L=>{p([h,m],[_,L])?g.push({d:x,p1:_,p2:L}):(O[L.id]||[]).forEach(T=>{y(T)})})}}}function p(a,h){return a.every(m=>h.some(g=>m.id===g.id))}function d(a){let h={},m=a;return(a.children||[]).forEach(g=>{let y=g.data.rels,x=y.parents[0]===m.data.id?y.parents[1]:y.parents[0];h[x]||(h[x]=[]),h[x].push(g)}),h}function c(a){let h=0;a.forEach(m=>{h=h+1,m.forEach(g=>{g.d._toggle_id_sp||(g.d._toggle_id_sp={}),g.d._toggle_id_sp[g.p2.id]=h})})}}function yc(e,t=!0){let n=[];r(e),f(n);function r(u){if(u.children){if(n.some(d=>d.includes(u)))return;let p=s(u.children);if(p.length>0){let d=[u,...p];n.push(d),i(d),o(d)}else u.children.forEach(d=>{r(d)})}}function i(u){if(u.forEach(p=>{p.data._tgdp||(p.data._tgdp={});let d=e===p?"main":p.parent.data.id;p.data._tgdp[d]||(p.data._tgdp[d]=-1),p._toggle=p.data._tgdp[d]}),t){if(u.every(p=>p._toggle<0)){let d=u.sort((a,h)=>h._toggle-a._toggle)[0],c=e===d?"main":d.parent.data.id;d.data._tgdp[c]=1}if(u.filter(p=>p._toggle>0).length>1){let p=u.sort((d,c)=>c._toggle-d._toggle)[0];u.forEach(d=>{if(d===p)return;let c=d,a=e===c?"main":c.parent.data.id;c.data._tgdp[a]=-1})}}}function o(u){u.forEach(p=>{let d=e===p?"main":p.parent.data.id;p.data._tgdp[d]<0&&delete p.children})}function s(u){let p=[];return d(e),p;function d(c){c.children&&(l(u,c.children)?p.push(c):c.children.forEach(a=>{d(a)}))}}function l(u,p){return u!==p&&u.every(d=>p.some(c=>d.data.id===c.data.id))}function f(u){let p=0;u.forEach(d=>{p=p+1,d.forEach(c=>{c._toggle_id=p})})}}function et(e){return e.forEach(n=>{n.rels.parents||(n.rels.parents=[]),n.rels.spouses||(n.rels.spouses=[]),n.rels.children||(n.rels.children=[]),t(n)}),e;function t(n){n.rels.parents||(n.rels.parents=[]),n.rels.father&&n.rels.parents.push(n.rels.father),n.rels.mother&&n.rels.parents.push(n.rels.mother),delete n.rels.father,delete n.rels.mother}}function Mn(e,t=!1){return e.forEach(n=>{var r;if(t){let i,o;(r=n.rels.parents)===null||r===void 0||r.forEach(s=>{let l=e.find(f=>f.id===s);if(!l)throw new Error("Parent not found");l.data.gender==="M"&&(i?o=l.id:i=l.id),l.data.gender==="F"&&(o?i=l.id:o=l.id)}),i&&(n.rels.father=i),o&&(n.rels.mother=o),delete n.rels.parents}n.rels.parents&&n.rels.parents.length===0&&delete n.rels.parents,n.rels.spouses&&n.rels.spouses.length===0&&delete n.rels.spouses,n.rels.children&&n.rels.children.length===0&&delete n.rels.children}),e}function uo(e,{main_id:t=null,node_separation:n=250,level_separation:r=150,single_parent_empty_card:i=!0,is_horizontal:o=!1,one_level_rels:s=!1,sortChildrenFunction:l=void 0,sortSpousesFunction:f=void 0,ancestry_depth:u=void 0,progeny_depth:p=void 0,show_siblings_of_main:d=!1,modifyTreeHierarchy:c=void 0,private_cards_config:a=void 0,duplicate_branch_toggle:h=!1,on_toggle_one_close_others:m=!0}){if(!e||!e.length)throw new Error("No data");o&&([n,r]=[r,n]);let g=i?v(e):e;(!t||!g.find(b=>b.id===t))&&(t=g[0].id);let y=g.find(b=>b.id===t);if(!y)throw new Error("Main not found");let x=L(y,"children",!1),_=L(y,"parents",!0);g.forEach(b=>b.main=b===y),T(_,x);let S=D(_,x);P(S),N(S,n),d&&!s&&uc({tree:S,data_stash:g,node_separation:n,sortChildrenFunction:l}),R(S),q(S),S.forEach(b=>b.all_rels_displayed=co(b,S)),a&&fc({tree:S,data_stash:g,private_cards_config:a}),xc(S),h&&gc(S);let O=X(S,n,r);return{data:S,data_stash:g,dim:O,main_id:y.id,is_horizontal:o};function L(b,k,$){let E=k==="children"?Ne:$s,A=un().nodeSize([n,r]).separation(F),M=he(b,E);I(M,$),h&&C(M,g,$),c&&c(M,$),A(M);let H=M.descendants();return H.forEach(B=>{B.x===void 0&&(B.x=0),B.y===void 0&&(B.y=0)}),H;function F(B,V){let Q=1;return $||(z(B,V)||(Q+=.25),s||re(B,V)&&(Q+=Es(B,V)),z(B,V)&&!G(B,V)&&(Q+=.125)),Q}function z(B,V){return B.parent==V.parent}function G(B,V){let Q=[...B.data.rels.parents].sort(),te=[...V.data.rels.parents].sort();return Q.length===te.length&&Q.every((Ft,Is)=>Ft===te[Is])}function j(B){return B.data.rels.spouses&&B.data.rels.spouses.length>0}function re(B,V){return j(B)||j(V)}function Ne(B){let V=[...B.rels.children||[]].map(Q=>g.find(te=>te.id===Q)).filter(Q=>Q!==void 0);return l&&V.sort(l),cc(V),f&&f(B,g),lc(V,B,g),V}function $s(B){let V=[...B.rels.parents],Q=g.find(te=>te.id===V[0]);return Q&&Q.data.gender==="F"&&V.reverse(),V.filter(te=>te).map(te=>g.find(Ft=>Ft.id===te)).filter(te=>te!==void 0)}function Es(B,V){return((B.data.rels.spouses||[]).length+(V.data.rels.spouses||[]).length)*.5}}function T(b,k){let $=(b[0].x-k[0].x)/2;b.forEach(E=>E.x-=$),k.forEach(E=>E.x+=$)}function D(b,k){return b.forEach($=>{$.is_ancestry=!0}),b.forEach($=>$.depth===1?$.parent=k[0]:null),[...k,...b.slice(1)]}function q(b){b.forEach(k=>{if(k.y*=k.is_ancestry?-1:1,o){let $=k.x;k.x=k.y,k.y=$}})}function N(b,k){for(let $=b.length;$--;){let E=b[$];if(!E.is_ancestry){let A=E.data.rels.spouses||[];if(E._ignore_spouses&&(A=A.filter(M=>!E._ignore_spouses.includes(M))),A.length>0){if(s&&E.depth>0)continue;let M=E.data.data.gender==="M"?-1:1;E.x+=A.length/2*k*M,A.forEach((H,F)=>{let z={data:g.find(G=>G.id===H),added:!0,depth:E.depth,spouse:E,x:E.x-k*(F+1)*M,y:E.y,tid:`${E.data.id}-spouse-${F}`};z.sx=F>0?z.x:z.x+k/2*M,z.sy=F>0?z.y:z.y+k/2*M,E.spouses||(E.spouses=[]),E.spouses.push(z),b.push(z)})}}if(E.parents&&E.parents.length===2){let A=E.parents[0],M=E.parents[1],H=A.x-(A.x-M.x)/2,F=(z,G)=>H+k/2*(z.x<G.x?1:-1);M.x=F(A,M),A.x=F(M,A)}}}function R(b){b.forEach(k=>{if(k.is_ancestry||k.depth===0||k.added||k.sibling)return;let $=k.parent,E=($?.spouses||[]).find(M=>k.data.rels.parents.includes(M.data.id));if($&&E){!$.added&&!E.added&&console.error("no added spouse",$,E);let M=$.added?$:E;A(k,M)}else if($||E){let M=$||E;if(!M)throw new Error("no progeny parent");M.sx=M.x,M.sy=M.y,A(k,M)}function A(M,H){M.psx=o?H.y:H.sx,M.psy=o?H.sx:H.y}})}function P(b){b.forEach(k=>{if(delete k.children,b.forEach($=>{$.parent===k&&($.is_ancestry?(k.parents||(k.parents=[]),k.parents.push($)):(k.children||(k.children=[]),k.children.push($)))}),k.parents&&k.parents.length===2){let $=k.parents[0],E=k.parents[1];$.coparent=E,E.coparent=$}})}function X(b,k,$){o&&([k,$]=[$,k]);let E=Ee(b,M=>M.x),A=Ee(b,M=>M.y);if(E[0]===void 0||E[1]===void 0||A[0]===void 0||A[1]===void 0)throw new Error("No extent");return{width:E[1]-E[0]+k,height:A[1]-A[0]+$,x_off:-E[0]+k/2,y_off:-A[0]+$/2}}function v(b){let k=[];for(let A=0;A<b.length;A++){let M=b[A];if(M.rels.children&&M.rels.children.length>0){M.rels.spouses||(M.rels.spouses=[]);let H;M.rels.children.forEach(F=>{let z=b.find(G=>G.id===F);if(z.rels.parents.length!==2){if(H||(H=$(M)),H.rels.children||(H.rels.children=[]),H.rels.children.push(z.id),z.rels.parents.length!==1)throw new Error("child has more than 1 parent");z.rels.parents.push(H.id)}})}}return k.forEach(A=>b.push(A)),b;function $(A){return(A.rels.spouses||[]).map(H=>b.find(F=>F.id===H)).filter(H=>H!==void 0).find(H=>H.to_add)||E(A)}function E(A){let M=le({data:{gender:A.data.gender==="M"?"F":"M"},rels:{spouses:[A.id]}});return M.to_add=!0,k.push(M),A.rels.spouses||(A.rels.spouses=[]),A.rels.spouses.push(M.id),M}}function I(b,k){let $=k?u:p;if(s&&($=1),!$&&$!==0)return b;return E(b,0),b;function E(A,M){M===$?A.children&&delete A.children:A.children&&A.children.forEach(H=>{E(H,M+1)})}}function C(b,k,$){$?yc(b,m):_c(b,k,m)}}function xc(e){let t=[];e.forEach(n=>{if(t.includes(n.data.id)){let r=e.filter(i=>i.data.id===n.data.id);r.forEach((i,o)=>{i.tid=`${n.data.id}--x${o+1}`,i.duplicate=r.length,t.push(n.data.id)})}else n.tid=n.data.id,t.push(n.data.id)})}function fo(e){return An(e.data,e)}function An(e,t){let n=et(e);return uo(n,t)}function Tn(e){let t,n=Object.assign({transition_time:1e3},e);return n.main_id_history=[],n.data&&(c(n.data),et(n.data)),{state:n,updateTree:a=>{!n.data||n.data.length===0||(n.tree=i(),!n.main_id&&n.tree&&u(n.tree.main_id),t&&t(a))},updateData:a=>{c(a),et(a),n.data=a,p()},updateMainId:u,getMainId:()=>n.main_id,getData:()=>n.data,getTree:()=>n.tree,setOnUpdate:a=>t=a,getMainDatum:o,getDatum:s,getTreeMainDatum:l,getTreeDatum:f,getLastAvailableMainDatum:d,methods:{}};function i(){let a={main_id:n.main_id};return n.node_separation!==void 0&&(a.node_separation=n.node_separation),n.level_separation!==void 0&&(a.level_separation=n.level_separation),n.single_parent_empty_card!==void 0&&(a.single_parent_empty_card=n.single_parent_empty_card),n.is_horizontal!==void 0&&(a.is_horizontal=n.is_horizontal),n.one_level_rels!==void 0&&(a.one_level_rels=n.one_level_rels),n.modifyTreeHierarchy!==void 0&&(a.modifyTreeHierarchy=n.modifyTreeHierarchy),n.sortChildrenFunction!==void 0&&(a.sortChildrenFunction=n.sortChildrenFunction),n.sortSpousesFunction!==void 0&&(a.sortSpousesFunction=n.sortSpousesFunction),n.ancestry_depth!==void 0&&(a.ancestry_depth=n.ancestry_depth),n.progeny_depth!==void 0&&(a.progeny_depth=n.progeny_depth),n.show_siblings_of_main!==void 0&&(a.show_siblings_of_main=n.show_siblings_of_main),n.private_cards_config!==void 0&&(a.private_cards_config=n.private_cards_config),n.duplicate_branch_toggle!==void 0&&(a.duplicate_branch_toggle=n.duplicate_branch_toggle),uo(n.data,a)}function o(){let a=n.data.find(h=>h.id===n.main_id);if(!a)throw new Error("Main datum not found");return a}function s(a){let h=n.data.find(m=>m.id===a);if(h)return h}function l(){if(!n.tree)throw new Error("No tree");let a=n.tree.data.find(h=>h.data.id===n.main_id);if(!a)throw new Error("No tree main datum");return a}function f(a){if(!n.tree)throw new Error("No tree");let h=n.tree.data.find(m=>m.data.id===a);if(h)return h}function u(a){a!==n.main_id&&(n.main_id_history=n.main_id_history.filter(h=>h!==a).slice(-10),n.main_id_history.push(a),n.main_id=a)}function p(){n.main_id?!n.data.find(h=>h.id===n.main_id)&&n.data.length>0&&u(n.data[0].id):n.data.length>0&&u(n.data[0].id)}function d(){let a=n.main_id_history.slice(0).reverse().find(m=>s(m));if(!a&&n.data.length>0&&(a=n.data[0].id),!a)throw new Error("No main id");a!==n.main_id&&u(a);let h=s(a);if(!h)throw new Error("Main datum not found");return h}function c(a){if(n.legacy_format===void 0){for(let h of a)if(h.rels.father||h.rels.mother){n.legacy_format=!0;return}n.legacy_format=!1}}}function ho({t:e,svg:t,transition_time:n=2e3}){let r=Ht(t),i=r.__zoomObj;w(r).transition().duration(n||0).delay(n?100:0).call(i.transform,$e.scale(e.k).translate(e.x,e.y))}function xn({svg:e,svg_dim:t,tree_dim:n,transition_time:r}){let i=po(t,n);ho({t:i,svg:e,transition_time:r})}function po(e,t){let n=Math.min(e.width/t.width,e.height/t.height);n>1&&(n=1);let r=t.x_off+(e.width-t.width*n)/n/2,i=t.y_off+(e.height-t.height*n)/n/2;return{k:n,x:r,y:i}}function mo({datum:e,svg:t,svg_dim:n,scale:r,transition_time:i}){let o=r||1,s=n.width/2-e.x*o,l=n.height/2-e.y,f={k:o,x:s/o,y:l/o};ho({t:f,svg:t,transition_time:i})}function go({amount:e,svg:t,transition_time:n=500}){let r=Ht(t),i=r.__zoomObj;if(!i)throw new Error("Zoom object not found");w(r).transition().duration(n||0).delay(n?100:0).call(i.scaleBy,e)}function _o(e){let t=Ht(e);return De(t)}function yo(e,t){let n=Ht(e),r=De(n);go({amount:t/r.k,svg:e})}function Ht(e){let t=e.__zoomObj?e:e.parentNode;if(!t.__zoomObj)throw new Error("Zoom object not found");return t}function xo(e,t={}){if(e.__zoom){console.log("zoom already setup");return}let n=e.querySelector(".view"),r=gn().on("zoom",t.onZoom||i);w(e).call(r),e.__zoomObj=r,t.zoom_polite&&r.filter(o);function i(s){w(n).attr("transform",s.transform)}function o(s){return s.type==="wheel"&&!s.ctrlKey?!1:!(s.touches&&s.touches.length<2)}}function vc(e,t=!1){let n=[];return(e.spouses||e.coparent)&&o(e),r(e),i(e),n;function r(a){if(!a.parents)return;let h=a.parents[0],m=a.parents[1]||h,g={x:s(h,m,"x"),y:s(h,m,"y")};n.push({d:f(a,g),_d:()=>{let y={x:a.x,y:a.y},x={x:a.x,y:a.y};return f(y,x)},curve:!0,id:d(a,h,m),depth:a.depth+1,is_ancestry:!0,source:a,target:[h,m]})}function i(a){!a.children||a.children.length===0||a.children.forEach((h,m)=>{let g=c(h,a)||a,y=g.sx;if(typeof y!="number")throw new Error("sx is not a number");let x=t?{x:a.x,y}:{x:y,y:a.y};n.push({d:f(h,x),_d:()=>f(x,{x:l(x,"x"),y:l(x,"y")}),curve:!0,id:d(h,a,g),depth:a.depth+1,is_ancestry:!1,source:[a,g],target:h})})}function o(a){a.spouses?a.spouses.forEach(m=>n.push(h(a,m))):a.coparent&&n.push(h(a,a.coparent));function h(m,g){return{d:[[m.x,m.y],[g.x,g.y]],_d:()=>[m.is_ancestry?[l(m,"x")-1e-4,l(m,"y")]:[m.x,m.y],m.is_ancestry?[l(g,"x"),l(g,"y")]:[m.x-1e-4,m.y]],curve:!1,id:d(m,g),depth:m.depth,spouse:!0,is_ancestry:g.is_ancestry,source:m,target:g}}}function s(a,h,m,g=!1){return g?l(a,m)-(l(a,m)-l(h,m))/2:a[m]-(a[m]-h[m])/2}function l(a,h){let m=a.hasOwnProperty(`_${h}`)?a[`_${h}`]:a[h];if(typeof m!="number")throw new Error(`${h} is not a number`);return m}function f(a,h){return t?p(a,h):u(a,h)}function u(a,h){let m=a.y+(h.y-a.y)/2;return[[a.x,a.y],[a.x,m],[a.x,m],[h.x,m],[h.x,m],[h.x,h.y]]}function p(a,h){let m=a.x+(h.x-a.x)/2;return[[a.x,a.y],[m,a.y],[m,a.y],[m,h.y],[m,h.y],[h.x,h.y]]}function d(...a){return a.map(h=>h.tid).sort().join(", ")}function c(a,h){return(h.spouses||[]).find(g=>a.data.rels.parents.includes(g.data.id))}}function wc(e,t,n={}){let r=t.data.reduce((c,a)=>(vc(a,t.is_horizontal).forEach(h=>c[h.id]=h),c),{}),i=Object.values(r),o=w(e).select(".links_view").selectAll("path.link").data(i,c=>c.id);if(n.transition_time===void 0)throw new Error("transition_time is undefined");let s=o.exit(),l=o.enter().append("path").attr("class","link"),f=l.merge(o);s.each(d),l.each(u),f.each(p);function u(c){w(this).attr("fill","none").attr("stroke","#fff").attr("stroke-width",1).style("opacity",0).attr("d",_n(c,!0))}function p(c){let a=w(this),h=n.initial?Le(t,c,n.transition_time):0;a.transition("path").duration(n.transition_time).delay(h).attr("d",_n(c)).style("opacity",1)}function d(c){let a=w(this);a.transition("op").duration(800).style("opacity",0),a.transition("path").duration(n.transition_time).attr("d",_n(c,!0)).on("end",()=>a.remove())}}function _n(e,t=!1){let n=Mt().curve(pn),r=Mt().curve(fn),i=t?e._d():e.d;return e.curve?r(i):n(i)}function bc(e,t,n,r={}){let i=w(e).select(".cards_view").selectAll("g.card_cont").data(t.data,c=>c.data.id),o=i.exit(),s=i.enter().append("g").attr("class","card_cont"),l=s.merge(i);o.each(c=>He(c,!1,!0)),s.each(c=>He(c,!0,!1)),o.each(d),i.each(u),s.each(f),l.each(p);function f(c){w(this).attr("transform",`translate(${c._x}, ${c._y})`).style("opacity",0),n.call(this,c)}function u(c){}function p(c){n.call(this,c);let a=r.initial?Le(t,c,r.transition_time):0;w(this).transition().duration(r.transition_time).delay(a).attr("transform",`translate(${c.x}, ${c.y})`).style("opacity",1)}function d(c){let a=c,h=a?[a._x,a._y]:[0,0],m=w(this);m.transition().duration(r.transition_time).style("opacity",0).attr("transform",`translate(${h[0]}, ${h[1]})`).on("end",()=>m.remove())}}function Cc(e,t,n,r={}){let i=a(e),o=w(i).select(".cards_view").selectAll("div.card_cont").data(t.data,h=>h.tid),s=o.exit(),l=o.enter().append("div").attr("class","card_cont").style("pointer-events","none"),f=l.merge(o);s.each(h=>He(h,!1,!0)),l.each(h=>He(h,!0,!1)),s.each(c),o.each(p),l.each(u),f.each(d);function u(h){w(this).style("position","absolute").style("top","0").style("left","0").style("transform",`translate(${h._x}px, ${h._y}px)`).style("opacity",0),n.call(this,h)}function p(h){}function d(h){n.call(this,h);let m=r.initial?Le(t,h,r.transition_time):0;w(this).transition().duration(r.transition_time).delay(m).style("transform",`translate(${h.x}px, ${h.y}px)`).style("opacity",1)}function c(h){let m=h,g=m?[m._x,m._y]:[0,0],y=w(this);y.transition().duration(r.transition_time).style("opacity",0).style("transform",`translate(${g[0]}px, ${g[1]}px)`).on("end",()=>y.remove())}function a(h){if(r.cardHtmlDiv)return r.cardHtmlDiv;let m=h.closest("#f3Canvas");if(!m)throw new Error("canvas not found");let g=m.querySelector("#htmlSvg");if(!g)throw new Error("htmlSvg not found");return g}}function Lt(e,t={}){let n=e.getBoundingClientRect(),r=`
    <svg class="main_svg">
      <rect width="${n.width}" height="${n.height}" fill="transparent" />
      <g class="view">
        <g class="links_view"></g>
        <g class="cards_view"></g>
      </g>
      <g style="transform: translate(100%, 100%)">
        <g class="fit_screen_icon cursor-pointer" style="transform: translate(-50px, -50px); display: none">
          <rect width="27" height="27" stroke-dasharray="${27/2}" stroke-dashoffset="${27/4}" 
            style="stroke:#fff;stroke-width:4px;fill:transparent;"/>
          <circle r="5" cx="${27/2}" cy="${27/2}" style="fill:#fff" />          
        </g>
      </g>
    </svg>
  `,i=l(e),o=se("div").node();o.innerHTML=r;let s=o.querySelector("svg");return i.appendChild(s),e.appendChild(i),xo(i,t),s;function l(f){let u=f.querySelector("#f3Canvas");return u||(u=se("div").attr("id","f3Canvas").attr("style","position: relative; overflow: hidden; width: 100%; height: 100%;").node()),u}}function Rn(e){return Lt(e,{onZoom:Dn(()=>e.querySelector("svg .view"),()=>e.querySelector("#htmlSvg .cards_view"))}),vo(e),{svg:e.querySelector("svg.main_svg"),svgView:e.querySelector("svg .view"),htmlSvg:e.querySelector("#htmlSvg"),htmlView:e.querySelector("#htmlSvg .cards_view")}}function vo(e){let n=w(e).select("#f3Canvas").append("div").attr("id","htmlSvg").attr("style","position: absolute; width: 100%; height: 100%; z-index: 2; top: 0; left: 0");return n.append("div").attr("class","cards_view").style("transform-origin","0 0"),n.node()}function Dn(e,t){return function(r){let i=r.transform;w(e()).style("transform",`translate(${i.x}px, ${i.y}px) scale(${i.k}) `),w(t()).style("transform",`translate(${i.x}px, ${i.y}px) scale(${i.k}) `)}}var Sc=Object.freeze({__proto__:null,createHtmlSvg:vo,default:Rn,onZoomSetup:Dn});function kc(e){let t=()=>e.querySelector("svg .view"),n=()=>e.querySelector("#htmlSvg");return Lt(e,{onZoom:Dn(t,()=>e.querySelector("#htmlSvg .cards_view"))}),w(n()).append("div").attr("class","cards_view_fake").style("display","none"),wo(n)}function wo(e){let t=[];return function(o){let s=r(o,t);return t=[...o,...s],n(bo(e),t),t};function n(i,o){let s=w(i).selectAll("div.card_cont_2fake").data(o,a=>a.data.id),l=s.exit(),f=s.enter().append("div").attr("class","card_cont_2fake").style("display","none").attr("data-id",()=>Math.random()),u=f.merge(s);l.each(c),f.each(p),u.each(d);function p(a){a.unique_id=w(this).attr("data-id")}function d(a){a.unique_id=w(this).attr("data-id")}function c(a){a&&(a.unique_id=w(this).attr("data-id"),w(this).remove())}}function r(i,o){return o.length>0?o.filter(s=>!i.find(l=>l.data.id===s.data.id)):[]}}function bo(e){return w(e()).select("div.cards_view_fake").node()}function $c(e){w(e()).append("div").attr("class","cards_view_fake").style("display","none")}var Ec=wo;function Ic(e){return e.unique_id}function Mc(e,t,n,r={}){let i=r.cardHtmlDiv?r.cardHtmlDiv:e.closest("#f3Canvas").querySelector("#htmlSvg"),o=w(bo(()=>i)).selectAll("div.card_cont_fake").data(t.data,a=>a.data.id),s=o.exit(),l=o.enter().append("div").attr("class","card_cont_fake").style("display","none"),f=l.merge(o);s.each(a=>He(a,!1,!0)),l.each(a=>He(a,!0,!1)),s.each(c),o.each(p),l.each(u),f.each(d);function u(a){w(n(a)).style("position","absolute").style("top","0").style("left","0").style("opacity",0).style("transform",`translate(${a._x}px, ${a._y}px)`)}function p(a){}function d(a){let h=w(n(a)),m=r.initial?Le(t,a,r.transition_time):0;h.transition().duration(r.transition_time).delay(m).style("transform",`translate(${a.x}px, ${a.y}px)`).style("opacity",1)}function c(a){let h=a,m=h?[h._x,h._y]:[0,0],g=w(n(a)),y=w(this);g.transition().duration(r.transition_time).style("opacity",0).style("transform",`translate(${m[0]}px, ${m[1]}px)`).on("end",()=>y.remove())}}function On(e,t,n,r={}){r.initial=r.hasOwnProperty("initial")?r.initial:!w(t.parentNode).select(".card_cont").node(),r.transition_time=r.hasOwnProperty("transition_time")?r.transition_time:1e3,r.cardComponent?Mc(t,e,n,r):r.cardHtml?Cc(t,e,n,r):bc(t,e,n,r),wc(t,e,r);let i=r.tree_position||"fit";return r.initial?xn({svg:t,svg_dim:t.getBoundingClientRect(),tree_dim:e.dim,transition_time:0}):i==="fit"?xn({svg:t,svg_dim:t.getBoundingClientRect(),tree_dim:e.dim,transition_time:r.transition_time}):i==="main_to_middle"&&mo({datum:e.data[0],svg:t,svg_dim:t.getBoundingClientRect(),scale:r.scale,transition_time:r.transition_time}),!0}function Hn(e,{d:t}){return e.updateMainId(t.data.id),e.updateTree({}),!0}function Co(e,t){let n=e.rels,r=[...n.parents,...n.spouses||[],...n.children||[]].filter(i=>!!i);for(let i of r){let o=t.find(s=>s.id===i);if(!Ln(o,t,[e.id]))return!1}return!0}function Ln(e,t,n=[]){let r=t[0];if(e.id===r.id)return!0;let i=[...n],o=!1;return s(e),o;function s(l){if(o)return;let f=l.rels;[...f.parents,...f.spouses||[],...f.children||[]].filter(p=>!!p).forEach(p=>{if(i.includes(p))return;i.push(p);let d=t.find(c=>c.id===p);d.id===r.id?o=!0:s(d)})}}function So(e,t,n){n.forEach((r,i)=>e.data[i]=r),ko(e,t),e.to_add&&delete e.to_add,e.unknown&&delete e.unknown}function ko(e,t){Object.keys(e.data).forEach(n=>{if(n.includes("__ref__")){let r=n.split("__ref__")[1],i=t.find(s=>s.id===r);if(!i)return;let o=n.split("__ref__")[0]+"__ref__"+e.id;i.data[o]=e.data[n]}})}function vn(e,t){Object.keys(e.data).forEach(n=>{if(n.includes("__ref__")){let r=n.split("__ref__")[1],i=t.find(s=>s.id===r);if(!i)return;let o=n.split("__ref__")[0]+"__ref__"+e.id;delete i.data[o]}})}function Ac(e,t){return delete e.to_add,e}function $o(e,t){return Nn(e,t,!1),!1}function Nn(e,t,n=!0){if(Co(e,t))return r(),n&&Nt(t),{success:!0};return i(),{success:!0};function r(){t.forEach(o=>{for(let s in o.rels){if(!o.rels.hasOwnProperty(s))continue;let l=s;Array.isArray(o.rels[l])&&o.rels[l].includes(e.id)&&o.rels[l].splice(o.rels[l].findIndex(f=>f===e.id),1)}}),vn(e,t),t.splice(t.findIndex(o=>o.id===e.id),1),t.length===0&&t.push(le({data:{gender:"M"}}))}function i(){vn(e,t),e.data={gender:e.data.gender},e.unknown=!0}}function Eo(e){return Nt(e),e.forEach(t=>{delete t.main,delete t._tgdp,delete t._tgdp_sp,delete t.__tgdp_sp}),e.forEach(t=>{Object.keys(t).forEach(n=>{n[0]==="_"&&console.error("key starts with _",n)})}),e}function Nt(e){for(let t=e.length-1;t>=0;t--)e[t].to_add&&$o(e[t],e)}function Io(){return`
    <g data-icon="user">
      ${K()}
      <path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />
    </g>
  `}function Mo(){return`
    <g data-icon="user-edit">
      ${K()}
      <path d="M21.7,13.35L20.7,14.35L18.65,12.3L19.65,11.3C19.86,11.09 20.21,11.09 20.42,11.3L21.7,12.58C21.91,
      12.79 21.91,13.14 21.7,13.35M12,18.94L18.06,12.88L20.11,14.93L14.06,21H12V18.94M12,14C7.58,14 4,15.79 4,
      18V20H10V18.11L14,14.11C13.34,14.03 12.67,14 12,14M12,4A4,4 0 0,0 8,8A4,4 0 0,0 12,12A4,4 0 0,0 16,8A4,4 0 0,0 12,4Z" />
    </g>
  `}function Ao(){return`
    <g data-icon="user-plus">
      ${K()}
      <path d="M15,14C12.33,14 7,15.33 7,18V20H23V18C23,15.33 17.67,14 15,14M6,10V7H4V10H1V12H4V15H6V12H9V10M15,12A4,4 0 0,0 19,8A4,4 0 0,0 15,4A4,4 0 0,0 11,8A4,4 0 0,0 15,12Z" />
    </g>
  `}function To(){return`
    <g data-icon="user-plus-close">
      ${K()}
      <path d="M15,14C12.33,14 7,15.33 7,18V20H23V18C23,15.33 17.67,14 15,14M6,10V7H4V10H1V12H4V15H6V12H9V10M15,12A4,4 0 0,0 19,8A4,4 0 0,0 15,4A4,4 0 0,0 11,8A4,4 0 0,0 15,12Z" />
      <line x1="3" y1="3" x2="24" y2="24" stroke="currentColor" stroke-width="2" />
    </g>
  `}function Fn(){return`
    <g data-icon="plus">
      ${K()}
      <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
    </g>
  `}function Ro(){return`
    <g data-icon="pencil">
      ${K()}
      <path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" />
    </g>
  `}function Do(){return`
    <g data-icon="pencil-off">
      ${K()}
      <path d="M18.66,2C18.4,2 18.16,2.09 17.97,2.28L16.13,4.13L19.88,7.88L21.72,6.03C22.11,5.64 22.11,5 21.72,4.63L19.38,2.28C19.18,2.09 18.91,2 18.66,2M3.28,4L2,5.28L8.5,11.75L4,16.25V20H7.75L12.25,15.5L18.72,22L20,20.72L13.5,14.25L9.75,10.5L3.28,4M15.06,5.19L11.03,9.22L14.78,12.97L18.81,8.94L15.06,5.19Z" />
    </g>
  `}function Oo(){return`
    <g data-icon="trash">
      ${K()}
      <path d="M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19M8,9H16V19H8V9M15.5,4L14.5,3H9.5L8.5,4H5V6H19V4H15.5Z" />
    </g>
  `}function Ho(){return`
    <g data-icon="history-back">
      ${K()}
      <path d="M20 13.5C20 17.09 17.09 20 13.5 20H6V18H13.5C16 18 18 16 18 13.5S16 9 13.5 9H7.83L10.91 12.09L9.5 13.5L4 8L9.5 2.5L10.92 3.91L7.83 7H13.5C17.09 7 20 9.91 20 13.5Z" />
    </g>
  `}function Lo(){return`
    <g data-icon="history-forward">
      ${K()}
      <path d="M10.5 18H18V20H10.5C6.91 20 4 17.09 4 13.5S6.91 7 10.5 7H16.17L13.08 3.91L14.5 2.5L20 8L14.5 13.5L13.09 12.09L16.17 9H10.5C8 9 6 11 6 13.5S8 18 10.5 18Z" />
    </g>
  `}function No(){return`
    <g data-icon="person">
      <path d="M256 288c79.5 0 144-64.5 144-144S335.5 0 256 0 112 
        64.5 112 144s64.5 144 144 144zm128 32h-55.1c-22.2 10.2-46.9 16-72.9 16s-50.6-5.8-72.9-16H128C57.3 320 0 377.3 
        0 448v16c0 26.5 21.5 48 48 48h416c26.5 0 48-21.5 48-48v-16c0-70.7-57.3-128-128-128z" />
    </g>
  `}function Fo(){return`
    <g transform="translate(31,25)" data-icon="mini-tree">
      <rect x="-31" y="-25" width="72" height="15" fill="rgba(0,0,0,0)"></rect>
      <g>
        <rect x="-31" y="-25" width="72" height="15" fill="rgba(0,0,0,0)"></rect>
        <line y2="-17.5" stroke="#fff" />
        <line x1="-20" x2="20" y1="-17.5" y2="-17.5" stroke="#fff" />
        <rect x="-31" y="-25" width="25" height="15" rx="5" ry="5" class="card-male" />
        <rect x="6" y="-25" width="25" height="15" rx="5" ry="5" class="card-female" />
      </g>
    </g>
  `}function Po(){return`
    <g data-icon="toggle-on">
      ${K()}
      <circle class="f3-small-circle" r="4" cx="18" cy="12" />
      <path d="M17,7H7A5,5 0 0,0 2,12A5,5 0 0,0 7,17H17A5,5 0 0,0 22,12A5,5 0 0,0 17,7M17,15A3,3 0 0,1 14,12A3,3 0 0,1 17,9A3,3 0 0,1 20,12A3,3 0 0,1 17,15Z" />
    </g>
  `}function zo(){return`
    <g data-icon="toggle-off">
      ${K()}
      <circle class="f3-small-circle" r="4" cx="6" cy="12" />
      <path d="M17,7H7A5,5 0 0,0 2,12A5,5 0 0,0 7,17H17A5,5 0 0,0 22,12A5,5 0 0,0 17,7M7,15A3,3 0 0,1 4,12A3,3 0 0,1 7,9A3,3 0 0,1 10,12A3,3 0 0,1 7,15Z" />
    </g>
  `}function qo(){return`
    <g data-icon="chevron-down">
      ${K()}
      <path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z" />
    </g>
  `}function Bo(){return`
    <g data-icon="chevron-up">
      ${K()}
      <path d="M7.41,15.41L12,10.83L16.59,15.41L18,14L12,8L6,14L7.41,15.41Z" />
    </g>
  `}function Vo(){return`
    <g data-icon="link-off">
      ${K()}
      <path d="M17,7H13V8.9H17C18.71,8.9 20.1,10.29 20.1,12C20.1,13.43 19.12,14.63 17.79,15L19.25,16.44C20.88,15.61 22,13.95 
      22,12A5,5 0 0,0 17,7M16,11H13.81L15.81,13H16V11M2,4.27L5.11,7.38C3.29,8.12 2,9.91 2,12A5,5 0 0,0 7,17H11V15.1H7C5.29,15.1 
      3.9,13.71 3.9,12C3.9,10.41 5.11,9.1 6.66,8.93L8.73,11H8V13H10.73L13,15.27V17H14.73L18.74,21L20,19.74L3.27,3L2,4.27Z" />
    </g>
  `}function Uo(){return`
    <g data-icon="info">
      ${K()}
      <path d="M13,9H11V7H13M13,17H11V11H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" />
    </g>
  `}function Tc(){return Z(Io())}function Rc(){return Z(Mo())}function Xo(){return Z(Ao())}function Yo(){return Z(To())}function Zo(){return Z(Fn())}function Go(){return Z(Ro())}function Wo(){return Z(Do())}function Dc(){return Z(Oo())}function Ko(){return Z(Ho())}function Jo(){return Z(Lo())}function Pn(){return Z(No(),"0 0 512 512")}function zn(){return Z(Fo(),"0 0 72 25")}function jo(){return Z(Po())}function Qo(){return Z(zo())}function es(){return Z(qo())}function Oc(){return Z(Bo())}function ts(){return Z(Vo())}function ns(){return Z(Uo())}function Z(e,t="0 0 24 24"){let n=e.match(/data-icon="([^"]+)"/),r=n?`data-icon="${n[1]}"`:"";return`
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="${t}" style="fill: currentColor" ${r}>
      ${e}
    </svg>
  `}function K(){return`
    <circle r="12" cx="12" cy="12" style="fill: rgba(0,0,0,0)" />
  `}var rs=Object.freeze({__proto__:null,chevronDownIcon:qo,chevronDownSvgIcon:es,chevronUpIcon:Bo,chevronUpSvgIcon:Oc,historyBackIcon:Ho,historyBackSvgIcon:Ko,historyForwardIcon:Lo,historyForwardSvgIcon:Jo,infoIcon:Uo,infoSvgIcon:ns,linkOffIcon:Vo,linkOffSvgIcon:ts,miniTreeIcon:Fo,miniTreeSvgIcon:zn,pencilIcon:Ro,pencilOffIcon:Do,pencilOffSvgIcon:Wo,pencilSvgIcon:Go,personIcon:No,personSvgIcon:Pn,plusIcon:Fn,plusSvgIcon:Zo,toggleIconOff:zo,toggleIconOn:Po,toggleSvgIconOff:Qo,toggleSvgIconOn:jo,trashIcon:Oo,trashSvgIcon:Dc,userEditIcon:Mo,userEditSvgIcon:Rc,userIcon:Io,userPlusCloseIcon:To,userPlusCloseSvgIcon:Yo,userPlusIcon:Ao,userPlusSvgIcon:Xo,userSvgIcon:Tc});function Hc(e){return` 
    <form id="familyForm" class="f3-form">
      ${as()}
      <h3 class="f3-form-title">${e.title}</h3>
      ${is(e)}

      ${os(e)}
      
      <div class="f3-form-buttons">
        <button type="button" class="f3-cancel-btn">Cancel</button>
        <button type="submit">Submit</button>
      </div>

      ${e.linkExistingRelative?ss(e):""}
    </form>
  `}function Lc(e){return` 
    <form id="familyForm" class="f3-form ${e.editable?"":"non-editable"}">
      ${as()}
      <div style="text-align: right; display: 'block'">
        ${e.no_edit?"":Pc(e)}
        ${e.no_edit?qc():zc(e)}
      </div>

      ${is(e)}

      ${os(e)}
      
      <div class="f3-form-buttons">
        <button type="button" class="f3-cancel-btn">Cancel</button>
        <button type="submit">Submit</button>
      </div>

      ${e.linkExistingRelative?ss(e):""}

      <hr>
      ${Nc(e)}

      ${Fc(e)}
    </form>
  `}function Nc(e){return`
    <div>
      <button type="button" class="f3-delete-btn" ${e.can_delete?"":"disabled"}>
        Delete
      </button>
    </div>
  `}function Fc(e){return`
    <div>
      <button type="button" class="f3-remove-relative-btn${e.removeRelativeActive?" active":""}">
        ${e.removeRelativeActive?"Cancel Remove Relation":"Remove Relation"}
      </button>
    </div>
  `}function Pc(e){return`
    <span class="f3-add-relative-btn">
      ${e.addRelativeActive?Yo():Xo()}
    </span>
  `}function zc(e){return`
    <span class="f3-edit-btn">
      ${e.editable?Wo():Go()}
    </span>
  `}function is(e){return e.editable?`
    <div class="f3-radio-group">
      ${e.gender_field.options.map(t=>`
        <label>
          <input type="radio" name="${e.gender_field.id}" 
            value="${t.value}" 
            ${t.value===e.gender_field.initial_value?"checked":""}
            ${e.gender_field.disabled?"disabled":""}
          >
          ${t.label}
        </label>
      `).join("")}
    </div>
  `:""}function os(e){if(!e.editable)return n();let t="";return e.fields.forEach(r=>{if(r.type==="text")t+=`
      <div class="f3-form-field">
        <label>${r.label}</label>
        <input type="${r.type}" 
          name="${r.id}" 
          value="${r.initial_value||""}"
          placeholder="${r.label}">
      </div>`;else if(r.type==="textarea")t+=`
      <div class="f3-form-field">
        <label>${r.label}</label>
        <textarea name="${r.id}" 
          placeholder="${r.label}">${r.initial_value||""}</textarea>
      </div>`;else if(r.type==="select"){let i=r;t+=`
      <div class="f3-form-field">
        <label>${i.label}</label>
        <select name="${i.id}" value="${i.initial_value||""}">
          <option value="">${i.placeholder||`Select ${i.label}`}</option>
          ${i.options.map(o=>`<option ${o.value===i.initial_value?"selected":""} value="${o.value}">${o.label}</option>`).join("")}
        </select>
      </div>`}else r.type==="rel_reference"&&(t+=`
      <div class="f3-form-field">
        <label>${r.label} - <i>${r.rel_label}</i></label>
        <input type="text" 
          name="${r.id}" 
          value="${r.initial_value||""}"
          placeholder="${r.label}">
      </div>`)}),t;function n(){let r="";return e.fields.forEach(i=>{var o;if(i.type==="rel_reference"){if(!i.initial_value)return;r+=`
        <div class="f3-info-field">
          <span class="f3-info-field-label">${i.label} - <i>${i.rel_label}</i></span>
          <span class="f3-info-field-value">${i.initial_value||""}</span>
        </div>`}else if(i.type==="select"){let s=i;if(!i.initial_value)return;r+=`
        <div class="f3-info-field">
          <span class="f3-info-field-label">${s.label}</span>
          <span class="f3-info-field-value">${((o=s.options.find(l=>l.value===s.initial_value))===null||o===void 0?void 0:o.label)||""}</span>
        </div>`}else r+=`
        <div class="f3-info-field">
          <span class="f3-info-field-label">${i.label}</span>
          <span class="f3-info-field-value">${i.initial_value||""}</span>
        </div>`}),r}}function ss(e){let t=e.linkExistingRelative.hasOwnProperty("title")?e.linkExistingRelative.title:"Profile already exists?",n=e.linkExistingRelative.hasOwnProperty("select_placeholder")?e.linkExistingRelative.select_placeholder:"Select profile",r=e.linkExistingRelative.options;return`
    <div>
      <hr>
      <div class="f3-link-existing-relative">
        <label>${t}</label>
        <select>
          <option value="">${n}</option>
          ${r.map(i=>`<option value="${i.value}">${i.label}</option>`).join("")}
        </select>
      </div>
    </div>
  `}function as(){return`
    <span class="f3-close-btn">
      \xD7
    </span>
  `}function qc(){return'<div style="height: 24px;"></div>'}function ls(e,t){return us(e,t)}function cs(e,t){return us(e,t)}function us(e,t){let n=o(e),r=document.createElement("div");return i(),r;function i(){let s=n?Hc(e):Lc(e);r.innerHTML=s,Bc(r,e,t,i),n?Vc(r,e):Uc(r,e,i),e.onFormCreation&&e.onFormCreation({cont:r,form_creator:e})}function o(s){return"new_rel"in s}}function Bc(e,t,n,r){let i=e.querySelector("form");i.addEventListener("submit",t.onSubmit),i.querySelector(".f3-cancel-btn").addEventListener("click",l),i.querySelector(".f3-close-btn").addEventListener("click",n);function l(){t.editable=!1,t.onCancel&&t.onCancel(),r()}}function Vc(e,t){let r=e.querySelector("form").querySelector(".f3-link-existing-relative select");r&&r.addEventListener("change",t.linkExistingRelative.onSelect)}function Uc(e,t,n){let r=e.querySelector("form"),i=r.querySelector(".f3-edit-btn");i&&i.addEventListener("click",u);let o=r.querySelector(".f3-delete-btn");o&&t.onDelete&&o.addEventListener("click",t.onDelete);let s=r.querySelector(".f3-add-relative-btn");s&&t.addRelative&&s.addEventListener("click",()=>{t.addRelativeActive?t.addRelativeCancel():t.addRelative(),t.addRelativeActive=!t.addRelativeActive,n()});let l=r.querySelector(".f3-remove-relative-btn");l&&t.removeRelative&&l.addEventListener("click",()=>{t.removeRelativeActive?t.removeRelativeCancel():t.removeRelative(),t.removeRelativeActive=!t.removeRelativeActive,n()});let f=r.querySelector(".f3-link-existing-relative select");f&&f.addEventListener("change",t.linkExistingRelative.onSelect);function u(){t.editable=!t.editable,n()}}function fs(e,t,n){let r=[],i=-1;return{changed:o,back:s,forward:l,canForward:f,canBack:u};function o(){i<r.length-1&&(r=r.slice(0,i+1));let d=t();d.main_id=e.getMainId(),r.push(d),i++}function s(){u()&&(i--,p(r[i]))}function l(){f()&&(i++,p(r[i]))}function f(){return i<r.length-1}function u(){return i>0}function p(d){let c=e.getMainId();d=JSON.parse(JSON.stringify(d)),d.find(a=>a.id===c)||e.updateMainId(d.main_id),e.updateData(d),n()}}function ds(e,t){let n=w(e).append("div").attr("class","f3-history-controls");e.insertBefore(n.node(),e.firstChild);let r=n.append("button").attr("class","f3-back-button").on("click",()=>{t.back(),o()}),i=n.append("button").attr("class","f3-forward-button").on("click",()=>{t.forward(),o()});return r.html(Ko()),i.html(Jo()),{back_btn:r.node(),forward_btn:i.node(),updateButtons:o,destroy:s};function o(){r.classed("disabled",!t.canBack()),i.classed("disabled",!t.canForward()),!t.canBack()&&!t.canForward()?n.style("opacity",0).style("pointer-events","none"):n.style("opacity",1).style("pointer-events","auto")}function s(){w(e).select(".f3-history-controls").remove()}}var hs=Object.freeze({__proto__:null,addNewPerson:pc,calculateDelay:Le,calculateTreeFit:po,cardChangeMain:Hn,cardComponentSetup:kc,cardToMiddle:mo,checkIfConnectedToFirstPerson:Ln,checkIfRelativesConnectedWithoutPerson:Co,cleanupDataJson:Eo,createFormEdit:cs,createFormNew:ls,createHistory:fs,createHistoryControls:ds,createNewPerson:le,createNewPersonWithGenderFromRel:hc,deletePerson:Nn,getCurrentZoom:_o,htmlContSetup:Rn,isAllRelativeDisplayed:co,manualZoom:go,moveToAddToAdded:Ac,onDeleteSyncRelReference:vn,removeToAdd:$o,removeToAddFromData:Nt,setupZoom:xo,submitFormData:So,syncRelReference:ko,treeFit:xn,zoomTo:yo});function ps({d:e,card_dim:t,card_display:n}){return{template:`
    <g class="card-body">
      <rect width="${t.w}" height="${t.h}" class="card-body-rect" />
      ${Yc({d:e,card_dim:t,card_display:n}).template}
    </g>
  `}}function Xc({d:e,card_dim:t,label:n}){return{template:`
    <g class="card-body">
      <rect class="card-body-rect" width="${t.w}" height="${t.h}" />
      <text transform="translate(${t.img_w+5}, ${t.h/2})">
        <tspan font-size="18" dy="8" pointer-events="none">${n}</tspan>
      </text>
    </g>
  `}}function Yc({d:e,card_dim:t,card_display:n}){return{template:`
    <g>
      <g class="card-text" clip-path="url(#card_text_clip)">
        <g transform="translate(${t.text_x}, ${t.text_y})">
          <text>
            ${Array.isArray(n)?n.map(r=>`<tspan x="0" dy="14">${r(e.data)}</tspan>`).join(`
`):n(e.data)}
          </text>
        </g>
      </g>
      <rect width="${t.w-10}" height="${t.h}" style="mask: url(#fade)" class="text-overflow-mask" /> 
    </g>
  `}}function ao({d:e,card_dim:t,is_new:n}){return{template:`
    <rect width="${t.w}" height="${t.h}" rx="4" ry="4" class="card-outline ${e.data.main&&!n?"card-main-outline":""} ${n?"card-new-outline":""}" />
  `}}function Zc({d:e,card_dim:t}){return{template:`
    <g class="card_family_tree" style="cursor: pointer">
      <rect x="-31" y="-25" width="72" height="15" fill="rgba(0,0,0,0)"></rect>
      <g transform="translate(${t.w*.8},6)scale(.9)">
        <rect x="-31" y="-25" width="72" height="15" fill="rgba(0,0,0,0)"></rect>
        <line y2="-17.5" stroke="#fff" />
        <line x1="-20" x2="20" y1="-17.5" y2="-17.5" stroke="#fff" />
        <rect x="-31" y="-25" width="25" height="15" rx="5" ry="5" class="card-male" />
        <rect x="6" y="-25" width="25" height="15" rx="5" ry="5" class="card-female" />
      </g>
    </g>
  `}}function Gc({d:e,image:t,card_dim:n,maleIcon:r,femaleIcon:i}){return{template:`
    <g style="transform: translate(${n.img_x}px,${n.img_y}px);" class="card_image" clip-path="url(#card_image_clip)">
      ${t?`<image href="${t}" height="${n.img_h}" width="${n.img_w}" preserveAspectRatio="xMidYMin slice" />`:(e.data.data.gender,e.data.data.gender,o())}      
    </g>
  `};function o(){return`
      <g class="genderless-icon">
        <rect height="${n.img_h}" width="${n.img_w}" fill="rgb(59, 85, 96)" />
        <g transform="scale(${n.img_w*.001616})">
         <path transform="translate(50,40)" fill="lightgrey" d="M256 288c79.5 0 144-64.5 144-144S335.5 0 256 0 112 
            64.5 112 144s64.5 144 144 144zm128 32h-55.1c-22.2 10.2-46.9 16-72.9 16s-50.6-5.8-72.9-16H128C57.3 320 0 377.3 
            0 448v16c0 26.5 21.5 48 48 48h416c26.5 0 48-21.5 48-48v-16c0-70.7-57.3-128-128-128z" />
        </g>
      </g>
    `}}function Tt(e,t,n){let r=document.createElementNS("http://www.w3.org/2000/svg","g");r.innerHTML=e,n?t.insertBefore(r,t.firstChild):t.appendChild(r)}var lo={miniTree:Wc,cardBody:Kc,cardImage:Jc};function Wc(e,t){if(e.data.to_add)return;let n=t.card_dim;if(e.all_rels_displayed)return;let r=se("svg:g").html(Zc({d:e,card_dim:n}).template);return r.on("click",function(i){i.stopPropagation(),t.onMiniTreeClick?t.onMiniTreeClick.call(this,i,e):Hn(t.store,{d:e})}),r.node()}function Kc(e,t){let n=t.card_dim,r=se("svg:g").html(ps({d:e,card_dim:n,card_display:t.card_display}).template);return r.on("click",function(i){i.stopPropagation(),t.onCardClick?t.onCardClick.call(this,i,e):Hn(t.store,{d:e})}),r.node()}function Jc(e,t){if(e.data.to_add)return;let n=t.card_dim;return se("svg:g").html(Gc({d:e,image:e.data.data.avatar||null,card_dim:n,maleIcon:void 0,femaleIcon:void 0}).template).node()}function wn(e,t,n=!1){e&&(n?t.insertBefore(e,t.firstChild):t.appendChild(e))}function jc(e,t,n,r){if(!t.hasOwnProperty("_toggle"))return;let i=e.querySelector(".card"),o=i.querySelector(".card-inner"),s=e.querySelector(".card").offsetWidth;e.querySelector(".card").offsetHeight;let l,f,u={};if(t.spouse){let d=t.spouse,c=d.data.main?"main":d.parent.data.id;if(l=d.data._tgdp_sp[c][t.data.id]<0,u.top=60,u.left=t.sx-t.x-30+s/2,n&&(u.top=t.sy-t.x+4,u.left=s/2+4,Math.abs(t.sx-t.y)<10&&(u.left=s-4)),f=d._toggle_id_sp?d._toggle_id_sp[t.data.id]:-1,f===-1)return}else{let d=t.data.main?"main":t.parent.data.id;l=t.data._tgdp[d]<0,u.top=-65,u.left=-30+s/2,n&&(u.top=5,u.left=-55),f=t._toggle_id}if(o.style.zIndex=1,w(i).append("div").attr("class","f3-toggle-div").attr("style","cursor: pointer; width: 60px; height: 60px;position: absolute; z-index: -1;").style("top",u.top+"px").style("left",u.left+"px").on("click",d=>{if(d.stopPropagation(),t.spouse){let c=t.spouse,a=c.data.main?"main":c.parent.data.id;c.data._tgdp_sp[a].hasOwnProperty(t.data.id)||console.error("no toggle",t,c);let h=c.data._tgdp_sp[a][t.data.id];h<0?h=new Date().getTime():h=-new Date().getTime(),c.data._tgdp_sp[a][t.data.id]=h}else{let c=t.data.main?"main":t.parent.data.id,a=t.data._tgdp[c];a<0?a=new Date().getTime():a=-new Date().getTime(),t.data._tgdp[c]=a}r()}).append("div").html(l?Qo():jo()).select("svg").classed("f3-toggle-icon",!0).style("color",l?"#585656":"#61bf52").style("padding","0"),w(i).select(".f3-toggle-icon .f3-small-circle").style("fill","#fff"),w(i).select(".f3-toggle-icon").append("text").attr("transform",l?"translate(10.6, 14.5)":"translate(4.1, 14.5)").attr("fill","#fff").attr("font-size","7px").text("C"+f),l){let d;t.is_ancestry?n?d="translate(5, -30)rotate(-90)":d="translate(0, -10)":n?d="translate(11, -22)rotate(90)":d="translate(-7, -32)rotate(180)",w(i).select(".f3-toggle-div").insert("div").html(zn()).select("svg").attr("style","position: absolute; z-index: -1;top: 0;left: 0;border-radius: 0;").style("width","66px").style("height","112px").attr("transform",d).attr("viewBox","0 0 72 125").select("line").attr("y1",t.is_ancestry?"62":"92")}}function ms(e){let t=e.style==="default"?u:e.style==="imageCircleRect"?f:e.style==="imageCircle"?p:e.style==="imageRect"?d:e.style==="rect"?c:u;return function(_){if(this.innerHTML=`
    <div class="card ${a(_).join(" ")}" data-id="${_.tid}" style="transform: translate(-50%, -50%); pointer-events: auto;">
      ${e.mini_tree?l(_):""}
      ${e.cardInnerHtmlCreator&&!_.data._new_rel_data?e.cardInnerHtmlCreator(_):t(_)}
    </div>
    `,this.querySelector(".card").addEventListener("click",S=>e.onCardClick(S,_)),e.onCardUpdate&&e.onCardUpdate.call(this,_),e.onCardMouseenter&&w(this).select(".card").on("mouseenter",S=>e.onCardMouseenter(S,_)),e.onCardMouseleave&&w(this).select(".card").on("mouseleave",S=>e.onCardMouseleave(S,_)),_.duplicate&&x(this,_),e.duplicate_branch_toggle&&jc(this,_,e.store.state.is_horizontal,e.store.updateTree),location.origin.includes("localhost")&&(_.__node=this.querySelector(".card"),_.__label=_.data.data["first name"],_.data.to_add)){let S=_.spouse||_.coparent||null;S&&w(this).select(".card").attr("data-to-add",S.data.data["first name"])}};function n(_){return`
    <div class="card-inner card-image-circle" ${h()}>
      ${_.data.data[e.cardImageField]?`<img src="${_.data.data[e.cardImageField]}" ${m()}>`:g(_)}
      <div class="card-label">${o(_)}</div>
      ${_.duplicate?y(_):""}
    </div>
    `}function r(_){return`
    <div class="card-inner card-image-rect" ${h()}>
      ${_.data.data[e.cardImageField]?`<img src="${_.data.data[e.cardImageField]}" ${m()}>`:g(_)}
      <div class="card-label">${o(_)}</div>
      ${_.duplicate?y(_):""}
    </div>
    `}function i(_){return`
    <div class="card-inner card-rect" ${h()}>
      ${o(_)}
      ${_.duplicate?y(_):""}
    </div>
    `}function o(_){return _.data._new_rel_data?s(_):_.data.to_add?`<div>${e.empty_card_label||"ADD"}</div>`:_.data.unknown?`<div>${e.unknown_card_label||"UNKNOWN"}</div>`:`
      ${e.card_display.map(S=>`<div>${S(_.data)}</div>`).join("")}
    `}function s(_){let S=[];return S.push(`data-rel-type="${_.data._new_rel_data.rel_type}"`),["son","daughter"].includes(_.data._new_rel_data.rel_type)&&S.push(`data-other-parent-id="${_.data._new_rel_data.other_parent_id}"`),`<div ${S.join(" ")}>${_.data._new_rel_data.label}</div>`}function l(_){return!e.mini_tree||_.data.to_add||_.data._new_rel_data||_.all_rels_displayed?"":`<div class="mini-tree">${zn()}</div>`}function f(_){return _.data.data[e.cardImageField]?p(_):c(_)}function u(_){return r(_)}function p(_){return n(_)}function d(_){return r(_)}function c(_){return i(_)}function a(_){let S=[];return _.data.data.gender==="M"?S.push("card-male"):_.data.data.gender==="F"?S.push("card-female"):S.push("card-genderless"),S.push(`card-depth-${_.is_ancestry?-_.depth:_.depth}`),_.data.main&&S.push("card-main"),_.data._new_rel_data&&S.push("card-new-rel"),_.data.to_add&&S.push("card-to-add"),_.data.unknown&&S.push("card-unknown"),S}function h(){let _='style="';if(e.card_dim.w||e.card_dim.h)_+=`width: ${e.card_dim.w}px; min-height: ${e.card_dim.h}px;`,e.card_dim.height_auto?_+="height: auto;":_+=`height: ${e.card_dim.h}px;`;else return"";return _+='"',_}function m(){let _='style="position: relative;';if(e.card_dim.img_w||e.card_dim.img_h||e.card_dim.img_x||e.card_dim.img_y)_+=`width: ${e.card_dim.img_w}px; height: ${e.card_dim.img_h}px;`,_+=`left: ${e.card_dim.img_x}px; top: ${e.card_dim.img_y}px;`;else return"";return _+='"',_}function g(_){return _.data._new_rel_data?`<div class="person-icon" ${m()}>${Zo()}</div>`:`<div class="person-icon" ${m()}>${e.defaultPersonIcon?e.defaultPersonIcon(_):Pn()}</div>`}function y(_){return`<div class="f3-card-duplicate-tag">x${_.duplicate}</div>`}function x(_,S){w(_).on("mouseenter",O=>{w(_.closest(".cards_view")).selectAll(".card_cont").select(".card").classed("f3-card-duplicate-hover",L=>L.data.id===S.data.id)}),w(_).on("mouseleave",O=>{w(_.closest(".cards_view")).selectAll(".card_cont").select(".card").classed("f3-card-duplicate-hover",!1)})}}function gs(e,t){if(e.querySelector("defs#f3CardDef"))return;e.insertAdjacentHTML("afterbegin",`
      <defs id="f3CardDef">
        <linearGradient id="fadeGrad">
          <stop offset="0.9" stop-color="white" stop-opacity="0"/>
          <stop offset=".91" stop-color="white" stop-opacity=".5"/>
          <stop offset="1" stop-color="white" stop-opacity="1"/>
        </linearGradient>
        <mask id="fade" maskContentUnits="objectBoundingBox"><rect width="1" height="1" fill="url(#fadeGrad)"/></mask>
        <clipPath id="card_clip"><path d="${n({w:t.w,h:t.h},5)}"></clipPath>
        <clipPath id="card_text_clip"><rect width="${t.w-10}" height="${t.h}"></rect></clipPath>
        <clipPath id="card_image_clip"><path d="M0,0 Q 0,0 0,0 H${t.img_w} V${t.img_h} H0 Q 0,${t.img_h} 0,${t.img_h} z"></clipPath>
        <clipPath id="card_image_clip_curved"><path d="${n({w:t.img_w,h:t.img_h},5,["rx","ry"])}"></clipPath>
      </defs>
    `);function n(r,i,o){let{w:s,h:l}=r,f=i,u=o||[],p=m=>u.includes(m),d=p("lx")?"M0,0":`M0,${f} Q 0,0 5,0`,c=p("rx")?`H${s}`:`H${s-f} Q ${s},0 ${s},5`,a=p("ry")?`V${l}`:`V${l-f} Q ${s},${l} ${s-f},${l}`,h=p("ly")?"H0":`H${f} Q 0,${l} 0,${l-f}`;return`${d} ${c} ${a} ${h} z`}}function Qc(e,t){e.querySelector("defs#f3CardDef")&&e.querySelector("defs#f3CardDef").remove(),gs(e,t)}function qn(e){return e=t(e),gs(e.svg,e.card_dim),function(n){let r=n.data.data.gender==="M"?"card-male":n.data.data.gender==="F"?"card-female":"card-genderless",i=e.card_dim,o=se("svg:g").attr("class",`card ${r}`).attr("transform",`translate(${[-i.w/2,-i.h/2]})`);o.append("g").attr("class","card-inner").attr("clip-path","url(#card_clip)"),this.innerHTML="",this.appendChild(o.node()),o.on("click",function(s){s.stopPropagation(),e.onCardClick.call(this,s,n)}),n.data._new_rel_data?(Tt(ao({d:n,card_dim:i,is_new:n.data.to_add}).template,o.node(),!0),Tt(Xc({d:n,card_dim:i,label:n.data._new_rel_data.label}).template,this.querySelector(".card-inner"),!0),w(this.querySelector(".card-inner")).append("g").attr("class","card-edit-icon").attr("fill","currentColor").attr("transform",`translate(-1,2)scale(${i.img_h/22})`).html(Fn())):(Tt(ao({d:n,card_dim:i,is_new:n.data.to_add}).template,o.node(),!0),Tt(ps({d:n,card_dim:i,card_display:e.card_display}).template,this.querySelector(".card-inner"),!1),e.img&&wn(lo.cardImage(n,e),this.querySelector(".card")),e.mini_tree&&wn(lo.miniTree(n,e),this.querySelector(".card"),!0)),e.onCardUpdate&&e.onCardUpdate.call(this,n)};function t(n){let r={img:!0,mini_tree:!0,link_break:!1,card_dim:{w:220,h:70,text_x:75,text_y:15,img_w:60,img_h:60,img_x:5,img_y:5}};n||(n={});for(let i in r)typeof n[i]>"u"&&(n[i]=r[i]);return n}}function Bn(e){return e.onCardClick===void 0&&(e.onCardClick=(t,n)=>{e.store.updateMainId(n.data.id),e.store.updateTree({})}),qn(e)}function _s(e,t){return new bn(e,t)}var bn=class{constructor(t,n){this.cont=t,this.active=!1,this.onClose=n,this.popup_cont=w(this.cont).append("div").attr("class","f3-popup").node(),this.create()}create(){let t=w(this.popup_cont);t.html(`
      <div class="f3-popup-content">
        <span class="f3-popup-close">&times;</span>
        <div class="f3-popup-content-inner"></div>
      </div>
    `),t.select(".f3-popup-close").on("click",()=>{this.close()}),t.on("click",n=>{n.target==t.node()&&this.close()})}activate(t){let n=w(this.popup_cont).select(".f3-popup-content-inner").node();t&&n.appendChild(t),this.open()}open(){this.active=!0}close(){this.popup_cont.remove(),this.active=!1,this.onClose&&this.onClose()}};function ys(e,t,n){let r=t.find(p=>p.id===e),i={};return o(r.id,"self",0),s(i),n.show_in_law&&l(i,t),f(i),i;function o(p,d,c,a=void 0){if(!p||i[p])return;d&&(i[p]=d);let m=t.find(g=>g.id===p).rels;if(d==="self")m.parents.forEach(g=>o(g,"parent",c-1,p)),(m.spouses||[]).forEach(g=>o(g,"spouse",c)),(m.children||[]).forEach(g=>o(g,"child",c+1));else if(d==="parent")m.parents.forEach(g=>o(g,"grandparent",c-1,p)),(m.children||[]).forEach(g=>{a&&a===g||o(g,"sibling",c+1)});else if(d!=="spouse")if(d==="child")(m.children||[]).forEach(g=>o(g,"grandchild",c+1));else if(d==="sibling")(m.children||[]).forEach(g=>o(g,"nephew",c+1));else if(d==="grandparent")a||console.error(`${d} should have prev_rel_id`),m.parents.forEach(g=>o(g,"great-grandparent",c-1,p)),(m.children||[]).forEach(g=>{a&&a===g||o(g,"uncle",c+1)});else if(d.includes("grandchild"))(m.children||[]).forEach(g=>o(g,Rt(d,c+1),c+1));else if(d.includes("great-grandparent"))a||console.error(`${d} should have prev_rel_id`),m.parents.forEach(g=>o(g,Rt(d,c-1),c-1,p)),(m.children||[]).forEach(g=>{if(a&&a===g)return;let y=vs(c+1);y===0?o(g,"granduncle",c+1):y>0?o(g,Rt("granduncle",c+1),c+1):console.error(`${d} should have great_count > -1`)});else if(d==="nephew")(m.children||[]).forEach(g=>o(g,"grandnephew",c+1));else if(d.includes("grandnephew"))(m.children||[]).forEach(g=>o(g,Rt(d,c+1),c+1));else if(d==="uncle")(m.children||[]).forEach(g=>o(g,"1st Cousin",c+1));else if(d==="granduncle")(m.children||[]).forEach(g=>o(g,"1st Cousin 1x removed",c+1));else if(d.includes("great-granduncle")){let g=c+1,y=Math.abs(g);(m.children||[]).forEach(x=>o(x,`1st Cousin ${y}x removed`,g))}else d.slice(4).startsWith("Cousin")?(m.children||[]).forEach(g=>{let y=c+1,x=Math.abs(y),_=+d[0];y===0?o(g,`${yn(_+1)} Cousin`,y):y<0?o(g,`${yn(_+1)} Cousin ${x}x removed`,y):y>0&&o(g,`${yn(_)} Cousin ${x}x removed`,y)}):console.error(`${d} not found`)}function s(p){let d=[];Object.keys(p).forEach(c=>{let a=p[c];if(a.includes("child")||a==="spouse")return;let h=xs(r.id,c,t);if(!h)return console.error(`${t.find(m=>m.id===c).data} not found in main_ancestry`);h.is_half_kin&&d.push(c)}),d.forEach(c=>{p[c]=`Half ${p[c]}`})}function l(p,d){Object.keys(p).forEach(c=>{let a=p[c],h=d.find(m=>m.id===c);if(a==="spouse"){let m=[];h.rels.parents.forEach(g=>(u(g).rels.children||[]).forEach(y=>m.push(y))),m.forEach(g=>{p[g]||(p[g]="sibling-in-law")})}a==="sibling"&&(h.rels.spouses||[]).forEach(m=>{p[m]||(p[m]="sibling-in-law")}),a==="child"&&(h.rels.spouses||[]).forEach(m=>{p[m]||(p[m]="child-in-law")}),a==="uncle"&&(h.rels.spouses||[]).forEach(m=>{p[m]||(p[m]="uncle-in-law")}),a.includes("Cousin")&&(h.rels.spouses||[]).forEach(m=>{p[m]||(p[m]=`${a} in-law`)})})}function f(p){Object.keys(p).forEach(d=>{let c=p[d],h=t.find(m=>m.id===d).data.gender;if(c.includes("parent")){let g=h==="M"?"father":h==="F"?"mother":"parent";p[d]=p[d].replace("parent",g)}else if(c.includes("sibling")){let g=h==="M"?"brother":h==="F"?"sister":"sibling";p[d]=p[d].replace("sibling",g)}else if(c.includes("child")){let g=h==="M"?"son":h==="F"?"daughter":"child";p[d]=p[d].replace("child",g)}else if(c.includes("uncle")){let g=h==="M"?"uncle":h==="F"?"aunt":"aunt/uncle";p[d]=p[d].replace("uncle",g)}else if(c.includes("nephew")){let g=h==="M"?"nephew":h==="F"?"niece":"neice/nephew";p[d]=p[d].replace("nephew",g)}})}function u(p){return t.find(d=>d.id===p)}}function xs(e,t,n){let r=f(e),i,o,s;if(p(t),d(t),l(t),!i)return null;return{found:i,is_ancestor:o,is_half_kin:s};function l(a){if(i)return;if(a===e){o=!0,i=a,s=!1;return}let m=n.find(x=>x.id===a).rels,g=u(m),y=r.find(x=>x[0]&&g[0]&&x[0]===g[0]||x[1]&&g[1]&&x[1]===g[1]);if(y){i=g.filter((x,_)=>x===y[_]),s=c(g,y);return}m.parents.forEach(x=>l(x))}function f(a){let h=[];return m(a),h;function m(g){let x=n.find(_=>_.id===g).rels;h.push(u(x)),x.parents.forEach(_=>m(_))}}function u(a){return a.parents}function p(a){let h=n.find(g=>g.id===a);r.find(g=>g[0]===h.id||g[1]===h.id)&&(o=!0,i=a,s=!1)}function d(a){(n.find(m=>m.id===e).rels.spouses||[]).includes(a)&&(i=[e,a])}function c(a,h){return a.some((m,g)=>m!==h[g])||h.some((m,g)=>m!==a[g])}}function yn(e){let t=["st","nd","rd"];return t[e-1]?e+t[e-1]:e+"th"}function vs(e){return Math.abs(e)-2}function Rt(e,t){let n=vs(t);return e.includes("great-")&&(e=e.split("great-")[1]),n===1?`great-${e}`:n>1?`${n}x-great-${e}`:(console.error(`${e} should have great_count > 1`),e)}function ws(e,t,n,r){var i;let o,s=r[t].toLowerCase();if(s.includes("in-law")){o=t;let T=n.find(D=>D.id===o);s.includes("sister")||s.includes("brother")?t=e:t=(i=T.rels.spouses)===null||i===void 0?void 0:i.find(D=>r[D]&&!r[D].includes("in-law"))}let l=xs(e,t,n);if(!l)return console.error(`${t} not found in main_ancestry`);let f=l.is_ancestor?l.found:l.found[0],u=n.find(T=>T.id===f),p=he(u,g),d=p.descendants().map(T=>T.data.id),c=y(e,d),a=y(t,d);m(p);let h=p.descendants().map(T=>{let D={id:T.data.id,data:JSON.parse(JSON.stringify(T.data.data)),kinship:r[T.data.id],rels:{parents:[],spouses:[],children:[]}};return T.children&&T.children.length>0&&(D.rels.children=T.children.map(q=>q.data.id)),D});return h.length>0&&!l.is_ancestor&&!l.is_half_kin&&x(h),o&&_(h),h;function m(T){T.children=(T.children||[]).filter(D=>!!(c.includes(D.data.id)||a.includes(D.data.id))),T.children.forEach(D=>m(D)),T.children.length===0&&delete T.children}function g(T){return[...T.rels.children||[]].map(q=>n.find(N=>N.id===q)).filter(q=>q)}function y(T,D){let q=[T];return N(T),q;function N(R){n.find(v=>v.id===R).rels.parents.forEach(v=>{D.includes(v)&&(q.push(v),N(v))})}}function x(T){let D=T[0];if(!l)return console.error(`${t} not found in main_ancestry`);let q=f===l.found[0]?l.found[1]:l.found[0];D.rels.spouses=[q];let N=n.find(P=>P.id===q),R={id:N.id,data:JSON.parse(JSON.stringify(N.data)),kinship:r[N.id],rels:{spouses:[D.id],children:D.rels.children,parents:[]}};T.push(R),(D.rels.children||[]).forEach(P=>{let X=n.find(I=>I.id===P),v=T.find(I=>I.id===P);v.rels.parents=[...X.rels.parents]})}function _(T){s.includes("sister")||s.includes("brother")?O(T):S(T)}function S(T){let D=T.find(P=>P.id===t),q=o;D.rels.spouses=[q];let N=n.find(P=>P.id===q),R={id:N.id,data:JSON.parse(JSON.stringify(N.data)),kinship:r[N.id],rels:{spouses:[D.id],children:[],parents:[]}};T.push(R)}function O(T){var D;let q=T.find(I=>I.id===t),N=L(o);T.push({id:o,data:JSON.parse(JSON.stringify(N.data)),kinship:r[o],rels:{spouses:[],children:[],parents:[]}});let R=[];N.rels.parents.forEach(I=>(L(I).rels.children||[]).forEach(C=>R.push(C)));let P=(D=L(t).rels.spouses)===null||D===void 0?void 0:D.find(I=>R.includes(I));q.rels.spouses=[P];let X=L(P),v={id:X.id,data:JSON.parse(JSON.stringify(X.data)),kinship:r[X.id],rels:{spouses:[q.id],children:[],parents:[]}};T.push(v),N.rels.parents.forEach(I=>{let C=L(I),b=C.data.gender==="M"?"Father-in-law":C.data.gender==="F"?"Mother-in-law":"Parent-in-law",k={id:C.id,data:JSON.parse(JSON.stringify(C.data)),kinship:b,rels:{spouses:[],children:[P,o],parents:[]}},$=N.rels.parents.find(E=>E!==E);$&&k.rels.parents.push($),T.unshift(k)})}function L(T){return n.find(D=>D.id===T)}}function bs(e,t,n){let r=e.id;n.forEach(s=>{s.rels.parents.includes(r)&&(s.rels.parents[s.rels.parents.indexOf(r)]=t),s.rels.spouses&&s.rels.spouses.includes(r)&&(s.rels.spouses=s.rels.spouses.filter(l=>l!==r),s.rels.spouses.includes(t)||s.rels.spouses.push(t)),s.rels.children&&s.rels.children.includes(r)&&(s.rels.children=s.rels.children.filter(l=>l!==r),s.rels.children.includes(t)||s.rels.children.push(t))});let i=n.find(s=>s.id===t),o=n.find(s=>s.id===r);if(!o)throw new Error("New rel not found");if(!i)throw new Error("Link rel not found");if((o.rels.children||[]).forEach(s=>{i.rels.children||(i.rels.children=[]),i.rels.children.includes(s)||i.rels.children.push(s)}),(o.rels.spouses||[]).forEach(s=>{i.rels.spouses||(i.rels.spouses=[]),i.rels.spouses.includes(s)||i.rels.spouses.push(s)}),i.rels.parents.length===0)i.rels.parents=[...o.rels.parents];else{let s=i.rels.parents.find(p=>{var d;return((d=n.find(c=>c.id===p))===null||d===void 0?void 0:d.data.gender)==="M"}),l=i.rels.parents.find(p=>{var d;return((d=n.find(c=>c.id===p))===null||d===void 0?void 0:d.data.gender)==="F"}),f=o.rels.parents.find(p=>{var d;return((d=n.find(c=>c.id===p))===null||d===void 0?void 0:d.data.gender)==="M"}),u=o.rels.parents.find(p=>{var d;return((d=n.find(c=>c.id===p))===null||d===void 0?void 0:d.data.gender)==="F"});f&&(s?(console.error("link rel already has father"),i.rels.parents[i.rels.parents.indexOf(s)]=f):i.rels.parents.push(f)),u&&(l?(console.error("link rel already has mother"),i.rels.parents[i.rels.parents.indexOf(l)]=u):i.rels.parents.push(u))}n.splice(n.findIndex(s=>s.id===r),1)}function eu(e,t){let n=e._new_rel_data?t.find(l=>l.id===e._new_rel_data.rel_id):null,r=o(e,t),i=s(e,t);if(e._new_rel_data&&["son","daughter"].includes(e._new_rel_data.rel_type)){if(!n)throw new Error("Rel datum not found");i.push(...s(n,t))}return t.filter(l=>l.id!==e.id&&l.id!==n?.id&&!l._new_rel_data&&!l.to_add&&!l.unknown).filter(l=>!r.includes(l.id)).filter(l=>!i.includes(l.id)).filter(l=>!(l.rels.spouses||[]).includes(e.id));function o(l,f){let u=[];return p(l),u;function p(d){d.rels.parents.forEach(c=>{if(c){u.push(c);let a=f.find(h=>h.id===c);if(!a)throw new Error("Parent not found");p(a)}})}}function s(l,f){let u=[];return p(l),u;function p(d){(d.rels.children?[...d.rels.children]:[]).forEach(a=>{u.push(a);let h=f.find(m=>m.id===a);if(!h)throw new Error("Child not found");p(h)})}}}function tu({datum:e,store:t,fields:n,postSubmitHandler:r,addRelative:i,removeRelative:o,deletePerson:s,onCancel:l,editFirst:f,link_existing_rel_config:u,onFormCreation:p,no_edit:d,onSubmit:c,onDelete:a,canEdit:h,canDelete:m}){let g=m?m(e):!0;(h?h(e):!0)||(d=!0,g=!1);let x,_={datum_id:e.id,fields:[],onSubmit:D,onCancel:l,onFormCreation:p,no_edit:d,gender_field:S()};if(e._new_rel_data)x=Object.assign(Object.assign({},_),{title:e._new_rel_data.label,new_rel:!0,editable:!0});else{if(!i)throw new Error("addRelative is required");if(!o)throw new Error("removeRelative is required");x=Object.assign(Object.assign({},_),{onDelete:N,addRelative:()=>i.activate(e),addRelativeCancel:()=>i.onCancel(),addRelativeActive:i.is_active,removeRelative:()=>o.activate(e),removeRelativeCancel:()=>o.onCancel(),removeRelativeActive:o.is_active,editable:!1,can_delete:g})}return(e._new_rel_data||e.to_add||e.unknown)&&u&&(x.linkExistingRelative=T(e,t.getData(),u)),d?x.editable=!1:f&&(x.editable=!0),n.forEach(R=>{R.type==="rel_reference"?O(R):R.type==="select"?L(R):x.fields.push({id:R.id,type:R.type,label:R.label,initial_value:e.data[R.id]})}),x;function S(){return{id:"gender",type:"switch",label:"Gender",initial_value:e.data.gender,disabled:!1,options:[{value:"M",label:"Male"},{value:"F",label:"Female"}]}}function O(R){R.getRelLabel||console.error("getRelLabel is not set"),R.rel_type==="spouse"&&(e.rels.spouses||[]).forEach(P=>{let X=t.getDatum(P);if(!X)throw new Error("Spouse not found");let v=`${R.id}__ref__${P}`,I={id:v,type:"rel_reference",label:R.label,rel_id:P,rel_label:R.getRelLabel(X),initial_value:e.data[v],rel_type:R.rel_type};x.fields.push(I)})}function L(R){if(!R.options&&!R.optionCreator)return console.error("optionCreator or options is not set for field",R);let P={id:R.id,type:R.type,label:R.label,initial_value:e.data[R.id],placeholder:R.placeholder,options:R.options||R.optionCreator(e)};x.fields.push(P)}function T(R,P,X){if(!X)throw new Error("link_existing_rel_config is required");return{title:X.title,select_placeholder:X.select_placeholder,options:eu(R,P).map(I=>({value:I.id,label:X.linkRelLabel(I)})).sort((I,C)=>typeof I.label=="string"&&typeof C.label=="string"?I.label.localeCompare(C.label):I.label<C.label?-1:1),onSelect:q}}function D(R){c?c(R,e,P,()=>r({})):(R.preventDefault(),P(),r({}));function P(){let X=new FormData(R.target);So(e,t.getData(),X)}}function q(R){let P=R.target.value;r({link_rel_id:P})}function N(){a?a(e,()=>s(),()=>r({delete:!0})):(s(),r({delete:!0}))}}function nu(e,t){t.forEach(n=>{let r=n._new_rel_data;r&&r.rel_type==="spouse"&&(n.data.gender=n.data.gender==="M"?"F":"M")})}function ru(e){for(let t=e.length-1;t>=0;t--){let n=e[t];n._new_rel_data&&(e.forEach(r=>{r.rels.parents.includes(n.id)&&r.rels.parents.splice(r.rels.parents.indexOf(n.id),1),r.rels.children&&r.rels.children.includes(n.id)&&r.rels.children.splice(r.rels.children.indexOf(n.id),1),r.rels.spouses&&r.rels.spouses.includes(n.id)&&r.rels.spouses.splice(r.rels.spouses.indexOf(n.id),1)}),e.splice(t,1))}}function iu(e,t,n,r){let i={parent:!0,spouse:!0,child:!0};r&&(i=Object.assign(i,r(e))),e.rels.spouses||(e.rels.spouses=[]),e.rels.children||(e.rels.children=[]),i.parent&&o(),i.spouse&&(s(),l()),i.child&&f();function o(){let u=e.rels.parents,p=u.find(h=>{var m;return((m=t.find(g=>g.id===h))===null||m===void 0?void 0:m.data.gender)==="M"}),d=u.find(h=>{var m;return((m=t.find(g=>g.id===h))===null||m===void 0?void 0:m.data.gender)==="F"});if(u.length<2&&!p){let h=le({data:{gender:"M"},rels:{children:[e.id]}});h._new_rel_data={rel_type:"father",label:n.father,rel_id:e.id},e.rels.parents.push(h.id),t.push(h)}if(u.length<2&&!d){let h=le({data:{gender:"F"},rels:{children:[e.id]}});h._new_rel_data={rel_type:"mother",label:n.mother,rel_id:e.id},e.rels.parents.push(h.id),t.push(h)}let c=t.find(h=>h.id===e.rels.parents[0]),a=t.find(h=>h.id===e.rels.parents[1]);c.rels.spouses||(c.rels.spouses=[]),a.rels.spouses||(a.rels.spouses=[]),c.rels.spouses.includes(a.id)||c.rels.spouses.push(a.id),a.rels.spouses.includes(c.id)||a.rels.spouses.push(c.id),c.rels.children||(c.rels.children=[]),a.rels.children||(a.rels.children=[]),c.rels.children.includes(e.id)||c.rels.children.push(e.id),a.rels.children.includes(e.id)||a.rels.children.push(e.id)}function s(){if(e.rels.spouses||(e.rels.spouses=[]),e.rels.children){let u;e.rels.children.forEach(p=>{let d=t.find(c=>c.id===p);if(d.rels.parents.length===1){let a=t.find(h=>h.id===d.rels.parents[0]).data.gender==="M"?"F":"M";u||(u=le({data:{gender:a},rels:{spouses:[e.id]}})),u._new_rel_data={rel_type:"spouse",label:n.spouse,rel_id:e.id},u.rels.children.push(d.id),e.rels.spouses.push(u.id),d.rels.parents.push(u.id),t.push(u)}})}}function l(){e.rels.spouses||(e.rels.spouses=[]);let u=e.data.gender==="M"?"F":"M",p=le({data:{gender:u},rels:{spouses:[e.id]}});p._new_rel_data={rel_type:"spouse",label:n.spouse,rel_id:e.id},e.rels.spouses.push(p.id),t.push(p)}function f(){e.rels.children||(e.rels.children=[]),e.rels.spouses||(e.rels.spouses=[]),e.rels.spouses.forEach(u=>{let p=t.find(a=>a.id===u);p.rels.children||(p.rels.children=[]);let d=le({data:{gender:"M"},rels:{parents:[e.id,p.id]}});d._new_rel_data={rel_type:"son",label:n.son,other_parent_id:p.id,rel_id:e.id},p.rels.children.push(d.id),e.rels.children.push(d.id),t.push(d);let c=le({data:{gender:"F"},rels:{parents:[e.id,p.id]}});c._new_rel_data={rel_type:"daughter",label:n.daughter,other_parent_id:p.id,rel_id:e.id},p.rels.children.push(c.id),e.rels.children.push(c.id),t.push(c)})}return t}var ou=(e,t,n)=>new Cn(e,t,n),Cn=class{constructor(t,n,r){return this.store=t,this.onActivate=n,this.cancelCallback=r,this.datum=null,this.onChange=null,this.onCancel=null,this.is_active=!1,this.addRelLabels=this.addRelLabelsDefault(),this}activate(t){this.is_active&&this.onCancel(),this.onActivate(),this.is_active=!0,this.store.state.one_level_rels=!0;let n=this.store;this.datum=t;let r=this.datum.data.gender;iu(t,this.getStoreData(),this.addRelLabels,this.canAdd),n.updateTree({}),this.onChange=i,this.onCancel=()=>o(this);function i(s,l){s?._new_rel_data?l?.link_rel_id?bs(s,l.link_rel_id,n.getData()):delete s._new_rel_data:s.id===t.id?s.data.gender!==r&&(r=s.data.gender,nu(s,n.getData())):console.error("Something went wrong")}function o(s){s.is_active&&(s.is_active=!1,s.store.state.one_level_rels=!1,s.cleanUp(),s.cancelCallback(s.datum),s.datum=null,s.onChange=null,s.onCancel=null)}}setAddRelLabels(t){if(typeof t!="object"){console.error("add_rel_labels must be an object");return}for(let n in t){let r=n;this.addRelLabels[r]=t[r]}return this}setCanAdd(t){return this.canAdd=t,this}addRelLabelsDefault(){return{father:"Add Father",mother:"Add Mother",spouse:"Add Spouse",son:"Add Son",daughter:"Add Daughter"}}getStoreData(){return this.store.getData()}cleanUp(t){return t||(t=this.store.getData()),ru(t),t}},su=(e,t,n,r)=>new Sn(e,t,n,r),Sn=class{constructor(t,n,r,i){return this.store=t,this.onActivate=n,this.cancelCallback=r,this.modal=i,this.datum=null,this.onChange=null,this.onCancel=null,this.is_active=!1,this}activate(t){this.is_active&&this.onCancel(),this.onActivate(),this.is_active=!0,this.store.state.one_level_rels=!0;let n=this.store;n.updateTree({}),this.datum=t,this.onChange=r.bind(this),this.onCancel=i.bind(this);function r(o,s){let l=c(o),f=t.rels;l==="parent"?u.call(this):l==="spouse"?p.call(this):l==="children"&&d.call(this);function u(){let a=o.data.id,h=n.getDatum(a);if(!h)throw new Error("Parent not found");if(!h.rels.children)throw new Error("Parent has no children");h.rels.children=h.rels.children.filter(m=>m!==t.id),f.parents=f.parents.filter(m=>m!==a),s()}function p(){let a=o.data;h()?m.call(this):g.call(this,!0);function h(){return(a.rels.children||[]).some(x=>{let _=n.getDatum(x);if(!_)throw new Error("Child not found");return!!_.rels.parents.includes(a.id)})}function m(){let y=t.data.gender==="M"?"f3-male-bg":t.data.gender==="F"?"f3-female-bg":null,x=a.data.gender==="M"?"f3-male-bg":a.data.gender==="F"?"f3-female-bg":null,_=se("div").html(`
            <p>You are removing a spouse relationship. Since there are shared children, please choose which parent should keep them in the family tree.</p>
            <div class="f3-modal-options">
              <button data-option="assign-to-current" class="f3-btn ${y}">Keep children with current person</button>
              <button data-option="assign-to-spouse" class="f3-btn ${x}">Keep children with spouse</button>
            </div>
          `);_.selectAll('[data-option="assign-to-current"]').on("click",()=>{g(!0),this.modal.close()}),_.selectAll('[data-option="assign-to-spouse"]').on("click",()=>{g(!1),this.modal.close()}),this.modal.activate(_.node())}function g(y){o.data.rels.spouses=o.data.rels.spouses.filter(S=>S!==t.id),f.spouses=f.spouses.filter(S=>S!==o.data.id);let x=y?t:o.data,_=y?o.data:t;(f.children||[]).forEach(S=>{let O=n.getDatum(S);if(!O)throw new Error("Child not found");O.rels.parents.includes(_.id)&&(O.rels.parents=O.rels.parents.filter(L=>L!==_.id))}),_.rels.children&&(_.rels.children=_.rels.children.filter(S=>!(x.rels.children||[]).includes(S))),s()}}function d(){if(!f.children)throw new Error("Children not found");f.children=f.children.filter(a=>a!==o.data.id),o.data.rels.parents=o.data.rels.parents.filter(a=>a!==t.id),s()}function c(a){if(a.is_ancestry){if(t.rels.parents.includes(a.data.id))return"parent"}else if(a.spouse){if(!t.rels.spouses)throw new Error("Spouses not found");if(t.rels.spouses.includes(a.data.id))return"spouse"}else{if(!t.rels.children)throw new Error("Children not found");if(t.rels.children.includes(a.data.id))return"children"}return null}}function i(){if(this.is_active){if(this.is_active=!1,this.store.state.one_level_rels=!1,!this.datum)throw new Error("Datum not found");this.cancelCallback(this.datum),this.datum=null,this.onChange=null,this.onCancel=null}}}};function au(e){return new kn(e)}var kn=class{constructor(t){this.cont=t,this.active=!1,this.onClose=null,this.modal_cont=w(this.cont).append("div").attr("class","f3-modal").node(),w(this.modal_cont).style("display","none"),this.create()}create(){let t=w(this.modal_cont);t.html(`
      <div class="f3-modal-content">
        <span class="f3-modal-close">&times;</span>
        <div class="f3-modal-content-inner"></div>
        <div class="f3-modal-content-bottom"></div>
      </div>
    `),t.select(".f3-modal-close").on("click",()=>{this.close()}),t.on("click",n=>{n.target==t.node()&&this.close()})}activate(t,{boolean:n,onAccept:r,onCancel:i}={}){this.reset();let o=w(this.modal_cont).select(".f3-modal-content-inner").node();if(typeof t=="string"?o.innerHTML=t:o.appendChild(t),n){if(!r)throw new Error("onAccept is required");if(!i)throw new Error("onCancel is required");w(this.modal_cont).select(".f3-modal-content-bottom").html(`
        <button class="f3-modal-accept f3-btn">Accept</button>
        <button class="f3-modal-cancel f3-btn">Cancel</button>
      `),w(this.modal_cont).select(".f3-modal-accept").on("click",()=>{r(),this.reset(),this.close()}),w(this.modal_cont).select(".f3-modal-cancel").on("click",()=>{this.close()}),this.onClose=i}this.open()}reset(){this.onClose=null,w(this.modal_cont).select(".f3-modal-content-inner").html(""),w(this.modal_cont).select(".f3-modal-content-bottom").html("")}open(){this.modal_cont.style.display="block",this.active=!0}close(){this.modal_cont.style.display="none",this.active=!1,this.onClose&&this.onClose()}},lu=(e,t)=>new $n(e,t),$n=class{constructor(t,n){return this.cont=t,this.store=n,this.fields=[{type:"text",label:"first name",id:"first name"},{type:"text",label:"last name",id:"last name"},{type:"text",label:"birthday",id:"birthday"},{type:"text",label:"avatar",id:"avatar"}],this.is_fixed=!0,this.no_edit=!1,this.onChange=null,this.editFirst=!1,this.postSubmit=null,this.onFormCreation=null,this.createFormEdit=null,this.createFormNew=null,this.formCont=this.getFormContDefault(),this.modal=this.setupModal(),this.addRelativeInstance=this.setupAddRelative(),this.removeRelativeInstance=this.setupRemoveRelative(),this.history=this.createHistory(),this}open(t){t.rels||(t=t.data),this.addRelativeInstance.is_active?n(this):this.removeRelativeInstance.is_active?r(this,this.store.getTreeDatum(t.id)):this.cardEditForm(t);function n(i){t._new_rel_data?i.cardEditForm(t):(i.addRelativeInstance.onCancel(),i.cardEditForm(t),i.store.updateMainId(t.id),i.store.updateTree({}))}function r(i,o){if(!o)throw new Error("Tree datum not found");if(!i.removeRelativeInstance.datum)throw new Error("Remove relative datum not found");if(!i.removeRelativeInstance.onCancel)throw new Error("Remove relative onCancel not found");if(!i.removeRelativeInstance.onChange)throw new Error("Remove relative onChange not found");if(t.id===i.removeRelativeInstance.datum.id)i.removeRelativeInstance.onCancel(),i.cardEditForm(t);else{let s=function(){i.removeRelativeInstance.onCancel(),i.updateHistory(),i.store.updateTree({})};i.removeRelativeInstance.onChange(o,s.bind(i))}}}setupAddRelative(){return ou(this.store,()=>t(this),r=>n(this,r));function t(r){r.removeRelativeInstance.is_active&&r.removeRelativeInstance.onCancel()}function n(r,i){r.store.updateMainId(i.id),r.store.updateTree({}),r.openFormWithId(i.id)}}setupRemoveRelative(){return su(this.store,t.bind(this),n.bind(this),this.modal);function t(){this.addRelativeInstance.is_active&&this.addRelativeInstance.onCancel(),r(this.cont,!0)}function n(i){r(this.cont,!1),this.store.updateMainId(i.id),this.store.updateTree({}),this.openFormWithId(i.id)}function r(i,o){w(i).select("#f3Canvas").classed("f3-remove-relative-active",o)}}createHistory(){let t=fs(this.store,this._getStoreDataCopy.bind(this),i.bind(this)),n=this.cont.querySelector(".f3-nav-cont");if(!n)throw new Error("Nav cont not found");let r=ds(n,t);return t.changed(),r.updateButtons(),Object.assign(Object.assign({},t),{controls:r});function i(){var o;console.log("historyUpdateTree"),this.addRelativeInstance.is_active&&this.addRelativeInstance.onCancel(),this.removeRelativeInstance.is_active&&this.removeRelativeInstance.onCancel(),this.store.updateTree({initial:!1}),this.history.controls.updateButtons(),this.openFormWithId((o=this.store.getMainDatum())===null||o===void 0?void 0:o.id),this.onChange&&this.onChange()}}openWithoutRelCancel(t){this.cardEditForm(t)}getFormContDefault(){let t=w(this.cont).select("div.f3-form-cont").node();return t||(t=w(this.cont).append("div").classed("f3-form-cont",!0).node()),{el:t,populate(n){t.innerHTML="",t.appendChild(n)},open(){w(t).classed("opened",!0)},close(){w(t).classed("opened",!1).html("")}}}setFormCont(t){return this.formCont=t,this}cardEditForm(t){let n={},r=t?._new_rel_data;r?n.onCancel=()=>this.addRelativeInstance.onCancel():(n.addRelative=this.addRelativeInstance,n.removeRelative=this.removeRelativeInstance,n.deletePerson=()=>{Nn(t,this.store.getData()),this.openFormWithId(this.store.getLastAvailableMainDatum().id),this.store.updateTree({})});let i=tu(Object.assign({store:this.store,datum:t,postSubmitHandler:l=>s(this,l),fields:this.fields,onCancel:()=>{},editFirst:this.editFirst,no_edit:this.no_edit,link_existing_rel_config:this.link_existing_rel_config,onFormCreation:this.onFormCreation,onSubmit:this.onSubmit,onDelete:this.onDelete,canEdit:this.canEdit,canDelete:this.canDelete},n)),o=r?(this.createFormNew||ls)(i,this.closeForm.bind(this)):(this.createFormEdit||cs)(i,this.closeForm.bind(this));this.formCont.populate(o),this.openForm();function s(l,f){if(l.addRelativeInstance.is_active){l.addRelativeInstance.onChange(t,f),l.postSubmit&&l.postSubmit(t,l.store.getData());let u=l.addRelativeInstance.datum;if(!u)throw new Error("Active datum not found");l.store.updateMainId(u.id),l.openWithoutRelCancel(u)}else(t.to_add||t.unknown)&&f?.link_rel_id?(bs(t,f.link_rel_id,l.store.getData()),l.store.updateMainId(f.link_rel_id),l.openFormWithId(f.link_rel_id)):f?.delete||(l.postSubmit&&l.postSubmit(t,l.store.getData()),l.openFormWithId(t.id));l.is_fixed||l.closeForm(),l.store.updateTree({}),l.updateHistory()}}openForm(){this.formCont.open()}closeForm(){this.formCont.close(),this.store.updateTree({})}fixed(){return this.is_fixed=!0,this.formCont.el&&w(this.formCont.el).style("position","relative"),this}absolute(){return this.is_fixed=!1,this.formCont.el&&w(this.formCont.el).style("position","absolute"),this}setCardClickOpen(t){return t.setOnCardClick((n,r)=>{this.isAddingRelative()?this.open(r.data):this.isRemovingRelative()?this.open(r.data):(this.open(r.data),t.onCardClickDefault(n,r))}),this}openFormWithId(t){if(t){let n=this.store.getDatum(t);if(!n)throw new Error("Datum not found");this.openWithoutRelCancel(n)}else{let n=this.store.getMainDatum();if(!n)throw new Error("Main datum not found");this.openWithoutRelCancel(n)}}setNoEdit(){return this.no_edit=!0,this}setEdit(){return this.no_edit=!1,this}setFields(t){let n=[];if(!Array.isArray(t))return console.error("fields must be an array"),this;for(let r of t)typeof r=="string"?n.push({type:"text",label:r,id:r}):typeof r=="object"?r.id?n.push(r):console.error("fields must be an array of objects with id property"):console.error("fields must be an array of strings or objects");return this.fields=n,this}setOnChange(t){return this.onChange=t,this}setCanEdit(t){return this.canEdit=t,this}setCanDelete(t){return this.canDelete=t,this}setCanAdd(t){return this.addRelativeInstance.setCanAdd(t),this}addRelative(t){return t||(t=this.store.getMainDatum()),this.addRelativeInstance.activate(t),this}setupModal(){return au(this.cont)}setEditFirst(t){return this.editFirst=t,this}isAddingRelative(){return this.addRelativeInstance.is_active}isRemovingRelative(){return this.removeRelativeInstance.is_active}setAddRelLabels(t){return this.addRelativeInstance.setAddRelLabels(t),this}setLinkExistingRelConfig(t){return this.link_existing_rel_config=t,this}setOnFormCreation(t){return this.onFormCreation=t,this}setCreateFormEdit(t){return this.createFormEdit=t,this}setCreateFormNew(t){return this.createFormNew=t,this}_getStoreDataCopy(){let t=JSON.parse(JSON.stringify(this.store.getData()));return this.addRelativeInstance.is_active&&(t=this.addRelativeInstance.cleanUp(t)),t=Eo(t),t}getStoreDataCopy(){return this.exportData()}exportData(){let t=this._getStoreDataCopy();return t=Mn(t,this.store.state.legacy_format),t}getDataJson(){return JSON.stringify(this.exportData(),null,2)}updateHistory(){this.history&&(this.history.changed(),this.history.controls.updateButtons()),this.onChange&&this.onChange()}setPostSubmit(t){return this.postSubmit=t,this}setOnSubmit(t){return this.onSubmit=t,this}setOnDelete(t){return this.onDelete=t,this}destroy(){return this.history.controls.destroy(),this.history=null,this.formCont.el&&w(this.formCont.el).remove(),this.addRelativeInstance.onCancel&&this.addRelativeInstance.onCancel(),this.store.updateTree({}),this}};function cu(e,t,n){let r=[];t.data.forEach(c=>{c.coparent&&c.data.data.gender==="F"&&r.push({nodes:[c,c.coparent],id:`${c.data.id}--${c.coparent.data.id}`}),c.spouses&&c.spouses.forEach(a=>r.push({nodes:[a,c],id:`${a.data.id}--${c.data.id}`}))});let i=w(e).select(".links_view").selectAll("g.link-text").data(r,c=>c.id),o=i.exit(),s=i.enter().append("g").attr("class","link-text"),l=s.merge(i),f=(c,a)=>c.spouse&&c.data.data.gender==="F"?c.x-n.node_separation/2:a.spouse&&a.data.data.gender==="M"?a.x+n.node_separation/2:Math.min(c.x,a.x)+n.node_separation/2;o.each(d),s.each(u),l.each(p);function u(c){let[a,h]=c.nodes,m=w(this);m.attr("transform",`translate(${f(a,h)}, ${a.y-3})`).style("opacity",0),m.append("text").style("font-size","12px").style("fill","#fff").style("text-anchor","middle")}function p(c){let[a,h]=c.nodes,m=w(this),g=n.initial?Le(t,a,n.transition_time):0;m.select("text").text(n.linkSpouseText(a,h)),m.transition("text").duration(n.transition_time).delay(g).attr("transform",`translate(${f(a,h)}, ${a.y-3})`),m.transition("text-op").duration(100).delay(g+n.transition_time).style("opacity",1)}function d(c){let a=w(this);a.transition("text").duration(100).style("opacity",0).on("end",()=>a.remove())}}function uu(e,t,n={}){return new En(e,t,n)}var En=class{constructor(t,n,r={}){this.cont=t,this.options=[],this.onSelect=n,this.config=r,this.autocomplete_cont=w(this.cont).append("div").attr("class","f3-autocomplete-cont").node(),this.create()}create(){var t;let n=this;w(this.autocomplete_cont).html(`
      <div class="f3-autocomplete">
        <div class="f3-autocomplete-input-cont">
          <input type="text" placeholder="${((t=this.config)===null||t===void 0?void 0:t.placeholder)||"Search"}">
          <span class="f3-autocomplete-toggle">${es()}</span>
        </div>
        <div class="f3-autocomplete-items" tabindex="0"></div>
      </div>
    `);let r=w(this.autocomplete_cont).select(".f3-autocomplete"),i=r.select("input"),o=r.select(".f3-autocomplete-items");r.on("focusout",()=>{setTimeout(()=>{r.node().contains(document.activeElement)||l()},200)}),i.on("focus",()=>{u(),s()}).on("input",s).on("keydown",p),o.on("wheel",d=>d.stopPropagation()),r.select(".f3-autocomplete-toggle").on("click",d=>{d.stopPropagation();let c=r.classed("active");r.classed("active",!c),c?l():(i.node().focus(),s())});function s(){r.classed("active",!0);let d=i.property("value"),c=n.options.filter(m=>m.label.toLowerCase().includes(d.toLowerCase()));c.forEach(a),c.sort(h),f(c);function a(m){let g=m.label.toLowerCase().indexOf(d.toLowerCase());g!==-1?m.label_html=y():m.label_html=m.label;function y(){return m.label.substring(0,g)+"<strong>"+m.label.substring(g,g+d.length)+"</strong>"+m.label.substring(g+d.length)}}function h(m,g){return m.label<g.label?-1:m.label>g.label?1:0}}function l(){r.classed("active",!1),f([])}function f(d){o.selectAll("div.f3-autocomplete-item").data(d,a=>a?.value).join("div").attr("class","f3-autocomplete-item").on("click",(a,h)=>{n.onSelect(h.value)}).html(a=>a.optionHtml?a.optionHtml(a):c(a));function c(a){return`<div class="${a.class?a.class:""}">${a.label_html}</div>`}}function u(){n.options=n.getOptions()}function p(d){let c=o.selectAll("div.f3-autocomplete-item").nodes(),a=c.findIndex(m=>w(m).classed("f3-selected"));if(d.key==="ArrowDown"){d.preventDefault();let m=a<c.length-1?a+1:0;h(c,m)}else if(d.key==="ArrowUp"){d.preventDefault();let m=a>0?a-1:c.length-1;h(c,m)}else if(d.key==="Enter"&&a!==-1){d.preventDefault();let m=w(c[a]).datum();m&&n.onSelect(m.value)}function h(m,g){m.forEach(y=>w(y).classed("f3-selected",!1)),m[g]&&(w(m[g]).classed("f3-selected",!0),m[g].scrollIntoView({block:"nearest"}))}}}setOptionsGetter(t){return this.getOptions=t,this}setOptionsGetterPerson(t,n){return this.getOptions=()=>{let o=[];return t().forEach(l=>{l.to_add||l.unknown||l._new_rel_data||o.find(f=>f.value===l.id)||o.push({label:n(l),value:l.id,optionHtml:r(l)})}),o},this;function r(o){let s=!Ln(o,t());return l=>`
        <div>
          <span style="float: left; width: 10px; height: 10px; margin-right: 10px;" class="f3-${i(o)}-color">${Pn()}</span>
          <span>${l.label_html}</span>
          ${s?`<span style="float: right; width: 10px; height: 10px; margin-left: 5px;" title="This profile is not connected to the main profile">${ts()}</span>`:""}
        </div>
      `}function i(o){return o.data.gender==="M"?"male":o.data.gender==="F"?"female":"genderless"}}destroy(){this.autocomplete_cont.remove()}};function Cs(e){let t=[];return Array.isArray(e)?e.forEach(n=>{typeof n=="function"?t.push(n):typeof n=="string"?t.push(r=>r.data[n]):Array.isArray(n)&&t.push(r=>n.map(i=>r.data[i]).join(" "))}):typeof e=="function"?t.push(e):typeof e=="string"&&t.push(n=>n.data[e]),t}function fu(e,t,n,r){let i=n.is_ancestry,o=t.data(),s=[],l=[];if(i){let d=[],c=n,a=0;for(;c!==r&&a<100;){a++;let m=o.find(g=>g.spouse===!0&&(g.source===c||g.target===c));if(m){let g=o.filter(x=>Array.isArray(x.target)&&x.target.includes(m.source)&&x.target.includes(m.target)),y=p(g,r);if(!y)break;d.push(m),d.push(y),c=y.source}else{let g=o.filter(x=>Array.isArray(x.target)&&x.target.includes(c)),y=p(g,r);if(!y)break;d.push(y),c=y.source}}t.each(function(m){d.includes(m)&&s.push({link:m,node:this})});let h=u(n,d);e.each(function(m){h.includes(m)&&l.push({card:m,node:this})})}else if(n.spouse&&n.spouse.data===r.data){t.each(function(c){c.target===n&&s.push({link:c,node:this})});let d=[r,n];e.each(function(c){d.includes(c)&&l.push({card:c,node:this})})}else if(n.sibling){t.each(function(c){if(!Array.isArray(n.parents))throw new Error("datum.parents is not an array");c.source===n&&s.push({link:c,node:this}),c.source===r&&Array.isArray(c.target)&&c.target.length===2&&s.push({link:c,node:this}),n.parents.includes(c.source)&&!Array.isArray(c.target)&&n.parents.includes(c.target)&&s.push({link:c,node:this})});let d=[r,n,...n.parents||[]];e.each(function(c){d.includes(c)&&l.push({card:c,node:this})})}else{let d=[],c=n,a=0;for(;c!==r&&a<100;){a++;let m=o.find(g=>g.target===c&&Array.isArray(g.source));if(m){let g=o.find(y=>y.spouse===!0&&f([y.source,y.target],m.source));d.push(m),d.push(g),g?c=g.source:c=m.source[0]}else{let g=o.find(y=>y.target===c&&!Array.isArray(y.source));if(!g)break;d.push(g),c=g.source}}t.each(function(m){d.includes(m)&&s.push({link:m,node:this})});let h=u(r,d);e.each(function(m){h.includes(m)&&l.push({card:m,node:this})})}return{cards_node_to_main:l,links_node_to_main:s};function f(d,c){return d.every(a=>c.some(h=>a===h))}function u(d,c){let a=c.filter(g=>g).reduce((g,y)=>(Array.isArray(y.target)?g.push(...y.target):g.push(y.target),Array.isArray(y.source)?g.push(...y.source):g.push(y.source),g),[]),h=[r,n];return m(d),h;function m(g){g.data.rels.children&&g.data.rels.children.forEach(y=>{let x=a.find(_=>_.data.id===y);x&&(h.push(x),m(x))})}}function p(d,c){return d.length===0?null:d.length===1?d[0]:d.find(a=>a.source===c)}}function Dt(e,t){return new du(e,t)}var du=class{constructor(t,n){return this.cont=t,this.svg=this.cont.querySelector("svg.main_svg"),this.store=n,this.card_display=[r=>`${r.data["first name"]} ${r.data["last name"]}`],this.cardImageField="avatar",this.onCardClick=this.onCardClickDefault,this.style="default",this.mini_tree=!1,this.card_dim={},this}getCard(){return ms({store:this.store,card_display:this.card_display,cardImageField:this.cardImageField,defaultPersonIcon:this.defaultPersonIcon,onCardClick:this.onCardClick,style:this.style,mini_tree:this.mini_tree,onCardUpdate:this.onCardUpdate,card_dim:this.card_dim,empty_card_label:this.store.state.single_parent_empty_card_label||"",unknown_card_label:this.store.state.unknown_card_label||"",cardInnerHtmlCreator:this.cardInnerHtmlCreator,duplicate_branch_toggle:this.store.state.duplicate_branch_toggle,onCardMouseenter:this.onCardMouseenter?this.onCardMouseenter.bind(this):void 0,onCardMouseleave:this.onCardMouseleave?this.onCardMouseleave.bind(this):void 0})}setCardDisplay(t){return this.card_display=Cs(t),this}setCardImageField(t){return this.cardImageField=t,this}setDefaultPersonIcon(t){return this.defaultPersonIcon=t,this}setOnCardClick(t){return this.onCardClick=t,this}onCardClickDefault(t,n){this.store.updateMainId(n.data.id),this.store.updateTree({})}setStyle(t){return this.style=t,this}setMiniTree(t){return this.mini_tree=t,this}setOnCardUpdate(t){return this.onCardUpdate=t,this}setCardDim(t){if(typeof t!="object")return console.error("card_dim must be an object"),this;for(let n in t){let r=t[n];if(typeof r!="number"&&typeof r!="boolean")return console.error(`card_dim.${n} must be a number or boolean`),this;n==="width"&&(n="w"),n==="height"&&(n="h"),n==="img_width"&&(n="img_w"),n==="img_height"&&(n="img_h"),n==="img_x"&&(n="img_x"),n==="img_y"&&(n="img_y"),this.card_dim[n]=r}return this}resetCardDim(){return this.card_dim={},this}setCardInnerHtmlCreator(t){return this.cardInnerHtmlCreator=t,this}setOnHoverPathToMain(){return this.onCardMouseenter=this.onEnterPathToMain.bind(this),this.onCardMouseleave=this.onLeavePathToMain.bind(this),this}unsetOnHoverPathToMain(){return this.onCardMouseenter=void 0,this.onCardMouseleave=void 0,this}onEnterPathToMain(t,n){this.to_transition=n.data.id;let r=this.store.getTreeMainDatum(),i=w(this.cont).select("div.cards_view").selectAll(".card_cont"),o=w(this.cont).select("svg.main_svg .links_view").selectAll(".link"),{cards_node_to_main:s,links_node_to_main:l}=fu(i,o,n,r);return s.forEach(f=>{let u=Math.abs(n.depth-f.card.depth)*200;w(f.node.querySelector("div.card-inner")).transition().duration(0).delay(u).on("end",()=>this.to_transition===n.data.id&&w(f.node.querySelector("div.card-inner")).classed("f3-path-to-main",!0))}),l.forEach(f=>{let u=Math.abs(n.depth-f.link.depth)*200;w(f.node).transition().duration(0).delay(u).on("end",()=>this.to_transition===n.data.id&&w(f.node).classed("f3-path-to-main",!0))}),this}onLeavePathToMain(t,n){return this.to_transition=!1,w(this.cont).select("div.cards_view").selectAll("div.card-inner").classed("f3-path-to-main",!1),w(this.cont).select("svg.main_svg .links_view").selectAll(".link").classed("f3-path-to-main",!1),this}};function Ot(e,t){return new hu(e,t)}var hu=class{constructor(t,n){return this.cont=t,this.store=n,this.svg=this.cont.querySelector("svg.main_svg"),this.card_dim={w:220,h:70,text_x:75,text_y:15,img_w:60,img_h:60,img_x:5,img_y:5},this.card_display=[],this.mini_tree=!0,this.link_break=!1,this.onCardClick=this.onCardClickDefault.bind(this),this}getCard(){return qn({store:this.store,svg:this.svg,card_dim:this.card_dim,card_display:this.card_display,mini_tree:this.mini_tree,link_break:this.link_break,onCardClick:this.onCardClick,onCardUpdate:this.onCardUpdate})}setCardDisplay(t){return this.card_display=Cs(t),this}setCardDim(t){if(typeof t!="object")return console.error("card_dim must be an object"),this;for(let n in t){let r=t[n];if(typeof r!="number"&&typeof r!="boolean")return console.error(`card_dim.${n} must be a number or boolean`),this;n==="width"&&(n="w"),n==="height"&&(n="h"),n==="img_width"&&(n="img_w"),n==="img_height"&&(n="img_h"),n==="img_x"&&(n="img_x"),n==="img_y"&&(n="img_y"),this.card_dim[n]=r}return Qc(this.svg,this.card_dim),this}setOnCardUpdate(t){return this.onCardUpdate=t,this}setMiniTree(t){return this.mini_tree=t,this}setLinkBreak(t){return this.link_break=t,this}onCardClickDefault(t,n){this.store.updateMainId(n.data.id),this.store.updateTree({})}setOnCardClick(t){return this.onCardClick=t,this}};function Vn(e,t){return new In(e,t)}var In=class{constructor(t,n){this.getCard=null,this.transition_time=2e3,this.linkSpouseText=null,this.personSearch=null,this.is_card_html=!1,this.beforeUpdate=null,this.afterUpdate=null,this.cont=pu(t);let{svg:r}=Rn(this.cont);this.svg=r,mu(this.cont);let i=n&&n.length>0?n[0].id:"";return this.store=this.createStore(n,i),this.setOnUpdate(),this.editTreeInstance=null,this}createStore(t,n){return Tn({data:t,main_id:n,node_separation:250,level_separation:150,single_parent_empty_card:!0,is_horizontal:!1})}setOnUpdate(){this.store.setOnUpdate(t=>{this.beforeUpdate&&this.beforeUpdate(t),t=Object.assign({transition_time:this.store.state.transition_time},t||{}),this.is_card_html&&(t=Object.assign({},t||{},{cardHtml:!0})),On(this.store.getTree(),this.svg,this.getCard(),t||{}),this.linkSpouseText&&cu(this.svg,this.store.getTree(),Object.assign({},t||{},{linkSpouseText:this.linkSpouseText,node_separation:this.store.state.node_separation})),this.afterUpdate&&this.afterUpdate(t)})}updateTree(t={initial:!1}){return this.store.updateTree(t),this}updateData(t){return this.store.updateData(t),this}setCardYSpacing(t){return typeof t!="number"?(console.error("card_y_spacing must be a number"),this):(this.store.state.level_separation=t,this)}setCardXSpacing(t){return typeof t!="number"?(console.error("card_x_spacing must be a number"),this):(this.store.state.node_separation=t,this)}setOrientationVertical(){return this.store.state.is_horizontal=!1,this}setOrientationHorizontal(){return this.store.state.is_horizontal=!0,this}setShowSiblingsOfMain(t){return this.store.state.show_siblings_of_main=t,this}setModifyTreeHierarchy(t){return this.store.state.modifyTreeHierarchy=t,this}setPrivateCardsConfig(t){return this.store.state.private_cards_config=t,this}setLinkSpouseText(t){return this.linkSpouseText=t,this}setSingleParentEmptyCard(t,{label:n="Unknown"}={}){return this.store.state.single_parent_empty_card=t,this.store.state.single_parent_empty_card_label=n,this.editTreeInstance&&this.editTreeInstance.addRelativeInstance.is_active&&this.editTreeInstance.addRelativeInstance.onCancel(),Nt(this.store.getData()||[]),this}setCard(t){if(t===Dt)return this.setCardHtml();if(t===Ot)return this.setCardSvg();throw new Error("Card must be an instance of cardHtml or cardSvg")}setCardHtml(){let t=this.cont.querySelector("#htmlSvg");if(!t)throw new Error("htmlSvg not found");this.is_card_html=!0,this.svg.querySelector(".cards_view").innerHTML="",t.style.display="block";let n=Dt(this.cont,this.store);return this.getCard=()=>n.getCard(),n}setCardSvg(){let t=this.cont.querySelector("#htmlSvg");if(!t)throw new Error("htmlSvg not found");this.is_card_html=!1,this.svg.querySelector(".cards_view").innerHTML="",t.style.display="none";let n=Ot(this.cont,this.store);return this.getCard=()=>n.getCard(),n}setTransitionTime(t){return this.store.state.transition_time=t,this}setSortChildrenFunction(t){return this.store.state.sortChildrenFunction=t,this}setSortSpousesFunction(t){return this.store.state.sortSpousesFunction=t,this}setAncestryDepth(t){return this.store.state.ancestry_depth=t,this}setProgenyDepth(t){return this.store.state.progeny_depth=t,this}getMaxDepth(t){return dc(t,this.store.getData())}calculateKinships(t,n={}){return ys(t,this.store.getData(),n)}getKinshipsDataStash(t,n){return ws(t,n,this.store.getData(),this.calculateKinships(t))}setDuplicateBranchToggle(t){return this.store.state.duplicate_branch_toggle=t,this}editTree(){return this.editTreeInstance=lu(this.cont,this.store)}updateMain(t){let n;return t.id?n=t.id:n=t.data.id,this.store.updateMainId(n),this.store.updateTree({}),this}updateMainId(t){return this.store.updateMainId(t),this}getMainDatum(){return this.store.getMainDatum()}setBeforeUpdate(t){return this.beforeUpdate=t,this}setAfterUpdate(t){return this.afterUpdate=t,this}setPersonDropdown(t,{cont:n=this.cont.querySelector(".f3-nav-cont"),onSelect:r,placeholder:i="Search"}={}){r||(r=o.bind(this)),this.personSearch=uu(n,r,{placeholder:i}),this.personSearch.setOptionsGetterPerson(this.store.getData,t);function o(s){let l=this.store.getDatum(s);if(!l)throw new Error("Datum not found");this.editTreeInstance&&this.editTreeInstance.open(l),this.updateMainId(s),this.updateTree({initial:!1})}return this}unSetPersonSearch(){return this.personSearch.destroy(),this.personSearch=null,this}};function pu(e){if(typeof e=="string"&&(e=document.querySelector(e)),!e)throw new Error("cont not found");return e}function mu(e){w(e).append("div").attr("class","f3-nav-cont")}function gu(e,t,n){let{self_id:r,getLabel:i,title:o}=e,s=ys(r,n,e),l=s[t];if(!l)return;let f=l;l==="self"?f="You":f=Ss(f);let u=`
    <div class="f3-kinship-info">
      <div class="f3-info-field">
        <span class="f3-info-field-label">${o}</span>
        <span class="f3-info-field-value">
          <span>${f}</span>
          <span class="f3-kinship-info-icon">${ns()}</span>
        </span>
      </div>
    </div>
  `,p=se("div").html(u).select("div").node(),d=null;return w(p).select(".f3-kinship-info-icon").on("click",a=>c(a,p)),p;function c(a,h){let y=a.clientX-250-10,x=a.clientY-400-10;if(y+250>window.innerWidth&&(y=window.innerWidth-250-10),x<0&&(x=10),d&&d.active){d.close(),d=null;return}d=_s(h),w(d.popup_cont).style("width","250px").style("height","400px").style("left",`${y}px`).style("top",`${x}px`);let _=d.popup_cont.querySelector(".f3-popup-content-inner");d.activate(),_u(r,t,n,s,_,i)}}function _u(e,t,n,r,i,o){w(i).select("#SmallChart").node()||w(i).append("div").attr("id","SmallChart").attr("class","f3");let s=w("#SmallChart");s.selectAll("*").remove();let l=ws(e,t,n,r),f=!0,u=s.append("div");p(l);function p(d){let c=Vn("#SmallChart",d).setTransitionTime(500).setCardXSpacing(170).setCardYSpacing(70).setSingleParentEmptyCard(!1),a=c.setCardHtml().setStyle("rect").setCardInnerHtmlCreator(y=>h(y)).setOnCardUpdate(function(y){w(this).select(".card").classed("card-main",!1)});a.onCardClick=(y,x)=>{},c.updateTree({initial:!0}),setTimeout(()=>g(.65),100),m();function h(y){let x=y.data.kinship==="self"?"You":y.data.kinship;return x=Ss(x),f||(x=o(y.data)),`
        <div class="card-inner card-rect ${_()}">
          <div class="card-label">${x}</div>
        </div>
      `;function _(){return y.data.kinship==="self"?"card-kinship-self"+(f?"":" f3-real-label"):y.data.id===t?"card-kinship-rel":"card-kinship-default"}}function m(){u.classed("f3-kinship-labels-toggle",!0),u.append("label").text("Kinship labels").append("input").attr("type","checkbox").attr("checked",!0).on("change",y=>{f=!f,c.updateTree({initial:!1,tree_position:"inherit"})})}function g(y){let x=c.cont.querySelector("svg.main_svg");_o(x).k>y&&yo(x,y)}}}function Ss(e){return e=e[0].toUpperCase()+e.slice(1),e.includes("great-")&&(e=e.replace("great-","Great-")),e}var ks=Object.freeze({__proto__:null,Card:Bn,CardHtml:ms,CardSvg:qn,appendElement:wn,infoPopup:_s,kinshipInfo:gu});var U_=Object.assign({},Sc,{setupHtmlSvg:$c,setupReactiveTreeData:Ec,getUniqueId:Ic});return Os(yu);})();
