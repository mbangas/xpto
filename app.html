<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>myLineage — Cadastro</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css">
    <style>
      .photo-area{position:relative;display:inline-block;}
      .tag-overlay{position:absolute;left:0;top:0;right:0;bottom:0;pointer-events:none}
      .tag-rect{position:absolute;border:2px solid rgba(59,130,246,0.9);background:rgba(59,130,246,0.12);pointer-events:auto;cursor:pointer;border-radius:6px;box-sizing:border-box}
      .tag-label{position:absolute;background:rgba(0,0,0,0.6);color:#fff;padding:2px 6px;border-radius:6px;font-size:12px;transform:translateY(-120%);white-space:nowrap}
      .tag-form{position:absolute;background:var(--bg-card);padding:8px;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,0.4);z-index:620}
      .tag-form input{margin-bottom:6px;}
    </style>
    <script src="remote-storage.js"></script>
  </head>
  <body>
    <div class="app-shell">
      <aside class="sidebar">
        <a href="index.html" class="logo"><i class="mdi mdi-tree" aria-hidden="true"></i><span>myLineage</span></a>
        <nav>
          <a href="app.html" class="active"><i class="mdi mdi-account-multiple" aria-hidden="true"></i>Cadastro</a>
          <a href="indicadores.html"><i class="mdi mdi-chart-bar" aria-hidden="true"></i>Indicadores</a>
          <a href="arvore.html"><i class="mdi mdi-sitemap" aria-hidden="true"></i>Árvore</a>
          <a href="gedcom.html"><i class="mdi mdi-dna" aria-hidden="true"></i>GEDCOM</a>
          <a href="album.html"><i class="mdi mdi-image-multiple" aria-hidden="true"></i>Álbum</a>
          <a href="documentos.html"><i class="mdi mdi-folder-open" aria-hidden="true"></i>Documentos</a>
          <a href="validacao.html"><i class="mdi mdi-shield-check" aria-hidden="true"></i>Validação</a>
          <a href="historico.html"><i class="mdi mdi-history" aria-hidden="true"></i>Histórico</a>
        </nav>
        <div class="sidebar-footer">
          <a href="apis.html"><i class="mdi mdi-api" aria-hidden="true"></i>APIs</a>
          <a href="configuracao.html"><i class="mdi mdi-cog" aria-hidden="true"></i>Definições</a>
        </div>
      </aside>
      <main class="content">
        <div class="topbar">
          <div style="display:flex;align-items:center;gap:12px"><h1>Cadastro</h1></div>
        </div>
        <div style="padding:24px;display:flex;flex-direction:column;gap:16px;">

          <!-- Toolbar -->
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
            <div style="position:relative;flex:1;min-width:160px;max-width:320px;">
              <i class="mdi mdi-magnify" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text-disabled);font-size:1rem;pointer-events:none;"></i>
              <input id="nameFilter" type="search" placeholder="Pesquisar por nome…" autocomplete="off"
                style="width:100%;padding:7px 12px 7px 34px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-main);font-size:0.85rem;font-family:var(--font-main);outline:none;transition:border-color var(--transition);" />
            </div>
            <label style="display:flex;align-items:center;gap:6px;font-size:0.82rem;color:var(--text-secondary);cursor:pointer;user-select:none;white-space:nowrap;">
              <input type="checkbox" id="hideDeleted" checked /> Ocultar eliminados
            </label>
          </div>

          <!-- Summary -->
          <div id="tableSummary" style="font-size:0.78rem;color:var(--text-disabled);"></div>

          <!-- Table card -->
          <div class="card" style="padding:0;overflow:hidden;gap:0;">
            <table id="peopleTable">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Nascimento</th>
                  <th>Idade</th>
                  <th>Parentesco</th>
                  <th style="text-align:right;">Acções</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div id="paginationControls" style="padding:10px 20px;border-top:1px solid var(--border-subtle);min-height:42px;"></div>
          </div>

          <!-- Legenda Parentesco -->
          <div style="display:flex;align-items:center;flex-wrap:wrap;gap:12px;padding:10px 4px;">
            <span style="font-size:0.75rem;color:var(--text-disabled);font-weight:600;letter-spacing:0.04em;text-transform:uppercase;">Legenda:</span>
            <span style="display:inline-flex;align-items:center;gap:6px;font-size:0.78rem;color:var(--text-secondary);">
              <span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:rgba(68,147,248,0.25);border:1.5px solid #4493f8;flex-shrink:0;"></span>Linha directa
            </span>
            <span style="display:inline-flex;align-items:center;gap:6px;font-size:0.78rem;color:var(--text-secondary);">
              <span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:rgba(130,100,220,0.25);border:1.5px solid #9b7fe8;flex-shrink:0;"></span>Cônjuges &amp; afins
            </span>
            <span style="display:inline-flex;align-items:center;gap:6px;font-size:0.78rem;color:var(--text-secondary);">
              <span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:rgba(255,155,60,0.25);border:1.5px solid #c97c28;flex-shrink:0;"></span>Colaterais
            </span>
            <span style="display:inline-flex;align-items:center;gap:6px;font-size:0.78rem;color:var(--text-secondary);">
              <span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:rgba(255,215,0,0.25);border:1.5px solid rgba(200,170,0,0.7);flex-shrink:0;"></span>Pessoa em Foco
            </span>
          </div>

        </div>
      </main>
    </div>

    <!-- ── Right drawer overlay ── -->
    <div class="drawer-overlay" id="drawerOverlay"></div>

    <!-- ── Right drawer ── -->
    <div class="drawer" id="personDrawer" role="dialog" aria-modal="true" aria-labelledby="drawerTitle">
      <div class="drawer-header">
        <button class="btn btn-ghost btn-sm" id="drawerBackBtn" style="display:none;padding:2px 6px;margin-right:4px;" title="Voltar"><i class="mdi mdi-arrow-left"></i></button>
        <h2 id="drawerTitle" style="flex:1;">Detalhes da Pessoa</h2>
        <button class="drawer-close" id="drawerCloseBtn" aria-label="Fechar painel"><i class="mdi mdi-close"></i></button>
      </div>
      <div class="drawer-person-header" id="drawerPersonHeader">
        <div class="drawer-avatar" id="drawerAvatar"></div>
        <div>
          <div class="drawer-person-name" id="drawerPersonName">—</div>
          <div class="drawer-person-sub" id="drawerPersonSub"></div>
        </div>
      </div>
      <div class="drawer-body" id="drawerBody"></div>
      <div class="drawer-footer">
        <button class="btn btn-danger btn-sm" id="drawerDeleteBtn"><i class="mdi mdi-delete-outline"></i> Apagar</button>
        <button class="btn btn-ghost btn-sm" id="drawerCancelBtn">Cancelar</button>
        <button class="btn btn-sm" id="drawerSaveBtn"><i class="mdi mdi-content-save-outline"></i> Guardar</button>
      </div>
    </div>

    <script>
    (function(){
      'use strict';
      const DB = window.GedcomDB;

      /* ── Helpers ──────────────────────────────────────────────────────── */
      const MONTHS = ['','JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
      const MONTHS_MAP = {JAN:1,FEB:2,MAR:3,APR:4,MAY:5,JUN:6,JUL:7,AUG:8,SEP:9,OCT:10,NOV:11,DEC:12};
      const QUAL_TO_GED = {'Antes de':'BEF','Depois de':'AFT','Cerca de':'ABT'};
      const GED_TO_QUAL = {BEF:'Antes de',AFT:'Depois de',ABT:'Cerca de',EST:'Cerca de'};

      function buildGedcomDate(day,month,year,qualifier){
        let p=[];
        if(qualifier && qualifier!=='Exatamente'){ p.push(QUAL_TO_GED[qualifier]||qualifier); }
        if(day) p.push(String(day));
        if(month) p.push(MONTHS[month]||'');
        if(year) p.push(String(year));
        return p.join(' ');
      }
      function parseGedcomDate(s){
        if(!s) return {};
        const tokens=s.toUpperCase().split(/\s+/);
        let q=null,d=null,m=null,y=null;
        for(const t of tokens){
          if(GED_TO_QUAL[t]) q=GED_TO_QUAL[t];
          else if(MONTHS_MAP[t]) m=MONTHS_MAP[t];
          else if(/^\d{3,4}$/.test(t)) y=parseInt(t);
          else if(/^\d{1,2}$/.test(t)&&!d) d=parseInt(t);
        }
        return {day:d,month:m,year:y,qualifier:q};
      }
      function fmtEventDate(ev){
        if(!ev||!ev.date) return '';
        const p=parseGedcomDate(ev.date);
        const qualMap={'Antes de':'ant.','Depois de':'dep.','Cerca de':'c.'};
        const q=p.qualifier?(qualMap[p.qualifier]||p.qualifier)+' ':'';
        let parts=[];
        if(p.day) parts.push(String(p.day).padStart(2,'0'));
        if(p.month) parts.push(String(p.month).padStart(2,'0'));
        if(p.year) parts.push(String(p.year));
        return q+(parts.length?parts.join('/'):ev.date);
      }

      function _esc(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

      function formatISODate(dateStr){
        if(!dateStr) return '';
        const d=new Date(dateStr);
        if(isNaN(d)) return dateStr;
        return d.getDate().toString().padStart(2,'0')+'-'+(d.getMonth()+1).toString().padStart(2,'0')+'-'+d.getFullYear();
      }

      /* ── Pagination + filter ──────────────────────────────────────────── */
      let currentPage = 1;
      const PAGE_SIZE = 10;
      let currentFilter = '';

      function renderPagination(totalPages){
        const ctrl=document.getElementById('paginationControls');
        if(!ctrl) return;
        if(totalPages<=1){ ctrl.innerHTML=''; return; }
        ctrl.innerHTML='<div style="display:flex;align-items:center;gap:6px;"><button id="prevPage" '+(currentPage<=1?'disabled':'')+' class="icon-btn" aria-label="Página anterior"><i class="mdi mdi-chevron-left"></i></button><span style="font-size:0.82rem;color:var(--text-secondary);">Página '+currentPage+' de '+totalPages+'</span><button id="nextPage" '+(currentPage>=totalPages?'disabled':'')+' class="icon-btn" aria-label="Próxima página"><i class="mdi mdi-chevron-right"></i></button></div>';
        const prev=document.getElementById('prevPage'), next=document.getElementById('nextPage');
        if(prev) prev.addEventListener('click',function(){ if(currentPage>1){ currentPage--; renderTable(); }});
        if(next) next.addEventListener('click',function(){ if(currentPage<totalPages){ currentPage++; renderTable(); }});
      }

      function renderTable(){
        const tbody=document.querySelector('#peopleTable tbody');
        tbody.innerHTML='';
        const _focusedPerson=DB.getSetting('focusedPerson');
        const _focusedId=(_focusedPerson&&_focusedPerson.id)||null;
        const relMap=computeRelationships(_focusedId);
        const hideDeleted=document.getElementById('hideDeleted').checked;
        const all=DB.getIndividuals(!hideDeleted);
        const filtered=all.filter(indi=>{
          if(hideDeleted && indi.deletedAt) return false;
          if(!currentFilter) return true;
          return DB.getDisplayName(indi).toLowerCase().indexOf(currentFilter)!==-1;
        });
        const summaryEl=document.getElementById('tableSummary');
        if(summaryEl){
          const total=DB.getIndividuals(false).filter(i=>!i.deletedAt).length;
          summaryEl.textContent=filtered.length===0?'Sem registos':`${filtered.length} ${filtered.length===1?'pessoa':'pessoas'}${filtered.length!==total?' (filtrado de '+total+' no total)':''}`;
        }
        const totalPages=Math.max(1,Math.ceil(filtered.length/PAGE_SIZE));
        if(currentPage>totalPages) currentPage=totalPages;
        const start=(currentPage-1)*PAGE_SIZE;
        filtered.slice(start,start+PAGE_SIZE).forEach(indi=>{
          const tr=document.createElement('tr');
          if(indi.deletedAt) tr.classList.add('deleted');
          const name=_esc(DB.getDisplayName(indi));
          const avatarBg=indi.sex==='F'?'#e26aa6':indi.sex==='M'?'#4493f8':'#555';
          const avatarChar=indi.sex==='F'?'♀':indi.sex==='M'?'♂':'?';
          const birth=DB.getBirthEvent(indi);
          const death=DB.getDeathEvent(indi);
          const birthParsed=birth&&birth.date?parseGedcomDate(birth.date):null;
          const deathParsed=death&&death.date?parseGedcomDate(death.date):null;
          const birthYear=(birthParsed&&birthParsed.year)||null;
          const age=birthParsed?_calcAge(birthParsed, deathParsed):null;
          const agePillBg=indi.deletedAt?'rgba(248,81,73,0.18)':(death?'rgba(255,255,255,0.07)':avatarBg.replace(')',',0.18)').replace('#e26aa6','rgba(226,106,166,0.18)').replace('#4493f8','rgba(68,147,248,0.18)').replace('#555','rgba(85,85,85,0.18)'));
          const agePillColor=indi.deletedAt?'var(--red)':(death?'var(--text-secondary)':avatarBg);
          const agePillIcon=death?'✝':'♥';
          const ageHTML=age!=null
            ?`<div style="display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:20px;background:${agePillBg};border:1px solid ${agePillColor}33;">
                <span style="font-size:0.65rem;color:${agePillColor};">${agePillIcon}</span>
                <span style="font-size:0.82rem;font-weight:600;color:${agePillColor};font-variant-numeric:tabular-nums;">${age}</span>
                <span style="font-size:0.7rem;color:${agePillColor};opacity:0.7;">anos</span>
               </div>`
            :'<span style="color:var(--text-disabled);font-size:0.82rem;">—</span>';
          const relHTML=relMap.has(indi.id)?_relBadgeHtml(relMap.get(indi.id)):'<span style="color:var(--text-disabled);font-size:0.8rem;">—</span>';
          tr.innerHTML=`<td><div style="display:flex;align-items:center;gap:10px;"><div style="width:28px;height:28px;border-radius:50%;background:${avatarBg};display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:0.75rem;color:#fff;font-weight:600;">${avatarChar}</div><a href="#" class="person-link" data-id="${indi.id}" style="font-weight:500;">${name}</a></div></td><td style="color:var(--text-secondary);font-size:0.82rem;font-variant-numeric:tabular-nums;">${birthYear||'—'}</td><td>${ageHTML}</td><td>${relHTML}</td><td style="text-align:right;" class="actions"><button data-id="${indi.id}" class="tree-focus icon-btn" title="Ver na Árvore"><i class="mdi mdi-sitemap"></i></button></td>`;
          tbody.appendChild(tr);
        });
        renderPagination(totalPages);
      }

      function _parseYear(dateStr){
        if(!dateStr) return null;
        const m=dateStr.match(/\b(\d{3,4})\b/);
        return m?parseInt(m[1]):null;
      }

      /* Exact age in completed years from a parsed birth to a parsed or current date */
      function _calcAge(birthP, refP){
        if(!birthP||!birthP.year) return null;
        const now=new Date();
        const refYear  = refP&&refP.year  ? refP.year  : now.getFullYear();
        const refMonth = refP&&refP.month ? refP.month : now.getMonth()+1;
        const refDay   = refP&&refP.day   ? refP.day   : now.getDate();
        const bYear  = birthP.year;
        const bMonth = birthP.month||1;   // if unknown assume Jan (most conservative)
        const bDay   = birthP.day  ||1;
        let age = refYear - bYear;
        // subtract 1 if birthday hasn't occurred yet in the reference year
        if(refMonth < bMonth || (refMonth===bMonth && refDay < bDay)) age--;
        return age>=0?age:null;
      }

      /* ── Relationship / Kinship calculator ───────────────────────────── */
      let _relCache = { focusId: '__none__', map: new Map() };
      function computeRelationships(focusId) {
        if (_relCache.focusId === focusId) return _relCache.map;
        const rels = new Map();
        if (!focusId) { _relCache = {focusId: focusId, map: rels}; return rels; }
        const indiMap = {};
        DB.getIndividuals(true).forEach(function(i){ indiMap[i.id] = i; });
        const famMap = {};
        DB.getFamilies(true).forEach(function(f){ famMap[f.id] = f; });
        // BFS through the biological parent-child tree.
        // ups = generations from the focused person up to the common ancestor.
        // downs = generations from the common ancestor down to the target.
        const bioVisited = new Map();
        bioVisited.set(focusId, {ups:0, downs:0});
        const queue = [{id:focusId, ups:0, downs:0}];
        while (queue.length > 0) {
          const item = queue.shift();
          const id = item.id, ups = item.ups, downs = item.downs;
          const indi = indiMap[id];
          if (!indi) continue;
          // Go UP to parents (only when we haven't started going down yet)
          if (downs === 0 && indi.famc) {
            const famcIds = Array.isArray(indi.famc) ? indi.famc : [indi.famc];
            for (let fi = 0; fi < famcIds.length; fi++) {
              const fam = famMap[famcIds[fi]];
              if (!fam) continue;
              const pp = [fam.husb, fam.wife];
              for (let pi = 0; pi < pp.length; pi++) {
                const pId = pp[pi];
                if (pId && !bioVisited.has(pId)) {
                  bioVisited.set(pId, {ups:ups+1, downs:0});
                  queue.push({id:pId, ups:ups+1, downs:0});
                }
              }
            }
          }
          // Go DOWN to children through fams
          const fams = indi.fams || [];
          for (let fi = 0; fi < fams.length; fi++) {
            const fam = famMap[fams[fi]];
            if (!fam) continue;
            const ch = fam.children || [];
            for (let ci = 0; ci < ch.length; ci++) {
              const cId = ch[ci];
              if (!bioVisited.has(cId)) {
                bioVisited.set(cId, {ups:ups, downs:downs+1});
                queue.push({id:cId, ups:ups, downs:downs+1});
              }
            }
          }
        }
        // Convert visited map to relationship labels
        bioVisited.forEach(function(v, id) {
          const indi = indiMap[id];
          const sex = (indi && indi.sex) || '';
          rels.set(id, id === focusId ? null : _kinshipLabel(v.ups, v.downs, sex));
        });
        // Second pass: spouses and in-laws
        const spousesToAdd = [];
        bioVisited.forEach(function(v, id) {
          const indi = indiMap[id];
          if (!indi) return;
          const fams = indi.fams || [];
          for (let fi = 0; fi < fams.length; fi++) {
            const fam = famMap[fams[fi]];
            if (!fam) continue;
            const couple = [fam.husb, fam.wife];
            for (let ci = 0; ci < couple.length; ci++) {
              const spId = couple[ci];
              if (!spId || spId === id || rels.has(spId)) continue;
              const spIndi = indiMap[spId];
              const sf = (spIndi && spIndi.sex) === 'F', sm = (spIndi && spIndi.sex) === 'M';
              let label = null;
              if (id === focusId)               label = sf?'Esposa':sm?'Esposo':'Cônjuge';
              else if (v.ups===0&&v.downs===1)  label = sf?'Nora':sm?'Genro':'Cônjuge de filho/a';
              else if (v.ups===1&&v.downs===0)  label = sf?'Madrasta':sm?'Padrasto':'Cônjuge do pai/mãe';
              else if (v.ups===1&&v.downs===1)  label = sf?'Cunhada':sm?'Cunhado':'Cunhado/a';
              else if (v.ups===0&&v.downs===2)  label = sf?'Cônjuge da neta':sm?'Cônjuge do neto':'Cônjuge do neto/a';
              else if (v.ups===2&&v.downs===0)  label = sf?'Cônjuge da avó':sm?'Cônjuge do avô':'Cônjuge avô/avó';
              if (label) spousesToAdd.push({id:spId, label:label});
            }
          }
        });
        for (let i = 0; i < spousesToAdd.length; i++) {
          if (!rels.has(spousesToAdd[i].id)) rels.set(spousesToAdd[i].id, spousesToAdd[i].label);
        }
        _relCache = {focusId: focusId, map: rels};
        return rels;
      }

      function _kinshipLabel(ups, downs, sex) {
        const f = sex==='F', m = sex==='M';
        if (ups===1&&downs===0) return f?'Mãe':m?'Pai':'Pai/Mãe';
        if (ups===2&&downs===0) return f?'Avó':m?'Avô':'Avô/Avó';
        if (ups===3&&downs===0) return f?'Bisavó':m?'Bisavô':'Bisavô/ó';
        if (ups===4&&downs===0) return f?'Trisavó':m?'Trisavô':'Trisavô/ó';
        if (ups>=5&&downs===0)  return (f?'Tetravó ('+ups+'ª)':'Tetravo ('+ups+'º)');
        if (ups===0&&downs===1) return f?'Filha':m?'Filho':'Filho/a';
        if (ups===0&&downs===2) return f?'Neta':m?'Neto':'Neto/a';
        if (ups===0&&downs===3) return f?'Bisneta':m?'Bisneto':'Bisneto/a';
        if (ups===0&&downs===4) return f?'Trineta':m?'Trineto':'Trineto/a';
        if (ups===0&&downs>=5)  return (f?'Descendente ('+downs+'x)':'Descendente ('+downs+'x)');
        if (ups===1&&downs===1) return f?'Irmã':m?'Irmão':'Irmão/ã';
        if (ups===1&&downs===2) return f?'Sobrinha':m?'Sobrinho':'Sobrinho/a';
        if (ups===1&&downs===3) return f?'Sobrinha-neta':m?'Sobrinho-neto':'Sobrinho/a-neto';
        if (ups===1&&downs===4) return f?'Sobrinha-bisneta':m?'Sobrinho-bisneto':'Sobrinho/a-bisneto';
        if (ups===2&&downs===1) return f?'Tia':m?'Tio':'Tio/Tia';
        if (ups===3&&downs===1) return f?'Tia-avó':m?'Tio-avô':'Tio-avô/ó';
        if (ups===4&&downs===1) return f?'Tia-bisavó':m?'Tio-bisavô':'Tio-bisavô/ó';
        if (ups===2&&downs===2) return f?'1ª Prima':m?'1º Primo':'1º Primo/a';
        if (ups===3&&downs===3) return f?'2ª Prima':m?'2º Primo':'2º Primo/a';
        if (ups===4&&downs===4) return f?'3ª Prima':m?'3º Primo':'3º Primo/a';
        if (ups===2&&downs===3) return (f?'1ª Prima':'1º Primo')+' 1x afastado/a';
        if (ups===3&&downs===2) return (f?'1ª Prima':'1º Primo')+' 1x afastado/a';
        if (ups===2&&downs===4) return (f?'1ª Prima':'1º Primo')+' 2x afastado/a';
        if (ups===4&&downs===2) return (f?'1ª Prima':'1º Primo')+' 2x afastado/a';
        if (ups===3&&downs===4) return (f?'2ª Prima':'2º Primo')+' 1x afastado/a';
        if (ups===4&&downs===3) return (f?'2ª Prima':'2º Primo')+' 1x afastado/a';
        const minDeg = Math.min(ups, downs);
        const removed = Math.abs(ups - downs);
        if (minDeg >= 2) {
          const deg = minDeg - 1;
          const label = f ? deg+'ª Prima' : m ? deg+'º Primo' : deg+'º Primo/a';
          return removed > 0 ? label + ' ' + removed + 'x afastado/a' : label;
        }
        return 'Parente';
      }

      function _relBadgeHtml(label) {
        if (label === null) {
          return '<span style="display:inline-block;padding:2px 9px;border-radius:12px;font-size:0.73rem;font-weight:700;background:rgba(255,215,0,0.18);border:1px solid rgba(200,170,0,0.45);color:#b89a00;white-space:nowrap;">&#9733; Em Foco</span>';
        }
        if (!label) return '<span style="color:var(--text-disabled);font-size:0.8rem;">—</span>';
        const isDirect = /^(Pai|M\u00e3e|Filho|Filha|Av\u00f4|Av\u00f3|Bisav\u00f4|Bisav\u00f3|Trisav\u00f4|Trisav\u00f3|Trineto|Trineta|Bisneto|Bisneta|Neto|Neta|Tetrav|Descend)/.test(label);
        const isInLaw = /^(Esposo|Esposa|C\u00f4njuge|Genro|Nora|Padrasto|Madrasta|Cunhado|Cunhada)/.test(label);
        let bg, bd, col;
        if (isDirect)     { bg='rgba(68,147,248,0.13)'; bd='rgba(68,147,248,0.35)'; col='#4493f8'; }
        else if (isInLaw) { bg='rgba(130,100,220,0.13)'; bd='rgba(130,100,220,0.35)'; col='#9b7fe8'; }
        else              { bg='rgba(255,155,60,0.13)'; bd='rgba(255,155,60,0.35)'; col='#c97c28'; }
        return '<span style="display:inline-block;padding:2px 9px;border-radius:12px;font-size:0.73rem;font-weight:500;background:'+bg+';border:1px solid '+bd+';color:'+col+';white-space:nowrap;">'+_esc(label)+'</span>';
      }

      /* ── Search + nova pessoa ─────────────────────────────────────────── */
      (function(){
        const input=document.getElementById('nameFilter');
        if(input) input.addEventListener('input',function(){ currentFilter=this.value.toLowerCase().trim(); currentPage=1; renderTable(); });
      })();

      /* ── Table click handlers ──────────────────────────────────────────── */
      document.getElementById('peopleTable').addEventListener('click',function(e){
        if(e.target&&e.target.tagName==='A') e.preventDefault();
        const el=e.target.closest&&e.target.closest('[data-id]');
        if(!el) return;
        const id=el.getAttribute('data-id');
        if(el.classList.contains('person-link')) openDrawer('edit',id);
        else if(el.classList.contains('tree-focus')){
          DB.setSetting('tempFocusPerson',id);
          window.location.href='arvore.html';
        }
      });

      document.getElementById('hideDeleted').addEventListener('change', renderTable);

      /* ═══════════════════════════════════════════════════════════════════
         DRAWER
         ═══════════════════════════════════════════════════════════════════ */
      let _drawerPersonId = null, _drawerMode = 'edit';

      function openDrawer(mode, personId){
        const footer=document.querySelector('.drawer-footer'); if(footer) footer.style.display='';
        const backBtn=document.getElementById('drawerBackBtn'); if(backBtn){ backBtn.style.display='none'; backBtn._personId=null; }
        const phdr=document.getElementById('drawerPersonHeader'); if(phdr) phdr.style.display='';
        _drawerMode=mode; _drawerPersonId=personId||null;
        const indi=personId?DB.getIndividual(personId):null;
        document.getElementById('drawerTitle').textContent=mode==='create'?'Nova Pessoa':'Editar Pessoa';
        const nameEl=document.getElementById('drawerPersonName'), subEl=document.getElementById('drawerPersonSub'), avatarEl=document.getElementById('drawerAvatar');
        if(indi){
          nameEl.textContent=DB.getDisplayName(indi);
          let sub=[];
          const birth=DB.getBirthEvent(indi); if(birth&&birth.date) sub.push('\u2605 '+fmtEventDate(birth));
          const death=DB.getDeathEvent(indi); if(death&&death.date) sub.push('\u271D '+fmtEventDate(death));
          subEl.textContent=sub.join('  ·  ');
          const thumb=DB.getThumbnailForPerson(indi.id);
          if(thumb){ avatarEl.style.backgroundImage='url('+thumb+')'; avatarEl.style.backgroundSize='cover'; avatarEl.style.backgroundPosition='center'; }
          else{ avatarEl.style.backgroundImage=''; const s=indi.sex; avatarEl.style.background=s==='F'?'#e26aa6':s==='M'?'#4493f8':'#9aa0a6'; }
        } else {
          nameEl.textContent='Nova Pessoa'; subEl.textContent='';
          avatarEl.style.backgroundImage=''; avatarEl.style.background='var(--bg-surface-2)';
        }
        const body=document.getElementById('drawerBody');
        const given=indi?DB.getGivenName(indi):'';
        const surname=indi?DB.getSurname(indi):'';
        const sex=indi?(indi.sex||''):'';
        const notes=indi?(indi.notes||''):'';
        body.innerHTML=[
          '<div class="drawer-section-label">Identidade</div>',
          '<div class="form-row"><div><label>Primeiro nome</label><input type="text" id="df_firstName" value="'+_esc(given)+'" placeholder="Nome" /></div><div><label>Apelido</label><input type="text" id="df_lastName" value="'+_esc(surname)+'" placeholder="Apelido" /></div></div>',
          '<div><label>Género</label><select id="df_gender"><option value=""'+(!sex?' selected':'')+'>​(n/a)</option><option value="M"'+(sex==='M'?' selected':'')+'>Masculino</option><option value="F"'+(sex==='F'?' selected':'')+'>Feminino</option><option value="X"'+(sex==='X'?' selected':'')+'>Outro</option></select></div>',
          '<div class="drawer-section-label" style="margin-top:8px;">Notas</div>',
          '<div><textarea id="df_notes" rows="3" placeholder="Notas...">'+_esc(notes)+'</textarea></div>',
          indi?'<div style="margin-top:6px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;"><button class="btn btn-ghost btn-sm" style="font-size:0.82rem;" onclick="openDrawerSection(\''+indi.id+'\',\'relacoes\')"><i class="mdi mdi-account-multiple-outline"></i> Relações</button><button class="btn btn-ghost btn-sm" style="font-size:0.82rem;" onclick="openDrawerSection(\''+indi.id+'\',\'eventos\')"><i class="mdi mdi-calendar-check-outline"></i> Eventos</button><button class="btn btn-ghost btn-sm" style="font-size:0.82rem;" onclick="openDrawerSection(\''+indi.id+'\',\'fotos\')"><i class="mdi mdi-image-multiple-outline"></i> Fotos</button></div><div style="margin-top:10px;display:flex;gap:8px;"><button class="btn btn-sm" style="font-size:0.82rem;gap:5px;" onclick="_drawerShowAddPerson(\''+indi.id+'\')"><i class="mdi mdi-account-plus-outline"></i> Adicionar</button><button class="btn btn-sm" style="font-size:0.82rem;gap:5px;" onclick="_drawerShowLinkPerson(\''+indi.id+'\')"><i class="mdi mdi-link-variant"></i> Ligar</button></div>':''
        ].join('');
        document.getElementById('personDrawer').classList.add('open');
        document.getElementById('drawerOverlay').classList.add('open');
        setTimeout(()=>{ const fi=document.getElementById('df_firstName'); if(fi) fi.focus(); },50);
      }
      window.openDrawer = openDrawer;

      function closeDrawer(){
        document.getElementById('personDrawer').classList.remove('open');
        document.getElementById('drawerOverlay').classList.remove('open');
      }

      /* ── Drawer sections ───────────────────────────────────────────────── */
      window.openDrawerSection = function(personId, section){
        const indi=DB.getIndividual(personId);
        if(!indi) return;
        const footer=document.querySelector('.drawer-footer'); if(footer) footer.style.display='none';
        const phdr=document.getElementById('drawerPersonHeader'); if(phdr) phdr.style.display='none';
        const backBtn=document.getElementById('drawerBackBtn'); if(backBtn){ backBtn.style.display=''; backBtn._personId=personId; }
        document.getElementById('drawerTitle').textContent=(section==='relacoes'?'Relações':section==='fotos'?'Fotos':'Eventos')+' — '+DB.getDisplayName(indi);
        const body=document.getElementById('drawerBody');
        body.innerHTML=section==='relacoes'?_renderRelations(personId):section==='fotos'?_renderPhotos(personId):_renderEvents(personId);
        if(section==='fotos') _buildPhotoGrid(personId);
      };

      /* ── Events section ────────────────────────────────────────────────── */
      const EVENT_TYPES = {BIRT:'Nascimento',BAPM:'Batismo',CHR:'Batizado',DEAT:'Óbito',BURI:'Sepultamento',CREM:'Cremação',ADOP:'Adoção',OCCU:'Ocupação',RESI:'Residência',EVEN:'Outro'};

      function _renderEvents(personId){
        const indi=DB.getIndividual(personId);
        const evs=(indi&&indi.events||[]);
        let html='<div style="margin-bottom:12px;"><button class="btn btn-sm" onclick="_drawerShowAddEvent(\''+_esc(personId)+'\')" style="font-size:0.83rem;"><i class="mdi mdi-plus"></i> Adicionar Evento</button></div>';
        if(!evs.length){ html+='<div style="color:#888;padding:4px 0 12px;">Nenhum evento cadastrado.</div>'; return html; }
        html+='<div class="mini-list">';
        evs.forEach((ev,i)=>{
          const label=EVENT_TYPES[ev.type]||ev.type||'';
          html+='<div class="mini-card" style="padding:10px 12px;"><div style="display:flex;justify-content:space-between;align-items:center;gap:8px;"><div style="flex:1;"><span style="font-weight:600;font-size:0.9rem;">'+_esc(label)+'</span><span style="color:#888;font-size:0.82rem;margin-left:8px;">'+_esc(fmtEventDate(ev))+'</span></div><div style="display:flex;gap:2px;flex-shrink:0;"><button onclick="_drawerEditEvent('+i+',\''+_esc(personId)+'\')" title="Editar" style="background:none;border:none;cursor:pointer;color:#4493f8;padding:2px 4px;font-size:1rem;"><i class="mdi mdi-pencil-outline"></i></button><button onclick="_drawerDeleteEvent('+i+',\''+_esc(personId)+'\')" title="Apagar" style="background:none;border:none;cursor:pointer;color:#e06060;padding:2px 4px;font-size:1rem;"><i class="mdi mdi-trash-can-outline"></i></button></div></div>'+(ev.place?'<div style="color:#aaa;font-size:0.82rem;margin-top:3px;">&#128205; '+_esc(ev.place)+'</div>':'')+(ev.notes?'<div style="color:#bbb;font-size:0.82rem;margin-top:3px;">'+_esc(ev.notes)+'</div>':'')+'</div>';
        });
        html+='</div>';
        return html;
      }

      window._drawerDeleteEvent = function(idx,personId){
        if(!confirm('Apagar este evento?')) return;
        const indi=DB.getIndividual(personId); if(!indi) return;
        indi.events.splice(idx,1);
        DB.saveIndividual(indi);
        document.getElementById('drawerBody').innerHTML=_renderEvents(personId);
      };

      window._drawerEditEvent = function(idx,personId){
        const indi=DB.getIndividual(personId); if(!indi) return;
        const ev=indi.events[idx]; if(!ev) return;
        const p=parseGedcomDate(ev.date);
        const body=document.getElementById('drawerBody');
        const opts=Object.entries(EVENT_TYPES).map(([k,v])=>'<option value="'+k+'"'+(ev.type===k?' selected':'')+'>'+v+'</option>').join('');
        body.innerHTML='<div style="padding:4px 0 8px;"><h3 style="font-size:0.95rem;margin:0 0 14px;">Editar Evento</h3><div style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Tipo</label><select id="editEvType" style="width:100%;">'+opts+'</select></div><div style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Data</label><select id="editEvQual" style="width:100%;margin-bottom:6px;"><option value="Exatamente"'+((!p.qualifier||p.qualifier==='Exatamente')?' selected':'')+'>Exatamente</option><option value="Antes de"'+(p.qualifier==='Antes de'?' selected':'')+'>Antes de</option><option value="Depois de"'+(p.qualifier==='Depois de'?' selected':'')+'>Depois de</option><option value="Cerca de"'+(p.qualifier==='Cerca de'?' selected':'')+'>Cerca de</option></select><div style="display:flex;gap:6px;"><input id="editEvDay" type="number" min="1" max="31" placeholder="Dia" value="'+(p.day||'')+'" style="flex:1;min-width:0;text-align:center;"/><input id="editEvMonth" type="number" min="1" max="12" placeholder="Mês" value="'+(p.month||'')+'" style="flex:1;min-width:0;text-align:center;"/><input id="editEvYear" type="number" min="1" max="9999" placeholder="Ano" value="'+(p.year||'')+'" style="flex:2;min-width:0;text-align:center;"/></div></div><div style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Local</label><input id="editEvPlace" type="text" value="'+_esc(ev.place||'')+'" style="width:100%;"/></div><div style="margin-bottom:14px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Notas</label><textarea id="editEvNotes" rows="3" style="width:100%;resize:vertical;">'+_esc(ev.notes||'')+'</textarea></div><div style="display:flex;gap:8px;justify-content:flex-end;"><button class="btn btn-ghost btn-sm" onclick="openDrawerSection(\''+_esc(personId)+'\',\'eventos\')">Cancelar</button><button class="btn btn-sm" onclick="_drawerSaveEditEvent('+idx+',\''+_esc(personId)+'\')"><i class="mdi mdi-content-save-outline"></i> Guardar</button></div></div>';
      };

      window._drawerSaveEditEvent = function(idx,personId){
        const indi=DB.getIndividual(personId); if(!indi) return;
        const type=(document.getElementById('editEvType')||{}).value||'EVEN';
        const qual=(document.getElementById('editEvQual')||{}).value;
        const day=parseInt((document.getElementById('editEvDay')||{}).value)||null;
        const month=parseInt((document.getElementById('editEvMonth')||{}).value)||null;
        const year=parseInt((document.getElementById('editEvYear')||{}).value)||null;
        if(!day&&!month&&!year){ alert('Preencha pelo menos um campo de data.'); return; }
        const place=((document.getElementById('editEvPlace')||{}).value||'').trim();
        const notes=((document.getElementById('editEvNotes')||{}).value||'').trim();
        indi.events[idx]={type,date:buildGedcomDate(day,month,year,qual),place:place||undefined,notes:notes||undefined};
        DB.saveIndividual(indi);
        openDrawerSection(personId,'eventos');
      };

      window._drawerShowAddEvent = function(personId){
        const opts=Object.entries(EVENT_TYPES).map(([k,v])=>'<option value="'+k+'">'+v+'</option>').join('');
        document.getElementById('drawerBody').innerHTML='<div style="padding:4px 0 8px;"><h3 style="font-size:0.95rem;margin:0 0 14px;">Novo Evento</h3><div style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Tipo</label><select id="addEvType" style="width:100%;">'+opts+'</select></div><div style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Data</label><select id="addEvQual" style="width:100%;margin-bottom:6px;"><option value="Exatamente" selected>Exatamente</option><option value="Antes de">Antes de</option><option value="Depois de">Depois de</option><option value="Cerca de">Cerca de</option></select><div style="display:flex;gap:6px;"><input id="addEvDay" type="number" min="1" max="31" placeholder="Dia" style="flex:1;min-width:0;text-align:center;"/><input id="addEvMonth" type="number" min="1" max="12" placeholder="Mês" style="flex:1;min-width:0;text-align:center;"/><input id="addEvYear" type="number" min="1" max="9999" placeholder="Ano" style="flex:2;min-width:0;text-align:center;"/></div></div><div style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Local</label><input id="addEvPlace" type="text" placeholder="Local do evento" style="width:100%;"/></div><div style="margin-bottom:14px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Notas</label><textarea id="addEvNotes" rows="3" placeholder="Notas..." style="width:100%;resize:vertical;"></textarea></div><div style="display:flex;gap:8px;justify-content:flex-end;"><button class="btn btn-ghost btn-sm" onclick="openDrawerSection(\''+_esc(personId)+'\',\'eventos\')">Cancelar</button><button class="btn btn-sm" onclick="_drawerSaveNewEvent(\''+_esc(personId)+'\')"><i class="mdi mdi-content-save-outline"></i> Guardar</button></div></div>';
      };

      window._drawerSaveNewEvent = function(personId){
        const indi=DB.getIndividual(personId); if(!indi) return;
        const type=(document.getElementById('addEvType')||{}).value||'EVEN';
        const qual=(document.getElementById('addEvQual')||{}).value;
        const day=parseInt((document.getElementById('addEvDay')||{}).value)||null;
        const month=parseInt((document.getElementById('addEvMonth')||{}).value)||null;
        const year=parseInt((document.getElementById('addEvYear')||{}).value)||null;
        if(!day&&!month&&!year){ alert('Preencha pelo menos um campo de data.'); return; }
        const place=((document.getElementById('addEvPlace')||{}).value||'').trim();
        const notes=((document.getElementById('addEvNotes')||{}).value||'').trim();
        if(!indi.events) indi.events=[];
        indi.events.push({type,date:buildGedcomDate(day,month,year,qual),place:place||undefined,notes:notes||undefined});
        DB.saveIndividual(indi);
        openDrawerSection(personId,'eventos');
      };

      /* ── Relations section ─────────────────────────────────────────────── */
      function _getRelationsForPerson(personId){
        const rels=[];
        const parents=DB.getParents(personId);
        parents.forEach(p=>rels.push({type:'ancestor',targetId:p.id,name:DB.getDisplayName(p),sex:p.sex}));
        const children=DB.getChildren(personId);
        children.forEach(c=>rels.push({type:'child',targetId:c.id,name:DB.getDisplayName(c),sex:c.sex}));
        const spouses=DB.getSpouses(personId);
        spouses.forEach(s=>rels.push({type:'mate',targetId:s.id,name:DB.getDisplayName(s),sex:s.sex}));
        const siblings=DB.getSiblings(personId);
        siblings.forEach(s=>rels.push({type:'siblin',targetId:s.id,name:DB.getDisplayName(s),sex:s.sex}));
        return rels;
      }

      function _renderRelations(personId){
        const rels=_getRelationsForPerson(personId);
        const typeDesc={siblin:'Irmão / Irmã',ancestor:'Pai / Mãe',child:'Filho(a)',mate:'Companheiro(a)'};
        let html='<div style="margin-bottom:12px;"><button class="btn btn-sm" onclick="_drawerShowAddRelation(\''+_esc(personId)+'\')" style="font-size:0.83rem;"><i class="mdi mdi-plus"></i> Adicionar Relação</button></div>';
        if(!rels.length){ html+='<div style="color:#888;padding:4px 0 12px;">Nenhuma relação cadastrada.</div>'; return html; }
        html+='<div class="mini-list">';
        rels.forEach(r=>{
          let desc=typeDesc[r.type]||r.type;
          if(r.sex==='F'){ if(desc.includes('Filho')) desc='Filha'; if(desc.includes('Pai')) desc='Mãe'; if(desc.includes('Compan')) desc='Companheira'; if(desc.includes('Irm')) desc='Irmã'; }
          else if(r.sex==='M'){ if(desc.includes('Filho')) desc='Filho'; if(desc.includes('Mãe')||desc.includes('Pai')) desc='Pai'; if(desc.includes('Compan')) desc='Companheiro'; if(desc.includes('Irm')) desc='Irmão'; }
          html+='<div class="mini-card" style="padding:10px 12px;"><div style="display:flex;justify-content:space-between;align-items:center;gap:8px;"><div style="flex:1;"><span style="font-weight:600;font-size:0.9rem;">'+_esc(r.name)+'</span><span style="color:#aaa;font-size:0.82rem;margin-left:8px;">'+_esc(desc)+'</span></div><button onclick="_drawerDeleteRelation(\''+_esc(personId)+'\',\''+_esc(r.targetId)+'\',\''+_esc(r.type)+'\')" title="Apagar" style="background:none;border:none;cursor:pointer;color:#e06060;padding:2px 4px;font-size:1rem;flex-shrink:0;"><i class="mdi mdi-trash-can-outline"></i></button></div></div>';
        });
        html+='</div>';
        return html;
      }

      window._drawerDeleteRelation = function(personId,targetId,relType){
        if(!confirm('Apagar esta relação?')) return;
        if(relType==='ancestor'){
          // Remove parent from famc family
          const indi=DB.getIndividual(personId);
          if(indi&&indi.famc){
            const fam=DB.getFamily(indi.famc);
            if(fam){
              if(fam.husb===targetId) fam.husb=null;
              if(fam.wife===targetId) fam.wife=null;
              DB.saveFamily(fam);
              // Remove fams link from the parent
              const parent=DB.getIndividual(targetId);
              if(parent&&parent.fams){ parent.fams=parent.fams.filter(f=>f!==fam.id); DB.saveIndividual(parent); }
            }
          }
        } else if(relType==='child'){
          // Remove child from this person's fams families
          DB.getFamiliesAsSpouse(personId).forEach(fam=>{
            if(fam.children&&fam.children.includes(targetId)){
              fam.children=fam.children.filter(c=>c!==targetId);
              DB.saveFamily(fam);
              const child=DB.getIndividual(targetId);
              if(child&&child.famc===fam.id){ child.famc=null; DB.saveIndividual(child); }
            }
          });
        } else if(relType==='mate'){
          // Find shared family and remove spouse link
          DB.getFamiliesAsSpouse(personId).forEach(fam=>{
            if(fam.husb===targetId||fam.wife===targetId){
              if(fam.husb===targetId) fam.husb=null;
              if(fam.wife===targetId) fam.wife=null;
              DB.saveFamily(fam);
              const sp=DB.getIndividual(targetId);
              if(sp&&sp.fams){ sp.fams=sp.fams.filter(f=>f!==fam.id); DB.saveIndividual(sp); }
            }
          });
        } else if(relType==='siblin'){
          // Remove sibling from shared family
          const indi=DB.getIndividual(personId);
          if(indi&&indi.famc){
            const fam=DB.getFamily(indi.famc);
            if(fam&&fam.children&&fam.children.includes(targetId)){
              fam.children=fam.children.filter(c=>c!==targetId);
              DB.saveFamily(fam);
              const sib=DB.getIndividual(targetId);
              if(sib&&sib.famc===fam.id){ sib.famc=null; DB.saveIndividual(sib); }
            }
          }
        }
        document.getElementById('drawerBody').innerHTML=_renderRelations(personId);
      };

      window._drawerShowAddRelation = function(personId){
        const others=DB.getIndividuals().filter(i=>i.id!==personId);
        const parents=DB.getParents(personId);
        let kinOpts='<option value="ancestor">Pai / Mãe</option><option value="child">Filho(a)</option><option value="mate">Companheiro(a)</option><option value="siblin">Irmão / Irmã</option>';
        if(parents.length>=2) kinOpts='<option value="child">Filho(a)</option><option value="mate">Companheiro(a)</option><option value="siblin">Irmão / Irmã</option>';
        const opts=others.map(i=>'<option value="'+i.id+'">'+_esc(DB.getDisplayName(i))+'</option>').join('');
        document.getElementById('drawerBody').innerHTML='<div style="padding:4px 0 8px;"><h3 style="font-size:0.95rem;margin:0 0 14px;">Nova Relação</h3><div style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Tipo</label><select id="addRelType" style="width:100%;">'+kinOpts+'</select></div><div style="margin-bottom:14px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Pessoa</label><select id="addRelTarget" style="width:100%;">'+opts+'</select></div><div style="display:flex;gap:8px;justify-content:flex-end;"><button class="btn btn-ghost btn-sm" onclick="openDrawerSection(\''+_esc(personId)+'\',\'relacoes\')">Cancelar</button><button class="btn btn-sm" onclick="_drawerSaveLinkRelation(\''+_esc(personId)+'\')"><i class="mdi mdi-content-save-outline"></i> Guardar</button></div></div>';
      };

      window._drawerSaveLinkRelation = function(personId){
        const relType=(document.getElementById('addRelType')||{}).value;
        const targetId=(document.getElementById('addRelTarget')||{}).value;
        if(!relType||!targetId) return alert('Selecione tipo e pessoa.');
        _linkRelation(personId,targetId,relType);
        openDrawerSection(personId,'relacoes');
      };

      function _linkRelation(personId,targetId,relType){
        const indi=DB.getIndividual(personId);
        const target=DB.getIndividual(targetId);
        if(!indi||!target) return;

        if(relType==='mate'){
          DB.ensureFamily(personId,targetId);
        } else if(relType==='ancestor'){
          // target is parent of indi
          if(!indi.famc){
            // Create family for parents
            const fam=DB.saveFamily({husb:target.sex==='M'?targetId:null,wife:target.sex==='F'?targetId:null,children:[personId],events:[]});
            indi.famc=fam.id; DB.saveIndividual(indi);
            if(!target.fams) target.fams=[];
            if(!target.fams.includes(fam.id)){ target.fams.push(fam.id); DB.saveIndividual(target); }
          } else {
            const fam=DB.getFamily(indi.famc);
            if(fam){
              if(!fam.husb&&target.sex!=='F'){ fam.husb=targetId; }
              else if(!fam.wife){ fam.wife=targetId; }
              else { fam.husb=targetId; } // overwrite
              DB.saveFamily(fam);
              if(!target.fams) target.fams=[];
              if(!target.fams.includes(fam.id)){ target.fams.push(fam.id); DB.saveIndividual(target); }
            }
          }
        } else if(relType==='child'){
          // target is child of indi
          const fams=DB.getFamiliesAsSpouse(personId);
          let fam=fams.length?fams[0]:null;
          if(!fam){
            fam=DB.saveFamily({husb:indi.sex==='M'?personId:null,wife:indi.sex==='F'?personId:null,children:[],events:[]});
            if(!indi.fams) indi.fams=[];
            indi.fams.push(fam.id); DB.saveIndividual(indi);
          }
          if(!fam.children) fam.children=[];
          if(!fam.children.includes(targetId)){ fam.children.push(targetId); DB.saveFamily(fam); }
          target.famc=fam.id; DB.saveIndividual(target);
        } else if(relType==='siblin'){
          // target is sibling of indi — share famc family
          if(indi.famc){
            const fam=DB.getFamily(indi.famc);
            if(fam){
              if(!fam.children) fam.children=[];
              if(!fam.children.includes(targetId)){ fam.children.push(targetId); DB.saveFamily(fam); }
              target.famc=fam.id; DB.saveIndividual(target);
            }
          } else {
            // Create family for both
            const fam=DB.saveFamily({children:[personId,targetId],events:[]});
            indi.famc=fam.id; DB.saveIndividual(indi);
            target.famc=fam.id; DB.saveIndividual(target);
          }
        }
      }

      /* ── Add person workflow ───────────────────────────────────────────── */
      window._drawerShowAddPerson = function(personId){
        const indi=DB.getIndividual(personId); if(!indi) return;
        const parents=DB.getParents(personId);
        const footer=document.querySelector('.drawer-footer'); if(footer) footer.style.display='none';
        const phdr=document.getElementById('drawerPersonHeader'); if(phdr) phdr.style.display='none';
        const backBtn=document.getElementById('drawerBackBtn'); if(backBtn){ backBtn.style.display=''; backBtn._personId=personId; }
        document.getElementById('drawerTitle').textContent='Adicionar — '+DB.getDisplayName(indi);
        let kinOpts='<option value="sibling_male">Irmão</option><option value="sibling_female">Irmã</option><option value="child_male">Filho</option><option value="child_female">Filha</option>';
        if(parents.length<2) kinOpts+='<option value="ancestor_male">Pai</option><option value="ancestor_female">Mãe</option>';
        kinOpts+='<option value="mate_male">Companheiro</option><option value="mate_female">Companheira</option>';
        document.getElementById('drawerBody').innerHTML='<div style="padding:4px 0 8px;"><h3 style="font-size:0.95rem;margin:0 0 14px;">Nova Pessoa</h3><div style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Grau de parentesco</label><select id="addPersKinship" style="width:100%;">'+kinOpts+'</select></div><div style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Primeiro nome</label><input id="addPersFirstName" type="text" placeholder="Nome" style="width:100%;"/></div><div style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Apelido</label><input id="addPersLastName" type="text" placeholder="Apelido" style="width:100%;"/></div><div style="margin-bottom:14px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Notas</label><textarea id="addPersNotes" rows="2" placeholder="Notas..." style="width:100%;resize:vertical;"></textarea></div><div style="display:flex;gap:8px;justify-content:flex-end;"><button class="btn btn-ghost btn-sm" onclick="openDrawer(\'edit\',\''+_esc(personId)+'\')">Cancelar</button><button class="btn btn-sm" onclick="_drawerSaveNewPerson(\''+_esc(personId)+'\')"><i class="mdi mdi-content-save-outline"></i> Guardar</button></div></div>';
        setTimeout(()=>{ const fi=document.getElementById('addPersFirstName'); if(fi) fi.focus(); },50);
      };

      window._drawerSaveNewPerson = function(personId){
        const kinship=(document.getElementById('addPersKinship')||{}).value||'';
        const firstName=((document.getElementById('addPersFirstName')||{}).value||'').trim();
        const lastName=((document.getElementById('addPersLastName')||{}).value||'').trim();
        const notes=((document.getElementById('addPersNotes')||{}).value||'').trim();
        if(!firstName&&!lastName){ alert('Introduza pelo menos um nome.'); return; }
        const sexMap={sibling_male:'M',sibling_female:'F',child_male:'M',child_female:'F',ancestor_male:'M',ancestor_female:'F',mate_male:'M',mate_female:'F'};
        const relMap={sibling_male:'siblin',sibling_female:'siblin',child_male:'child',child_female:'child',ancestor_male:'ancestor',ancestor_female:'ancestor',mate_male:'mate',mate_female:'mate'};
        const sex=sexMap[kinship]||'U';
        const relType=relMap[kinship]||'';
        // Create the new individual
        const newIndi=DB.saveIndividual({names:[{given:firstName,surname:lastName,type:'birth'}],sex,notes:notes||undefined,events:[]});
        if(relType) _linkRelation(personId,newIndi.id,relType);
        openDrawer('edit',personId);
        renderTable();
      };

      /* ── Link existing person ──────────────────────────────────────────── */
      window._drawerShowLinkPerson = function(personId){
        const indi=DB.getIndividual(personId); if(!indi) return;
        const parents=DB.getParents(personId);
        const footer=document.querySelector('.drawer-footer'); if(footer) footer.style.display='none';
        const phdr=document.getElementById('drawerPersonHeader'); if(phdr) phdr.style.display='none';
        const backBtn=document.getElementById('drawerBackBtn'); if(backBtn){ backBtn.style.display=''; backBtn._personId=personId; }
        document.getElementById('drawerTitle').textContent='Ligar — '+DB.getDisplayName(indi);
        let kinOpts='<option value="siblin">Irmão / Irmã</option><option value="child">Filho(a)</option>';
        if(parents.length<2) kinOpts='<option value="ancestor">Pai / Mãe</option>'+kinOpts;
        kinOpts+='<option value="mate">Companheiro(a)</option>';
        const others=DB.getIndividuals().filter(i=>i.id!==personId);
        const opts=others.map(i=>'<option value="'+i.id+'">'+_esc(DB.getDisplayName(i))+'</option>').join('');
        document.getElementById('drawerBody').innerHTML='<div style="padding:4px 0 8px;"><h3 style="font-size:0.95rem;margin:0 0 14px;">Ligar Pessoa Existente</h3><div style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Grau de parentesco</label><select id="linkPersKinship" style="width:100%;">'+kinOpts+'</select></div><div style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Pesquisar pessoa</label><input id="linkPersSearch" type="text" placeholder="Pesquisar por nome..." style="width:100%;margin-bottom:6px;" /><select id="linkPersTarget" size="6" style="width:100%;min-height:110px;">'+opts+'</select></div><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;"><button class="btn btn-ghost btn-sm" onclick="openDrawer(\'edit\',\''+_esc(personId)+'\')">Cancelar</button><button class="btn btn-sm" onclick="_drawerSaveLinkPerson(\''+_esc(personId)+'\')"><i class="mdi mdi-content-save-outline"></i> Guardar</button></div></div>';
        const sel=document.getElementById('linkPersTarget');
        if(sel) sel._allOpts=others.map(i=>({value:i.id,text:DB.getDisplayName(i)}));
        const si=document.getElementById('linkPersSearch');
        if(si){ si.addEventListener('input',function(){ const q=this.value.toLowerCase(); const all=sel._allOpts||[]; sel.innerHTML=all.filter(o=>o.text.toLowerCase().includes(q)).map(o=>'<option value="'+o.value+'">'+_esc(o.text)+'</option>').join(''); }); si.focus(); }
      };

      window._drawerSaveLinkPerson = function(personId){
        const relType=(document.getElementById('linkPersKinship')||{}).value;
        const targetId=(document.getElementById('linkPersTarget')||{}).value;
        if(!relType||!targetId){ alert('Selecione tipo e pessoa.'); return; }
        if(targetId===personId){ alert('Não pode ligar uma pessoa a si própria.'); return; }
        _linkRelation(personId,targetId,relType);
        openDrawer('edit',personId);
        renderTable();
      };

      /* ── Photos section ───────────────────────────────────────────────── */
      // _renderPhotos returns the static upload-bar + empty grid container.
      // _buildPhotoGrid then fills the grid using real DOM nodes + addEventListener.
      function _renderPhotos(personId){
        return '<div style="margin-bottom:14px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">'
          + '<label for="drawerPhotoInput" class="btn btn-sm" style="cursor:pointer;font-size:0.83rem;"><i class="mdi mdi-image-plus"></i> Escolher Ficheiro</label>'
          + '<span id="drawerPhotoName" style="color:#aaa;font-size:0.82rem;max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">Nenhum ficheiro</span>'
          + '<button class="btn btn-sm" id="drawerUploadBtn" style="font-size:0.83rem;"><i class="mdi mdi-upload"></i> Upload</button>'
          + '</div>'
          + '<input type="file" id="drawerPhotoInput" accept="image/*" style="display:none;"/>'
          + '<div id="_photoGrid" style="display:flex;flex-wrap:wrap;gap:10px;"></div>';
      }

      function _buildPhotoGrid(personId){
        // Wire upload button
        var uploadBtn = document.getElementById('drawerUploadBtn');
        if(uploadBtn) uploadBtn.addEventListener('click', function(){ window._drawerUploadPhoto(personId); });
        var fileInput = document.getElementById('drawerPhotoInput');
        if(fileInput) fileInput.addEventListener('change', function(){
          var nameEl = document.getElementById('drawerPhotoName');
          if(nameEl) nameEl.textContent = fileInput.files&&fileInput.files.length ? fileInput.files[0].name : 'Nenhum ficheiro';
        });

        var grid = document.getElementById('_photoGrid');
        if(!grid) return;
        var media = DB.getMultimediaForIndividual(personId);
        if(!media.length){
          grid.innerHTML = '<div style="color:#888;padding:4px 0 12px;">Nenhuma foto associada.</div>';
          return;
        }

        media.forEach(function(m){
          var src = m.dataUrl || (m.files && m.files[0] ? m.files[0].file : '') || '';
          var hasImage = src.startsWith('data:') || src.startsWith('http') || src.startsWith('/');
          var wrap = document.createElement('div');
          wrap.style.cssText = 'position:relative;display:inline-block;';

          if(hasImage){
            var img = document.createElement('img');
            img.src = src;
            img.title = m.title || '';
            img.style.cssText = 'width:72px;height:72px;object-fit:cover;border-radius:6px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.3);display:block;';
            (function(mid, pid){
              img.onclick = function(ev){ ev.stopPropagation(); window._drawerViewPhoto(mid, pid); };
            })(m.id, personId);
            wrap.appendChild(img);
          } else {
            var placeholder = document.createElement('div');
            placeholder.style.cssText = 'width:72px;height:72px;border-radius:6px;background:#2a2a3a;border:1px dashed #555;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;cursor:pointer;';
            var iconEl = document.createElement('i');
            iconEl.className = 'mdi mdi-image-off';
            iconEl.style.cssText = 'font-size:1.4rem;color:#888;pointer-events:none;';
            var label = document.createElement('span');
            label.style.cssText = 'font-size:0.55rem;color:#888;text-align:center;word-break:break-all;padding:0 3px;max-height:28px;overflow:hidden;pointer-events:none;';
            label.textContent = src || '(sem nome)';
            placeholder.appendChild(iconEl);
            placeholder.appendChild(label);
            placeholder.title = 'Clique para carregar: ' + (src || '(sem nome)');
            (function(mid, pid){
              placeholder.onclick = function(ev){ ev.stopPropagation(); window._drawerLinkGedcomPhoto(mid, pid); };
            })(m.id, personId);
            wrap.appendChild(placeholder);
          }

          // Remove/unlink button
          var removeBtn = document.createElement('button');
          removeBtn.title = 'Remover vínculo';
          removeBtn.innerHTML = '<i class="mdi mdi-close" style="pointer-events:none;"></i>';
          removeBtn.style.cssText = 'position:absolute;top:-6px;right:-6px;background:#e06060;border:none;color:#fff;border-radius:50%;width:18px;height:18px;font-size:0.65rem;cursor:pointer;padding:0;display:flex;align-items:center;justify-content:center;';
          removeBtn.addEventListener('click', (function(mid, pid){ return function(ev){ ev.stopPropagation(); window._drawerUnlinkPhoto(mid, pid); }; })(m.id, personId));
          wrap.appendChild(removeBtn);

          grid.appendChild(wrap);
        });
      }

      window._drawerUploadPhoto = async function(personId){
        const input=document.getElementById('drawerPhotoInput');
        if(!input||!input.files||!input.files.length) return alert('Selecione uma imagem.');
        const f=input.files[0];
        try{
          const dataUrl=await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); });
          const media=DB.saveMultimedia({title:f.name,dataUrl,files:[{file:dataUrl,format:f.type}]});
          const indi=DB.getIndividual(personId);
          if(indi){ if(!indi.multimediaRefs) indi.multimediaRefs=[]; indi.multimediaRefs.push(media.id); DB.saveIndividual(indi); }
          input.value=''; openDrawerSection(personId,'fotos');
        }catch(err){ alert('Erro: '+err); }
      };

      window._drawerLinkGedcomPhoto = function(mediaId, personId){
        // For GEDCOM-imported photos that have a filename but no image data,
        // let the user pick the actual file to associate with this multimedia record
        const input=document.createElement('input');
        input.type='file'; input.accept='image/*';
        input.onchange=async function(){
          if(!input.files||!input.files.length) return;
          const f=input.files[0];
          try{
            const dataUrl=await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); });
            const m=DB.getMultimediaItem(mediaId);
            if(!m) return;
            m.dataUrl=dataUrl;
            m.files=[{file:dataUrl,format:f.type}];
            if(!m.title) m.title=f.name;
            DB.saveMultimedia(m);
            openDrawerSection(personId,'fotos');
          }catch(err){ alert('Erro ao carregar imagem: '+err); }
        };
        input.click();
      };

      window._drawerUnlinkPhoto = function(mediaId,personId){
        if(!confirm('Remover vínculo desta foto?')) return;
        const indi=DB.getIndividual(personId);
        if(indi&&indi.multimediaRefs){ indi.multimediaRefs=indi.multimediaRefs.filter(id=>id!==mediaId); DB.saveIndividual(indi); }
        openDrawerSection(personId,'fotos');
      };

      /* ── Photo modal → delegated to PhotoLightbox ──────────────────────── */
      window._drawerViewPhoto = function(mediaId, personId){ window.PhotoLightbox.open(mediaId, personId); };

      /* ── Drawer save / delete / close ──────────────────────────────────── */
      function drawerSave(){
        const given=(document.getElementById('df_firstName')||{}).value||'';
        const surname=(document.getElementById('df_lastName')||{}).value||'';
        const sex=(document.getElementById('df_gender')||{}).value||'U';
        const notes=(document.getElementById('df_notes')||{}).value||'';
        if(_drawerMode==='create'){
          DB.saveIndividual({names:[{given:given.trim(),surname:surname.trim(),type:'birth'}],sex,notes,events:[]});
        } else if(_drawerPersonId){
          const indi=DB.getIndividual(_drawerPersonId);
          if(indi){ indi.names=[{given:given.trim(),surname:surname.trim(),type:'birth'}]; indi.sex=sex; indi.notes=notes; DB.saveIndividual(indi); }
        }
        closeDrawer(); renderTable();
      }

      function drawerDeletePerson(){
        if(!_drawerPersonId||!confirm('Apagar esta pessoa?')) return;
        DB.deleteIndividual(_drawerPersonId);
        closeDrawer(); renderTable();
      }

      document.getElementById('drawerCloseBtn').addEventListener('click', closeDrawer);
      document.getElementById('drawerCancelBtn').addEventListener('click', closeDrawer);
      document.getElementById('drawerOverlay').addEventListener('click', closeDrawer);
      document.getElementById('drawerSaveBtn').addEventListener('click', drawerSave);
      document.getElementById('drawerDeleteBtn').addEventListener('click', drawerDeletePerson);
      document.getElementById('drawerBackBtn').addEventListener('click', function(){ const pid=this._personId; if(pid) openDrawer('edit',pid); });

      /* ── Init ──────────────────────────────────────────────────────────── */
      renderTable();

      // Auto-open from URL param (?edit=id)
      (function(){
        const p=new URLSearchParams(window.location.search);
        const editId=p.get('edit');
        if(editId) openDrawer('edit',editId);
      })();

    })();
    </script>
    <script src="photo-lightbox.js"></script>
    <script src="history-logger.js"></script>
  </body>
</html>
