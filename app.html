<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cadastro de Pessoas</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css">
    <style>
      .photo-area{position:relative;display:inline-block;}
      .tag-overlay{position:absolute;left:0;top:0;right:0;bottom:0;pointer-events:none}
      .tag-rect{position:absolute;border:2px solid rgba(59,130,246,0.9);background:rgba(59,130,246,0.12);pointer-events:auto;cursor:pointer;border-radius:6px;box-sizing:border-box}
      .tag-label{position:absolute;background:rgba(0,0,0,0.6);color:#fff;padding:2px 6px;border-radius:6px;font-size:12px;transform:translateY(-120%);white-space:nowrap}
      .tag-form{position:absolute;background:var(--bg-card);padding:8px;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,0.4);z-index:620}
      .tag-form input{margin-bottom:6px;}
    </style>
    <script src="remote-storage.js"></script>
  </head>
  <body>
    <div class="app-shell">
      <aside class="sidebar">
        <a href="index.html" class="logo"><i class="mdi mdi-tree" aria-hidden="true"></i><span>myLineage</span></a>
        <nav>
          <a href="app.html" class="active"><i class="mdi mdi-account-multiple" aria-hidden="true"></i>Cadastro</a>
          <a href="indicadores.html"><i class="mdi mdi-chart-bar" aria-hidden="true"></i>Indicadores</a>
          <a href="arvore.html"><i class="mdi mdi-sitemap" aria-hidden="true"></i>Árvore</a>
          <a href="gedcom.html"><i class="mdi mdi-dna" aria-hidden="true"></i>GEDCOM</a>
          <a href="album.html"><i class="mdi mdi-image-multiple" aria-hidden="true"></i>Álbum</a>
          <a href="documentos.html"><i class="mdi mdi-folder-open" aria-hidden="true"></i>Documentos</a>
        </nav>
        <div class="sidebar-footer">
          <a href="apis.html"><i class="mdi mdi-api" aria-hidden="true"></i>APIs</a>
          <a href="configuracao.html"><i class="mdi mdi-cog" aria-hidden="true"></i>Definições</a>
        </div>
      </aside>
      <main class="content">
        <div class="topbar">
          <div style="display:flex;align-items:center;gap:12px"><h1>Cadastro de Pessoas</h1></div>
        </div>
        <div class="main-grid">
          <div class="table-panel card">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0;">
                <div style="display:flex;gap:12px;align-items:center;">
                    <div style="display:flex;align-items:center;gap:6px;">
                      <input type="text" id="nameFilter" placeholder="Filtrar por nome..." style="padding:8px 10px;border-radius:8px;border:1px solid rgba(163,163,255,0.06);background:transparent;color:var(--text-main);" />
                      <button id="nameSearchBtn" class="icon-btn" type="button" title="Pesquisar"><i class="mdi mdi-magnify" aria-hidden="true"></i></button>
                    </div>
                  </div>
              </div>
          <div>
            <label><input type="checkbox" id="hideDeleted" checked /> Ocultar registros excluídos</label>
          </div>
          <table id="peopleTable">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="paginationControls" style="color:var(--text-secondary);margin-top:12px;"></div>
      </div>
      <div class="form-panel card" id="formPanel" style="display:none;">
        <div class="accordion">
          <div class="accordion-card" id="cardDados">
            <button type="button" class="accordion-header" data-target="contentDados"><span>Dados Pessoais</span><span class="accordion-arrow"><i class="mdi mdi-chevron-down" aria-hidden="true"></i></span></button>
            <div class="accordion-content" id="contentDados">
              <form id="personForm">
                <input type="hidden" id="id" name="id" />
                <input type="hidden" id="createdAt" name="createdAt" />
                <input type="hidden" id="updatedAt" name="updatedAt" />
                <input type="hidden" id="deletedAt" name="deletedAt" />
                <div>
                  <label for="firstName">First Name</label>
                  <input type="text" id="firstName" name="firstName" required />
                </div>
                <div>
                  <label for="lastName">Last Name</label>
                  <input type="text" id="lastName" name="lastName" required />
                </div>
                <div>
                  <label for="gender">Gender</label>
                  <select id="gender" name="gender">
                    <option value="">-- selecione --</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div class="full">
                  <label for="notes">Notes</label>
                  <textarea id="notes" name="notes"></textarea>
                </div>
                <div id="ageInfo"></div>
                <div class="full" style="display:flex;gap:8px;flex-wrap:wrap;">
                  <button type="submit" id="saveBtn" class="btn">Salvar</button>
                  <button type="button" id="resetBtn" class="btn btn-ghost">Limpar</button>
                  <button type="button" id="detailBtn" class="btn btn-ghost">Detalhe</button>
                </div>
              </form>
            </div>
          </div>

          <!-- Apenas Dados Pessoais visíveis na página de Cadastro. Eventos/ Relações mudaram para página de detalhe. -->
        </div>
        <div id="datesInfo" style="font-size:0.85em;color:#666;margin-top:16px;text-align:right;"></div>
      </div>
        </div>
      </main>
    </div>

    <!-- ── Right drawer overlay ── -->
    <div class="drawer-overlay" id="drawerOverlay"></div>

    <!-- ── Right drawer ── -->
    <div class="drawer" id="personDrawer" role="dialog" aria-modal="true" aria-labelledby="drawerTitle">
      <div class="drawer-header">
        <button class="btn btn-ghost btn-sm" id="drawerBackBtn" style="display:none;padding:2px 6px;margin-right:4px;" title="Voltar"><i class="mdi mdi-arrow-left"></i></button>
        <h2 id="drawerTitle" style="flex:1;">Detalhes da Pessoa</h2>
        <button class="drawer-close" id="drawerCloseBtn" aria-label="Fechar painel"><i class="mdi mdi-close"></i></button>
      </div>
      <div class="drawer-person-header" id="drawerPersonHeader">
        <div class="drawer-avatar" id="drawerAvatar"></div>
        <div>
          <div class="drawer-person-name" id="drawerPersonName">—</div>
          <div class="drawer-person-sub" id="drawerPersonSub"></div>
        </div>
        <div class="drawer-person-actions">
          <a id="drawerDetailLink" href="#" class="btn btn-ghost btn-sm" title="Abrir detalhe completo">
            <i class="mdi mdi-open-in-new"></i>
          </a>
        </div>
      </div>
      <div class="drawer-body" id="drawerBody"></div>
      <div class="drawer-footer">
        <button class="btn btn-danger btn-sm" id="drawerDeleteBtn"><i class="mdi mdi-delete-outline"></i> Apagar</button>
        <button class="btn btn-ghost btn-sm" id="drawerCancelBtn">Cancelar</button>
        <button class="btn btn-sm" id="drawerSaveBtn"><i class="mdi mdi-content-save-outline"></i> Guardar</button>
      </div>
    </div>

    <!-- ── Drawer photo modal ── -->
    <div id="drawerPhotoModal" style="display:none;position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.72);align-items:flex-start;justify-content:center;z-index:600;overflow-y:auto;padding:24px 0;">
      <div style="background:var(--bg-card);padding:22px;border-radius:12px;max-width:1000px;width:96%;box-sizing:border-box;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <div style="font-weight:700">Visualizar Foto</div>
          <button onclick="_drawerClosePhotoModal()" class="btn">Fechar</button>
        </div>
        <div style="margin-bottom:8px;font-size:0.82rem;color:#aaa;">Arrasta um retângulo sobre a imagem para identificar uma pessoa.</div>
        <div id="drawerModalImageWrapper" style="display:flex;align-items:center;justify-content:center;margin-bottom:16px;padding:8px;">
          <div id="drawerModalImageArea" style="max-width:100%;overflow:visible;">
            <!-- image + overlays inserted by JS -->
          </div>
        </div>
        <div style="margin-bottom:8px;">
          <label style="font-weight:600;color:var(--text-secondary);display:block;margin-bottom:6px;">Notas da Foto</label>
          <textarea id="drawerPhotoNotesArea" style="width:100%;min-height:80px;padding:8px;border-radius:8px;border:1px solid rgba(163,163,255,0.08);background:rgba(35,40,58,0.7);color:var(--text-main);box-sizing:border-box;resize:vertical;"></textarea>
          <div id="drawerPhotoTaggedPeople" style="margin-top:8px;font-size:0.95rem;color:var(--text-main);"></div>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;">
          <button class="btn" onclick="_drawerSavePhotoNotes()">Salvar Notas</button>
        </div>
      </div>
    </div>

    <script>
            // Novo controle de exibição da ficha
            const formPanel = document.getElementById('formPanel');
            function showFormPanel(show = true) {
              formPanel.style.display = show ? 'block' : 'none';
            }
            // Accordion helpers
            function openAccordion(id) {
              const el = document.getElementById(id);
              if (!el) return;
              el.style.display = 'block';
              if (el.parentElement) el.parentElement.classList.add('open');
            }
            function closeAccordion(id) {
              const el = document.getElementById(id);
              if (!el) return;
              el.style.display = 'none';
              if (el.parentElement) el.parentElement.classList.remove('open');
            }
            function toggleAccordion(id) {
              const el = document.getElementById(id);
              if (!el) return;
              if (el.style.display === 'block') closeAccordion(id); else openAccordion(id);
            }
            // Wire accordion headers
            document.addEventListener('click', function(e){
              const btn = e.target.closest && e.target.closest('.accordion-header');
              if (btn && btn.dataset && btn.dataset.target) {
                toggleAccordion(btn.dataset.target);
              }
            });

            // Modifica editPerson para mostrar ficha e folders
            const originalEditPerson = editPerson;
            editPerson = function(id) {
              const people = loadPeople();
              const p = people.find(x => x.id === id);
              if (!p) return alert('Registro não encontrado');
              document.getElementById('id').value = p.id;
              document.getElementById('firstName').value = p.firstName || '';
              document.getElementById('lastName').value = p.lastName || '';
              document.getElementById('gender').value = p.gender || '';
              document.getElementById('notes').value = p.notes || '';
              // Exibe datas no rodapé
              showDatesInfo(p);
              // Calcula e exibe idade (ou idade ao falecer)
              try {
                const evs = getEvents();
                const birth = evs.find(e => e.personId === p.id && e.type === 'BIRTH' && !e.deletedAt);
                const death = evs.find(e => e.personId === p.id && e.type === 'DEATH' && !e.deletedAt);
                const ageEl = document.getElementById('ageInfo');
                if (birth && birth.date) {
                  const ref = death && death.date ? death.date : new Date().toISOString();
                  const age = computeAge(birth.date, ref);
                  ageEl.textContent = age == null ? '' : (death ? 'Idade ao falecer: ' + age + ' anos' : 'Idade: ' + age + ' anos');
                } else if (ageEl) {
                  ageEl.textContent = '';
                }
              } catch (e) { /* ignore */ }
              showFormPanel(true);
              // Abre panel de Dados e, se existirem, relações/eventos
              if (document.getElementById('contentRelacoes')) openAccordion('contentRelacoes');
              if (document.getElementById('contentEventos')) openAccordion('contentEventos');
              openAccordion('contentDados');
              // Preenche pessoas para relação (se select presente)
              if (document.getElementById('relationPerson')) fillRelationPersonSelect(id);
              // Renderiza listas apenas se os containers existirem
              if (document.getElementById('relationsList')) renderRelationsList(id);
              if (document.getElementById('eventsList')) renderEventsList(id);
            }
            // Oculta ficha ao salvar ou limpar
            document.getElementById('personForm').addEventListener('submit', function(e){
              e.preventDefault();
              const id = document.getElementById('id').value || generateUUID();
              const firstName = document.getElementById('firstName').value.trim();
              const lastName = document.getElementById('lastName').value.trim();
              const gender = document.getElementById('gender').value;
              const notes = document.getElementById('notes').value;
              const people = loadPeople();
              const existingIndex = people.findIndex(x => x.id === id);
              const now = nowISO();
              let createdAt = now;
              let deletedAt = null;
              if (existingIndex >= 0) {
                createdAt = people[existingIndex].createdAt || now;
                deletedAt = people[existingIndex].deletedAt || null;
                people[existingIndex] = {
                  ...people[existingIndex],
                  firstName, lastName, gender, notes,
                  updatedAt: now
                };
              } else {
                people.push({
                  id,
                  firstName,
                  lastName,
                  gender,
                  notes,
                  createdAt: now,
                  updatedAt: now,
                  deletedAt: null
                });
              }
              savePeople(people);
              renderTable();
              resetForm();
              showDatesInfo();
              showFormPanel(false);
              closeAccordion('contentRelacoes');
              closeAccordion('contentEventos');
              closeAccordion('contentDados');
            });
            document.getElementById('resetBtn').addEventListener('click', function(){
              resetForm();
              showDatesInfo();
              showFormPanel(false);
              closeAccordion('contentRelacoes');
              closeAccordion('contentEventos');
              closeAccordion('contentDados');
            });
            // Botão Detalhe: abre página de detalhe com todas as secções
            const detailBtn = document.getElementById('detailBtn');
            if (detailBtn) detailBtn.addEventListener('click', function(){
              const id = document.getElementById('id').value;
              if (!id) return alert('Nenhuma pessoa selecionada');
              window.location.href = 'pessoa-detalhe.html?id=' + encodeURIComponent(id);
            });
            // Oculta ficha ao iniciar
            showFormPanel(false);
            closeAccordion('contentRelacoes');
            closeAccordion('contentEventos');
            closeAccordion('contentDados');
            // Helpers to toggle small forms: show lists by default
            function showEventForm(show) {
              const w = document.getElementById('eventFormWrapper');
              const list = document.getElementById('eventsList');
              if (!w || !list) return;
              w.style.display = show ? 'block' : 'none';
              list.style.display = show ? 'none' : 'block';
            }
            function showRelationForm(show) {
              const w = document.getElementById('relationFormWrapper');
              const list = document.getElementById('relationsList');
              if (!w || !list) return;
              w.style.display = show ? 'block' : 'none';
              list.style.display = show ? 'none' : 'block';
            }
            // Wire open / cancel buttons for events/relations (if present)
            (function(){
              const openEventBtn = document.getElementById('openEventFormBtn');
              if (openEventBtn) openEventBtn.addEventListener('click', function(){ showEventForm(true); openAccordion('contentEventos'); });
              const cancelEventBtn = document.getElementById('cancelEventBtn');
              if (cancelEventBtn) cancelEventBtn.addEventListener('click', function(){ const f = document.getElementById('eventForm'); if(f) f.reset(); showEventForm(false); });
              const openRelationBtn = document.getElementById('openRelationFormBtn');
              if (openRelationBtn) openRelationBtn.addEventListener('click', function(){ showRelationForm(true); openAccordion('contentRelacoes'); });
              const cancelRelationBtn = document.getElementById('cancelRelationBtn');
              if (cancelRelationBtn) cancelRelationBtn.addEventListener('click', function(){ const f = document.getElementById('relationForm'); if(f) f.reset(); showRelationForm(false); });
            })();
            // Eventos
            function getEvents() {
              try {
                const raw = localStorage.getItem('events:myLineage');
                return raw ? JSON.parse(raw) : [];
              } catch (e) { return []; }
            }
            function saveEvents(events) {
              localStorage.setItem('events:myLineage', JSON.stringify(events));
            }
            function renderEventsList(personId) {
              // Always show the list view by default when rendering
              try { showEventForm(false); } catch (e) {}
              const events = getEvents();
              const list = document.getElementById('eventsList');
              const evs = events.filter(ev => ev.personId === personId && !ev.deletedAt);
              if (evs.length === 0) {
                list.innerHTML = '<div style="color:#888">Nenhum evento cadastrado.</div>';
                return;
              }
              let html = '<ul>';
              evs.forEach((ev, idx) => {
                html += `<li><b>${ev.type}</b> - ${ev.date || 'Sem data'}${ev.location ? ', ' + ev.location : ''} <br><small>${ev.notes || ''}</small> <button class="remove-event" data-index="${idx}" title="Remover evento" style="background:none;border:none;cursor:pointer;padding:0;margin-left:8px;"><i class="mdi mdi-trash-can" style="font-size:1.2em;" aria-hidden="true"></i></button></li>`;
              });
              html += '</ul>';
              list.innerHTML = html;
              // Adiciona handler para remover evento
              document.querySelectorAll('.remove-event').forEach(btn => {
                btn.addEventListener('click', function(){
                  const idx = parseInt(this.getAttribute('data-index'));
                  let events = getEvents();
                  const evs = events.filter(ev => ev.personId === personId && !ev.deletedAt);
                  const eventToRemove = evs[idx];
                  events = events.map(ev => {
                    if (ev.id === eventToRemove.id) {
                      return { ...ev, deletedAt: nowISO(), updatedAt: nowISO() };
                    }
                    return ev;
                  });
                  saveEvents(events);
                  renderEventsList(personId);
                  renderTable(); // Atualiza tabela
                });
              });
            }
            const addEventBtnEl = document.getElementById('addEventBtn');
            if (addEventBtnEl) addEventBtnEl.addEventListener('click', function(){
              const personId = document.getElementById('id').value;
              if (!personId) return alert('Pessoa não selecionada');
              const type = document.getElementById('eventType').value;
              const date = document.getElementById('eventDate').value || null;
              const location = document.getElementById('eventLocation').value || null;
              const notes = document.getElementById('eventNotes').value || '';
              if (!type) return alert('Tipo de evento obrigatório');
              const events = getEvents();
              const now = nowISO();
              events.push({
                id: generateUUID(),
                personId,
                type,
                date,
                location,
                notes,
                createdAt: now,
                updatedAt: now,
                deletedAt: null
              });
              saveEvents(events);
              renderEventsList(personId);
              renderTable(); // Atualiza tabela
              const evForm = document.getElementById('eventForm'); if (evForm) evForm.reset();
              showEventForm(false);
            });

            // Relações
            function fillRelationPersonSelect(currentId) {
              const people = loadPeople();
              const select = document.getElementById('relationPerson');
              select.innerHTML = '<option value="">-- selecione --</option>';
              people.forEach(p => {
                if (p.id !== currentId && !p.deletedAt) {
                  select.innerHTML += `<option value="${p.id}">${escapeHtml(p.firstName)} ${escapeHtml(p.lastName)}</option>`;
                }
              });
            }

            // Abre a ficha de uma pessoa (usado para navegação por relações)
            function showPersonDetail(id) {
              const people = loadPeople();
              const p = people.find(x => x.id === id);
              if (!p) return alert('Registro não encontrado');
              document.getElementById('id').value = p.id;
              document.getElementById('firstName').value = p.firstName || '';
              document.getElementById('lastName').value = p.lastName || '';
              document.getElementById('gender').value = p.gender || '';
              document.getElementById('notes').value = p.notes || '';
              if (document.getElementById('createdAt')) document.getElementById('createdAt').value = p.createdAt || '';
              if (document.getElementById('updatedAt')) document.getElementById('updatedAt').value = p.updatedAt || '';
              if (document.getElementById('deletedAt')) document.getElementById('deletedAt').value = p.deletedAt || '';
              showDatesInfo(p);
              // Calcula e exibe idade (ou idade ao falecer)
              try {
                const evs = getEvents();
                const birth = evs.find(e => e.personId === p.id && e.type === 'BIRTH' && !e.deletedAt);
                const death = evs.find(e => e.personId === p.id && e.type === 'DEATH' && !e.deletedAt);
                const ageEl = document.getElementById('ageInfo');
                if (birth && birth.date) {
                  const ref = death && death.date ? death.date : new Date().toISOString();
                  const age = computeAge(birth.date, ref);
                  ageEl.textContent = age == null ? '' : (death ? 'Idade ao falecer: ' + age + ' anos' : 'Idade: ' + age + ' anos');
                } else if (ageEl) {
                  ageEl.textContent = '';
                }
              } catch (e) { /* ignore */ }
              showFormPanel(true);
              if (document.getElementById('contentRelacoes')) openAccordion('contentRelacoes');
              if (document.getElementById('contentEventos')) openAccordion('contentEventos');
              openAccordion('contentDados');
              if (document.getElementById('relationPerson')) fillRelationPersonSelect(id);
              if (document.getElementById('relationsList')) renderRelationsList(id);
              if (document.getElementById('eventsList')) renderEventsList(id);
              window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            function getRelations() {
              try {
                const raw = localStorage.getItem('relations:myLineage');
                return raw ? JSON.parse(raw) : [];
              } catch (e) { return []; }
            }
            function saveRelations(relations) {
              localStorage.setItem('relations:myLineage', JSON.stringify(relations));
            }
            function renderRelationsList(personId) {
              // Ensure relation form is closed and the list is visible
              try { showRelationForm(false); } catch(e) {}
              const relations = getRelations();
              const people = loadPeople();
              const list = document.getElementById('relationsList');
              const rels = relations.filter(r => r.from === personId);
              if (rels.length === 0) {
                list.innerHTML = '<div style="color:#888">Nenhuma relação cadastrada.</div>';
                return;
              }
              const typeDesc = {
                siblin: 'Irmão / Irmã',
                ancestor: 'Pai / Mãe',
                child: 'Filho(a)',
                mate: 'Companheiro(a)'
              };
              let html = '<ul>';
              rels.forEach((r, idx) => {
                const p = people.find(x => x.id === r.to);
                const desc = typeDesc[r.type] || r.type;
                  const nameHtml = p ? `<a href="#" class="relation-link" data-id="${p.id}">${escapeHtml(p.firstName + ' ' + p.lastName)}</a>` : escapeHtml(r.to);
                  html += `<li>${desc}: ${nameHtml} <button class="remove-relation" data-index="${idx}" title="Remover relação" style="background:none;border:none;cursor:pointer;padding:0;margin-left:8px;"><i class="mdi mdi-trash-can" style="font-size:1.2em;" aria-hidden="true"></i></button></li>`;
              });
              html += '</ul>';
              list.innerHTML = html;
                // add click handlers for relation links (navigate to related person's detail)
                document.querySelectorAll('.relation-link').forEach(a => {
                  a.addEventListener('click', function(ev){ ev.preventDefault(); const id = this.getAttribute('data-id'); if(id) showPersonDetail(id); });
                });
              // Adiciona handler para remover relação
              document.querySelectorAll('.remove-relation').forEach(btn => {
                btn.addEventListener('click', function(){
                  const idx = parseInt(this.getAttribute('data-index'));
                  let relations = getRelations();
                  const rels = relations.filter(r => r.from === personId);
                  const relToRemove = rels[idx];
                  relations = relations.filter(r => !(r.from === personId && r.to === relToRemove.to && r.type === relToRemove.type));
                  saveRelations(relations);
                  renderRelationsList(personId);
                });
              });
            }
            const addRelationBtnEl = document.getElementById('addRelationBtn');
            if (addRelationBtnEl) addRelationBtnEl.addEventListener('click', function(){
              const type = document.getElementById('relationType').value;
              const to = document.getElementById('relationPerson').value;
              const from = document.getElementById('id').value;
              if (!type || !to || !from) return alert('Selecione tipo e pessoa relacionada.');
              const relations = getRelations();
              relations.push({ from, to, type });
              saveRelations(relations);
              renderRelationsList(from);
              const relTypeEl = document.getElementById('relationType'); if (relTypeEl) relTypeEl.value = '';
              const relPersonEl = document.getElementById('relationPerson'); if (relPersonEl) relPersonEl.value = '';
              showRelationForm(false);
            });
      const STORAGE_KEY = 'people:myLineage';

      function nowISO() { return new Date().toISOString(); }

      function generateUUID() {
        if (crypto && crypto.randomUUID) return crypto.randomUUID();
        const bytes = crypto.getRandomValues(new Uint8Array(16));
        bytes[6] = (bytes[6] & 0x0f) | 0x40;
        bytes[8] = (bytes[8] & 0x3f) | 0x80;
        const b2h = b => Array.from(b).map(x => x.toString(16).padStart(2,'0')).join('');
        const s = b2h(bytes);
        return s.slice(0,8)+'-'+s.slice(8,12)+'-'+s.slice(12,16)+'-'+s.slice(16,20)+'-'+s.slice(20);
      }

      function loadPeople() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : [];
        } catch (e) {
          console.error('Erro ao ler storage', e);
          return [];
        }
      }

      function savePeople(people) { localStorage.setItem(STORAGE_KEY, JSON.stringify(people)); }

      // Pagination + filter state
      let currentPage = 1;
      const PAGE_SIZE = 10;
      // currentFilter is applied when the user clicks the search button or presses Enter
      let currentFilter = '';

      function renderPagination(totalPages) {
        const ctrl = document.getElementById('paginationControls');
        if (!ctrl) return;
        if (totalPages <= 1) { ctrl.innerHTML = ''; return; }
        const prevDisabled = currentPage <= 1 ? 'disabled' : '';
        const nextDisabled = currentPage >= totalPages ? 'disabled' : '';
        // force no line-breaks and keep controls inline
        ctrl.style.whiteSpace = 'nowrap';
        ctrl.style.display = 'inline-flex';
        ctrl.style.alignItems = 'center';
        ctrl.style.gap = '6px';
        ctrl.innerHTML = `<button id="prevPage" ${prevDisabled} class="icon-btn" aria-label="Página anterior"><i class="mdi mdi-chevron-left" aria-hidden="true"></i></button><span style="margin-right:0;">Página ${currentPage} de ${totalPages}</span><button id="nextPage" ${nextDisabled} class="icon-btn" aria-label="Próxima página"><i class="mdi mdi-chevron-right" aria-hidden="true"></i></button>`;
        const prev = document.getElementById('prevPage');
        const next = document.getElementById('nextPage');
        if (prev) prev.addEventListener('click', function(){ if (currentPage>1) { currentPage--; renderTable(); } });
        if (next) next.addEventListener('click', function(){ if (currentPage<totalPages) { currentPage++; renderTable(); } });
      }

      function renderTable() {
        const tbody = document.querySelector('#peopleTable tbody');
        tbody.innerHTML = '';
        const all = loadPeople();
        const hideDeleted = document.getElementById('hideDeleted').checked;
        const filter = currentFilter;

        // Apply hidden and filter
        const filtered = all.filter(p => {
          if (hideDeleted && p.deletedAt) return false;
          if (!filter) return true;
          const full = ((p.firstName||'') + ' ' + (p.lastName||'')).toLowerCase();
          return full.indexOf(filter) !== -1;
        });

        const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
        if (currentPage > totalPages) currentPage = totalPages;
        const start = (currentPage - 1) * PAGE_SIZE;
        const pageItems = filtered.slice(start, start + PAGE_SIZE);

        pageItems.forEach(p => {
          const tr = document.createElement('tr');
          if (p.deletedAt) tr.classList.add('deleted');
          const fullName = ((p.firstName||'') + ' ' + (p.lastName||'')).replace(/\s+/g,' ').trim();
          const fullNameEsc = escapeHtml(fullName);
          tr.innerHTML = `
            <td><a href="#" class="person-link" data-id="${p.id}">${fullNameEsc}</a></td>
            <td class="actions">
              <button data-id="${p.id}" class="detail" title="Detalhe" style="background:none;border:none;cursor:pointer;padding:0;margin-right:20px;"><i class="mdi mdi-eye" style="font-size:1.2em;" aria-hidden="true"></i></button>
              <button data-id="${p.id}" class="tree-focus" title="Ver na Árvore" style="background:none;border:none;cursor:pointer;padding:0;"><i class="mdi mdi-sitemap" style="font-size:1.2em;" aria-hidden="true"></i></button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        renderPagination(totalPages);
      }

      // Search button / Enter key behavior: apply filter independently and reset to page 1
      (function(){
        const btn = document.getElementById('nameSearchBtn');
        const input = document.getElementById('nameFilter');
        if (btn && input) {
          btn.addEventListener('click', function(){
            currentFilter = (input.value || '').toLowerCase().trim();
            currentPage = 1;
            renderTable();
          });
          input.addEventListener('keydown', function(e){
            if (e.key === 'Enter'){
              e.preventDefault();
              currentFilter = (input.value || '').toLowerCase().trim();
              currentPage = 1;
              renderTable();
            }
          });
        }
      })();

      function escapeHtml(s){ return String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

      function resetForm() {
        document.getElementById('personForm').reset();
        document.getElementById('id').value = '';
        // Limpa campos de datas que só existem após salvar (criação deve deixar em branco)
        if (document.getElementById('createdAt')) document.getElementById('createdAt').value = '';
        if (document.getElementById('updatedAt')) document.getElementById('updatedAt').value = '';
        if (document.getElementById('deletedAt')) document.getElementById('deletedAt').value = '';
          const ageEl = document.getElementById('ageInfo'); if (ageEl) ageEl.textContent = '';
      }

      function formatDate(dateStr) {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        if (isNaN(d)) return escapeHtml(dateStr);
        const pad = n => n.toString().padStart(2, '0');
        const day = pad(d.getDate());
        const month = pad(d.getMonth() + 1);
        const year = d.getFullYear();
        return `${day}-${month}-${year}`;
      }

      function computeAge(birthStr, refStr) {
        if (!birthStr) return null;
        const b = new Date(birthStr);
        const r = refStr ? new Date(refStr) : new Date();
        if (isNaN(b) || isNaN(r)) return null;
        let years = r.getFullYear() - b.getFullYear();
        const m = r.getMonth() - b.getMonth();
        if (m < 0 || (m === 0 && r.getDate() < b.getDate())) years--;
        return years;
      }

      function showDatesInfo(person) {
        const el = document.getElementById('datesInfo');
        if (!el) return;
        if (!person) {
          el.innerHTML = '';
          return;
        }
        let html = '';
        if (person.createdAt) html += `<div>Criado em: <span>${formatDate(person.createdAt)}</span></div>`;
        if (person.updatedAt) html += `<div>Atualizado em: <span>${formatDate(person.updatedAt)}</span></div>`;
        if (person.deletedAt) html += `<div>Excluído em: <span>${formatDate(person.deletedAt)}</span></div>`;
        el.innerHTML = html;
      }

      document.getElementById('personForm').addEventListener('submit', function(e){
        e.preventDefault();
        const id = document.getElementById('id').value || generateUUID();
        const firstName = document.getElementById('firstName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        const gender = document.getElementById('gender').value;
        const notes = document.getElementById('notes').value;
        const createdAtField = document.getElementById('createdAt').value;
        const deletedAtField = document.getElementById('deletedAt').value || null;

        const people = loadPeople();
        const existingIndex = people.findIndex(x => x.id === id);
        const now = nowISO();

        if (existingIndex >= 0) {
          people[existingIndex] = {
            ...people[existingIndex],
            firstName, lastName, gender, notes,
            updatedAt: now,
            deletedAt: deletedAtField || null
          };
        } else {
          people.push({
            id,
            firstName,
            lastName,
            gender,
            notes,
            createdAt: createdAtField || now,
            updatedAt: now,
            deletedAt: deletedAtField || null
          });
        }

        savePeople(people);
        renderTable();
        resetForm();
      });

      document.getElementById('resetBtn').addEventListener('click', function(){ resetForm(); });

      document.getElementById('peopleTable').addEventListener('click', function(e){
        // Prevent default navigation for links
        if (e.target && e.target.tagName === 'A') e.preventDefault();
        // Find the closest element that carries a data-id
        const el = e.target.closest && e.target.closest('[data-id]');
        if (!el) return;
        const id = el.getAttribute('data-id');
        if (!id) return;
        // If it's the person link or edit: open edit; detail: open detail page; del: soft delete
        if (el.classList.contains('edit') || el.classList.contains('person-link')) {
          openDrawer('edit', id);
        } else if (el.classList.contains('detail')) {
          window.location.href = 'pessoa-detalhe.html?id=' + encodeURIComponent(id);
        } else if (el.classList.contains('tree-focus')) {
          sessionStorage.setItem('tempFocusPerson:myLineage', JSON.stringify({ id: id }));
          window.location.href = 'arvore.html';
        }
      });

      document.getElementById('hideDeleted').addEventListener('change', renderTable);

      function editPerson(id) {
        const people = loadPeople();
        const p = people.find(x => x.id === id);
        if (!p) return alert('Registro não encontrado');
        document.getElementById('id').value = p.id;
        document.getElementById('firstName').value = p.firstName || '';
        document.getElementById('lastName').value = p.lastName || '';
        document.getElementById('gender').value = p.gender || '';
        document.getElementById('notes').value = p.notes || '';
        document.getElementById('createdAt').value = p.createdAt || '';
        document.getElementById('updatedAt').value = p.updatedAt || '';
        document.getElementById('deletedAt').value = p.deletedAt || '';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function softDeletePerson(id) {
        if (!confirm('Confirmar exclusão (soft delete)?')) return;
        const people = loadPeople();
        const i = people.findIndex(x => x.id === id);
        if (i < 0) return alert('Registro não encontrado');
        people[i].deletedAt = nowISO();
        people[i].updatedAt = nowISO();
        savePeople(people);
        renderTable();
      }

      renderTable();

      // ═══════════════════════════════════════════════
      //  DRAWER — inline person editor (same as árvore)
      // ═══════════════════════════════════════════════
      let _drawerPersonId = null;
      let _drawerMode = 'edit';

      function getPhotos(){ try{ const raw = localStorage.getItem('photos:myLineage'); return raw ? JSON.parse(raw) : []; }catch(e){ return []; } }
      function getPhotoRelations(){ try{ const raw = localStorage.getItem('photoRelations:myLineage'); return raw ? JSON.parse(raw) : {}; }catch(e){ return {}; } }
      function getThumbnailForPerson(personId){ try{ const rels = getPhotoRelations(); const photos = getPhotos(); const ids = rels[personId] || []; if(Array.isArray(ids) && ids.length){ for(const id of ids){ const ph = photos.find(p=>String(p.id)===String(id)); if(ph){ return ph.originalDataUrl || ph.dataUrl || null; } } } return null; }catch(e){ return null; } }

      function _esc(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

      function openDrawer(mode, personId){
        const _footer = document.querySelector('.drawer-footer');
        if(_footer) _footer.style.display = '';
        const _backBtn = document.getElementById('drawerBackBtn');
        if(_backBtn){ _backBtn.style.display = 'none'; _backBtn._personId = null; }
        const _phdr = document.getElementById('drawerPersonHeader');
        if(_phdr) _phdr.style.display = '';
        _drawerMode = mode;
        _drawerPersonId = personId ? String(personId) : null;
        const people = loadPeople();
        const person = personId ? people.find(p=>String(p.id)===String(personId)) : null;
        const drawer  = document.getElementById('personDrawer');
        const overlay = document.getElementById('drawerOverlay');
        document.getElementById('drawerTitle').textContent = mode === 'create' ? 'Nova Pessoa' : 'Editar Pessoa';
        const nameEl = document.getElementById('drawerPersonName');
        const subEl  = document.getElementById('drawerPersonSub');
        const avatarEl = document.getElementById('drawerAvatar');
        const detailLink = document.getElementById('drawerDetailLink');
        if(person){
          const fullName = (((person.firstName||'')+' '+(person.lastName||'')).trim()) || '(sem nome)';
          nameEl.textContent = fullName;
          let sub = [];
          const evAll = (function(){ try{ return JSON.parse(localStorage.getItem('events:myLineage')||'[]'); }catch(e){ return []; } })();
          const evB = evAll.find(e=>String(e.personId)===String(person.id)&&(e.type==='BIRTH'||e.type==='birth')&&!e.deletedAt);
          if(evB&&evB.date) sub.push('\u2605 '+evB.date);
          const evD = evAll.find(e=>String(e.personId)===String(person.id)&&(e.type==='DEATH'||e.type==='death')&&!e.deletedAt);
          if(evD&&evD.date) sub.push('\u271D '+evD.date);
          subEl.textContent = sub.join('  ·  ');
          const thumb = getThumbnailForPerson(person.id);
          if(thumb){ avatarEl.style.backgroundImage='url('+thumb+')'; avatarEl.style.backgroundSize='cover'; avatarEl.style.backgroundPosition='center'; }
          else{ avatarEl.style.backgroundImage=''; const g=(person.gender||'').toLowerCase(); avatarEl.style.background=(g==='female'||g==='feminino'||g==='f')?'#e26aa6':(g==='male'||g==='masculino'||g==='m')?'#4493f8':'#9aa0a6'; }
          detailLink.href='pessoa-detalhe.html?id='+encodeURIComponent(person.id);
          detailLink.style.display='';
        } else {
          nameEl.textContent='Nova Pessoa'; subEl.textContent='';
          avatarEl.style.backgroundImage=''; avatarEl.style.background='var(--bg-surface-2)';
          detailLink.style.display='none';
        }
        const body = document.getElementById('drawerBody');
        const firstName = person?(person.firstName||''):'';
        const lastName  = person?(person.lastName||''):'';
        const gender    = person?(person.gender||''):'';
        const notes     = person?(person.notes||''):'';
        body.innerHTML = [
          '<div class="drawer-section-label">Identidade</div>',
          '<div class="form-row">',
            '<div><label>Primeiro nome</label><input type="text" id="df_firstName" value="'+_esc(firstName)+'" placeholder="Nome" /></div>',
            '<div><label>Apelido</label><input type="text" id="df_lastName" value="'+_esc(lastName)+'" placeholder="Apelido" /></div>',
          '</div>',
          '<div><label>Género</label>',
            '<select id="df_gender">',
              '<option value=""'+(!gender?'selected':'')+'>​(n/a)</option>',
              '<option value="male"'+(gender==='male'||gender==='masculino'||gender==='m'?'selected':'')+'>Masculino</option>',
              '<option value="female"'+(gender==='female'||gender==='feminino'||gender==='f'?'selected':'')+'>Feminino</option>',
            '</select></div>',
          '<div class="drawer-section-label" style="margin-top:8px;">Notas</div>',
          '<div><textarea id="df_notes" rows="3" placeholder="Notas...">'+_esc(notes)+'</textarea></div>',
          person ? '<div style="margin-top:6px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;"><button class="btn btn-ghost btn-sm" style="font-size:0.82rem;" onclick="openDrawerSection(\''+person.id+'\',\'relacoes\')"><i class="mdi mdi-account-multiple-outline"></i> Rela\u00e7\u00f5es</button><button class="btn btn-ghost btn-sm" style="font-size:0.82rem;" onclick="openDrawerSection(\''+person.id+'\',\'eventos\')"><i class="mdi mdi-calendar-check-outline"></i> Eventos</button><button class="btn btn-ghost btn-sm" style="font-size:0.82rem;" onclick="openDrawerSection(\''+person.id+'\',\'fotos\')"><i class="mdi mdi-image-multiple-outline"></i> Fotos</button><button class="btn btn-ghost btn-sm" style="font-size:0.82rem;" onclick="_drawerShowAddPerson(\''+person.id+'\')"><i class="mdi mdi-account-plus-outline"></i> Adicionar</button></div>' : ''
        ].join('');
        drawer.classList.add('open');
        overlay.classList.add('open');
        setTimeout(()=>{ const fi=document.getElementById('df_firstName'); if(fi) fi.focus(); }, 50);
      }

      function closeDrawer(){
        document.getElementById('personDrawer').classList.remove('open');
        document.getElementById('drawerOverlay').classList.remove('open');
      }

      function openDrawerSection(personId, section){
        const people = loadPeople();
        const person = people.find(p=>String(p.id)===String(personId));
        if(!person) return;
        const footer = document.querySelector('.drawer-footer');
        if(footer) footer.style.display='none';
        const phdr = document.getElementById('drawerPersonHeader');
        if(phdr) phdr.style.display='none';
        const backBtn = document.getElementById('drawerBackBtn');
        if(backBtn){ backBtn.style.display=''; backBtn._personId=String(personId); }
        const sectionLabel = section==='relacoes'?'Relações':section==='fotos'?'Fotos':'Eventos';
        const personName = (((person.firstName||'')+' '+(person.lastName||'')).trim())||'';
        document.getElementById('drawerTitle').textContent = sectionLabel+' — '+personName;
        const body = document.getElementById('drawerBody');
        body.innerHTML = section==='relacoes' ? _renderDrawerRelations(String(personId), people) : section==='fotos' ? _renderDrawerPhotos(String(personId)) : _renderDrawerEvents(String(personId));
      }

      function _drawerGetEvents(){ try{ return JSON.parse(localStorage.getItem('events:myLineage')||'[]'); }catch(e){ return []; } }

      function _renderDrawerEvents(personId){
        const evs = _drawerGetEvents().filter(ev=>String(ev.personId)===personId&&!ev.deletedAt);
        const typeLabels={BIRTH:'Nascimento',BAPTISM:'Batismo',DEATH:'Óbito',MARRIAGE:'Casamento',DIVORCE:'Divórcio',ADOPTION:'Adoção',CUSTOM:'Outro'};
        function fmtDate(d){ if(!d) return ''; const p=d.split(/[-T]/); return p.length>=3?p[2]+'/'+p[1]+'/'+p[0]:d; }
        let html=`<div style="margin-bottom:12px;"><button class="btn btn-sm" onclick="_drawerShowAddEvent('${_esc(personId)}')" style="font-size:0.83rem;"><i class="mdi mdi-plus"></i> Adicionar Evento</button></div>`;
        if(!evs.length){ html+='<div style="color:#888;padding:4px 0 12px;">Nenhum evento cadastrado.</div>'; return html; }
        html+='<div class="mini-list">';
        evs.forEach(ev=>{
          const label=typeLabels[(ev.type||'').toUpperCase()]||ev.type||'';
          html+=`<div class="mini-card" style="padding:10px 12px;"><div style="display:flex;justify-content:space-between;align-items:center;gap:8px;"><div style="flex:1;"><span style="font-weight:600;font-size:0.9rem;">${_esc(label)}</span><span style="color:#888;font-size:0.82rem;margin-left:8px;">${_esc(fmtDate(ev.date||''))}</span></div><button onclick="_drawerDeleteEvent('${_esc(ev.id)}','${_esc(personId)}')" title="Apagar" style="background:none;border:none;cursor:pointer;color:#e06060;padding:2px 4px;font-size:1rem;line-height:1;flex-shrink:0;"><i class="mdi mdi-trash-can-outline"></i></button></div>${ev.location?`<div style="color:#aaa;font-size:0.82rem;margin-top:3px;">&#128205; ${_esc(ev.location)}</div>`:''} ${ev.notes?`<div style="color:#bbb;font-size:0.82rem;margin-top:3px;">${_esc(ev.notes)}</div>`:''}</div>`;
        });
        html+='</div>';
        return html;
      }

      function _drawerDeleteEvent(eventId, personId){
        if(!confirm('Apagar este evento?')) return;
        let events=_drawerGetEvents();
        events=events.map(ev=>ev.id===eventId?{...ev,deletedAt:new Date().toISOString()}:ev);
        localStorage.setItem('events:myLineage',JSON.stringify(events));
        const body=document.getElementById('drawerBody');
        if(body) body.innerHTML=_renderDrawerEvents(personId);
      }

      function _renderDrawerRelations(personId, people){
        let relations=[];
        try{ relations=JSON.parse(localStorage.getItem('relations:myLineage')||'[]'); }catch(e){}
        const rels=relations.filter(r=>r&&String(r.from)===personId);
        const typeDesc={siblin:'Irmão / Irmã',ancestor:'Pai / Mãe',child:'Filho(a)',mate:'Companheiro(a)'};
        let html=`<div style="margin-bottom:12px;"><button class="btn btn-sm" onclick="_drawerShowAddRelation('${_esc(personId)}')" style="font-size:0.83rem;"><i class="mdi mdi-plus"></i> Adicionar Relação</button></div>`;
        if(!rels.length){ html+='<div style="color:#888;padding:4px 0 12px;">Nenhuma relação cadastrada.</div>'; return html; }
        html+='<div class="mini-list">';
        rels.forEach(r=>{
          const p=people.find(x=>x.id===r.to);
          let desc=typeDesc[r.type]||r.type||'';
          if(p){ const g=((p.gender||'')+'').toLowerCase(); const isFem=g==='female'||g==='feminino'||g==='f'; const isMal=g==='male'||g==='masculino'||g==='m'; if(desc.includes('Filho')) desc=isFem?'Filha':isMal?'Filho':'Filho(a)'; if(desc.includes('Pai')||desc.includes('Mãe')) desc=isFem?'Mãe':isMal?'Pai':'Pai / Mãe'; if(desc.toLowerCase().includes('compan')||desc.includes('mate')) desc=isFem?'Companheira':isMal?'Companheiro':'Companheiro(a)'; if(desc.includes('Irm')) desc=isFem?'Irmã':isMal?'Irmão':'Irmão / Irmã'; }
          const name=p?(((p.firstName||'')+' '+(p.lastName||'')).trim()):r.to;
          html+=`<div class="mini-card" style="padding:10px 12px;"><div style="display:flex;justify-content:space-between;align-items:center;gap:8px;"><div style="flex:1;"><span style="font-weight:600;font-size:0.9rem;">${_esc(name)}</span><span style="color:#aaa;font-size:0.82rem;margin-left:8px;">${_esc(desc)}</span></div><button onclick="_drawerDeleteRelation('${_esc(personId)}','${_esc(r.to)}','${_esc(r.type)}')" title="Apagar" style="background:none;border:none;cursor:pointer;color:#e06060;padding:2px 4px;font-size:1rem;line-height:1;flex-shrink:0;"><i class="mdi mdi-trash-can-outline"></i></button></div></div>`;
        });
        html+='</div>';
        return html;
      }

      function _drawerShowAddEvent(personId){
        const body=document.getElementById('drawerBody');
        if(!body) return;
        body.innerHTML=`<div style="padding:4px 0 8px;"><h3 style="font-size:0.95rem;margin:0 0 14px;color:var(--text-primary);">Novo Evento</h3><div class="form-group" style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Tipo</label><select id="addEvType" style="width:100%;"><option value="BIRTH">Nascimento</option><option value="BAPTISM">Batismo</option><option value="DEATH">Óbito</option><option value="MARRIAGE">Casamento</option><option value="DIVORCE">Divórcio</option><option value="ADOPTION">Adoção</option><option value="CUSTOM">Outro</option></select></div><div class="form-group" style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Data</label><input id="addEvDate" type="date" style="width:100%;" /></div><div class="form-group" style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Local</label><input id="addEvLocation" type="text" placeholder="Local do evento" style="width:100%;" /></div><div class="form-group" style="margin-bottom:14px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Notas</label><textarea id="addEvNotes" rows="3" placeholder="Notas adicionais" style="width:100%;resize:vertical;"></textarea></div><div style="display:flex;gap:8px;justify-content:flex-end;"><button class="btn btn-ghost btn-sm" onclick="openDrawerSection('${_esc(personId)}','eventos')">Cancelar</button><button class="btn btn-sm" onclick="_drawerSaveNewEvent('${_esc(personId)}')"><i class="mdi mdi-content-save-outline"></i> Guardar</button></div></div>`;
      }

      function _drawerSaveNewEvent(personId){
        const type=(document.getElementById('addEvType')||{}).value||'CUSTOM';
        const date=(document.getElementById('addEvDate')||{}).value||'';
        const location=((document.getElementById('addEvLocation')||{}).value||'').trim();
        const notes=((document.getElementById('addEvNotes')||{}).value||'').trim();
        let events=_drawerGetEvents();
        const newEv={id:'ev_'+Date.now(),personId:String(personId),type:type.toUpperCase()};
        if(date) newEv.date=date;
        if(location) newEv.location=location;
        if(notes) newEv.notes=notes;
        events.push(newEv);
        localStorage.setItem('events:myLineage',JSON.stringify(events));
        openDrawerSection(personId,'eventos');
      }

      function _drawerShowAddRelation(personId){
        const people=loadPeople().filter(p=>!p.deletedAt&&String(p.id)!==String(personId));
        const body=document.getElementById('drawerBody');
        if(!body) return;
        const opts=people.map(p=>{ const name=(((p.firstName||'')+' '+(p.lastName||'')).trim())||p.id; return `<option value="${_esc(String(p.id))}">${_esc(name)}</option>`; }).join('');
        body.innerHTML=`<div style="padding:4px 0 8px;"><h3 style="font-size:0.95rem;margin:0 0 14px;color:var(--text-primary);">Nova Relação</h3><div class="form-group" style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Tipo de relação</label><select id="addRelType" style="width:100%;"><option value="ancestor">Pai / Mãe</option><option value="child">Filho(a)</option><option value="mate">Companheiro(a)</option><option value="siblin">Irmão / Irmã</option></select></div><div class="form-group" style="margin-bottom:14px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Pessoa</label><select id="addRelTo" style="width:100%;">${opts||'<option disabled>Nenhuma pessoa disponível</option>'}</select></div><div style="display:flex;gap:8px;justify-content:flex-end;"><button class="btn btn-ghost btn-sm" onclick="openDrawerSection('${_esc(personId)}','relacoes')">Cancelar</button><button class="btn btn-sm" onclick="_drawerSaveNewRelation('${_esc(personId)}')"><i class="mdi mdi-content-save-outline"></i> Guardar</button></div></div>`;
      }

      function _drawerSaveNewRelation(personId){
        const toId=(document.getElementById('addRelTo')||{}).value||'';
        const type=(document.getElementById('addRelType')||{}).value||'mate';
        if(!toId){ alert('Seleciona uma pessoa.'); return; }
        let relations=[];
        try{ relations=JSON.parse(localStorage.getItem('relations:myLineage')||'[]'); }catch(e){}
        const already=relations.some(r=>String(r.from)===String(personId)&&String(r.to)===String(toId)&&String(r.type)===String(type));
        if(already){ alert('Esta relação já existe.'); return; }
        relations.push({from:String(personId),to:String(toId),type});
        localStorage.setItem('relations:myLineage',JSON.stringify(relations));
        openDrawerSection(personId,'relacoes');
      }

      function _drawerDeleteRelation(fromId,toId,relType){
        if(!confirm('Apagar esta relação?')) return;
        let relations=[];
        try{ relations=JSON.parse(localStorage.getItem('relations:myLineage')||'[]'); }catch(e){}
        relations=relations.filter(r=>!(String(r.from)===String(fromId)&&String(r.to)===String(toId)&&String(r.type)===String(relType)));
        localStorage.setItem('relations:myLineage',JSON.stringify(relations));
        const body=document.getElementById('drawerBody');
        if(body) body.innerHTML=_renderDrawerRelations(fromId,loadPeople());
      }

      // ── Adicionar nova pessoa relacionada ─────────────────────────────────
      function _drawerShowAddPerson(personId){
        const people=loadPeople();
        const person=people.find(p=>String(p.id)===String(personId));
        if(!person) return;
        let relations=[];
        try{ relations=JSON.parse(localStorage.getItem('relations:myLineage')||'[]'); }catch(e){}
        const parentCount=relations.filter(r=>String(r.from)===String(personId)&&r.type==='ancestor').length;
        const footer=document.querySelector('.drawer-footer');
        if(footer) footer.style.display='none';
        const phdr=document.getElementById('drawerPersonHeader');
        if(phdr) phdr.style.display='none';
        const backBtn=document.getElementById('drawerBackBtn');
        if(backBtn){ backBtn.style.display=''; backBtn._personId=String(personId); }
        const personName=(((person.firstName||'')+' '+(person.lastName||'')).trim())||'';
        document.getElementById('drawerTitle').textContent='Adicionar \u2014 '+personName;
        const body=document.getElementById('drawerBody');
        if(!body) return;
        let kinshipOpts=`<option value="sibling_male">Irm\u00e3o</option><option value="sibling_female">Irm\u00e3</option><option value="child_male">Filho</option><option value="child_female">Filha</option>`;
        if(parentCount<2) kinshipOpts+=`<option value="ancestor_male">Pai</option><option value="ancestor_female">M\u00e3e</option>`;
        kinshipOpts+=`<option value="mate_male">Companheiro</option><option value="mate_female">Companheira</option>`;
        body.innerHTML=`<div style="padding:4px 0 8px;"><h3 style="font-size:0.95rem;margin:0 0 14px;color:var(--text-primary);">Nova Pessoa</h3><div class="form-group" style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Grau de parentesco</label><select id="addPersKinship" style="width:100%;" onchange="_drawerUpdateCoParentSection('${_esc(personId)}')">${kinshipOpts}</select></div><div id="addPersCoParentSection" class="form-group" style="margin-bottom:10px;display:none;"></div><div class="form-group" style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Primeiro nome</label><input id="addPersFirstName" type="text" placeholder="Nome" style="width:100%;" /></div><div class="form-group" style="margin-bottom:10px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Apelido</label><input id="addPersLastName" type="text" placeholder="Apelido" style="width:100%;" /></div><div class="form-group" style="margin-bottom:14px;"><label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Notas</label><textarea id="addPersNotes" rows="2" placeholder="Notas..." style="width:100%;resize:vertical;"></textarea></div><div style="display:flex;gap:8px;justify-content:flex-end;"><button class="btn btn-ghost btn-sm" onclick="openDrawer('edit','${_esc(personId)}')">Cancelar</button><button class="btn btn-sm" onclick="_drawerSaveNewPerson('${_esc(personId)}')"><i class="mdi mdi-content-save-outline"></i> Guardar</button></div></div>`;
        setTimeout(()=>{ const fi=document.getElementById('addPersFirstName'); if(fi) fi.focus(); },50);
      }

      function _drawerUpdateCoParentSection(personId){
        const kinship=(document.getElementById('addPersKinship')||{}).value||'';
        const section=document.getElementById('addPersCoParentSection');
        if(!section) return;
        if(kinship!=='child_male'&&kinship!=='child_female'){ section.style.display='none'; section.innerHTML=''; return; }
        let relations=[];
        try{ relations=JSON.parse(localStorage.getItem('relations:myLineage')||'[]'); }catch(e){}
        const mates=relations.filter(r=>String(r.from)===String(personId)&&r.type==='mate');
        if(mates.length<=1){ section.style.display='none'; section.innerHTML=''; return; }
        const people=loadPeople();
        const opts=mates.map(r=>{ const p=people.find(x=>String(x.id)===String(r.to)); const name=p?(((p.firstName||'')+' '+(p.lastName||'')).trim())||p.id:r.to; return `<option value="${_esc(String(r.to))}">${_esc(name)}</option>`; }).join('');
        section.innerHTML=`<label style="font-size:0.82rem;color:#aaa;display:block;margin-bottom:4px;">Outro progenitor</label><select id="addPersCoParent" style="width:100%;">${opts}</select>`;
        section.style.display='block';
      }

      function _drawerSaveNewPerson(personId){
        const kinship=((document.getElementById('addPersKinship')||{}).value||'');
        const firstName=((document.getElementById('addPersFirstName')||{}).value||'').trim();
        const lastName=((document.getElementById('addPersLastName')||{}).value||'').trim();
        const notes=((document.getElementById('addPersNotes')||{}).value||'').trim();
        if(!firstName&&!lastName){ alert('Introduza pelo menos um nome.'); return; }
        let gender='',relType='';
        if(kinship==='sibling_male'){ gender='male'; relType='siblin'; }
        else if(kinship==='sibling_female'){ gender='female'; relType='siblin'; }
        else if(kinship==='child_male'){ gender='male'; relType='child'; }
        else if(kinship==='child_female'){ gender='female'; relType='child'; }
        else if(kinship==='ancestor_male'){ gender='male'; relType='ancestor'; }
        else if(kinship==='ancestor_female'){ gender='female'; relType='ancestor'; }
        else if(kinship==='mate_male'){ gender='male'; relType='mate'; }
        else if(kinship==='mate_female'){ gender='female'; relType='mate'; }
        let people=loadPeople();
        const newId='p_'+Date.now();
        people.push({id:newId,firstName,lastName,gender,notes,createdAt:new Date().toISOString()});
        savePeople(people);
        if(relType){
          let relations=[];
          try{ relations=JSON.parse(localStorage.getItem('relations:myLineage')||'[]'); }catch(e){}
          relations.push({from:String(personId),to:String(newId),type:relType});
          if(relType==='siblin'){
            // herdar os mesmos pais da pessoa base
            relations.filter(r=>String(r.from)===String(personId)&&r.type==='ancestor')
              .forEach(r=>{ relations.push({from:String(newId),to:String(r.to),type:'ancestor'}); });
          }
          if(relType==='ancestor'){
            // relação inversa: novo pai/mãe tem a pessoa base como filho(a)
            relations.push({from:String(newId),to:String(personId),type:'child'});
            // pais já existentes da pessoa base (excluindo o que acabámos de adicionar)
            const existingParents=relations.filter(r=>String(r.from)===String(personId)&&r.type==='ancestor'&&String(r.to)!==String(newId));
            if(existingParents.length===0){
              // sem nenhum progenitor: criar <desconhecido> com género oposto
              const autoGender=(gender==='male'||gender==='masculino'||gender==='m')?'female':'male';
              const autoId='p_auto_'+Date.now();
              people.push({id:autoId,firstName:'<desconhecido>',lastName:'',gender:autoGender,notes:'',createdAt:new Date().toISOString()});
              savePeople(people);
              relations.push({from:String(personId),to:String(autoId),type:'ancestor'});
              relations.push({from:String(autoId),to:String(personId),type:'child'});
              relations.push({from:String(newId),to:String(autoId),type:'mate'});
              relations.push({from:String(autoId),to:String(newId),type:'mate'});
            } else {
              // já tem um progenitor: ligar novo como companheiro do existente
              const existingParentId=existingParents[0].to;
              relations.push({from:String(newId),to:String(existingParentId),type:'mate'});
              relations.push({from:String(existingParentId),to:String(newId),type:'mate'});
            }
          }
          if(relType==='mate'){
            // relação bidirecional: companheiro(a) também aponta para a pessoa base
            relations.push({from:String(newId),to:String(personId),type:'mate'});
          }
          if(relType==='child'){
            // child also needs ancestor entries pointing to its parents
            relations.push({from:String(newId),to:String(personId),type:'ancestor'});
            const mates=relations.filter(r=>String(r.from)===String(personId)&&r.type==='mate');
            if(mates.length===0){
              // sem companheiro: criar pessoa desconhecida com género oposto
              const basePerson=people.find(p=>String(p.id)===String(personId));
              const baseGender=((basePerson&&basePerson.gender)||'').toLowerCase();
              const autoGender=(baseGender==='male'||baseGender==='masculino'||baseGender==='m')?'female':'male';
              const autoId='p_auto_'+Date.now();
              people.push({id:autoId,firstName:'<desconhecido>',lastName:'',gender:autoGender,notes:'',createdAt:new Date().toISOString()});
              savePeople(people);
              relations.push({from:String(personId),to:String(autoId),type:'mate'});
              relations.push({from:String(autoId),to:String(personId),type:'mate'});
              relations.push({from:String(autoId),to:String(newId),type:'child'});
              relations.push({from:String(newId),to:String(autoId),type:'ancestor'});
            } else if(mates.length===1){
              relations.push({from:String(mates[0].to),to:String(newId),type:'child'});
              relations.push({from:String(newId),to:String(mates[0].to),type:'ancestor'});
            } else {
              const coParentId=((document.getElementById('addPersCoParent')||{}).value||'');
              if(coParentId){
                relations.push({from:String(coParentId),to:String(newId),type:'child'});
                relations.push({from:String(newId),to:String(coParentId),type:'ancestor'});
              }
            }
          }
          localStorage.setItem('relations:myLineage',JSON.stringify(relations));
        }
        openDrawer('edit',personId);
        renderTable();
      }

      // ── Fotos section ─────────────────────────────────────────────────────
      function _renderDrawerPhotos(personId){
        const photos = getPhotos();
        const rels = getPhotoRelations();
        const linked = (rels[personId] || []).map(id => photos.find(p => String(p.id) === String(id))).filter(Boolean);
        let html = `<div style="margin-bottom:14px;">`
          + `<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:6px;">`
          + `<label for="drawerPhotoInput" class="btn btn-sm" style="cursor:pointer;font-size:0.83rem;"><i class="mdi mdi-image-plus"></i> Escolher Ficheiro</label>`
          + `<span id="drawerPhotoName" style="color:#aaa;font-size:0.82rem;max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">Nenhum ficheiro</span>`
          + `<button class="btn btn-sm" onclick="_drawerUploadPhoto('${_esc(personId)}')" style="font-size:0.83rem;"><i class="mdi mdi-upload"></i> Upload</button>`
          + `</div>`
          + `<input type="file" id="drawerPhotoInput" accept="image/*" style="display:none;" onchange="document.getElementById('drawerPhotoName').textContent=this.files&&this.files.length?this.files[0].name:'Nenhum ficheiro'" />`
          + `</div>`;
        if(!linked.length){ html += '<div style="color:#888;padding:4px 0 12px;">Nenhuma foto associada.</div>'; return html; }
        html += '<div style="display:flex;flex-wrap:wrap;gap:10px;">';
        linked.forEach(ph => {
          const src = ph.originalDataUrl || ph.dataUrl || '';
          html += `<div style="position:relative;display:inline-block;">`
            + `<img src="${src}" style="width:72px;height:72px;object-fit:cover;border-radius:6px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.3);" onclick="_drawerViewPhoto('${_esc(ph.id)}')" title="${_esc(ph.name||'')}" />`
            + `<button onclick="_drawerUnlinkPhoto('${_esc(ph.id)}','${_esc(personId)}')" title="Remover vínculo" style="position:absolute;top:-6px;right:-6px;background:#e06060;border:none;color:#fff;border-radius:50%;width:18px;height:18px;font-size:0.65rem;cursor:pointer;padding:0;display:flex;align-items:center;justify-content:center;"><i class="mdi mdi-close"></i></button>`
            + `</div>`;
        });
        html += '</div>';
        return html;
      }

      async function _drawerUploadPhoto(personId){
        const input = document.getElementById('drawerPhotoInput');
        if(!input || !input.files || !input.files.length) return alert('Selecione uma imagem para upload.');
        const photos = getPhotos();
        const rels = getPhotoRelations();
        const f = input.files[0];
        try{
          const dataUrl = await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=()=>rej(); r.readAsDataURL(f); });
          const id = 'ph_' + Date.now();
          photos.push({ id, name: f.name, originalDataUrl: dataUrl, baseCopyName: null, createdAt: new Date().toISOString() });
          rels[personId] = rels[personId] || [];
          rels[personId].push(id);
          localStorage.setItem('photos:myLineage', JSON.stringify(photos));
          localStorage.setItem('photoRelations:myLineage', JSON.stringify(rels));
          input.value = '';
          openDrawerSection(personId, 'fotos');
        }catch(err){ alert('Erro no upload: ' + err); }
      }

      function _drawerUnlinkPhoto(photoId, personId){
        if(!confirm('Remover vínculo desta foto?')) return;
        const rels = getPhotoRelations();
        if(rels[personId]) rels[personId] = rels[personId].filter(id => String(id) !== String(photoId));
        localStorage.setItem('photoRelations:myLineage', JSON.stringify(rels));
        openDrawerSection(personId, 'fotos');
      }

      // ── Drawer photo modal functions ──────────────────────────────────
      let _drawerCurrentPhotoId = null;
      let _drawerIsDrawing = false;
      let _drawerDrawStart = null;
      let _drawerCurrentDrawEl = null;

      function _drawerGetPeople(){ return typeof getPeople==='function'?getPeople():loadPeople(); }

      function _drawerViewPhoto(photoId){
        const ph = getPhotos().find(p => String(p.id) === String(photoId));
        if(!ph) return;
        _drawerCurrentPhotoId = photoId;
        const area = document.getElementById('drawerModalImageArea');
        area.innerHTML = '';
        area.style.display = 'flex'; area.style.alignItems = 'center'; area.style.justifyContent = 'center';
        const photoArea = document.createElement('div'); photoArea.className = 'photo-area'; photoArea.style.maxWidth = '100%';
        const img = document.createElement('img'); img.id = 'drawerModalImage';
        img.style.cssText = 'display:block;max-width:100%;max-height:70vh;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.5);';
        img.src = ph.originalDataUrl || ph.dataUrl || '';
        const overlay = document.createElement('div'); overlay.className = 'tag-overlay';
        overlay.style.cssText = 'position:absolute;left:0;top:0;right:0;bottom:0;pointer-events:auto;';
        const container = document.createElement('div'); container.style.position = 'relative';
        container.appendChild(img); container.appendChild(overlay);
        photoArea.appendChild(container); area.appendChild(photoArea);
        const notesEl = document.getElementById('drawerPhotoNotesArea');
        if(notesEl) notesEl.value = ph.notes || '';
        _drawerRenderPhotoTags(ph);
        overlay.addEventListener('pointerdown', function(ev){ ev.preventDefault(); _drawerStartDraw(ev, img, overlay); });
        overlay.addEventListener('pointermove', function(ev){ if(_drawerIsDrawing) _drawerUpdateDraw(ev, img, overlay); });
        overlay.addEventListener('pointerup',   function(ev){ if(_drawerIsDrawing) _drawerFinishDraw(ev, img, overlay); });
        document.getElementById('drawerPhotoModal').style.display = 'flex';
      }

      function _drawerClosePhotoModal(){
        _drawerCurrentPhotoId=null; _drawerIsDrawing=false; _drawerDrawStart=null; _drawerCurrentDrawEl=null;
        document.getElementById('drawerPhotoModal').style.display='none';
        const a=document.getElementById('drawerModalImageArea'); if(a) a.innerHTML='';
      }

      function _drawerSavePhotoNotes(){
        if(!_drawerCurrentPhotoId) return;
        const notes=((document.getElementById('drawerPhotoNotesArea')||{}).value||'');
        const photos=getPhotos(); const idx=photos.findIndex(p=>p.id===_drawerCurrentPhotoId); if(idx<0) return alert('Foto não encontrada');
        photos[idx].notes=notes; photos[idx].updatedAt=new Date().toISOString();
        localStorage.setItem('photos:myLineage',JSON.stringify(photos)); alert('Notas guardadas.');
      }

      function _drawerRenderPhotoTags(photo){
        try{
          const overlay=document.querySelector('#drawerModalImageArea .tag-overlay'); if(!overlay) return;
          overlay.innerHTML='';
          const tags=photo.tags||[]; const img=document.getElementById('drawerModalImage');
          tags.forEach(t=>{
            const el=document.createElement('div'); el.className='tag-rect';
            el.style.left=(t.bbox.x*100)+'%'; el.style.top=(t.bbox.y*100)+'%';
            el.style.width=(t.bbox.w*100)+'%'; el.style.height=(t.bbox.h*100)+'%';
            el.title=t.personName||t.name||'Identificado';
            el.addEventListener('click',function(ev){ ev.stopPropagation(); _drawerOpenEditTagForm(t,img,overlay); });
            const lbl=document.createElement('div'); lbl.className='tag-label'; lbl.textContent=t.personName||t.name||'Pessoa'; el.appendChild(lbl);
            overlay.appendChild(el);
          });
          const ppl=document.getElementById('drawerPhotoTaggedPeople'); if(!ppl) return;
          const unique=Array.from(new Map((tags||[]).map(t=>[t.personId||t.personName,t])).values());
          ppl.innerHTML=unique.length===0?'<span style="color:#888">Nenhuma pessoa identificada.</span>':'<strong>Pessoas identificadas:</strong> '+unique.map(t=>_esc(t.personName||t.name||'')).join(', ');
        }catch(e){ console.error(e); }
      }

      function _drawerStartDraw(ev,img,overlay){ _drawerIsDrawing=true; _drawerDrawStart={x:ev.clientX,y:ev.clientY}; _drawerCurrentDrawEl=document.createElement('div'); _drawerCurrentDrawEl.className='tag-rect'; _drawerCurrentDrawEl.style.left='0'; _drawerCurrentDrawEl.style.top='0'; _drawerCurrentDrawEl.style.width='0'; _drawerCurrentDrawEl.style.height='0'; overlay.appendChild(_drawerCurrentDrawEl); }
      function _drawerUpdateDraw(ev,img,overlay){ if(!_drawerIsDrawing||!_drawerCurrentDrawEl||!_drawerDrawStart) return; const r=img.getBoundingClientRect(); const l=Math.min(_drawerDrawStart.x,ev.clientX)-r.left; const t=Math.min(_drawerDrawStart.y,ev.clientY)-r.top; const w=Math.abs(ev.clientX-_drawerDrawStart.x); const h=Math.abs(ev.clientY-_drawerDrawStart.y); _drawerCurrentDrawEl.style.left=(l/r.width*100)+'%'; _drawerCurrentDrawEl.style.top=(t/r.height*100)+'%'; _drawerCurrentDrawEl.style.width=(w/r.width*100)+'%'; _drawerCurrentDrawEl.style.height=(h/r.height*100)+'%'; }
      function _drawerFinishDraw(ev,img,overlay){ if(!_drawerIsDrawing) return; _drawerIsDrawing=false; const r=img.getBoundingClientRect(); const bbox={x:Math.max(0,Math.min(1,(Math.min(_drawerDrawStart.x,ev.clientX)-r.left)/r.width)),y:Math.max(0,Math.min(1,(Math.min(_drawerDrawStart.y,ev.clientY)-r.top)/r.height)),w:Math.max(0,Math.min(1,Math.abs(ev.clientX-_drawerDrawStart.x)/r.width)),h:Math.max(0,Math.min(1,Math.abs(ev.clientY-_drawerDrawStart.y)/r.height))}; if(_drawerCurrentDrawEl&&_drawerCurrentDrawEl.parentElement) _drawerCurrentDrawEl.parentElement.removeChild(_drawerCurrentDrawEl); _drawerCurrentDrawEl=null; _drawerDrawStart=null; if(bbox.w>0.01&&bbox.h>0.01) _drawerShowTagForm(bbox,img,overlay); }

      function _drawerShowTagForm(bbox,img,overlay){
        const form=document.createElement('div'); form.className='tag-form'; form.style.left=(bbox.x*100)+'%'; form.style.top=(bbox.y*100)+'%';
        form.innerHTML='<div style="font-weight:600;margin-bottom:6px;">Identificar pessoa</div>';
        const people=_drawerGetPeople();
        const input=document.createElement('input'); input.placeholder='Pesquisar pessoa (nome)'; input.style.width='220px';
        const sugg=document.createElement('div'); sugg.style.cssText='position:absolute;left:8px;top:38px;background:var(--bg-card);border:1px solid rgba(255,255,255,0.1);max-height:160px;overflow:auto;width:220px;z-index:630;display:none;border-radius:6px;';
        const saveBtn=document.createElement('button'); saveBtn.textContent='Salvar'; saveBtn.className='btn';
        const cancelBtn=document.createElement('button'); cancelBtn.textContent='Cancelar'; cancelBtn.className='btn';
        const br=document.createElement('div'); br.style.marginTop='6px';
        form.appendChild(input); form.appendChild(sugg); form.appendChild(br); form.appendChild(saveBtn); form.appendChild(cancelBtn);
        form.addEventListener('pointerdown',ev=>ev.stopPropagation());
        let selectedPersonId=null;
        function renderSugg(q){ const list=people.filter(p=>!p.deletedAt&&((p.firstName||'')+' '+(p.lastName||'')).toLowerCase().includes((q||'').toLowerCase())).slice(0,30); sugg.innerHTML=''; if(!list.length){sugg.style.display='none';return;} list.forEach(p=>{ const row=document.createElement('div'); row.style.cssText='padding:6px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.04);'; row.textContent=((p.firstName||'')+' '+(p.lastName||'')).trim(); row.addEventListener('click',()=>{input.value=row.textContent;selectedPersonId=p.id;sugg.style.display='none';input.focus();}); sugg.appendChild(row); }); sugg.style.display='block'; }
        input.addEventListener('input',function(){selectedPersonId=null;renderSugg(this.value);});
        input.addEventListener('keydown',ev=>{if(ev.key==='Enter'){ev.preventDefault();saveBtn.click();}});
        cancelBtn.addEventListener('click',()=>{if(form.parentElement)form.parentElement.removeChild(form);});
        saveBtn.addEventListener('click',()=>{const name=input.value.trim();if(!name)return alert('Insira um nome ou selecione uma pessoa.');_drawerSaveTag({personId:selectedPersonId||null,personName:name,bbox});if(form.parentElement)form.parentElement.removeChild(form);});
        setTimeout(()=>{try{input.focus();}catch(e){}},50);
        overlay.appendChild(form);
      }

      function _drawerOpenEditTagForm(tag,img,overlay){
        const form=document.createElement('div'); form.className='tag-form'; form.style.left=(tag.bbox.x*100)+'%'; form.style.top=(tag.bbox.y*100)+'%';
        form.innerHTML='<div style="font-weight:600;margin-bottom:6px;">Editar identificação</div>';
        const people=_drawerGetPeople();
        const input=document.createElement('input'); input.value=tag.personName||tag.name||''; input.style.width='220px';
        const sugg=document.createElement('div'); sugg.style.cssText='position:absolute;left:8px;top:38px;background:var(--bg-card);border:1px solid rgba(255,255,255,0.1);max-height:160px;overflow:auto;width:220px;z-index:630;display:none;border-radius:6px;';
        const saveBtn=document.createElement('button'); saveBtn.textContent='Salvar'; saveBtn.className='btn';
        const deleteBtn=document.createElement('button'); deleteBtn.textContent='Remover'; deleteBtn.className='btn';
        const cancelBtn=document.createElement('button'); cancelBtn.textContent='Cancelar'; cancelBtn.className='btn';
        const br=document.createElement('div'); br.style.marginTop='6px';
        form.appendChild(input); form.appendChild(sugg); form.appendChild(br); form.appendChild(saveBtn); form.appendChild(deleteBtn); form.appendChild(cancelBtn);
        form.addEventListener('pointerdown',ev=>ev.stopPropagation());
        let selectedPersonId=tag.personId||null;
        function renderSugg(q){ const list=people.filter(p=>!p.deletedAt&&((p.firstName||'')+' '+(p.lastName||'')).toLowerCase().includes((q||'').toLowerCase())).slice(0,30); sugg.innerHTML=''; if(!list.length){sugg.style.display='none';return;} list.forEach(p=>{ const row=document.createElement('div'); row.style.cssText='padding:6px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.04);'; row.textContent=((p.firstName||'')+' '+(p.lastName||'')).trim(); row.addEventListener('click',()=>{input.value=row.textContent;selectedPersonId=p.id;sugg.style.display='none';input.focus();}); sugg.appendChild(row); }); sugg.style.display='block'; }
        input.addEventListener('input',function(){selectedPersonId=null;renderSugg(this.value);});
        input.addEventListener('keydown',ev=>{if(ev.key==='Enter'){ev.preventDefault();saveBtn.click();}});
        saveBtn.addEventListener('click',()=>{ const name=input.value.trim(); const pid=selectedPersonId||tag.personId||null; if(!name)return alert('Nome obrigatório'); const photos=getPhotos(); const idx=photos.findIndex(p=>p.id===_drawerCurrentPhotoId); if(idx<0)return; const tIdx=(photos[idx].tags||[]).findIndex(x=>x.id===tag.id); if(tIdx<0)return; photos[idx].tags[tIdx].personName=name; photos[idx].tags[tIdx].personId=pid; photos[idx].tags[tIdx].updatedAt=new Date().toISOString(); localStorage.setItem('photos:myLineage',JSON.stringify(photos)); if(pid){const rels=getPhotoRelations();rels[pid]=rels[pid]||[];if(!rels[pid].includes(_drawerCurrentPhotoId))rels[pid].push(_drawerCurrentPhotoId);localStorage.setItem('photoRelations:myLineage',JSON.stringify(rels));} _drawerRenderPhotoTags(photos[idx]); if(form.parentElement)form.parentElement.removeChild(form); });
        deleteBtn.addEventListener('click',()=>{ if(!confirm('Remover esta identificação?'))return; const photos=getPhotos(); const idx=photos.findIndex(p=>p.id===_drawerCurrentPhotoId); if(idx<0)return; photos[idx].tags=(photos[idx].tags||[]).filter(x=>x.id!==tag.id); localStorage.setItem('photos:myLineage',JSON.stringify(photos)); _drawerRenderPhotoTags(photos[idx]); if(form.parentElement)form.parentElement.removeChild(form); });
        cancelBtn.addEventListener('click',()=>{if(form.parentElement)form.parentElement.removeChild(form);});
        setTimeout(()=>{try{input.focus();}catch(e){}},50);
        overlay.appendChild(form);
      }

      function _drawerSaveTag({ personId, personName, bbox }){
        try{
          const photos=getPhotos(); const idx=photos.findIndex(p=>p.id===_drawerCurrentPhotoId); if(idx<0)return;
          const tag={id:'tag_'+Date.now()+Math.random().toString(36).slice(2,6),personId:personId||null,personName:personName||'',bbox,createdAt:new Date().toISOString()};
          photos[idx].tags=photos[idx].tags||[]; photos[idx].tags.push(tag); photos[idx].updatedAt=new Date().toISOString();
          localStorage.setItem('photos:myLineage',JSON.stringify(photos));
          if(personId){const rels=getPhotoRelations();rels[personId]=rels[personId]||[];if(!rels[personId].includes(photos[idx].id))rels[personId].push(photos[idx].id);localStorage.setItem('photoRelations:myLineage',JSON.stringify(rels));}
          _drawerRenderPhotoTags(photos[idx]);
        }catch(e){ console.error(e); }
      }

      function drawerSave(){
        const firstName=(document.getElementById('df_firstName')||{}).value||'';
        const lastName=(document.getElementById('df_lastName')||{}).value||'';
        const gender=(document.getElementById('df_gender')||{}).value||'';
        const notes=(document.getElementById('df_notes')||{}).value||'';
        let people=loadPeople();
        if(_drawerMode==='create'){
          const newId='p_'+Date.now();
          people.push({id:newId,firstName:firstName.trim(),lastName:lastName.trim(),gender,notes,createdAt:new Date().toISOString()});
          savePeople(people);
        } else {
          const idx=people.findIndex(p=>String(p.id)===String(_drawerPersonId));
          if(idx!==-1){ people[idx]=Object.assign({},people[idx],{firstName:firstName.trim(),lastName:lastName.trim(),gender,notes,updatedAt:new Date().toISOString()}); savePeople(people); }
        }
        closeDrawer();
        renderTable();
      }

      function drawerDeletePerson(){
        if(!_drawerPersonId) return;
        if(!confirm('Apagar esta pessoa?')) return;
        const pid=String(_drawerPersonId);
        let people=loadPeople();
        const idx=people.findIndex(p=>String(p.id)===pid);
        if(idx!==-1){ people[idx]=Object.assign({},people[idx],{deletedAt:new Date().toISOString()}); savePeople(people); }
        let relations=[];
        try{ relations=JSON.parse(localStorage.getItem('relations:myLineage')||'[]'); }catch(e){}
        relations=relations.filter(r=>String(r.from)!==pid&&String(r.to)!==pid);
        localStorage.setItem('relations:myLineage',JSON.stringify(relations));
        closeDrawer();
        renderTable();
      }

      document.getElementById('drawerCloseBtn').addEventListener('click', closeDrawer);
      document.getElementById('drawerCancelBtn').addEventListener('click', closeDrawer);
      document.getElementById('drawerOverlay').addEventListener('click', closeDrawer);
      document.getElementById('drawerSaveBtn').addEventListener('click', drawerSave);
      document.getElementById('drawerDeleteBtn').addEventListener('click', drawerDeletePerson);
      document.getElementById('drawerBackBtn').addEventListener('click', function(){ const pid=this._personId; if(pid) openDrawer('edit',pid); });
    </script>
  </body>
</html>
