<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>myLineage — Árvore Genealógica</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css">
    <style>
      .photo-area{position:relative;display:inline-block;}
      .tag-overlay{position:absolute;left:0;top:0;right:0;bottom:0;pointer-events:none}
      .tag-rect{position:absolute;border:2px solid rgba(59,130,246,0.9);background:rgba(59,130,246,0.12);pointer-events:auto;cursor:pointer;border-radius:6px;box-sizing:border-box}
      .tag-label{position:absolute;background:rgba(0,0,0,0.6);color:#fff;padding:2px 6px;border-radius:6px;font-size:12px;transform:translateY(-120%);white-space:nowrap}
      .tag-form{position:absolute;background:var(--bg-card);padding:8px;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,0.4);z-index:620}
      .tag-form input{margin-bottom:6px;}
      #topolaChart{width:100%;overflow:auto;position:relative;}
      #topolaChart svg{display:block;min-height:400px;}
      .chart-toolbar{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap;}
      .chart-toolbar select,.chart-toolbar button{font-size:0.85rem;}
    </style>
    <script src="remote-storage.js"></script>
    <script src="topola-bundle.js"></script>
  </head>
  <body class="page-tree">
    <div class="app-shell">
      <aside class="sidebar">
        <a href="index.html" class="logo"><i class="mdi mdi-tree" aria-hidden="true"></i><span>myLineage</span></a>
        <nav>
          <a href="app.html"><i class="mdi mdi-account-multiple" aria-hidden="true"></i>Cadastro</a>
          <a href="indicadores.html"><i class="mdi mdi-chart-bar" aria-hidden="true"></i>Indicadores</a>
          <a href="arvore.html" class="active"><i class="mdi mdi-sitemap" aria-hidden="true"></i>Árvore</a>
          <a href="gedcom.html"><i class="mdi mdi-dna" aria-hidden="true"></i>GEDCOM</a>
          <a href="album.html"><i class="mdi mdi-image-multiple" aria-hidden="true"></i>Álbum</a>
          <a href="documentos.html"><i class="mdi mdi-folder-open" aria-hidden="true"></i>Documentos</a>
          <a href="validacao.html"><i class="mdi mdi-shield-check" aria-hidden="true"></i>Validação</a>
          <a href="historico.html"><i class="mdi mdi-history" aria-hidden="true"></i>Histórico</a>
        </nav>
        <div class="sidebar-footer">
          <a href="apis.html"><i class="mdi mdi-api" aria-hidden="true"></i>APIs</a>
          <a href="configuracao.html"><i class="mdi mdi-cog" aria-hidden="true"></i>Definições</a>
        </div>
      </aside>
      <main class="content">
        <div class="topbar">
          <div style="display:flex;align-items:center;gap:10px;">
            <i class="mdi mdi-sitemap" style="color:var(--accent);font-size:1.15rem;"></i>
            <h1>Árvore Genealógica</h1>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <button id="resetFocusBtn" class="btn btn-ghost btn-sm" title="Resetar foco para a pessoa configurada">
              <i class="mdi mdi-crosshairs-gps" aria-hidden="true"></i> Reset foco
            </button>
          </div>
        </div>

        <div class="tree-canvas-wrap">
          <div class="chart-toolbar">
            <label style="font-size:0.85rem;color:var(--text-secondary);">Tipo de gráfico:</label>
            <select id="chartTypeSelect">
              <option value="hourglass">Hourglass (Ascend. + Descend.)</option>
              <option value="relatives">Relatives</option>
              <option value="fancy">Fancy</option>
            </select>
            <label style="font-size:0.85rem;color:var(--text-secondary);margin-left:12px;">Pessoa:</label>
            <select id="focusPersonSelect"></select>
            <button id="renderChartBtn" class="btn btn-sm"><i class="mdi mdi-refresh"></i> Renderizar</button>
          </div>
          <div id="topolaChart">
            <svg id="topolaSvg" style="width:100%;height:600px;"></svg>
          </div>
          <div class="legend">
            <span><span class="avatar" style="background:#4493f8"></span> Masculino</span>
            <span><span class="avatar" style="background:#e26aa6"></span> Feminino</span>
            <span><span class="avatar" style="background:#9aa0a6"></span> Outro</span>
          </div>
        </div>

        <div id="person-focus" class="person-focus" aria-live="polite"></div>
      </main>
    </div>

    <!-- ── Right drawer overlay ── -->
    <div class="drawer-overlay" id="drawerOverlay"></div>

    <!-- ── Right drawer ── -->
    <div class="drawer" id="personDrawer" role="dialog" aria-modal="true" aria-labelledby="drawerTitle">
      <div class="drawer-header">
        <button class="btn btn-ghost btn-sm" id="drawerBackBtn" style="display:none;padding:2px 6px;margin-right:4px;" title="Voltar"><i class="mdi mdi-arrow-left"></i></button>
        <h2 id="drawerTitle" style="flex:1;">Detalhes da Pessoa</h2>
        <button class="drawer-close" id="drawerCloseBtn" aria-label="Fechar painel"><i class="mdi mdi-close"></i></button>
      </div>
      <div class="drawer-person-header" id="drawerPersonHeader">
        <div class="drawer-avatar" id="drawerAvatar"></div>
        <div>
          <div class="drawer-person-name" id="drawerPersonName">—</div>
          <div class="drawer-person-sub" id="drawerPersonSub"></div>
        </div>
      </div>
      <div class="drawer-body" id="drawerBody"></div>
      <div class="drawer-footer">
        <button class="btn btn-danger btn-sm" id="drawerDeleteBtn"><i class="mdi mdi-delete-outline"></i> Apagar</button>
        <button class="btn btn-ghost btn-sm" id="drawerCancelBtn">Cancelar</button>
        <button class="btn btn-sm" id="drawerSaveBtn"><i class="mdi mdi-content-save-outline"></i> Guardar</button>
      </div>
    </div>

    <!-- ── Drawer photo modal ── -->
    <div id="drawerPhotoModal" style="display:none;position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.72);align-items:flex-start;justify-content:center;z-index:600;overflow-y:auto;padding:24px 0;">
      <div style="background:var(--bg-card);padding:22px;border-radius:12px;max-width:1000px;width:96%;box-sizing:border-box;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <div style="font-weight:700">Visualizar Foto</div>
          <button onclick="_drawerClosePhotoModal()" class="btn">Fechar</button>
        </div>
        <div style="margin-bottom:8px;font-size:0.82rem;color:#aaa;">Arrasta um retângulo sobre a imagem para identificar uma pessoa.</div>
        <div id="drawerModalImageWrapper" style="display:flex;align-items:center;justify-content:center;margin-bottom:16px;padding:8px;">
          <div id="drawerModalImageArea" style="max-width:100%;overflow:visible;"></div>
        </div>
        <div style="margin-bottom:8px;">
          <label style="font-weight:600;color:var(--text-secondary);display:block;margin-bottom:6px;">Notas da Foto</label>
          <textarea id="drawerPhotoNotesArea" style="width:100%;min-height:80px;padding:8px;border-radius:8px;border:1px solid rgba(163,163,255,0.08);background:rgba(35,40,58,0.7);color:var(--text-main);box-sizing:border-box;resize:vertical;"></textarea>
          <div id="drawerPhotoTaggedPeople" style="margin-top:8px;font-size:0.95rem;color:var(--text-main);"></div>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;">
          <button class="btn" onclick="_drawerSavePhotoNotes()">Salvar Notas</button>
        </div>
      </div>
    </div>

    <script>
    (function(){
      'use strict';
      const DB = window.GedcomDB;
      const T = window.TopolaLib;

      /* ── Helpers ──────────────────────────────────────────────────────── */
      const MONTHS_MAP = {JAN:1,FEB:2,MAR:3,APR:4,MAY:5,JUN:6,JUL:7,AUG:8,SEP:9,OCT:10,NOV:11,DEC:12};
      function _esc(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

      function parseGedcomDateToTopola(dateStr){
        if(!dateStr) return undefined;
        const tokens=dateStr.toUpperCase().split(/\s+/);
        let day,month,year;
        for(const t of tokens){
          if(MONTHS_MAP[t]) month=MONTHS_MAP[t];
          else if(/^\d{3,4}$/.test(t)) year=parseInt(t);
          else if(/^\d{1,2}$/.test(t)&&!day) day=parseInt(t);
        }
        if(!year&&!month&&!day) return undefined;
        return {date:{day,month,year}};
      }

      /* ── Build Topola-compatible JSON ─────────────────────────────────── */
      function buildTopolaJson(){
        const indis=DB.getIndividuals();
        const fams=DB.getFamilies();
        const tIndis=indis.map(indi=>{
          const birth=DB.getBirthEvent(indi);
          const death=DB.getDeathEvent(indi);
          const thumb=DB.getThumbnailForPerson(indi.id);
          return {
            id: indi.id,
            firstName: DB.getGivenName(indi)||undefined,
            lastName: DB.getSurname(indi)||undefined,
            sex: indi.sex||undefined,
            famc: indi.famc||undefined,
            fams: (indi.fams&&indi.fams.length)?indi.fams:undefined,
            birth: birth?{...parseGedcomDateToTopola(birth.date),place:birth.place||undefined}:undefined,
            death: death?{...parseGedcomDateToTopola(death.date),place:death.place||undefined}:undefined,
            images: thumb?[{url:thumb,title:''}]:undefined
          };
        });
        const tFams=fams.map(fam=>{
          const marr=(fam.events||[]).find(e=>e.type==='MARR');
          return {
            id: fam.id,
            husb: fam.husb||undefined,
            wife: fam.wife||undefined,
            children: (fam.children&&fam.children.length)?fam.children:undefined,
            marriage: marr?{...parseGedcomDateToTopola(marr.date),place:marr.place||undefined}:undefined
          };
        });
        return {indis:tIndis,fams:tFams};
      }

      /* ── Chart rendering ──────────────────────────────────────────────── */
      let chartHandle=null;

      const CHART_TYPES={
        hourglass: T.HourglassChart,
        relatives: T.RelativesChart,
        fancy: T.FancyChart
      };

      function renderChart(startIndi){
        const json=buildTopolaJson();
        if(!json.indis.length){
          document.getElementById('topolaSvg').innerHTML='<text x="50%" y="50%" text-anchor="middle" fill="#888" font-size="16">Sem dados. Adicione pessoas no Cadastro.</text>';
          return;
        }
        const chartType=CHART_TYPES[document.getElementById('chartTypeSelect').value]||T.HourglassChart;
        const svg=document.getElementById('topolaSvg');
        svg.innerHTML=''; // clear
        try{
          chartHandle=T.createChart({
            json,
            chartType,
            renderer: T.DetailedRenderer,
            svgSelector: '#topolaSvg',
            indiCallback: function(info){ if(info&&info.id) openDrawer('edit',info.id); },
            animate: true,
            updateSvgSize: true,
            horizontal: false,
            locale: 'pt'
          });
          chartHandle.render({startIndi:startIndi||undefined});
        }catch(err){
          console.error('Topola render error:',err);
          svg.innerHTML='<text x="50%" y="50%" text-anchor="middle" fill="#e06060" font-size="14">Erro ao renderizar: '+_esc(err.message)+'</text>';
        }
      }

      /* ── Focus person ─────────────────────────────────────────────────── */
      function getFocusPersonId(){
        // Check temp setting (from Cadastro "Ver na Árvore")
        const temp=DB.getSetting('tempFocusPerson');
        if(temp){ DB.setSetting('tempFocusPerson',null); return temp; }
        // Check configured focus person
        const focused=DB.getSetting('focusedPerson');
        if(focused) return focused;
        // Default: first individual
        const indis=DB.getIndividuals();
        return indis.length?indis[0].id:null;
      }

      function populateFocusSelect(selectedId){
        const sel=document.getElementById('focusPersonSelect');
        sel.innerHTML='';
        DB.getIndividuals().forEach(indi=>{
          const opt=document.createElement('option');
          opt.value=indi.id;
          opt.textContent=DB.getDisplayName(indi);
          if(indi.id===selectedId) opt.selected=true;
          sel.appendChild(opt);
        });
      }

      /* ── Person focus info bar ─────────────────────────────────────────── */
      function showFocusInfo(indiId){
        const el=document.getElementById('person-focus');
        const indi=DB.getIndividual(indiId);
        if(!indi){ el.innerHTML=''; return; }
        const name=DB.getDisplayName(indi);
        const birth=DB.getBirthEvent(indi);
        const death=DB.getDeathEvent(indi);
        let info=name;
        if(birth&&birth.date) info+=' | \u2605 '+birth.date;
        if(death&&death.date) info+=' | \u271D '+death.date;
        el.innerHTML='<i class="mdi mdi-account-circle" style="color:var(--accent);"></i> '+_esc(info);
      }

      /* ── Init ──────────────────────────────────────────────────────────── */
      const focusId=getFocusPersonId();
      populateFocusSelect(focusId);
      showFocusInfo(focusId);
      renderChart(focusId);

      document.getElementById('renderChartBtn').addEventListener('click',function(){
        const sel=document.getElementById('focusPersonSelect');
        const id=sel.value;
        showFocusInfo(id);
        renderChart(id);
      });

      document.getElementById('resetFocusBtn').addEventListener('click',function(){
        const configured=DB.getSetting('focusedPerson');
        const indis=DB.getIndividuals();
        const id=configured||(indis.length?indis[0].id:null);
        if(id){
          document.getElementById('focusPersonSelect').value=id;
          showFocusInfo(id);
          renderChart(id);
        }
      });

      /* ═══════════════════════════════════════════════════════════════════
         DRAWER (same pattern as app.html)
         ═══════════════════════════════════════════════════════════════════ */
      let _drawerPersonId=null,_drawerMode='edit';

      function openDrawer(mode,personId){
        const footer=document.querySelector('.drawer-footer'); if(footer) footer.style.display='';
        const backBtn=document.getElementById('drawerBackBtn'); if(backBtn){ backBtn.style.display='none'; backBtn._personId=null; }
        const phdr=document.getElementById('drawerPersonHeader'); if(phdr) phdr.style.display='';
        _drawerMode=mode; _drawerPersonId=personId||null;
        const indi=personId?DB.getIndividual(personId):null;
        document.getElementById('drawerTitle').textContent=mode==='create'?'Nova Pessoa':'Editar Pessoa';
        const nameEl=document.getElementById('drawerPersonName'),subEl=document.getElementById('drawerPersonSub'),avatarEl=document.getElementById('drawerAvatar');
        if(indi){
          nameEl.textContent=DB.getDisplayName(indi);
          let sub=[];
          const birth=DB.getBirthEvent(indi); if(birth&&birth.date) sub.push('\u2605 '+birth.date);
          const death=DB.getDeathEvent(indi); if(death&&death.date) sub.push('\u271D '+death.date);
          subEl.textContent=sub.join('  ·  ');
          const thumb=DB.getThumbnailForPerson(indi.id);
          if(thumb){avatarEl.style.backgroundImage='url('+thumb+')';avatarEl.style.backgroundSize='cover';avatarEl.style.backgroundPosition='center';}
          else{avatarEl.style.backgroundImage='';avatarEl.style.background=indi.sex==='F'?'#e26aa6':indi.sex==='M'?'#4493f8':'#9aa0a6';}
        } else {
          nameEl.textContent='Nova Pessoa'; subEl.textContent='';
          avatarEl.style.backgroundImage=''; avatarEl.style.background='var(--bg-surface-2)';
        }
        const body=document.getElementById('drawerBody');
        const given=indi?DB.getGivenName(indi):'';
        const surname=indi?DB.getSurname(indi):'';
        const sex=indi?(indi.sex||''):'';
        const notes=indi?(indi.notes||''):'';
        body.innerHTML=[
          '<div class="drawer-section-label">Identidade</div>',
          '<div class="form-row"><div><label>Primeiro nome</label><input type="text" id="df_firstName" value="'+_esc(given)+'" placeholder="Nome" /></div><div><label>Apelido</label><input type="text" id="df_lastName" value="'+_esc(surname)+'" placeholder="Apelido" /></div></div>',
          '<div><label>Género</label><select id="df_gender"><option value=""'+(!sex?' selected':'')+'>​(n/a)</option><option value="M"'+(sex==='M'?' selected':'')+'>Masculino</option><option value="F"'+(sex==='F'?' selected':'')+'>Feminino</option><option value="X"'+(sex==='X'?' selected':'')+'>Outro</option></select></div>',
          '<div class="drawer-section-label" style="margin-top:8px;">Notas</div>',
          '<div><textarea id="df_notes" rows="3" placeholder="Notas...">'+_esc(notes)+'</textarea></div>',
          indi?'<div style="margin-top:6px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;"><button class="btn btn-ghost btn-sm" style="font-size:0.82rem;" onclick="openDrawerSection(\''+indi.id+'\',\'relacoes\')"><i class="mdi mdi-account-multiple-outline"></i> Relações</button><button class="btn btn-ghost btn-sm" style="font-size:0.82rem;" onclick="openDrawerSection(\''+indi.id+'\',\'eventos\')"><i class="mdi mdi-calendar-check-outline"></i> Eventos</button><button class="btn btn-ghost btn-sm" style="font-size:0.82rem;" onclick="openDrawerSection(\''+indi.id+'\',\'fotos\')"><i class="mdi mdi-image-multiple-outline"></i> Fotos</button></div>':''
        ].join('');
        document.getElementById('personDrawer').classList.add('open');
        document.getElementById('drawerOverlay').classList.add('open');
        setTimeout(()=>{const fi=document.getElementById('df_firstName');if(fi) fi.focus();},50);
      }

      function closeDrawer(){
        document.getElementById('personDrawer').classList.remove('open');
        document.getElementById('drawerOverlay').classList.remove('open');
      }

      window.openDrawerSection=function(personId,section){
        const indi=DB.getIndividual(personId); if(!indi) return;
        const footer=document.querySelector('.drawer-footer'); if(footer) footer.style.display='none';
        const phdr=document.getElementById('drawerPersonHeader'); if(phdr) phdr.style.display='none';
        const backBtn=document.getElementById('drawerBackBtn'); if(backBtn){backBtn.style.display='';backBtn._personId=personId;}
        document.getElementById('drawerTitle').textContent=(section==='relacoes'?'Relações':section==='fotos'?'Fotos':'Eventos')+' — '+DB.getDisplayName(indi);
        const body=document.getElementById('drawerBody');
        if(section==='relacoes') body.innerHTML=_renderRelations(personId);
        else if(section==='fotos') body.innerHTML=_renderPhotos(personId);
        else body.innerHTML=_renderEvents(personId);
      };

      /* ── Events section (simplified for tree page) ─────────────────────── */
      const EVENT_TYPES={BIRT:'Nascimento',BAPM:'Batismo',CHR:'Batizado',DEAT:'Óbito',BURI:'Sepultamento',CREM:'Cremação',ADOP:'Adoção',OCCU:'Ocupação',RESI:'Residência',EVEN:'Outro'};
      function fmtEventDate(ev){ if(!ev||!ev.date) return ''; return ev.date; }

      function _renderEvents(personId){
        const indi=DB.getIndividual(personId);
        const evs=(indi&&indi.events||[]);
        let html='<div style="margin-bottom:12px;"><button class="btn btn-sm" onclick="_treeAddEvent(\''+_esc(personId)+'\')" style="font-size:0.83rem;"><i class="mdi mdi-plus"></i> Adicionar</button></div>';
        if(!evs.length) return html+'<div style="color:#888;">Nenhum evento.</div>';
        html+='<div class="mini-list">';
        evs.forEach((ev,i)=>{
          html+='<div class="mini-card" style="padding:10px 12px;"><span style="font-weight:600;">'+(EVENT_TYPES[ev.type]||ev.type)+'</span> <span style="color:#888;margin-left:8px;">'+_esc(fmtEventDate(ev))+'</span>'+(ev.place?' <span style="color:#aaa;margin-left:8px;">'+_esc(ev.place)+'</span>':'')+'</div>';
        });
        html+='</div>';
        return html;
      }

      window._treeAddEvent=function(personId){
        // Navigate to app.html drawer for full event editing
        window.location.href='app.html?edit='+encodeURIComponent(personId);
      };

      /* ── Relations section ─────────────────────────────────────────────── */
      function _renderRelations(personId){
        const rels=[];
        DB.getParents(personId).forEach(p=>rels.push({type:'Pai / Mãe',name:DB.getDisplayName(p),id:p.id,sex:p.sex}));
        DB.getSpouses(personId).forEach(s=>rels.push({type:'Companheiro(a)',name:DB.getDisplayName(s),id:s.id,sex:s.sex}));
        DB.getChildren(personId).forEach(c=>rels.push({type:'Filho(a)',name:DB.getDisplayName(c),id:c.id,sex:c.sex}));
        DB.getSiblings(personId).forEach(s=>rels.push({type:'Irmão / Irmã',name:DB.getDisplayName(s),id:s.id,sex:s.sex}));
        let html='';
        if(!rels.length) return '<div style="color:#888;">Sem relações.</div>';
        html+='<div class="mini-list">';
        rels.forEach(r=>{
          let desc=r.type;
          if(r.sex==='F'){if(desc.includes('Filho'))desc='Filha';if(desc.includes('Pai'))desc='Mãe';if(desc.includes('Compan'))desc='Companheira';if(desc.includes('Irm'))desc='Irmã';}
          else if(r.sex==='M'){if(desc.includes('Filho'))desc='Filho';if(desc.includes('Mãe'))desc='Pai';if(desc.includes('Compan'))desc='Companheiro';if(desc.includes('Irm'))desc='Irmão';}
          html+='<div class="mini-card" style="padding:10px 12px;cursor:pointer;" onclick="(function(){document.getElementById(\'focusPersonSelect\').value=\''+r.id+'\';document.getElementById(\'renderChartBtn\').click();closeDrawer();}())"><span style="font-weight:600;">'+_esc(r.name)+'</span> <span style="color:#aaa;margin-left:8px;">'+_esc(desc)+'</span></div>';
        });
        html+='</div>';
        return html;
      }

      /* ── Photos section (minimal for tree) ─────────────────────────────── */
      function _renderPhotos(personId){
        const media=DB.getMultimediaForIndividual(personId);
        if(!media.length) return '<div style="color:#888;">Nenhuma foto.</div>';
        let html='<div style="display:flex;flex-wrap:wrap;gap:10px;">';
        media.forEach(m=>{
          const src=m.dataUrl||(m.files&&m.files[0]?m.files[0].file:'')||'';
          html+='<img src="'+src+'" style="width:72px;height:72px;object-fit:cover;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,0.3);" title="'+_esc(m.title||'')+'" />';
        });
        html+='</div>';
        return html;
      }

      /* ── Drawer save/delete/close ──────────────────────────────────────── */
      function drawerSave(){
        const given=(document.getElementById('df_firstName')||{}).value||'';
        const surname=(document.getElementById('df_lastName')||{}).value||'';
        const sex=(document.getElementById('df_gender')||{}).value||'U';
        const notes=(document.getElementById('df_notes')||{}).value||'';
        if(_drawerMode==='create'){
          DB.saveIndividual({names:[{given:given.trim(),surname:surname.trim(),type:'birth'}],sex,notes,events:[]});
        } else if(_drawerPersonId){
          const indi=DB.getIndividual(_drawerPersonId);
          if(indi){indi.names=[{given:given.trim(),surname:surname.trim(),type:'birth'}];indi.sex=sex;indi.notes=notes;DB.saveIndividual(indi);}
        }
        closeDrawer();
        populateFocusSelect(document.getElementById('focusPersonSelect').value);
        renderChart(document.getElementById('focusPersonSelect').value);
      }

      function drawerDeletePerson(){
        if(!_drawerPersonId||!confirm('Apagar esta pessoa?')) return;
        DB.deleteIndividual(_drawerPersonId);
        closeDrawer();
        populateFocusSelect(null);
        renderChart(null);
      }

      document.getElementById('drawerCloseBtn').addEventListener('click',closeDrawer);
      document.getElementById('drawerCancelBtn').addEventListener('click',closeDrawer);
      document.getElementById('drawerOverlay').addEventListener('click',closeDrawer);
      document.getElementById('drawerSaveBtn').addEventListener('click',drawerSave);
      document.getElementById('drawerDeleteBtn').addEventListener('click',drawerDeletePerson);
      document.getElementById('drawerBackBtn').addEventListener('click',function(){const pid=this._personId;if(pid) openDrawer('edit',pid);});

      /* ── Photo modal stubs ─────────────────────────────────────────────── */
      window._drawerClosePhotoModal=function(){document.getElementById('drawerPhotoModal').style.display='none';};
      window._drawerSavePhotoNotes=function(){};

    })();
    </script>
    <script src="history-logger.js"></script>
  </body>
</html>
